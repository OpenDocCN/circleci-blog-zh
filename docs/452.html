<html>
<head>
<title>Object validation and conversion with Marshmallow in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Python中用棉花糖进行对象验证和转换</h1>
<blockquote>原文：<a href="https://circleci.com/blog/object-validation-and-conversion-with-marshamallow/#2021-12-20T00:00:00-08:00">https://circleci.com/blog/object-validation-and-conversion-with-marshamallow/#2021-12-20T00:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>Marshmallow是一个Python库，它将复杂数据类型与Python数据类型相互转换。它是验证和转换数据的强大工具。在本教程中，我将使用Marshmallow来验证一个简单的书签API，用户可以在其中保存他们喜欢的URL以及每个站点的简短描述。</p>

<p>本教程将涵盖:</p>

<ol>
  <li>用棉花糖序列化和反序列化对象</li>
  <li>测试序列化和反序列化的对象</li>
  <li>用棉花糖验证对象</li>
</ol>

<h2>先决条件</h2>

<p>要充分利用本教程，您需要:</p>
<ol>
  <li>我们机器上安装的Python版本&gt; = 3.5</li>
  <li>GitHub账户。你可以在这里创建一个<a href="https://github.com/join" target="_blank" rel="noreferrer noopener"/>。</li>
  <li>CircleCI账户。你可以在这里创建一个<a href="https://circleci.com/signup/"/>。</li>
  <li>对SQLite数据库有基本的了解。</li>
  <li>对Flask框架的基本理解。</li>
</ol>

<blockquote><p>我们的教程是平台无关的，但是使用CircleCI作为例子。如果你没有CircleCI账号，请在 注册一个免费的<a href="https://circleci.com/signup/"> <strong>。</strong></a></p></blockquote>

<h2>克隆存储库并创建虚拟环境</h2>

<p>从<a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository" target="_blank" rel="noreferrer noopener">克隆</a>来自<a href="https://github.com/mwaz/marshmallow-object-validation-and-conversion" target="_blank" rel="noreferrer noopener">这个GitHub链接</a>的库开始。一旦你克隆了库，下一步就是创建一个<a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noreferrer noopener">虚拟环境</a>，并激活它来安装我们的Python包。使用此命令:</p>

<pre><code>pip3 install -r requirements.txt
</code></pre>
<p><strong>注意:</strong> <i>为了避免全局安装包，使用Python 3.5默认捆绑的虚拟环境。默认的虚拟环境允许轻松管理Python项目中的依赖关系。</i></p>

<p>要创建默认虚拟环境，请运行以下命令:</p>

<pre><code>virtualenv api-venv
</code></pre>
<p>创建后还需要激活。更多关于Python虚拟环境的信息可以在<a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noreferrer noopener">这里</a>找到。</p>

<h2>为什么是棉花糖？</h2>

<p>通常在处理数据时，需要将数据从一种数据结构转换成另一种数据结构。Marshmallow是一个Python库，它可以将复杂的数据类型转换成本地的Python数据类型，反之亦然。</p>

<p>Python解释器支持一些内置的数据类型，包括整数、布尔、元组、列表、字典、浮点、集合和数组。对于想要创建能够处理不同类型操作的复杂程序的开发人员来说，这些是必不可少的。</p>

<p>Marshmallow的一个优点是它可以与任何数据库技术一起工作。它是平台无关的，这对开发者来说总是一个胜利。</p>

<p>为了进一步推广棉花糖，我们将使用这些技术:</p>

<ul>
  <li><b> Marshmallow-sqlalchemy </b>是SQL对象关系映射器sqlalchemy的扩展。</li>
  <li><b> Flask-marshmallow </b>是一个针对棉花糖的Flask扩展，可以很容易地将棉花糖与Flask一起使用。它还为棉花糖对象生成URL和超链接。</li>
</ul>

<h2>理解棉花糖模式</h2>

<p>理解棉花糖模式是如何工作的对于使用它是必不可少的。模式作为Marshmallow的核心，通过声明的模式跟踪数据。模式定义了数据的结构以及数据的验证。</p>

<p>我们书签应用程序的模式示例如下:</p>

<pre><code>class BookMarkSchema(ma.Schema):
    title = fields.Str(required=True, allow_none=False)
    url = fields.URL(
        relative=True, require_tld=True, error="invalid url representation"
    )
    description = fields.String(required=False, allow_none=True)
    created_at = fields.DateTime(required=False, allow_none=True)
    updated_at = fields.DateTime(required=False, allow_none=True)
</code></pre>
<p>这个模式为我们的模式中的字段创建验证并定义数据类型。模式已经过时，是时候序列化和反序列化数据了。</p>

<p><img src="../Images/34fd9c01cb19f3ac571e1a49ffa132f3.png" alt="Data serialization and deserialization in Marshmallow" srcset="https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-12-20-serialization-and-deserialization.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-12-20-serialization-and-deserialization.png"/></p>

<h2>在烧瓶应用程序中实现棉花糖</h2>

<p>为了构建我们的书签API，我们将首先构建一个<code>BookMarkModel</code>类。这个类将在我们的表、关系和字段的结构上连接到数据库引擎。我们还将添加一个<code>BookMarkSchema</code>类来序列化和反序列化模型中的数据。这些类可以在<code>/src/app.py</code>文件中的克隆存储库中找到。</p>

<p>为了展示Marshmallow如何将数据从Python类型解析为序列化对象，我们使用了SQLAlchemy。序列化的对象可以存储在数据库中，以后可以从数据库中反序列化为可接受的Python数据类型。</p>

<p>首先为模型和模式定义类创建一个结构。</p>

<pre><code># Adding SQLAlchemy
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(BASE_DIR, 'db.sqlite3')
db = SQLAlchemy(app)


# Add Marshmallow
ma = Marshmallow(app)

# Create the API model (SQLAlchemy)
class BookMarkModel(db.Model):
    pass

# Create schema (marshmallow)
class BookMarkSchema(ma.Schema):
    class Meta:
        pass

bookMarkSchema = BookMarkSchema()
bookMarksScehma = BookMarkSchema(many = True)
</code></pre>

<p>这个代码片段首先将<code>SQLAlchemy</code>连接到我们的应用程序，默认情况下使用SQLite。当URL被配置时，它连接到那个SQL数据库。然后，当数据从我们的模型发送和接收时，snipped实例化Marshmallow到<code>serialize</code>和<code>deserialize</code>。</p>

<p>当与单个书签交互时，<code>bookMark = BookMarkSchema()</code>模式负责反序列化单个数据集(即<code>POST</code>、<code>READ</code>和<code>UPDATE</code>路线)。相反，<code>bookMarks = BookMarkSchema(many =True)</code>用于反序列化数据集中的项目列表，例如获取所有请求的书签。</p>

<h2>在Marshmallow中序列化和反序列化数据</h2>

<p>在前面的代码片段中，我们基于我们的<code>BookMarkModel</code>创建了一个棉花糖模式。在本节中，我们将使用b Marshmallow在保存到数据库时序列化数据，在从数据库检索时反序列化数据。</p>

<h2>序列化Python数据</h2>

<p>序列化是将Python对象转换成可以存储在数据库中或传输的格式的过程。在Flask中，我们使用SQLAlchemy连接到我们的数据库。我们需要将SQLAlchemy对象转换成JSON数据，然后可以与我们的API进行交互。棉花糖是这个过程中一个很好的工具。在本节中，我们将在创建书签后使用Marshmallow返回一个JSON对象。我们将通过向SQLite数据库添加一个新书签来实现这一点。</p>

<pre><code># CREATE a bookmark
@app.route("/bookmark/", methods=["POST"])
def create_bookmark():
    title = request.json["title"]
    description = request.json["description"]
    url = request.json["url"]

    book_mark = BookMarkModel(
        title=title,
        description=description,
        url=url,
        created_at=datetime.datetime.now(),
        updated_at=datetime.datetime.now(),
    )

    result = bookMarkSchema.dump(book_mark)
    
    db.session.add(book_mark)
    db.session.commit()
    return result, 201
</code></pre>

<p>这个代码片段使用<code>BookMarkModel</code>类创建一个新的书签。它使用<code>db.session.add</code>和<code>db.session.commit</code>方法向数据库连续添加和保存书签。为了序列化对象，代码片段使用了<code>BookMarkSchema</code>类的<code>dump</code>方法，该方法返回一个格式化的JSON对象。</p>

<p>为了验证这一点，我们可以用Postman向数据库添加一个书签，并检索它。首先使用以下命令运行Flask应用程序:</p>

<pre><code>    FLASK_APP=src/app.py flask run   
</code></pre>

<p>一旦应用程序开始运行，我们现在可以使用Postman和<code>POST</code> route <code>/bookmark</code>向我们的API请求创建一个新的书签。</p>

<p><img src="../Images/3f7d142c5ad0c338c12bee7a1e9bfcfa.png" alt="Using Postman to make an API request to create a bookmark" srcset="https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-12-20-creating-a-bookmark.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-12-20-creating-a-bookmark.png"/></p>

<p>该请求返回的响应是一个JSON对象。成功！现在已经创建了一个书签并用Marshmallow序列化了，您可以从数据库中检索它并反序列化它。</p>

<h2>将JSON数据反序列化回SQLite</h2>

<p>反序列化与序列化相反。为了序列化，我们将数据从Python转换为JSON。为了反序列化，我们将JSON数据转换为SQLAlchemy对象。当从SQLite数据库中反序列化对象时，Marshmallow会自动将序列化的数据转换为Python对象。Marshmallow为此使用了<code>load()</code>函数。</p>

<pre><code>book_mark = BookMarkModel(
        title=title,
        description=description,
        url=url,
        created_at=datetime.datetime.now(),
        updated_at=datetime.datetime.now(),
    )
    try:
        json_input = request.get_json()
        result = bookMarkSchema.load(json_input)
    except ValidationError as err:
        return {"errors": err.messages}, 422
</code></pre>

<p>对于反序列化，这个代码片段返回一个SQLAlchemy对象，该对象是从我们的API的JSON响应转换而来的。</p>

<p>既然已经序列化和反序列化了一些数据，下一步就是编写测试。测试将确保端点返回正确的数据。为了完全确保一切正常，我们还将在CircleCI上运行这些测试。</p>

<h2>测试序列化</h2>

<p>测试通过验证您的代码是否按预期运行来激发您对应用程序的信心。在本节中，我们将创建一个测试来确保我们的序列化按预期工作。</p>

<pre><code># Test if one can add data to the database
def test_add_bookmark():
    my_data = {
        "title": 'a unique title',
        "description": 'a bookmark description',
        "url": 'unique bookmark url',
    }
    res = app.test_client().post(
        "/bookmark/",
        data=json.dumps(my_data),
        content_type="application/json",
    )
    assert res.status_code == 201
</code></pre>

<p>该测试验证了我们可以成功创建一个新书签。它还测试响应是否是我们在创建方法时定义的201状态代码。现在，我们可以通过将测试添加到CircleCI管道中来进一步验证成功。</p>

<h2>设置Git并推送到CircleCI</h2>

<p>要设置CircleCI，通过运行以下命令初始化项目中的Git存储库:</p>

<pre><code>git init
</code></pre>

<p>然后，在根目录下创建一个<code>.gitignore</code>文件。在文件中添加任何您不想添加到远程存储库中的模块。下一步是添加一个提交，然后<a href="https://circleci.com/blog/pushing-a-project-to-github/">将你的项目推送到GitHub </a>。</p>

<p>登录CircleCI并进入Projects，在这里您应该会看到与您的GitHub用户名或您的组织相关联的所有GitHub存储库。您希望为本教程设置的特定存储库是<code>object-validation-and-conversion-with-marshmallow</code>。在“项目”面板上，选择设置选定项目的选项，然后将该选项用于现有配置。</p>

<p><strong>注意:</strong> <i>在启动构建之后，预计您的管道会失败。您仍然需要将定制的<code>.circleci/config.yml</code>配置文件添加到GitHub中，以便正确构建项目。</i></p>

<h2>设置CircleCI</h2>

<p>首先，在您的根目录中创建一个<code>.circleci</code>目录。为每个项目的CircleCI配置添加一个<code>config.yml</code>文件。在这个设置中，我们将使用CircleCI Python <code>orb</code>。使用此配置来执行您的测试。</p>

<pre><code>version: 2.1
orbs:
  python: circleci/python@1.2

workflows:
  sample:
    jobs:
      - build-and-test
jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.8
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: pip
      - run:
          name: Run tests
          command: python -m pytest

</code></pre>

<h3>使用第三方球体</h3>

<p>CircleCI orbs是可重用yaml配置的可重用包，它将多行代码压缩成一行。要允许使用像<code>python@1.2</code>这样的第三方球体，您可能需要:</p>
<ul>
  <li>如果您是管理员，请启用组织设置，或者</li>
  <li>向您组织的CircleCI管理员请求权限。</li>
</ul>

<p>设置好配置后，<a href="https://docs.github.com/en/get-started/using-git/pushing-commits-to-a-remote-repository" target="_blank" rel="noreferrer noopener">将</a>配置推送到Github。CircleCI将开始建设这个项目。</p>

<p>瞧啊。转到CircleCI仪表板，展开构建详细信息。验证测试运行成功，并集成到CircleCI中。</p>

<p><img src="../Images/604ed94910d4c7ecd2de39a7a7459d4c.png" alt="Build details showing pipeline setup success" srcset="https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-12-20-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-12-20-pipeline-setup-success.png"/></p>

<p>现在您已经设置了CI管道，您可以继续使用Marshmallow来验证数据。</p>

<h2>使用棉花糖的对象验证</h2>

<p>Marshmallow提供了一种在将对象数据发送到数据库之前验证对象数据的简单方法。Marshmallow模式使用模式中的<code>validate()</code>方法来创建书签。在这一步中，我们将添加验证以确保书签标题只允许字符串，而不允许其他类型。</p>

<pre><code>  class BookMarkSchema(ma.Schema):
    title = fields.String(required=True, allow_none=False)
    ...
</code></pre>
<p>当规则被传递给模式时，我们可以使用<code>validate()</code>方法来验证创建新书签的方法上的数据:</p>

<pre><code>def create_bookmark():
    title = request.json["title"]
    description = request.json["description"]
    url = request.json["url"]

    # Validate the data from request before serialization
    error = bookMarkSchema.validate({"title": title, "description": description, "url": url})
    if error:
        return jsonify(error)
</code></pre>

<p>在上面的代码片段中，我们使用<code>validate()</code>方法来检查返回的数据是否与我们描述的模式验证相匹配，如果出现错误，我们将把错误返回给用户。</p>

<p>为了验证这是否有效，向Postman发出一个<code>POST</code>请求，在<code>title</code>中输入一个整数值。您的API应该抛出一个错误。</p>

<p><img src="../Images/a894b4daed8b6921cdc61e617c775609.png" alt="Error showing incorrect value in title" srcset="https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-12-20-invalid-title-error.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-12-20-invalid-title-error.png"/></p>

<p>当与请求一起发送的无效<code>title</code>导致错误时，您将知道您的验证工作正常。</p>

<h2>为更多端点添加测试</h2>

<p>本教程没有涵盖用于克隆存储库的所有端点。如果您想自己继续，可以为端点添加测试，比如获取所有书签或获取单个书签。使用此代码:</p>

<pre><code># Test if all bookmarks are returned
def test_get_all_bookmarks_route():
    res = app.test_client().get("/bookmarks/")
    assert res.headers["Content-Type"] == "application/json"
    assert res.status_code == 200

# Test if a single bookmark is returned
def test_get_one_bookmark_route():
    res = app.test_client().get("/bookmark/1/")
    assert res.headers["Content-Type"] == "application/json"
    assert res.status_code == 200
</code></pre>

<p>这些测试验证了我们可以检索我们创建的书签，无论是所有书签还是一个书签。测试还验证了接收到的数据是一个<code>JSON</code>对象，与Marshmallow的序列化过程一致。</p>

<p>在我们称之为聚会之前，我们需要保存并提交我们的测试，并将它们推送到GitHub。成功的管道运行意味着一切顺利。</p>

<h2>结论</h2>

<p>在本文中，我们探索了使用Marshmallow反序列化和序列化数据以及执行验证的强大功能。通过这篇文章，我们已经经历了创建模型、创建模式以及连接它们的过程。我们还学习了如何使用验证来只允许特定类型的响应。我希望本教程对您有所帮助，并且希望您能够更好地理解如何使用Marshmallow进行序列化和反序列化。通过为更多的端点添加测试，让团队的其他成员参与进来，并将您所学到的知识应用到您自己的项目中。</p>



        
          
          
            <hr/>
            <p>Waweru Mwaura是一名软件工程师，也是一名专门研究质量工程的终身学习者。他是Packt的作者，喜欢阅读工程、金融和技术方面的书籍。你可以在<a href="https://waweruh.github.io/" target="_blank" rel="noreferrer noopener">他的网页简介</a>上了解更多关于他的信息。</p>

            <p><a href="/blog/author/waweru-mwaura/" class="arrow-link">阅读更多Waweru Mwaura的帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>