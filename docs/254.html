<html>
<head>
<title>Docker Deployment - Deploying to Google Cloud with Docker and Terraform | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Docker部署——使用Docker和Terraform | CircleCI部署到Google Cloud</h1>
<blockquote>原文：<a href="https://circleci.com/blog/deploying-using-terraform-gcp/#2018-12-13T10:00:00-08:00">https://circleci.com/blog/deploying-using-terraform-gcp/#2018-12-13T10:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>我经常在会议和技术会议上发言，最近我回答了很多关于不断向云平台交付应用程序的问题，例如使用<a href="https://www.terraform.io/" target="_blank" rel="noreferrer noopener"> HashiCorp Terraform </a>的<a href="https://cloud.google.com" target="_blank" rel="noreferrer noopener">谷歌云</a>。在这篇文章中，我将演示如何使用<a href="https://circleci.com/continuous-integration/"> CI/CD </a> pipelines、Docker和Terraform将应用程序部署到Google Cloud实例中。在这个例子中，您将使用一个<a href="https://cloud.google.com/container-optimized-os/docs/" target="_blank" rel="noreferrer noopener"> Google容器优化的OS </a>主机映像创建一个新的Google Cloud实例。谷歌的容器优化操作系统是为运行Docker容器而优化的计算引擎虚拟机的操作系统映像。借助容器优化操作系统，您可以快速、高效、安全地将Docker容器放在Google云平台上。</p>

<p>本教程还演示了如何使用Terraform创建一个新的Google Cloud实例，并使用这个<a href="https://github.com/datapunkz/python-cicd-workshop/blob/master/tutorial/cicd_101_guide.md" target="_blank" rel="noreferrer noopener"> CI/CD教程Docker映像</a>部署应用程序。该图像将从Docker Hub中提取，并在从Terraform创建的实例上运行。</p>



<h2>先决条件</h2>

<p>开始之前，您需要具备以下条件:</p>



<p>您还需要:</p>


<p>具备所有先决条件后，就可以继续下一部分了。</p>

<h2>基础设施作为代码</h2>

<p>基础设施即代码(IaC)是通过机器可读的定义文件来管理和配置云和IT资源的过程。IaC使组织能够使用现代DevOps工具(如<a href="https://www.terraform.io/" target="_blank" rel="noreferrer noopener"> Terraform </a>)调配、管理和销毁计算资源。</p>

<p>在本文中，您将使用IaC原则和Terraform将您的应用程序部署到Google Cloud。</p>

<h2>创建一个谷歌云平台项目</h2>

<p>使用这些指令<a href="https://github.com/GoogleCloudPlatform/community/blob/master/tutorials/getting-started-on-gcp-with-terraform/index.md#create-a-google-cloud-platform-project" target="_blank" rel="noreferrer noopener">创建一个新的谷歌云项目</a>。</p>

<h3>创建并获取谷歌云项目证书</h3>

<p>您需要创建<a href="https://github.com/GoogleCloudPlatform/community/blob/master/tutorials/getting-started-on-gcp-with-terraform/index.md#getting-project-credentials" target="_blank" rel="noreferrer noopener">谷歌云凭证</a>，以便使用Terraform执行管理操作。进入<a href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" target="_blank" rel="noreferrer noopener">创建服务账户密钥页面</a>。选择默认的服务账号或者新建一个，选择JSON作为key类型，点击<strong>创建</strong>。将这个JSON文件保存在<code>terraform/google_cloud/</code>的根目录下。</p>

<p><i> <strong>重要安全提示:</strong>将文件重命名为<code>cicd_demo_gcp_creds.json</code>，以保护您的Google Cloud凭据不会在公共GitHub存储库中被发布和暴露。您还可以通过简单地在这个项目的<code>.gitignore</code>文件中添加凭证的JSON文件名来保护凭证的JSON文件不被释放。您必须非常谨慎地对待这个JSON文件中的数据，因为一旦暴露，任何拥有这些信息的人都可以侵入您的Google Cloud帐户，创建资源，并收取费用。</i></p>

<h2>在本地安装Terraform</h2>

<p>首先，<a href="https://learn.hashicorp.com/tutorials/terraform/install-cli/" target="_blank" rel="noreferrer noopener">在本地安装Terraform】。</a></p>

<h2>设置地形</h2>

<p>在终端中，运行:</p>

<pre><code class="language-bash">cd terraform/google_cloud/
terraform init # this installs the Google Terraform plugins
</code></pre>

<p>接下来，您必须更改<code>main.tf</code>文件中的一些值。您将更改Terraform变量的值以匹配您的信息。将变量<code>project_name</code>的<code>default</code>标签更改为您之前创建的项目名称:</p>

<pre><code class="language-HCL">variable "project_name" {
  type = "string"
  default = "cicd-workshops"
}
</code></pre>
<p>将变量<code>docker_declaration</code>的<code>default</code>标记的<code>image</code>值:<code>image: 'ariv3ra/python-cicd-workshop'</code>更改为您在CI/CD教程中构建并推送到Docker Hub的Docker映像:</p>

<pre><code class="language-HCL">variable "docker_declaration" {
  type = "string"
  # Change the image: string to match the Docker image you want to use
  default = "spec:\n  containers:\n    - name: test-docker\n      image: 'ariv3ra/python-cicd-workshop'\n      stdin: false\n      tty: false\n  restartPolicy: Always\n"
}
</code></pre>

<h2>地形图</h2>

<p><a href="https://www.terraform.io/docs/commands/plan.html" target="_blank" rel="noreferrer noopener"> <code>terraform plan</code>命令</a>用于创建执行计划。除非明确禁用，否则Terraform会执行刷新，然后确定需要执行哪些操作才能达到配置文件中指定的所需状态。这个命令是检查一组更改的执行计划是否符合您的期望的一种方便的方法，而不需要对实际资源或状态进行任何更改。</p>

<p>在终端中，运行:</p>

<pre><code class="language-bash">terraform plan -out=plan.txt
</code></pre>

<p>这将向您显示一个漂亮的图表，其中列出了Terraform将创建或更改的项目。</p>

<h2>地形应用</h2>

<p><a href="https://www.terraform.io/docs/commands/apply.html" target="_blank" rel="noreferrer noopener"> <code>terraform apply</code>命令</a>用于应用所需的更改，以达到所需的配置状态，或由Terraform执行计划生成的预定动作集。</p>

<p>在终端中，运行:</p>

<pre><code class="language-bash">terraform apply plan.txt
</code></pre>

<p>这将执行Terraform计划，并尝试根据该计划和定义的Docker映像构建一个新的Google Compute实例。</p>

<h2>Google计算实例IP地址</h2>

<p>当Terraform完成构建Google资产时，您应该会看到实例的公共IP地址，它应该类似于下面的输出:</p>

<pre><code class="language-bash">Public IP Address = 104.196.11.156
</code></pre>

<p>复制列出的IP地址或DNS，并将其粘贴到web浏览器中，在末尾附加端口5000。完整的地址应该如下所示:</p>

<pre><code>https://35.237.090.42:5000
</code></pre>

<p>新应用程序应该呈现欢迎消息和图像。该应用程序是一个Docker容器，由您构建并推送到CircleCI的CI/CD intro tutorial Docker映像派生而来。</p>

<h2>地形破坏</h2>

<p>现在你已经证明你的Google Compute实例和Docker容器可以工作了，你应该运行<a href="https://www.terraform.io/docs/commands/destroy.html" target="_blank" rel="noreferrer noopener"> <code>terraform destroy</code>命令</a>来销毁你在本教程中创建的资产。你可以让它继续运行，但要知道，在谷歌云平台上运行任何资产都是有成本的，你可能要为这些成本负责。谷歌为其免费试用注册提供了慷慨的300美元信用，但如果你让资产运行，你可以很容易地吃掉它。这取决于你，但是运行<code>terraform destroy</code>将关闭任何运行资产。</p>

<h2>摘要</h2>

<p>在本文中，您使用Terraform从Docker Hub将示例应用程序部署到一个活动的Google Cloud实例。这个例子演示了在应用程序的CI/CD管道在CircleCI上构建为绿色后，如何使用Terraform手动部署应用程序。通过对项目的CircleCI <code>config.yml</code>文件进行一些额外的调整，您可以配置CI/CD管道，以便在管道中使用Terraform进行自动部署。配置自动地形部署有点复杂，需要更多的工程知识，但这绝对是可能的。这可能是未来博客帖子的主题，敬请关注！</p>

<p>如果你想了解更多关于CircleCI的信息，请查看<a href="https://circleci.com/docs/" target="_blank" rel="noreferrer noopener">文档</a>网站。如果你遇到困难，你可以通过<a href="https://discuss.circleci.com/" target="_blank" rel="noreferrer noopener">社区</a>论坛联系CircleCI社区。如果你想了解<a href="https://circleci.com/blog/deploy-terraform-behind-approval-job/">使用Terraform </a>部署基础设施的审批工作，请访问这篇博文。</p>



        
          
          
        
      </div>
    </div>    
</body>
</html>