<html>
<head>
<title>Automate GitHub Releases with CircleCI - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用CircleCI - CircleCI自动发布GitHub</h1>
<blockquote>原文：<a href="https://circleci.com/blog/publishing-to-github-releases-via-circleci/#2018-07-13T03:00:00-07:00">https://circleci.com/blog/publishing-to-github-releases-via-circleci/#2018-07-13T03:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>Releases是GitHub的一个特性，它允许你在GitHub漂亮的用户界面上展示代码的重要快照，用git标签标记。如果您目前没有使用发行版，我想向您展示为什么您可能想要使用，以及如何自动实现它们。</p>

<p>对于release，您可以获得标签所提供的内容——版本号和描述——但是您也可以获得一个更长的部分用于发布说明，以及一个存储和显示发布工件的地方。这意味着你的软件是二进制的。黛比。每个版本的rpm和AppImage文件都将由GitHub托管，为用户安装您的软件提供了一个方便的地方。</p>

<p>在这篇文章中，我将向你展示如何在CircleCI中创建发布。关于更全面的概述，请参见<a href="https://help.github.com/articles/creating-releases/"> GitHub关于创建版本的文档</a>。</p>



<p>其核心是，GitHub版本只是一个GitHub特性，位于git标签之上。让我们来分解一下:</p>

<h3>Git标签</h3>

<p>Git标签给你一个版本号来标记一个特定的git提交和一个简短的描述。信不信由你，只要把一个git标签推送到GitHub，就会在GitHub上你的项目的“Releases”标签里创建一个新的发布。这是一个只包含标签信息的准系统版本。</p>

<h3>放</h3>

<p>发布版通过提供更长的、“丰富的”描述、将标签标记为普通发布版或预发布版的能力，以及最重要的上传工件(如该发布版的二进制文件)的能力，为git标签增添了新的功能。我们将从CircleCI上传这些艺术品。</p>

<h2>工具</h2>

<p>有几种方法可以将CircleCI版本的工件发布到GitHub版本:</p>
<ul>
  <li>手动使用<code>curl</code>和GitHub API</li>
  <li>使用<a href="https://github.com/aktau/github-release"> GitHub发布</a></li>
  <li>使用<a href="https://github.com/itchio/gothub">github</a>_一个github释放叉)</li>
  <li>并且使用<a href="https://github.com/tcnksm/ghr"> ghr </a>，这就是我们将在我们的例子中使用的</li>
</ul>

<h3>使用ghr</h3>

<p><code>ghr</code>命令的全部细节可以在GitHub 上的<a href="https://github.com/tcnksm/ghr">中找到，但是，我们真的只需要学习一个子命令:</a></p>

<pre><code>ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${VERSION} ./artifacts/
</code></pre>

<p>这个命令将特定的工件(通常是二进制文件)上传到我们在GitHub上发布的GitHub版本。让我们来分解一下:</p>

<ul>
  <li>这里我们启动命令，并传递一个GitHub令牌给它进行认证。这是一个<a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/"> GitHub个人访问令牌</a>，而不是OAuth令牌/密钥。</li>
</ul>

<p>这是通过您的个人GitHub帐户专门创建的，您会希望保护这个令牌，并且只通过一个私有环境变量将它加载到CircleCI环境中。</p>

<ul>
  <li>
    <p>这是我们传递GitHub用户/组织名称和存储库名称的地方。这两个值都通过内置的CircleCI环境变量传递。不需要额外的工作。</p>
  </li>
  <li>
    <p><code>-c ${CIRCLE_SHA1}</code> -这里我们向<code>ghr</code>提供Git提交散列(在CircleCI中作为<code>$CIRCLE_SHA1</code>提供)。这告诉它释放是针对哪一个提交，以及标签。</p>
  </li>
  <li>
    <p><code>-delete</code> -删除git标签，如果已经存在，则释放。</p>
  </li>
  <li>
    <p><code>${VERSION}</code> -我们通过一个<code>$VERSION</code>环境变量设置git标签/发布版本。这可以是您想要的任何变量或字符串。通常，这与您的软件版本相同。</p>
  </li>
  <li>
    <p><code>./artifacts/</code>——然后我们设定路径寻找神器。在这种情况下，当前目录内名为<code>artifacts</code>的目录中的所有内容。</p>
  </li>
</ul>

<h3>普通CircleCI 2.0示例</h3>

<p>我们已经介绍了如何使用<code>ghr</code>创建GitHub版本，但是让我们看看它在CircleCI 2.0配置文件中的样子:</p>

<pre><code class="language-yaml">  publish-github-release:
    docker:
      - image: circleci/golang:1.8
    steps:
      - attach_workspace:
          at: ./artifacts
      - run:
          name: "Publish Release on GitHub"
          command: |
            go get github.com/tcnksm/ghr
            VERSION=$(my-binary --version)
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${VERSION} ./artifacts/
</code></pre>

<h3>CI构建CircleCI 2.0示例</h3>

<p>这是一个名为<code>publish-github-release</code>的CircleCI作业，它使用了一个<a href="https://circleci.com/docs/circleci-images/#go-golang"> CircleCI Go便利图像</a>。这是细目分类:</p>
<ul>
  <li>使用<a href="https://circleci.com/docs/workflows/#using-workspaces-to-share-data-among-jobs">工作空间</a>，我们从之前的工作中为我们的项目引入二进制文件(不在本文中讨论)。</li>
  <li>这个作业通过<code>go get</code>拉取并编译<code>ghr</code>(因为<code>ghr</code>是用Go写的)。</li>
  <li>它用<code>my-binary --version</code>的输出填充<code>$VERSION</code>，这是我们这篇文章的示例应用程序。</li>
  <li>然后我们使用<code>ghr</code>命令将<code>artifacts</code>目录中的二进制文件上传到GitHub。</li>
</ul>

<p>通过使用来自<a href="https://github.com/cibuilds"> CI构建</a>的<a href="https://github.com/cibuilds/github"> <code>ghr</code> Docker图像</a>，我们可以将上述工作缩短几秒钟。这是一个已经安装了<code>ghr</code>的轻量级Docker映像。下面是新的配置示例:</p>

<pre><code class="language-yaml">  publish-github-release:
    docker:
      - image: cibuilds/github:0.10
    steps:
      - attach_workspace:
          at: ./artifacts
      - run:
          name: "Publish Release on GitHub"
          command: |
            VERSION=$(my-binary --version)
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${VERSION} ./artifacts/
</code></pre>

<h3>工作流示例</h3>

<p>下面是一个例子，说明如何在一个<a href="https://circleci.com/docs/workflows/">工作流</a>中实现上述工作的一个变体，以将标记的提交发布到GitHub版本:</p>

<pre><code>workflows:
  version: 2
  main:
    jobs:
      - build:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+$/
      - publish-github-release:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+$/
</code></pre>

<p>在这个例子中，当git标签被推送时，CircleCI启动了<code>publish-github-release</code>任务。具体如何选择何时发布GitHub版本取决于您，但是这里我们将使用一个类似SemVer的git标签来完成。我们说SemVer-like是因为我们使用的标签regex<code>/^\d+\.\d+\.\d+$/</code>匹配诸如<code>1.2.3</code>的标签，但是没有考虑到<a href="https://semver.org/"> SemVer </a>的所有规则(语义版本)。为了完整起见，下面是根据<a href="https://rgxdb.com/r/40OZ1HN5">rgxdb.com</a>的说法，一个完整的SemVer正则表达式应该是什么样子:</p>

<pre><code>/(?&lt;=^[Vv]|^)(?:(?&lt;major&gt;(?:0|[1-9](?:(?:0|[1-9])+)*))[.](?&lt;minor&gt;(?:0|[1-9](?:(?:0|[1-9])+)*))[.](?&lt;patch&gt;(?:0|[1-9](?:(?:0|[1-9])+)*))(?:-(?&lt;prerelease&gt;(?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:0|[1-9](?:(?:0|[1-9])+)*))(?:[.](?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:0|[1-9](?:(?:0|[1-9])+)*)))*))?(?:[+](?&lt;build&gt;(?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:(?:0|[1-9])+))(?:[.](?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:(?:0|[1-9])+)))*))?)$/
</code></pre>

<p>阅读更多信息:</p>




        
          
          
        
      </div>
    </div>    
</body>
</html>