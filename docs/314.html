<html>
<head>
<title>Enabling module support for Go v1.11 in CircleCI - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在CircleCI - CircleCI中启用Go v1.11的模块支持</h1>
<blockquote>原文：<a href="https://circleci.com/blog/go-v1.11-modules-and-circleci/#2018-09-12T16:30:00-07:00">https://circleci.com/blog/go-v1.11-modules-and-circleci/#2018-09-12T16:30:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>Go v1.11于2018年8月24日发布。有相当多的变化！虽然有几个变化我真的很喜欢，比如能够<a href="https://golang.org/doc/go1.11#text/template">分配嵌套变量</a>，但也有一些变化会影响你的CircleCI构建。</p>



<h2>在版本中启用模块支持</h2>

<p>CircleCI上一个典型的Go项目的配置是这样开始的:</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.10
    working_directory: /go/src/github.com/my-org/my-repo
    steps:
      - checkout
</code></pre>

<p>简单地将Docker映像更改为<code>circleci/golang:1.11</code>将<strong>而不是</strong>启用模块支持。相反，有两种不同的方法可供您使用:</p>

<ol>
  <li>将您的代码移出<code>GOPATH</code></li>
  <li>将<code>GO111MODULE</code>环境变量设置为<code>"on"</code></li>
</ol>

<h3>方法1 -将代码移出GOPATH</h3>

<p>使用Go v1.11 Docker映像，通过将代码移动到<code>GOPATH</code>之外的路径来启用模块支持。例如:</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11
    working_directory: /my-app
    steps:
      - checkout
</code></pre>

<p>更好的是，除非你绝对需要指定一个<code>working_directory</code>，否则我会把它完全从配置中去掉。当你省略它时，CircleCI默认为<code>~/project</code>，并且在你的配置中少了一行。这是我推荐的启用模块支持的方法:</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11
    steps:
      - checkout
</code></pre>

<h3>方法2 -使用go 111模块</h3>

<p>如果您喜欢将项目代码保存在<code>GOPATH</code>中，可以通过环境变量启用模块支持。这里有一个例子:</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11
        environment:
          GO111MODULE: "on"
    working_directory: /go/src/github.com/my-org/my-repo
    steps:
      - checkout
</code></pre>

<p>注意用于包装<code>"on"</code>的双引号。对于许多人来说，不使用引号会导致YAML将值解释为<code>true</code>，而Go不接受这个值为有效值。</p>

<h2>在存储库中启用模块支持</h2>

<p>为了让CircleCI构建工作，您的存储库也必须构建为支持Go模块。关于这一点有很多要说的，你可以在<a href="https://github.com/golang/go/wiki/Modules"> Go Wiki </a>上详细阅读。如果你的项目比副业项目大，我建议你通读一遍。下面是简短的版本。</p>

<p>准备您的代码:</p>

<pre><code class="language-bash">go mod init
</code></pre>

<p>如果您来自另一种流行的Go vendoring方法，如Dep，则可以跳过下一步。否则，需要执行以下步骤来创建一个完整的<code>go.mod</code>文件:</p>

<pre><code class="language-bash">go mod tidy
</code></pre>

<p>现在，将mod管理文件添加到Git是最后一步:</p>

<pre><code class="language-bash">git add go.mod go.sum
git commit -m "Add Go module support."
git push
</code></pre>

<p>如果您之前没有使用依赖管理器，而只是使用<code>go get</code>来获取包，那么现在您可以从CircleCI配置中删除它。</p>

<h2>测试</h2>

<p>有两种形式的<code>go test</code>供你考虑:</p>

<pre><code>go test ./...  # Tests only the code in your current module, typically your repo.
go test all    # This will test your code as well as direct and in-direct dependancies.
</code></pre>

<h2>贮藏</h2>

<p>使用Go模块时，缓存位置会发生变化。以下是恢复和保存缓存的方法:</p>

<pre><code class="language-yaml">      - restore_cache:
          keys:
            - go-mod-v1-{{ checksum "go.sum" }}

# ...

      - save_cache:
          key: go-mod-v1-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
</code></pre>

<p>好运，地鼠们。:)</p>

<h2>更多资源</h2>





        
          
          
        
      </div>
    </div>    
</body>
</html>