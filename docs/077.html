<html>
<head>
<title>Continuous integration for a Bazel Android project | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Bazel Android项目的持续集成| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/bazel-for-android/#2021-03-09T10:00:00-08:00">https://circleci.com/blog/bazel-for-android/#2021-03-09T10:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>Bazel(发音像美味的药草:“bay-zell”)是由Google开发的通用构建工具。一些著名的公司，如Twitter和Android开源项目已经迁移到Bazel。在本教程中，您将学习如何构建一个Bazel Android项目，并设置它与CircleCI的持续集成。我们将通过自动运行测试并生成一个二进制APK文件来结束本文。</p>

<p>除了书面指南，还有一个<a href="https://github.com/zmarkan/bazel-android-cicd-example">工作样本项目</a>。样本项目也可以在CircleCI 上的<a href="https://app.circleci.com/pipelines/github/zmarkan/bazel-android-cicd-example">查看。</a></p>

<h3>关于示例项目</h3>

<p>本教程的示例项目是一个用Kotlin编写的最小的Android应用程序，带有Bazel构建配置。项目应用程序具有应用程序二进制代码- <code>//app/src:app</code>以及使用Robolectric - <code>//app/src:unit_tests</code>进行单元测试的构建目标。</p>

<h2>先决条件</h2>

<p>要完成本教程，您应该对现代Android开发、Kotlin、Gradle和Git有所了解。你不需要对巴泽尔有任何经验。</p>

<h2>为巴泽尔建立一个项目</h2>

<p>要开始，您需要转到GitHub，克隆示例项目，并检查设置。</p>

<p>示例项目是一个标准的、最小的Android Gradle应用程序，使用Kotlin。它有一个项目文件和一个带有自己的<code>build.gradle</code>的<code>app</code>模块。在<code>app</code>目录中有一个公共的文件层级，有<code>main</code>、<code>test</code>和<code>androidTest</code>子目录，用于各种构建类型。</p>

<p><strong>注意:</strong> <i>我在Mac OS Catalina上安装家酿软件时遇到了问题，因此您的里程数可能会有所不同。</i></p>

<h3>使用工作空间、构建和规则</h3>

<p>开始使用Bazel需要两个文件- <code>WORKSPACE</code>和<code>BUILD</code>。<code>WORKSPACE</code>文件描述的正是你的工作空间。</p>

<p><code>WORKSPACE</code>应该在引用所有其他资源的顶级目录中。它相当于顶层的<code>build.gradle</code>,在这里您可以指定在哪里找到依赖关系的存储库。</p>

<p>您在<code>WORKSPACE</code>文件中看到的第一行是:</p>

<pre><code>load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
</code></pre>

<p><code>load</code>方法允许您访问该位置的其他脚本；在我们的例子中<code>http_archive</code>。使用这个方法从web上获取其他远程资源，比如来自GitHub的库版本。Bazel的另一个很好的特性是用于验证下载文件完整性的<code>sha256</code>参数。</p>

<pre><code>http_archive(
    name = "rules_android",
    urls = ["https://github.com/bazelbuild/rules_android/archive/v0.1.1.zip"],
    sha256 = "cd06d15dd8bb59926e4d65f9003bfc20f9da4b2519985c27e190cddc8b7a7806",
    strip_prefix = "rules_android-0.1.1",
)

</code></pre>

<p>当然，因为Skylark是有效的Python，变量和常量的工作方式与您预期的一样。</p>

<pre><code>
RULES_JVM_EXTERNAL_TAG = "2.2"
RULES_JVM_EXTERNAL_SHA = "f1203ce04e232ab6fdd81897cf0ff76f2c04c0741424d192f28e65ae752ce2d6"

http_archive(
    name = "rules_jvm_external",
    strip_prefix = "rules_jvm_external-%s" % RULES_JVM_EXTERNAL_TAG,
    sha256 = RULES_JVM_EXTERNAL_SHA,
    url = "https://github.com/bazelbuild/rules_jvm_external/archive/%s.zip" % RULES_JVM_EXTERNAL_TAG,
)

load("@rules_jvm_external//:defs.bzl", "maven_install")

</code></pre>

<p>您已经看到了如何使用<code>http_archive</code>加载新脚本，然后使用它们加载名为<code>maven_install</code>的新脚本。</p>

<h3>获取依赖关系</h3>

<p>在Android和JVM项目中，您通常从Maven存储库中获取依赖项。两个最常见的开源依赖库是Maven Central或JCenter。对于特定于Android的依赖项，还有谷歌自己的Maven知识库。</p>

<p>Bazel采用了一种熟悉的<code>maven_install</code>方法:</p>

<pre><code>
maven_install(
    artifacts = [
        "androidx.core:core-ktx:1.2.0",
        "androidx.appcompat:appcompat:1.1.0",
        "androidx.fragment:fragment:1.0.0",
        "androidx.core:core:1.0.1",
        "androidx.lifecycle:lifecycle-runtime:2.0.0",
        "androidx.lifecycle:lifecycle-viewmodel:2.0.0",
        "androidx.lifecycle:lifecycle-common:2.0.0",
        "androidx.drawerlayout:drawerlayout:1.0.0",
        "androidx.constraintlayout:constraintlayout:1.1.3",
        "com.google.android.material:material:1.0.0",
        "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.4.1",
        "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.4.1",
        "junit:junit:4.+",

    ],
    repositories = [
        "https://maven.google.com",
        "https://jcenter.bintray.com",
    ],
    fetch_sources = True,
)

</code></pre>

<p><code>artifacts</code>参数包含所有的依赖项和它们的版本，<code>repositories</code>指定它们来自哪里。</p>

<p>为整个工作空间下载依赖项，但还不包括在应用程序中。在本教程的稍后部分，您会发现它们已经包含在内。</p>

<h3>合并科特林</h3>

<p>通读Bazel文档时，您会了解到Kotlin并没有得到该工具的官方支持。幸运的是，Kotlin有一个官方的社区规则，它带来了编译特性。</p>

<p>目前，Bazel插件还不完全支持Kotlin 1.4。您可以引入1.3.0稳定版或1.4.0候选版。</p>

<pre><code>
rules_kotlin_version = "legacy-1.4.0-rc4"
rules_kotlin_sha = "9cc0e4031bcb7e8508fd9569a81e7042bbf380604a0157f796d06d511cff2769"

http_archive(
    name = "io_bazel_rules_kotlin",
    urls = ["https://github.com/bazelbuild/rules_kotlin/releases/download/%s/rules_kotlin_release.tgz" % rules_kotlin_version],
    sha256 = rules_kotlin_sha,
)
load("@io_bazel_rules_kotlin//kotlin:kotlin.bzl", "kotlin_repositories", "kt_register_toolchains")

kotlin_version = "1.4.20"
kotlin_release_sha = "11db93a4d6789e3406c7f60b9f267eba26d6483dcd771eff9f85bb7e9837011f"
rules_kotlin_compiler_release = {
    "urls": [
    "https://github.com/JetBrains/kotlin/releases/download/v{v}/kotlin-compiler-{v}.zip".format(v = kotlin_version),
    ],
    "sha256": kotlin_release_sha,
}
kotlin_repositories(compiler_release = rules_kotlin_compiler_release)
kt_register_toolchains()

</code></pre>

<p>您可以使用Kotlin Bazel规则附带的Kotlin编译器的捆绑版本。如果你喜欢使用其他的东西，你可以从GitHub上的Kotlin发布页面下载任何其他的编译器版本。</p>

<p>现在我们已经完成了你的Kotlin Android应用程序的Bazel <code>WORKSPACE</code>，我们可以专注于单独的包和它的<code>BUILD</code>文件。</p>

<h3>什么是Bazel包？</h3>

<p>Bazel应用程序称为目标，它们位于Bazel软件包中。Bazel包是任何具有<code>BUILD</code>文件及其子目录的目录。也就是说，除非一个子目录包含自己的<code>BUILD</code>文件。在这种情况下，该特定的子目录将成为其自己的包。</p>

<p>Bazel中的包在工作区内用双斜线<code>//</code>和它们的目录结构来寻址。我们的应用程序有一个单独的包:<code>//app/src</code>。那就是<code>BUILD</code>文件所在的地方。</p>

<h3>在Bazel应用程序中使用目标</h3>

<p><code>BUILD</code>文件包含我们前面提到的<code>load</code>方法调用，以及<code>kt_android_binary</code>、<code>android_test</code>和<code>kt_android_library</code>调用。这些元素是Bazel应用程序中的目标。目标可以是接受输入并产生构建输出的任何东西。在我们的例子中，这可以是源代码，也可以是另一个目标。每个Bazel应用程序可以包含多个目标。</p>

<p>对于本教程，我们将使用<code>test</code>和<code>android_binary</code>目标。Android二进制文件输出您的。apk文件，并且<code>test</code>做测试。你可以在<a href="https://docs.bazel.build/versions/master/be/android.html">巴泽尔文档</a>中找到这两者的文档。对于每个Android目标，您必须包括Android清单文件。</p>

<pre><code>
android_binary(
    name = "my_bazel_app",
    manifest = MANIFEST,
    custom_package = PACKAGE,
    manifest_values = {
        "minSdkVersion": "21",
        "versionCode" : "2",
        "versionName" : "0.2",
        "targetSdkVersion": "29",
    },
    deps = [
        ":bazel_res",
        ":bazel_kt",
        artifact("androidx.appcompat:appcompat"),
    ],
)

</code></pre>

<h3>使用Bazel命令构建项目</h3>

<p>要构建，使用<code>bazel build [target]</code>。<code>[target]</code>是您工作空间中完全合格的Bazel目标。对于本教程中的示例应用程序，目标是:<code>//app/src:app</code>，因此命令将是<code>bazel build //app/src:app</code>。</p>

<p>第一次构建可能需要一些时间，但是Bazel将缓存大多数依赖项和临时工件，因此未来的构建将会更快。</p>

<h3>安装示例应用程序</h3>

<p>所有最终构建工件都存储在<code>bazel-bin/app/src/main/app.apk</code>中。为了安装应用程序，Bazel有一个方便的<code>mobile-install</code>命令:</p>

<pre><code>bazel mobile-install //app/src:app
</code></pre>

<p>该命令使用与您连接的设备相关的参数调用<code>adb install</code>。</p>

<h2>与CircleCI一起建立Bazel项目</h2>

<p>CircleCI有许多Android Docker映像，这些映像提供了构建Android应用程序所需的一切。也就是<i>几乎</i>一切。Bazel不是默认安装的，所以这将是我们的第一步。</p>

<p>Docker镜像是基于Debian Linux的，所以你可以使用Bazel文档中的<a href="https://docs.bazel.build/versions/master/install-ubuntu.html"> Ubuntu安装说明。有两个步骤:</a></p>
<ol>
  <li>安装Bazel apt库</li>
  <li>用<code>apt install</code>安装Bazel本身</li>
</ol>

<p>一个简单的<code>setup-bazel</code> CircleCI命令就可以完成这项工作。</p>

<pre><code>commands:
  setup-bazel:
    description: |
      Setup the Bazel build system used for building Android projects
    steps:
      - run:
          name: Add Bazel Apt repository
          command: |
            sudo apt install curl gnupg
            curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor &gt; bazel.gpg
            sudo mv bazel.gpg /etc/apt/trusted.gpg.d/
            echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
      - run:
          name: Install Bazel from Apt
          command: sudo apt update &amp;&amp; sudo apt install bazel
</code></pre>

<p>这个片段大部分是可复制、可粘贴和可重用的。您可能只是想为更加确定性的构建固定一个特定版本的Bazel。我将在接下来的步骤和最终的示例项目中向您展示原因。</p>

<h3>测试和构建Bazel目标</h3>

<p>为了测试和构建Bazel目标，您需要分别使用<code>bazel test</code>和<code>bazel build</code>命令，为正确的目标传递合格的包和名称。在我们的例子中，这些是用于测试的<code>//app/src:unit_tests</code>，以及用于应用程序二进制文件的<code>//app/src:app</code>。</p>

<p>在本例中，我们在<code>setup-bazel</code>步骤之后立即构建它们。</p>

<pre><code>jobs:
  build:
    docker:
      - image: circleci/android:api-29
    steps:
      - checkout
      - android/accept-licenses
      - setup-bazel
      - run:
          name: Run tests
          command: bazel test //app/src:unit_tests # Depending on your Bazel package and target
      - run:
          name: Run build
          command: bazel build //app/src:app # Depending on your Bazel package and target

</code></pre>
<h3>存储测试和构建工件</h3>

<p>Bazel for Android将所有测试输出存储在项目的<code>bazel-testlogs</code>目录中，将所有二进制输出存储在项目的<code>bazel-bin</code>目录中。</p>

<p>在我们的例子中，输出将采用与Bazel targets - <code>src/app</code>相同的包结构。当您添加这些节时，CircleCI会存储所有有用的输出:</p>

<pre><code>      - store_test_results:
          path: ~/project/bazel-testlogs/app/src/unit_tests
      - store_artifacts:
          path: ~/project/bazel-testlogs/app/src/unit_tests
      - store_artifacts:
          path: ~/project/bazel-bin/app/src/app.apk
      - store_artifacts:
          path: ~/project/bazel-bin/app/src/app_unsigned.apk
</code></pre>

<p>我们还存储了<code>app_unsigned.apk</code>,因为如果你想发布一个发布版本，你需要自己签名。你可以在安卓开发者门户上阅读更多关于<a href="https://developer.android.com/studio/publish/app-signing.html#sign-manually">手动签名的信息。</a></p>

<h3>安装和使用特定的Bazel版本，以实现更具确定性的构建</h3>

<p>当使用<code>apt install bazel</code>安装Bazel时，您安装的是<i>最新稳定的</i>版本。在本地机器上总是使用最新和最好的可能没问题，但是在CI/CD环境中，您可能希望在您的构建中有更多的确定性。</p>

<p>通过修改您的<code>apt install bazel</code>行来使用一个特定的版本，您可以确保一致地使用最新的版本:<code>apt install bazel-3.7.2</code>。您需要确保在所有后续调用中使用该特定版本。例如，<code>bazel-3.7.2 build ...</code>。</p>

<p>使用Bazel特定版本的一种方法是在您的<code>config.yml</code>中使用CircleCI可重用参数。示例项目使用了<code>build</code>作业中的参数:</p>

<pre><code>jobs:
  build:
    parameters:
      bazel-version:
        description: "Pinned Bazel version Replace with your one"
        default: "bazel-3.7.2"
        type: string
    ...
    steps:
      - checkout
      - android/accept-licenses
      - setup-bazel:
          bazel-version: &lt;&lt;parameters.bazel-version&gt;&gt;
      - run:
          name: Run tests
          command: &lt;&lt; parameters.bazel-version &gt;&gt; test //app/src:unit_tests # Depending on your Bazel package and target

</code></pre>

<h2>结论和下一步措施</h2>

<p>我希望这篇教程能让你了解如何在你的<a href="https://circleci.com/blog/what-is-a-ci-cd-pipeline/"> CI/CD管道</a>中运行和构建Bazel Android应用程序。下一步可能是通过自动部署到测试服务来进一步扩展管道，甚至直接在应用商店分发应用。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>