<html>
<head>
<title>Config best practices: Docker layer caching | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>配置最佳实践:Docker层缓存| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/config-best-practices-docker-layer-caching/#2022-01-11T02:00:00-08:00">https://circleci.com/blog/config-best-practices-docker-layer-caching/#2022-01-11T02:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>让我们面对现实:创建最佳CI/CD工作流并不总是一项简单的任务。事实上，编写有效和高效的配置代码是许多开发人员在DevOps之旅中面临的最大障碍。但是，您不需要成为专家就可以建立快速、可靠的测试和部署基础设施。通过一些简单的技巧，您可以优化您的<code>config.yml</code>文件并释放您的CI/CD管道的全部潜力。</p>

<p>在本系列中，我们将深入探讨我们的解决方案工程师在与企业级客户进行一对一配置审查时提出的一些常见建议。今天，我们重点关注Docker层缓存(DLC)，这是一种用于在作业之间保存Docker层并加快工作流程的强大技术。</p>

<p>DLC直到最近才在性能和规模计划中提供，现在已包括在新的CircleCI免费计划以及CircleCI服务器的安装中。在本帖中，我们将讨论什么是Docker层缓存，为什么它很重要，以及如何将它添加到您的管道中。</p>

<h2>什么是Docker层缓存？</h2>

<p>Docker是CircleCI平台上使用的容器化技术。在<a href="https://circleci.com/docs/executor-types/#using-docker"> Docker执行器</a>和<a href="https://circleci.com/docs/executor-types/#using-machine">机器执行环境</a>中，您可以运行Docker构建命令来封装您的应用程序以进行测试和部署。使用Docker层缓存，您可以保存您构建的Docker映像的各个层，以便在后续管道运行中重用它们。</p>

<p>Docker层缓存可以绕过部分或全部映像构建步骤，从而在构建过程中为您的团队节省大量时间。Docker映像是从docker文件构建的，docker文件中的每个命令都会在映像中创建一个新层。当您使用<code>docker build</code>或<code>docker compose</code>构建Docker映像时，DLC会将各个层保存到与运行作业的机器或远程Docker实例相连的卷中。下次运行影像构建作业时，CircleCI将从缓存中检索任何未更改的图层。</p>

<p>如果您的Dockerfile在管道运行之间保持不变，将从缓存中检索整个图像。如果您在两次运行之间对docker文件进行了更改，CircleCI将检索到该更改之前的所有层，然后基于新的docker文件构建图像的其余部分。您的docker文件在运行之间更改得越少，您的映像构建得就越快。</p>

<h2>什么时候应该使用Docker层缓存？</h2>

<p>Docker容器从根本上改变了软件开发的前景，通过将二进制文件和依赖项打包到一个可移植的软件单元中，消除了潜在的环境冲突或“它在我的机器上工作”的难题，允许团队协作、安全和一致地构建、测试和部署应用程序。许多团队已经采用<a href="/blog/benefits-of-containerization/">容器化</a>作为实现云原生开发实践的方式，并将他们的软件架构转向更分布式的方法。</p>

<p>如果您的应用程序依赖于容器，您可能会发现自己在每次运行CI/CD管道时都构建相同的映像，这会严重消耗您的构建时间。通过启用Docker图层缓存，您可以重用缓存的图像图层，而不是在每次运行构建时从头开始构建，从而显著减少构建时间。</p>

<p>请注意，DLC只会减少在远程docker环境中使用<code>docker build</code>、<code>docker compose</code>或类似的Docker命令构建自己的Docker映像所需的时间。它不影响旋转<a href="https://circleci.com/docs/glossary/#primary-container">主对接容器</a>所花费的时间。如果您在Docker容器中运行管道，但不在工作流中构建新的映像，那么您不会看到通过实现DLC来减少构建时间。</p>

<h2>如何将Docker层缓存添加到管道中</h2>

<p>您可以使用Docker层缓存来加速Docker和机器执行环境中的Docker映像构建。在Docker执行环境中，您创建的任何Docker映像都构建在一个名为remote Docker environment的二级容器中，这为构建过程增加了额外的安全性，并允许您访问各种Docker命令以及将<a href="/blog/debugging-ci-cd-pipelines-with-ssh-access/"> SSH到您的构建</a>中进行调试。您可以使用<code>setup-remote-docker</code>键启动远程Docker环境，然后通过将<code>docker_layer_caching</code>设置为<code>true</code>来向构建作业添加Docker层缓存:</p>

<pre><code>version: 2
jobs:
  build:
    docker:
      # DLC does nothing here, its caching depends on commonality of the image layers.
      - image: cimg/node:17.3.0
        auth:
        username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      # DLC will explicitly cache layers here and try to avoid rebuilding.
      - run: docker build .
</code></pre>

<p>在这个示例<code>config.yml</code>文件中，您将<code>docker</code>设置为<code>build</code>作业的执行环境，并设置一个远程Docker环境，将<code>docker_layer_caching</code>设置为<code>true</code>。CircleCI将缓存您使用<code>docker build</code>命令构建的Docker图像的图层，以便您下次运行该作业时，可以避免重新构建任何未更改的图层。</p>

<p>机器执行环境不需要远程Docker环境来运行<code>docker</code>或<code>docker-compose</code>命令，因此您可以将<code>docker_layer_caching: true</code>键直接包含在机器执行器键的下面:</p>

<pre><code>version: 2
jobs:
  build_elixir:
    machine:
      image: ubuntu-2004:202104-01
      docker_layer_caching: true
    steps:
      - checkout
      - run:
          name: build Elixir image
          command: docker build -t circleci/elixir:example .
</code></pre>

<p>在本例中，您将<code>ubuntu-2004:202104-01</code> Linux映像设置为机器执行器类型，然后设置<code>docker_layer_caching: true</code>为该环境启用Docker层缓存。当您使用<code>docker build</code>命令构建Elixir映像时，CircleCI将缓存各个层，以便在以后的运行中重用。</p>

<p>为项目启用DLC后，保存的所有图层将在作业运行之间的三天内可用。任何三天后不再使用的缓存图层都将被删除。每个项目最多可以创建50个DLC卷。有关如何在您的项目中实现Docker层缓存的更多信息，以及一些潜在的用例和限制，请访问<a href="https://circleci.com/docs/docker-layer-caching/"> DLC文档</a>。</p>

<h2>结论</h2>

<p>Docker层缓存是在CircleCI上加速Docker构建的重要部分，现在包含在CircleCI免费计划中。如果您的团队构建容器化的应用程序，您可以通过在项目中重用未更改的Docker层来节省宝贵的开发时间。这不仅使您的团队更加高效，并为您的组织节省资金，而且还帮助您更快地向您的用户交付价值，这是当今软件开发环境中的一个关键优势。</p>

<p>DLC只是您可以对配置进行的许多不同优化中的一种。其他基于缓存的优化包括将数据保存在工作区中，以及缓存依赖项以加快构建。关于依赖缓存的更多信息，请参见<a href="https://circleci.com/blog/config-best-practices-dependency-caching/">配置最佳实践:依赖缓存</a>。请继续关注本系列后续文章中对可用配置优化的其他深入探讨。</p>

<p>要开始使用最强大的CI/CD平台更快、更自信地构建、测试和部署您的应用，<a href="https://circleci.com/signup/">立即注册免费计划</a>。如果您对CircleCI配置的专家级审查感兴趣，可以通过注册<a href="https://circleci.com/support/plans/">高级支持计划</a>，获得专门支持工程师的个性化一对一评估。</p>

<hr/>


        
          
          
        
      </div>
    </div>    
</body>
</html>