<html>
<head>
<title>VPNs and Why They Don’t Work - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>VPN和为什么他们不工作- CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/vpns-and-why-they-don-t-work/#2016-05-24T10:09:00-07:00">https://circleci.com/blog/vpns-and-why-they-don-t-work/#2016-05-24T10:09:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        
          <p class="italic"><strong>来自出版商的说明:</strong>您已经找到了我们的一些旧内容，这些内容可能已经过时和/或不正确。尝试在<a href="https://circleci.com/docs/" target="_blank">我们的文档</a>或<a href="https://circleci.com/blog/">博客</a>中搜索最新信息。</p>
          <hr/>
        

        <p>请注意:这篇文章专门介绍了我们在SaaS的服务。如果您的团队使用VPN，我们的<a href="https://circleci.com/enterprise/">企业产品</a>将更适合您。给我们<a href="mailto:%20enterprise@circleci.com">一行</a>多聊聊。</p>

<p>用户经常向支持部门询问的一个问题是，如何在他们的构建中创建一个VPN隧道来安全地访问网络资源。这在我们的平台上不工作有几个原因。一个是由于VPN如何创建TUN/TAP设备，另一个与无特权的LXC容器有关。这篇文章将解决使用CircleCI和VPN的常见问题。</p>



<h2>调谐器/TAP设备</h2>

<h3>什么是调谐器/TAP设备？</h3>

<p>调谐器/TAP设备是为VPN连接创建和使用的特定设备。它充当以太网设备，但不是直接从物理设备接收数据，而是从用户空间程序接收数据(可以是您正在使用的任何VPN类型，如L2TP、PPP、Cisco等)。).然后，它将数据发送回用户空间程序，用户空间程序再将数据发送到加密的“设备”，以便传输到目的地。</p>

<h3>这和我的构建有什么关系？</h3>

<p>VPN连接软件使用特定设备节点(如/dev/net/tun)创建设备，并将其注册为tunX或tapX。创建VPN连接的用户空间程序需要有创建设备的适当权限。使用该设备的驱动程序也需要编译到内核中才能正确使用。虽然用户确实可以访问他们的构建，但这并不适用于您的构建是有原因的，这就是LXC发挥作用的地方。</p>

<h2>无特权的LXC集装箱</h2>

<h3>什么是LXC集装箱？</h3>

<p>当用户运行一个构建时，我们创建一个LXC容器。linux内核为不同的运行进程提供了不同的系统“视图”。这允许物理资源，如I/O、CPU、RAM等。在逻辑上被“划分”。内核还允许使用两个主要组件:控制组和POSIX文件功能。控制组允许内核将一个或多个进程组合在一起，然后指定要分配给该控制组的资源。POSIX文件功能只是允许这些进程使用的文件比标准的“根”和“用户”权限分离具有更细粒度的安全性。</p>

<h3>什么是无特权LXC容器？</h3>

<p>无特权的LXC集装箱是LXC集装箱的一个更安全的版本，并且是我们在CircleCI使用的。在特权LXC容器中，主机和容器的根UID是相同的(0)。这意味着，如果用户能够通过/proc或/sys文件系统，或者通过某个syscall突破容器，他们将是主机上的UID 0(或root ),从而对主机以及该主机上的所有其他容器/资源拥有root访问权限。</p>

<p>非特权LXC容器使用用户名称空间为用户分配主机上未使用的用户和组ID范围(通常为100，000到165，000)。这意味着如果用户能够突破容器，容器的UID 0将映射到主机上的UID 100，000。这实际上授予了他们与nobody用户相同的权限，并且极大地限制了他们在主机上的权限。</p>

<h3>为什么这意味着我不能创建VPN？</h3>

<p>当容器中的“root”用户试图制作一个TUN/TAP设备时，它在主机上需要比它所拥有的有限访问权限更多的权限。这限制了多项操作，包括但不限于:</p>

<ul>
  <li>挂载某些文件系统</li>
  <li>创建设备节点(如创建TUN/TAP设备所需的节点)</li>
  <li>或者任何需要分配给-- LXC分配给容器的UID/GID范围(100，000 - 165，000范围)之外的权限的操作。</li>
</ul>

<p>如果不能在非特权容器上创建TUN/TAP设备，使用非特权LXC容器的任何平台上的任何用户都不能使用VPN服务。这意味着，只要我们使用无特权的LXC容器，就不会支持创建TUN/TAP设备，除非LXC对上游进行了更改，允许我们允许用户创建这些设备。</p>

<p>这是否意味着你无能为力？不，当然不是。还有一些其他的选择。我们将发布一篇后续文章，概述这些内容，并展示如何在未来实现它们。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>