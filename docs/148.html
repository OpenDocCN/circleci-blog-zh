<html>
<head>
<title>YAML - config.yml | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>YAML - config.yml |循环</h1>
<blockquote>原文：<a href="https://circleci.com/blog/circleci-hacks-reuse-yaml-in-your-circleci-config-with-yaml/#2017-09-20T06:13:00-07:00">https://circleci.com/blog/circleci-hacks-reuse-yaml-in-your-circleci-config-with-yaml/#2017-09-20T06:13:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        
          <p class="italic"><strong>来自出版商的说明:</strong>您已经找到了我们的一些旧内容，这些内容可能已经过时和/或不正确。尝试在<a href="https://circleci.com/docs/" target="_blank">我们的文档</a>或<a href="https://circleci.com/blog/">博客</a>中搜索最新信息。</p>
          <hr/>
        

        <p>【2018年9月更新: <em>写这篇博文是为了演示如何使用一个名为锚和别名的原生YAML特性让CircleCI配置文件变得更加干燥。现在CircleCI配置v2.1可以完成这个目标。<a href="https://circleci.com/docs/reusing-config/">来看看</a>。</em></p>

<p><a href="https://circleci.com/docs/workflows/">工作流</a>让许多人在他们的配置文件中获得了“工作快乐”。一项工作是“构建”，另一项是“测试”，还有一项是“部署”？也许，那还不算太坏。如果一个扇出、扇入的工作流总共有5个作业，每个作业都使用相同的Docker图像，会怎么样？在那个<a href="https://circleci.com/docs/sample-config/"> config.yml </a>文件中会有冗余。我们可以减少它，让YAML为我们工作。</p>



<p>今天，我们将介绍YAML 1.2版规范中一个更酷、更鲜为人知的特性，<a href="http://yaml.org/spec/1.2/spec.html#id2765878">主播&amp;别名</a>。我们将使用它们来减少对以下示例CircleCI <a href="https://circleci.com/docs/sample-config/"> config.yml </a>文件的重复编辑:</p>

<pre><code class="language-YAML"># .circleci/config.yml
version: 2
jobs:
  build:
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: "Build Our Statically Generated Docs Website with Hugo"
          command: HUGO_ENV=production hugo -v -s src/
      - persist_to_workspace:
          root: /root/project
          paths:src/public/
  html-testing:
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test With HTML Proofer"
          command: echo "This is where we'd do testing with HTML Proofer."
  ui-testing:
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test With Selenium or Behat"
          command: echo "This is where we'd run a headless browser and test our site's UI."
  process-testing:
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test the commit for org or team processes"
          command: |
            echo "This is where we'd test this commit for things our project wants to enforce"
            echo " such as code formatting, the signing of a CLA, security requirements, etc."
  deploy:
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Deploy Our Docs Site"
          command: echo "This is where we'd deploy using rsync, awscli, etc."
# Below would be the Workflows specifc config, which we're leaving off for brevity (this example as already lengthy.
</code></pre>

<h2>YAML锚&amp;别名</h2>

<p>YAML允许将一个节点声明为锚点。这意味着该节点将在YAML中的某个地方被引用。在上面的配置示例中，您将看到每个作业声明的开头都是为每个作业重复的。具体来说，我们在配置文件中重复以下行5次:</p>

<pre><code>...
    docker:
      - image: felicianotech/docker-hugo:0.27.1
    working_directory: ~/project
...
</code></pre>

<p>相反，我们可以在<code>.circleci/config.yml</code>的开头使用一个<strong>定位符</strong>，将这些行设置为作业的默认行:</p>

<pre><code>defaults: &amp;defaults
  docker:
    - image: felicianotech/docker-hugo:0.27.1
  working_directory: ~/project
...
</code></pre>

<p>然后我们用一个<strong>别名</strong>来写更少的行。这里有一个使用前面的<code>build</code>作业的例子:</p>

<pre><code>...
  build:
    &lt;&lt;: *defaults
    steps:
      - checkout
      - run:
          name: "Build Our Statically Generated Docs Website with Hugo"
          command: HUGO_ENV=production hugo -v -s src/
      - persist_to_workspace:
          root: /root/project
          paths:src/public/
</code></pre>

<h2>结果呢</h2>

<p>如果我们在整个配置文件中重复这个过程，我们会从最初例子中的56行配置变成47行。</p>

<p>也许，在这个例子中，减少9行并不值得称道，但是我们不仅仅减少了行数:我们已经使维护YAML文件变得更加容易。如果我们使用的Docker图像用一个新的标签更新，比如说<code>felicianotech/docker-hugo:0.28</code>，我们可以在配置的顶部更新图像标签一次，然后就完成了。此工作流中的5个作业现在都将使用更新的映像，只有一处更改。</p>

<p>你可以在<a href="https://discuss.circleci.com"> CircleCI讨论</a>中继续关于YAML主播和别名的讨论。更多高级YAML用法的例子可以在<a href="https://en.wikipedia.org/wiki/YAML#Advanced_components">维基百科</a>上找到。您可以在下面看到修改后的完整配置示例。</p>

<hr/>

<p>我们使用YAML锚点和别名的示例配置文件:</p>

<pre><code class="language-YAML"># .circleci/config.yml
defaults: &amp;defaults
  docker:
    - image: felicianotech/docker-hugo:0.27.1
  working_directory: ~/project

version: 2
jobs:
  build:
    &lt;&lt;: *defaults
    steps:
      - checkout
      - run:
          name: "Build Our Statically Generated Docs Website with Hugo"
          command: HUGO_ENV=production hugo -v -s src/
      - persist_to_workspace:
          root: /root/project
          paths: src/public/
  html-testing:
    &lt;&lt;: *defaults
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test With HTML Proofer"
          command: echo "This is where we'd do testing with HTML Proofer."
  ui-testing:
    &lt;&lt;: *defaults
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test With Selenium or Behat"
          command: echo "This is where we'd run a headless browser and test our site's UI."
  process-testing:
    &lt;&lt;: *defaults
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Test the commit for org or team processes"
          command: |
            echo "This is where we'd test this commit for things our project wants to enforce"
            echo " such as code formatting, the signing of a CLA, security requirements, etc."
  deploy:
    &lt;&lt;: *defaults
    steps:
      - attach_workspace:
          at: /root/project
      - run:
          name: "Deploy Our Docs Site"
          command: echo "This is where we'd deploy using rsync, awscli, etc."
# Below would be the Workflows specific config, which we're leaving off for brevity (this example as already lengthy.
</code></pre>


        
          
          
        
      </div>
    </div>    
</body>
</html>