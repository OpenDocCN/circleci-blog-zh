<html>
<head>
<title>Deploy to Google Kubernetes Engine - Deploy to GKE | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>部署到谷歌Kubernetes引擎-部署到GKE | CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/simplifying-your-ci-cd-build-pipeline-to-gke-with-circleci-orbs/#2019-07-11T02:00:00-07:00">https://circleci.com/blog/simplifying-your-ci-cd-build-pipeline-to-gke-with-circleci-orbs/#2019-07-11T02:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>本文试图解开orbs的使用之谜，以便快速入门CircleCI平台。orb使您能够跨项目共享、标准化和简化配置。您可能还想使用orb作为配置最佳实践的参考。请参考此<a href="https://circleci.com/docs/orb-intro/"> orb简介</a>以获得高级概述。你也可以参考<a href="https://circleci.com/developer/orbs"> CircleCI orbs注册表</a>获得可用orbs的完整列表。</p>

<h2>使用的技术</h2>

<p>本文假设您对以下技术和工具有基本的了解:</p>

<ul>
  <li><a href="https://www.docker.com/">Docker</a>——用于使用容器创建、部署和运行应用程序。Docker提供了可重复的开发、构建、测试和生产环境。</li>
  <li><a href="https://circleci.com/"> CircleCI </a> -用于持续集成和持续部署(CI/CD)。</li>
  <li>Kubernetes——用于跨主机集群自动化部署、扩展和管理容器化应用。这降低了云计算的成本，简化了运营和架构。</li>
  <li>Git一个分布式版本控制系统，用于在软件开发过程中跟踪源代码的变化。</li>
  <li><a href="https://cloud.google.com/kubernetes-engine/">谷歌Kubernetes引擎(GKE)</a>——谷歌运行Kubernetes集群的云解决方案。</li>
</ul>

<h2>GKE设置</h2>
<p>Kubernetes是一个独立于供应商的集群和容器管理工具，由Google于2014年开源。它提供了一个“跨主机集群自动部署、扩展和操作应用程序容器的平台。”最重要的是，这降低了云计算的成本，简化了运营和架构。要快速了解GKE，请参见<a href="https://cloud.google.com/gcp/getting-started/#quick-starts">文档</a>。</p>

<p>如果你没有谷歌云平台账号，你可以在这里获得一个<a href="https://console.cloud.google.com/freetrial/signup/tos">。一旦我们登录到我们的帐户，我们需要创建一个id为<code>circle-ci-demo</code>的项目。</a></p>

<p>接下来，我们需要下载并安装<a href="https://cloud.google.com/sdk/"> Cloud SDK </a>，这是一个用于Google云平台产品和服务的命令行界面，其中包含了<code>gcloud</code>，我们稍后将会用到这个工具。</p>

<p>在命令行中，通过在终端中输入以下命令来确认项目确实存在:</p>

<pre><code>gcloud projects list
</code></pre>

<p><img src="../Images/e04adedda02f2bec0121e7c4ea3bd2e6.png" alt="gcloud projects list" srcset="https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-projects-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-08-31-gcloud-projects-list.jpg"/></p>

<p>通过在您的终端中输入以下命令来初始化<code>gcloud</code>环境:</p>

<pre><code>gcloud init
</code></pre>

<p>通过输入以下内容对其进行身份验证:</p>

<pre><code>gcloud auth login
</code></pre>

<p><code>kubectl</code>是一个命令行界面，用于对Kubernetes集群运行命令。让我们通过在您的终端中输入以下内容来安装它:</p>

<pre><code>gcloud components install kubectl
</code></pre>

<p>在GKE 上创建一个名为<code>circle-ci-cluster</code>的<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster">容器集群。您可以从GCP控制台执行此操作，但也可以通过在命令行中输入以下命令来执行:</a></p>

<pre><code>gcloud container clusters create circle-ci-cluster
</code></pre>

<p>我们可以使用以下命令确认集群创建成功:</p>

<pre><code>gcloud container clusters list
</code></pre>

<p>您的输出将类似于下面的输出:</p>

<p><img src="../Images/96ebb9150a0dc8f70e18fff6f0dd03f5.png" alt="gcloud clusters list" srcset="https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-08-31-gcloud-clusters-list.jpg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-08-31-gcloud-clusters-list.jpg"/></p>

<p>要从另一台计算机或项目的另一个成员对GCP控制台中创建的集群运行<code>kubectl</code>命令，您需要在您的环境中生成一个<code>kubeconfig</code>条目。通过运行以下命令生成一个<code>kubeconfig</code>条目:</p>

<pre><code>gcloud container clusters get-credentials circle-ci-cluster
</code></pre>

<p>要确保群集设置正确，请运行命令:</p>

<pre><code>kubectl config current-context
</code></pre>

<p>您的输出将类似于下面的输出:</p>

<p><img src="../Images/cbf7ed333c68c91e1b6e28a6c781c5a5.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557703694924_image.png"/></p>

<h2>Docker设置</h2>
<p>Docker 是一个开源工具，可以在软件容器中自动部署应用程序。使用容器来部署应用程序被称为<em>容器化</em>。集装箱化已经变得流行，因为集装箱灵活、轻便、可互换、便携、可升级和可堆叠。你可以在链接的<a href="https://docs.docker.com/get-started/">网页</a>中了解更多关于Docker的信息。</p>

<h3>Dockerizing一个简单的Node.js应用程序</h3>
<p>我们的项目需要一个<code>Dockerfile</code>来对我们的<a href="https://github.com/daumie/circleci-orbs">简单nodejs应用程序</a>进行dockerize。一个<strong> Dockerfile </strong>是一个文本文档，它包含用户可以在命令行上调用的所有命令来组合一个图像。下面是项目中使用的Dockerfile文件:</p>

<pre><code># Set the base image to use for subsequent instructions
FROM node:alpine

# Add metadata to an image 
LABEL app="simple-node-application"

# Directive to set environmental variables key to value pair
ENV NPM_CONFIG_LOGLEVEL warn

# Set the working directory for any subsequent ADD, COPY, CMD, ENTRYPOINT, 
# or RUN instructions that follow it in the Dockerfile
WORKDIR /usr/src/app

# Copy files or folders from source to the dest path in the image's filesystem.
COPY package.json /usr/src/app/
COPY . /usr/src/app/

# Execute any commands on top of the current image as a new layer and commit the results.
RUN npm install --production

# Define the network ports that this container will listen on at runtime.
EXPOSE 3000

# Configure the container to be run as an executable.
ENTRYPOINT ["npm", "start"]
</code></pre>

<p>我们现在可以使用以下内容构建和标记图像:</p>

<pre><code>docker build -t circleci-gke:v1 .
</code></pre>

<p>通过从终端运行以下命令，确认映像已成功创建:</p>

<pre><code>docker image
</code></pre>

<p>您的输出将类似于下面的输出:</p>

<p><img src="../Images/3e668a33b598d2739e232c70b17ddb1c.png" alt="List Docker Images" data-original-src="https://www.dropbox.com/s/rw1hlrp0kdvyxpw/Screenshot%202019-05-13%2003.18.03.png?raw=1"/></p>

<p>通过从终端运行以下命令，在本地测试映像:</p>

<pre><code>docker run -p 3000:3000 circleci-gke:v1
</code></pre>

<p>您现在可以通过访问<a href="https://127.0.0.1:3000"> https://127.0.0.1:3000 </a>在浏览器上访问该应用程序。</p>

<p><img src="../Images/079960f09d889ff8313f1a25320d209c.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557707214987_image.png"/></p>

<p>下一步是标记图像并将其推送到注册表中，以便于管理。开发人员、测试人员和CI/CD系统(如CircleCI)需要使用注册表来存储应用程序开发过程中创建的映像。我们可以用以下命令标记图像:</p>

<pre><code>docker tag circleci-gke:v1 gcr.io/circle-ci-demo/circleci-gke:v1
</code></pre>

<p>然后，我们可以将图像推送到Google的容器注册中心(GCR ):</p>

<pre><code>docker push gcr.io/circle-ci-demo/circleci-gke:v1
</code></pre>

<p>既然我们已经将工作的容器化Docker映像推送到注册中心，我们就可以将应用程序部署到我们的<code>circle-ci-cluster</code>集群了。</p>

<h2>为部署配置Kubernetes清单</h2>
<p>Kubernetes使用YAML进行配置。我们将需要一个类型为<code>LoadBalancer</code>的Kubernetes服务，以使我们的部署可以被外部世界访问。</p>

<p>Kubernetes <strong>服务</strong>是一种抽象，它定义了一组逻辑单元和访问它们的策略。更多关于Kubernetes服务的信息请点击这里<a href="https://kubernetes.io/docs/concepts/services-networking/service/">。</a></p>

<p>Kubernetes <strong>部署</strong>管理集群上运行的无状态服务。他们的目的是保持一组相同的pod运行，并以受控的方式升级它们——默认情况下执行滚动更新。更多关于kubernetes的部署<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">在这里</a>。</p>

<p>创建一个文件夹来保存Kubernetes服务和部署的<code>.yaml</code>文件。对于这个例子，我将文件夹命名为<code>admin</code>。用下面的内容在文件夹中创建两个文件:</p>

<pre><code>apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: production-circle-demo
  labels:
    app: simple-backend
spec:
  selector:
    matchLabels:
      app: ci-deploy
      tier: backend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: ci-deploy
        tier: backend
    spec:
      containers:
        - image: gcr.io/circle-ci-demo/circleci-gke:v1
          name: rusty-pangolin
          ports:
            - containerPort: 3000
              name: ci-deploy
</code></pre>
<p>应用程序部署. yaml</p>
<p><br/></p>

<pre><code>apiVersion: v1
kind: Service
metadata:
  name: circle-service
  labels:
    app: circle
spec:
  ports:
    - port: 3000
  selector:
    app: ci-deploy
    tier: backend
  type: LoadBalancer
</code></pre>
<p>app-service.yaml</p>
<p><br/></p>

<p>因为我们的Kubernetes清单在文件夹<code>admin</code>中，所以我们可以通过对文件夹<code>admin</code>运行以下命令来验证它们:</p>

<pre><code>kubectl apply --validate=true --dry-run=true -f admin/
</code></pre>

<p>您的输出将类似于下面的输出:</p>

<p><img src="../Images/9f22b5ca54273cf350d3e185fc1ddf35.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557709515592_image.png"/></p>

<p>现在我们已经准备好部署我们的应用程序了。使用以下命令部署它:</p>

<pre><code>kubectl apply --validate=true   -f admin/
</code></pre>

<p>您的输出将类似于下面的输出:</p>

<p><img src="../Images/cc0d9f88b92a73d0ff7720139cc3c728.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557709640462_image.png"/></p>

<p>要访问应用程序，请使用以下命令获取外部IP:</p>

<pre><code>kubectl get services
</code></pre>

<p><img src="../Images/920f696e7090388c3fbb991ba1ec4bc7.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557709978662_image.png"/></p>

<p>您可以在<code>http://&lt;EXTERNAL-IP&gt;:3000</code>访问应用程序。对我来说，那是http://35.246.104.239:3000/.</p>

<p>我们将如何自动从GitHub中签出应用程序，构建它，测试它，并更新GKE上的运行实例？我们将与CircleCI合作。</p>

<h2>配置CircleCI</h2>
<p>现在我们已经有了一个到GKE的基本工作部署，我们将需要一种方法来更新应用程序，一旦更改被推送到我们选择的VCS。我们将<a href="https://circleci.com/integrations/github/">整合CircleCI和GitHub </a>。CircleCI <a href="https://circleci.com/docs/configuration-reference/">配置</a>以<code>.yml</code>文件的形式存在于项目根文件夹的<code>.circleci</code>目录中，即配置的路径为<code>.circleci/config.yml</code>。</p>

<h3>使用CircleCI球体</h3>
<p>我们不需要编写任何定制脚本来将我们的应用程序部署到GKE。我们将通过将预构建的命令、作业和执行器导入到我们的配置文件中来节省大量时间。我们将使用<code>orbs</code>键调用这个项目中的以下orb:</p>

<ul>
  <li>
    <p><code>node: circleci/node@1.0.1</code> -用于安装所有的应用依赖项。</p>
  </li>
  <li>
    <p>与GCR一起工作的圆球。</p>
  </li>
  <li>
    <p>与GKE一起工作的球体。</p>
  </li>
</ul>

<p>orb由以下元素组成:</p>

<ul>
  <li>命令</li>
  <li>作业——一组可执行的命令或步骤。</li>
  <li>执行者——这些定义了一个作业的步骤将在其中运行的环境，例如Docker、Machine、macOS等。除了该环境的任何其他参数之外。</li>
</ul>

<p>对于这个项目，<code>config.yml</code>文件包含以下代码行:</p>

<pre><code>version: 2.1
orbs:
  node: circleci/node@1.0.1
  gcp-gke: circleci/gcp-gke@0.1.0
  gcr: circleci/gcp-gcr@0.0.2
jobs:
  build:
    description: Install npm
    # machine option runs your jobs in a dedicated, ephemeral VM that has the following specifications:
    machine: true
    steps:
      - checkout
      # Install node
      - node/install
      # Install npm
      - node/install-npm
      # Download and cache dependencies
      - node/with-cache:
          steps:
            - run:
                name: Install application dependencies
                command: npm install
          # Save cache
          cache-key: package.json
          # Ignore non-checksum cache hits
          use-strict-cache: true
  Build-Push-Image-Docker:
    description: Build and push image to Google Container Registry
    machine: true
    steps:
      - checkout
      - gcr/gcr-auth
      - gcr/build-image:
          image: circle-gke
          tag: "v2" #Change version number e.g to 'v3' when updating application
      - gcr/push-image:
          image: circle-gke
          tag: "v2" #Change version number e.g to 'v3' when updating application
    
  deploy:
    description: Deploy application to Google Kubernetes Engine
    machine: true
    steps:
      # Install `gcloud` and `kubectl` if not already installed.
      - gcp-gke/install
      # Initialize the `gcloud` CLI.
      - gcp-gke/init
      # Update a deployment Docker image.
      - gcp-gke/rollout-image:
          deployment: circle-ci-cluster
          container: dominic-backend
          image: gcr.io/circle-ci-demo/circle-gke:v2 # change version when updating
workflows:
  build_update_deploy:
    jobs:
      - build
      - Build-Push-Image-Docker:
          requires:
            - build
      - deploy:
          requires:
            - Build-Push-Image-Docker
</code></pre>

<p><a href="https://circleci.com/blog/pushing-a-project-to-github/">将CircleCI配置文件的更改</a>推送到GitHub。</p>

<p>如果您没有CircleCI帐户，请创建一个。你可以注册GitHub。从CircleCI仪表板点击<strong>添加项目</strong>，从显示的列表中添加项目。</p>

<p>在我们对CircleCI做任何改变之前，我们需要一个和GCP沟通的方法。在我们的例子中，我们需要CircleCI将创建的映像推送到GCR，并用新映像更新部署的实例。我们将使用GCP的服务帐户。使用这些<a href="https://cloud.google.com/iam/docs/creating-managing-service-accounts">指令</a>创建服务账户。给服务账号<strong>编辑</strong>项目权限:</p>

<p><img src="../Images/87017c922fe6154d29c4d2f4d5f3c817.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557711323146_image.png"/></p>

<p>下面是一个服务帐户密钥结构:</p>

<p><img src="../Images/8594099028ae4ed54ffa62fa6feb1f8a.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557711515788_image.png"/></p>

<p><strong>注:</strong> <i>这是一个示例服务帐户(未使用)。你应该<strong>永远不要</strong>将服务账户提交给代码库，因为恶意攻击者可以获得对你的云平台资源的访问权。</i></p>

<p>复制服务帐户内容，并通过单击右上角的cog图标将它们添加为项目的<a href="https://circleci.com/docs/env-vars/">环境变量</a>。</p>

<p><img src="../Images/61f67630895cc0889786d1597cdb2a26.png" alt="" srcset="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-01-05-gke1.png"/></p>

<p>在构建设置下，点击<strong>环境变量</strong>。</p>

<p><img src="../Images/34a0803c605364eddac983548825448c.png" alt="" srcset="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-01-05-gke2.png"/></p>

<p>添加服务密钥为<strong> GCLOUD_SERVICE_KEY </strong>。您还需要添加<strong>谷歌计算区域</strong>。您可以通过运行以下命令来实现这一点:</p>

<pre><code>gcloud container clusters describe circle-ci-cluster
</code></pre>

<p><strong>注意:</strong> <i>使用您创建的集群</i>。</p>

<p><img src="../Images/60359e9b7a7da167509c368fb05f0254.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557713392581_image.png"/></p>

<p>对于我的集群，在底部，区域可以标识为<code>europe-west2-a</code>。根据您所在的位置，这可能会有所不同。</p>

<p>对于<strong> GOOGLE_PROJECT_ID </strong>，我们可以从控制台直接从<strong>项目信息</strong>卡中抓取:</p>

<p><img src="../Images/b2b9c88734c89e67b221aa551e55fd24.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557713607219_image.png"/></p>

<p>现在我们有了CircleCI环境集。我们可以触发一个新的构建来测试我们的管道是否工作。您的工作流将类似于下面的工作流:</p>

<p><img src="../Images/c836c40edb797116e7a9cb37ffa89cdb.png" alt="" srcset="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-01-05-gke3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-01-05-gke3.png"/></p>

<h2>在GKE上访问应用程序</h2>
<p>您可以通过运行以下命令来获取应用程序的外部IP:</p>

<pre><code>kubectl get services
</code></pre>

<p><img src="../Images/723f21c7521b27117ae3065e99ec58e6.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557770693922_image.png"/></p>

<p>例如，我必须访问http://35.246.118.41:3000/.上的应用程序</p>

<p><img src="../Images/0a887ecc6b96a5581e33d48647ed4f08.png" alt="" data-original-src="https://paper-attachments.dropbox.com/s_8016080743F576C48E91D945D398CC041ADB730CA208978E3DDC23E64567452D_1557770972191_image.png"/></p>

<h2>结论</h2>

<p>使用CircleCI orbs通过简化我们编写CircleCI配置的方式来提高生产率。orb也可以共享，这通过在我们的配置文件中使用预构建的命令、作业和执行器来节省时间。</p>

<p>orb并不局限于CircleCI + GKE部署。您可以浏览注册表中可用的<a href="https://circleci.com/developer/orbs">orb列表，找到符合您选择的云平台、编程语言等的orb。</a></p>


        
          
          
            <hr/>
            <p>Dominic Motuka是Andela 的DevOps工程师，在AWS和GCP支持、自动化和优化生产就绪部署方面拥有4年多的实践经验，利用配置管理、CI/CD和DevOps流程。</p>

            <p><a href="/blog/author/dominic-motuka/" class="arrow-link">阅读多米尼克·莫图卡的更多帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>