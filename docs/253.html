<html>
<head>
<title>Deploying from CircleCI to Linode and other VPS providers - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>从CircleCI部署到Linode和其他VPS提供商- CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/deploying-to-linode-vps-providers/#2018-08-08T03:00:00-07:00">https://circleci.com/blog/deploying-to-linode-vps-providers/#2018-08-08T03:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>构建和测试软件的最终目标通常是部署该软件。CircleCI官方博客和许多社区博客展示了部署到Kubernetes集群、推送Docker注册中心、上传到AWS S3，甚至新的无服务器技术的例子。然而，对于个人开发者甚至小公司来说，使用这样的大型部署平台并不总是可行的。</p>

<p>但是还有其他选择。</p>

<p>在这篇博文中，我们将介绍几种将软件部署到传统虚拟专用服务器(VPS)的方法，例如由<a href="https://www.linode.com/"> Linode </a>、<a href="https://www.digitalocean.com/"> DigitalOcean </a>或<a href="https://www.vultr.com/"> Vultr </a>提供的那些。</p>



<h3>SSH密钥</h3>

<p>我们将要介绍的所有工具都将通过互联网发送您的数据，以便部署您的软件。既然如此，拥有一个安全的连接是非常重要的。这篇文章中的许多例子将使用SSH密钥来加密连接。我建议专门为CircleCI创建一个全新的SSH keypair。我最喜欢的创建SSH密钥的资源是GitHub 的<a href="https://help.github.com/articles/adding-a-new-ssh-key-to-your-github-account/">。</a></p>

<p>私钥应该通过web应用程序存储在CircleCI上。我们有指示你可以跟着<a href="https://circleci.com/docs/add-ssh-key/">到这里</a>。对于您想要部署到的远程服务器上的用户，公钥应该存储在<code>authorized_keys</code>文件中。例如，如果您正在部署一个Linux服务器<code>prod@example.com</code>，那么公钥应该被附加到远程机器上的文件<code>/home/prod/.ssh/authorized_keys</code>中。</p>

<h3>Rsync</h3>

<p><code>rsync</code>是一个已经存在了一段时间的文件传输工具。该名称来自“远程同步”，这意味着它允许您将文件从一个目录或机器传输到另一个目录或机器，但同时保持它们同步。这很有用，因为这个目的意味着<code>rsync</code>可以比较远程服务器上的文件，如果它们已经存在，就不要传输它们，这有助于更快和更有效的部署。</p>

<p>当你有几个文件要传输时，比如用Hugo或Jekyll构建一个静态生成的网站时，这种方法非常有效。基本的Rails、Flask和React应用程序也可以这样部署。</p>

<h3>使用</h3>

<pre><code>rsync -va --delete ./my-files/ user@example.com:/var/www/html
</code></pre>

<p>对于<code>rsync</code>，您提供选项，您想要传输的文件或目录，然后您想要传输到哪里。</p>

<ul>
  <li>
    <p>“v”表示打开详细度，以便我们可以在出现问题时看到发生了什么，而“a”表示存档模式。存档模式打开了许多有用的选项，如递归、复制文件权限和所有权等等。</p>
  </li>
  <li>
    <p><code>--delete</code> -这告诉<code>rsync</code>如果一个文件在CircleCI上被删除，它也应该从远程服务器上被删除。闲置的旧文件可能会导致不必要的问题，比如生产与您的本地环境不匹配，从而导致不必要的影响。</p>
  </li>
  <li>
    <p><code>./my-files/</code> -我们要复制其内容的目录。请注意，有一个尾随斜线，尽管对于<code>rsync</code>，没有尾随斜线。<code>./my-files</code>没有尾随斜线意味着“复制整个目录，包括其中的所有内容。”<code>./my-files/</code>末尾的斜杠表示“只复制目录的内容，而不复制目录本身。”</p>
  </li>
  <li>
    <p><code>user@example.com</code>--“用户”是我们要部署到的远程服务器“example.com”上的用户名。</p>
  </li>
  <li>
    <p><code>:/var/www/html</code> -这是远程服务器上的文件路径，<code>rsync</code>应该将文件发送到该路径。对于web服务器，这应该是DocumentRoot。</p>
  </li>
</ul>

<h3>安装</h3>

<p>虽然一些Docker镜像可能已经安装了<code>rsync</code>，但是<a href="https://hub.docker.com/r/circleci">官方CircleCI镜像</a>和第三方<a href="https://hub.docker.com/r/cibuilds"> CI构建镜像</a>没有。然而，安装它相当简单:</p>

<pre><code># Ubuntu &amp; Debian based Docker images
sudo apt-get update &amp;&amp; sudo apt-get install rsync

# Alpine based Docker images
apk update &amp;&amp; apk add rsync
</code></pre>

<h3>CircleCI示例</h3>

<p>这是我的个人网站(Feliciano)的CircleCI配置片段。Tech)，通过<code>rsync</code>部署:</p>

<pre><code class="language-yaml">  deploy:
    docker:
      - image: cibuilds/hugo:0.42.1
    steps:
      - attach_workspace:
          at: src
      - add_ssh_keys
      - run: |
          echo 'web01.revidian.net ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJiGRY6N9WYQ0vy6cTiwAgNbc6ueJmVo/EafBtmT7bcD6cQMbipYM/KfYQ2lCn2TxqWepZKYoyoVQXgArycCOns=' &gt;&gt; ~/.ssh/known_hosts
          rsync -va --delete src/public/ staticweb@web01.revidian.net:www/feliciano.tech/public_html
</code></pre>

<h3>相关工具</h3>

<p>除了<code>rsync</code>之外，还有其他类似的选项。被称为“安全复制”的“T1”和被称为“安全FTP”的“T2”是两种工具，它们都利用SSH进行加密，并处理基本的文件传输过程，您可以使用它们部署到VPS。<br/>记下最后一条。<br/>老式的FTP是完全不安全的，不应该使用。每当你想到FTP，就想到SFTP。</p>

<h2>停靠点(SSH)</h2>

<p>如果你在Linode或类似的提供商上运行Dockerized应用，你可能没有复杂的编排工具，如Kubernetes或Docker Swarm running。当然这并不意味着你不能，但是这对于VPS用户来说不太常见。那么我们如何在不手动登录服务器的情况下，从CircleCI“部署”一个Docker应用呢？让我们看一个例子:</p>

<pre><code class="language-yaml">  deploy:
    docker:
      - image: circleci/golang:1.10
    steps:
      - attach_workspace:
          at: src
      - add_ssh_keys
      - run: |
          docker build .
          docker login -u $DOCKER_USER -p $DOCKER_PASS
          docker push myuser/myapp
          echo 'example.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJiGRY6N9WYQ0vy6cTiwAgNbc6ueJmVo/EafBtmT7bcD6cQMbipYM/KfYQ2lCn2TxqWepZKYoyoVQXgArycCOns=' &gt;&gt; ~/.ssh/known_hosts
          ssh root@example.com &lt;&lt;'ENDSSH'
          docker pull myuser/myapp
          docker stop my-app
          docker rm my-app
          docker run --name=my-app --restart=always -v $PWD:/app -d myuser/myapp
          ENDSSH
</code></pre>

<p>在这个部署作业中，我们为示例应用程序构建了一个新的Docker映像，并将其推送到Docker Hub。这使得该应用程序可以在CircleCI之外使用。然后，我们使用SSH命令的一个特性，该特性允许我们在远程机器上运行命令，在本例中是我们的生产机器。我们使用SSH登录，将新的Docker映像拖到生产机器上，停止、删除并使用更新后的映像重新启动应用程序。</p>

<p>为了简化CircleCI配置，我们还可以将远程Docker命令保存到名为<code>update-app.sh</code>或类似的Bash脚本中，然后从CircleCI运行该脚本。看起来会像这样:</p>

<pre><code class="language-bash">ssh root@example.com '/var/app/update-app.sh`
</code></pre>
<p>如果你尝试一下，<a href="https://twitter.com/FelicianoTech">让我知道</a>你做得怎么样！</p>

<p>总而言之，如果您不需要像Kubernetes和AWS S3这样的大型提供商的灵活编排，使用VPS来部署您的应用程序是一个经常被忽略但可行的选择。我写这篇文章的目的是展示一些可以和CircleCI一起用于发布应用程序的其他部署选项。</p>



        
          
          
        
      </div>
    </div>    
</body>
</html>