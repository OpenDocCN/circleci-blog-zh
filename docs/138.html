<html>
<head>
<title>CircleCI + AWS ECR/ECS - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>圆形+ AWS ECR/ECS -圆形</h1>
<blockquote>原文：<a href="https://circleci.com/blog/circleci-aws-ecrecs/#2015-12-21T15:14:37-08:00">https://circleci.com/blog/circleci-aws-ecrecs/#2015-12-21T15:14:37-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        
          <p class="italic"><strong>来自出版商的说明:</strong>您已经找到了我们的一些旧内容，这些内容可能已经过时和/或不正确。尝试在<a href="https://circleci.com/docs/" target="_blank">我们的文档</a>或<a href="https://circleci.com/blog/">博客</a>中搜索最新信息。</p>
          <hr/>
        

        <p><img src="../Images/dbe824aebc7cbf58f81ed82ccfa98bd6.png" alt="AmazonWebservices_Logo_svg" data-original-src="https://d3r49iyjzglexf.cloudfront.net/blog/content/AmazonWebservices_Logo_svg-6addb4796c14a769627c80d5074a2518d9b0bd6a5f2dfc6061aae1f9738b7c46.jpg"/></p>

<p>假期已经到了，AWS上的Docker开发人员今年得到了一份不错的礼物。今天，亚马逊发布了一项新服务:EC2容器注册中心(ECR)。ECR为开发人员提供了一个安全、可伸缩、可靠的容器注册中心，而无需手动设置基础设施。作为认证发布合作伙伴，现在只需使用CircleCI和AWS，就可以在一次git推送中构建、测试、上传和部署新的Docker容器。</p>



<p>当亚马逊向我们提供这项新服务的测试版时，我们迫不及待地想看看CircleCI的所有可能性。现在，我们已经能够使用它了，我们想分享我们在一个使用CircleCI的小型演示项目中看到的内容，以测试并部署一个新的多容器设置到AWS。</p>

<h2>码头集装箱，运行和存储</h2>

<p>去年，亚马逊发布了他们的EC2容器服务，消除了处理运行Docker图像所需的基础设施的麻烦。通过这项服务，不仅可以测试代码，还可以通过CircleCI测试基础设施，这使得真正将基础设施视为代码变得更加容易。结合CircleCI，该系统允许快速测试和部署Docker化代码，但并没有真正提供一种存储Docker映像和轻松管理权限的方法。</p>

<p>AWS并不是第一个拥有Docker注册表的公司；Docker和Google都有自己的注册中心，当然，您也可以在现有的AWS EC2实例中运行自己的注册中心。即使有这些选项，AWS的新容器注册中心仍然更有用，因为它与现有的AWS服务紧密集成。我们发现新ECR有两大优势。首先，ECR是一个一流的AWS服务，因此它与Amazon的身份访问管理完全集成。其次，ECR在所有地区提供冗余的Docker注册服务器。这使得在AWS中使用Docker映像更加方便，并提供了一些急需的冗余和安全性，尤其是对于那些到目前为止一直在运行自己的注册表的开发人员。</p>

<h2>入门:通过CircleCI使用Amazon的容器服务</h2>

<p>在我们演示将Docker注册表切换到Amazon ECR之前，我们想向您展示如何将ECS与CircleCI一起使用。这里我们假设您已经<a href="https://aws.amazon.com/ecs/">在Amazon上设置了EC2容器服务</a>(但是还没有部署任何映像)，并且您了解<a href="https://docs.docker.com/compose/"> Docker和Docker compose </a>。<a href="/blog/tame-your-test-environment-with-docker-compose/">我们自己的凯文·贝尔</a>已经构建了一个简单的多容器服务，你可以在这个项目的GitHub页面上查看。但是，您应该知道，要通过CircleCI使用ECS和ECR，您至少需要有环境变量</p>

<p>AWS _ ACCESS _ KEY _ ID AWS _ DEFAULT _ REGION AWS _ SECRET _ ACCESS _ KEY</p>

<p>通过项目的<a href="https://circleci.com/docs/1.0/environment-variables/#custom"> CircleCI环境变量</a>设置页面进行设置。设置完这些变量后，启动并运行它们并不需要太多代码，而且circle.yml文件实际上并没有真正增加复杂性。下面是新circle.yml文件中仅有的非Docker或测试命令:</p>

<pre><code>  machine:
    pre:
      - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.0-circleci'
      - sudo chmod 0755 /usr/bin/docker
    services:
          - docker
  deployment:
    prod:
      branch: master
      commands:
        - ./deploy.sh
</code></pre>

<p>正如您在这里看到的，该项目的ECS部分的真正内容在deploy.sh脚本中。如果你打开它，你可以看到它由四个独立但基本的功能组成。首先，我们用<code>deploy_image</code>将新创建的图像推送到我们的注册表中。在这种情况下，它被推送到Docker.io，但我们很快就会改变这种情况。之后，我们用<code>deploy_cluster</code>部署我们的映像，创建一个<a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_defintions.html">任务定义</a>，用<a href="http://docs.aws.amazon.com/cli/latest/reference/ecs/register-task-definition.html">AWS ECS register-task-definition</a>注册任务定义，然后等待旧的任务修订被删除。之后，亚马逊应该会运行你的新Docker容器！</p>

<h2>那么我们如何使用ECR呢？</h2>

<p>亚马逊ECR甚至更容易设置。一旦在AWS上创建了Docker存储库，只需使用</p>

<p>` aws ecr获取-登录'</p>

<p>然后使用docker注册中心的地址和您的AWS帐户ID标记您的图像，例如</p>

<p>` docker tag Ubuntu:trusty AWS _ account _ id . dkr . ECR . us-east-1 . Amazon aws.com/ubuntu:trusty '</p>

<p>最后以类似的方式推送到AWS，例如</p>

<p>` docker push AWS _ account _ id . dkr . ECR . us-east-1 . Amazon AWS . com/Ubuntu:trusty '</p>

<p>这就是全部了！您现在正在通过CircleCI和AWS构建、测试、推送和部署您的代码和基础设施！</p>

<p>我希望这有助于您了解如何在项目中使用Docker和CircleCI以及AWS！这自然不是通过CircleCI使用亚马逊的容器服务和容器注册的唯一方式。我们期待着建立我们的合作伙伴关系，并带来更多的方式来整合亚马逊ECR和CircleCI。</p>

<p>一如既往，如果您发现自己迷路了或在使用这些服务时遇到了麻烦，我们很乐意回答您的任何问题。您可以通过<a href="https://discuss.circleci.com/">我们的讨论社区网站</a>联系我们的专家，或者通过【sayhi@circleci.com】T2或应用内联系我们。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>