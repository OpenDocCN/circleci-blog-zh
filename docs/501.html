<html>
<head>
<title>Restructuring Litho’s CircleCI config for Workflows - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>正在为工作流重新构建Litho的CircleCI配置- CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/restructuring-litho-s-circleci-config-for-workflows/#2018-06-18T10:50:00-07:00">https://circleci.com/blog/restructuring-litho-s-circleci-config-for-workflows/#2018-06-18T10:50:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>这是Pavlos-Petros Tournaris的客座博文。它最初出现在他的博客<a href="https://medium.com/@p.tournaris/restructuring-lithos-circeci-config-for-workflows-38bb9e28f56a">这里</a>。Pavlos-Petros在Workable担任Android软件工程师。我们希望你喜欢！</p>

<p><img src="../Images/4008177d4d0bfa28894f2fad32282989.png" alt="litho1.jpeg" srcset="https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/litho1.jpeg?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/litho1.jpeg"/></p>

<p>大约一年半前，脸书发布了作为开源项目的<a href="https://fblitho.com/"> Litho </a>。Litho是一个Android框架，它让你以声明的方式定义你的UI。它立即引起了我的兴趣，我开始用一些例子和宠物项目来弄脏我的手。这是一个很好的经验，接触石和它的反应一样的性质，这是我的第一次。对这个新领域的兴趣让我意识到我可以更深入地研究它，也可以为这个项目做贡献。因此，就像我喜欢的任何其他开源项目一样，我开始检查“问题”选项卡，看看我是否能帮助解决任何错误或贡献新功能。</p>

<h2>自动化测试</h2>
<p>Litho，就像大多数开源项目一样，包含许多测试(没有测试通常很难获得开发人员的信任)。Litho上的测试基础设施是基于单元测试的，这些单元测试要么通过<a href="https://buckbuild.com/"> Buck </a>运行，要么使用Gradle。</p>

<p>但是如果你不能对你的PRs有适当的反馈，并且确保进入<code>master</code>分支的每个提交都是绿色的，那么测试本身没有任何意义。</p>

<p>Litho使用CircleCI来利用其单元测试套件的运行，收集测试结果，并为每个推送到<code>master</code>的提交发布快照。</p>

<h2>以前的情况</h2>
<p>此前，Litho使用的是由Litho的机器人工程师之一Pascal Hartig制作的定制Docker图像。</p>

<p>这个映像正在下载Buck，构建它并保存在Docker环境中。同样的事情也分别发生在安卓NDK和安卓SDK上。当CircleCI开始构建commit时，它会配置一些所需的键，用于上传档案和将Buck导出到Path中。最后，它开始执行样本项目的所有Buck &amp; Gradle构建，以及执行BUCK &amp; Gradle测试，这通过发布快照和存储测试结果来完成。</p>

<p>虽然这样做效果很好，但是仍然需要为Buck和Gradle测试以及样本构建配置并行作业。</p>

<h2>以前情况的问题</h2>
<p>在开始调查哪些地方可以改进的时候，我注意到了一些可以提高性能的东西，还有一些是在与Pascal讨论之后出现的。</p>
<ul>
  <li>CircleCI配置使用自定义的Docker映像，由于CircleCI在其容器上缓存Docker映像的方式，每次作业运行时都会有效地提取该映像，运行一个环境大约需要5-6分钟。</li>
</ul>

<p><img src="../Images/3c3a180a6f52c90551708a35918ddf48.png" alt="litho2.png" srcset="https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/litho2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/litho2.png"/></p>

<ul>
  <li>
    <p>构建和测试不是并行运行的，这意味着即使Buck构建需要两分钟来执行测试，它也必须等待Gradle完成测试后才能继续。</p>
  </li>
  <li>
    <p>用于收集测试结果的正则表达式没有收集Buck测试结果。</p>
  </li>
</ul>

<h3>工作流来了</h3>
<p>CircleCI提供了一个名为Workflows的特性，它允许我们定义并行运行的作业列表，但是您也可以声明作业之间的依赖关系，这将有效地将它们的执行更改为顺序执行。</p>

<pre><code>- checkout_code      
- build:          
    requires:            
      - checkout_code      
- buck_sample_build:          
    requires:            
      - build      
- buck_sample_barebones_build:          
    requires:            
      - build      
- buck_sample_codelab_build:          
    requires:            
      - build      
- gradle_sample_kotlin_build:          
    requires:            
      - build      
- buck_litho_it_tests_run:          
    requires:            
      - build      
- buck_litho_it_powermock_tests_run:          
    requires:            
      - build      
- gradle_tests_run:          
    requires:            
      - build
</code></pre>

<h2>将平版印刷转变为使用工作流程</h2>
<p>第一步是创建一个检查回购代码的工作，并开始设置所需的依赖项，包括:Buck，将帮助我们构建Buck的依赖项，如Ant和Android NDK。这项工作被定义为Litho<code>build_and_test</code>工作流程的第一步。</p>

<p>依赖于该作业的是<code>build</code>作业，它负责构建Litho并保存任何Gradle产生的缓存。</p>

<p>之后，build将分发给其他七个负责构建样本和执行测试的任务。这些作业中的每一个还被配置为存储测试结果并上传任何产生的工件。</p>

<p><img src="../Images/cc6d8432a50d234682942edd5f197705.png" alt="litho3.png" srcset="https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/litho3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/litho3.png"/> <br/> <i>扇出</i></p>

<p>这个工作流由一个<code>publish_snapshot</code>作业完成，这个作业依赖于每一个执行测试的作业。在它们成功执行后，Gradle任务负责将包含最新更改的档案作为快照上传到Bintray上。</p>

<pre><code>- publish_snapshot:          
    requires:            
      - buck_litho_it_tests_run            
      - buck_litho_it_powermock_tests_run            
      - gradle_tests_run
</code></pre>

<h2>缓存和工作空间</h2>
<p>CircleCI的配置DSL，其中包括<code>cache</code> &amp; <code>workspace</code>。为了更好地解释这些术语，让我将它们定义如下:</p>

<ul>
  <li><code>cache</code>是将在工作流执行之间保留的已保存内容。</li>
</ul>

<p><img src="../Images/e28dbd0d2e0fa143688c7f1813bd9c21.png" alt="litho4_caching.png" srcset="https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/litho4_caching.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/litho4_caching.png"/> <i>缓存在CircleCI </i></p>

<pre><code>- &amp;save-repo-cache    
  paths:      
    - ~/.gradle/caches      
    - ~/.gradle/wrapper
</code></pre>

<ul>
  <li><code>workspace</code>是保存的内容，将在同一工作流程的作业执行中保留。</li>
</ul>

<p><img src="../Images/5e778f2a79ab1493e14c4f1ddfb11ece.png" alt="litho5_workspace.png" srcset="https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/litho5_workspace.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/litho5_workspace.png"/> <i>用工作区保存内容</i></p>

<pre><code>- persist_to_workspace:          
    root: workspace          
    paths:            
      - repo
</code></pre>

<p>例如，只要有适当的缓存破坏机制，任何梯度缓存的依赖项都是值得缓存的。然而，我们的回购代码是所有作业都需要的，因此值得将它保存到我们的工作区，以便每个作业都能够“附加”并访问该内容。</p>

<pre><code>attach_workspace: &amp;attach_workspace  
  attach_workspace:    
    at: ~/litho-working-dir/workspace
</code></pre>

<h2>作业配置</h2>
<p>作为工作流一部分的作业也可以为分支定义<code>filters</code>。这尤其有用，因为我们不想执行<code>publish_snapshot</code>作业，以防我们运行的提交不在<code>master</code>分支上，而是在PR上。这可能看起来是一个小变化，但它可以节省7-8分钟等待工作流执行完成的时间。</p>

<pre><code>filters:            
  branches:              
    only: master
</code></pre>

<h2>重组后的改进</h2>
<p>在大量的提交、工作流执行和与Pascal讨论可改进点之后，我们最终设法在大约15-20分钟内运行了一个工作流。以下是我们改进的几点:</p>

<ul>
  <li>我们通过使用CircleCI的Android映像并在启动时提取任何所需的依赖项，删除了自定义Docker映像。为我们提供了95%(甚至更多)的作业执行的1秒容器配置。</li>
  <li>我们用了CircleCI的Android Docker镜像Android SDK，而不是从头开始下载。</li>
  <li>我们让测试和构建工作并行运行，例如，在某个“示例”模块出现问题时，允许早期反馈。与Github的集成相结合，这真的提供了很多信息，因为如果负责对您的更改执行测试的工作失败了或没有失败，您可以立即得到通知，而不必等待整个工作流完成。</li>
  <li>我们从Buck测试执行中收集了以前未收集的测试结果。</li>
</ul>

<h2>结论</h2>
<p>这是一次有趣的经历，也是一次大开眼界的经历。我以前从未在这种程度上处理过CI工具，我完全可以说开发运维或CI配置肯定是一项困难的工作(尊重我们每天都要处理这些工作的同事)。</p>

<p>此外，感谢<a href="https://medium.com/@passy"> Pascal Hartig </a>对流程的帮助以及对改进点的讨论。</p>

<p>你可以在这里找到重构config.yml的commit:<a href="https://github.com/facebook/litho/commit/2c411830d11d08fc2af194d8ea244d0cbdf33f76">https://github . com/Facebook/litho/commit/2c 411830d 11d 08 fc 2 af 194 D8 ea 244d 0 cbdf 33 f 76</a></p>

<p>而Litho的最终config.yml在这里:<a href="https://github.com/facebook/litho/blob/master/.circleci/config.yml">https://github.com/facebook/litho/blob/master/.circleci/config.yml </a></p>


        
          
          
        
      </div>
    </div>    
</body>
</html>