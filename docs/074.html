<html>
<head>
<title>AWS EC2 - AWS ECR | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>AWS EC2 - AWS ECR | CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/aws-ecr-auth-support/#2017-09-11T05:00:00-07:00">https://circleci.com/blog/aws-ecr-auth-support/#2017-09-11T05:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        
          <p class="italic"><strong>来自出版商的说明:</strong>您已经找到了我们的一些旧内容，这些内容可能已经过时和/或不正确。尝试在<a href="https://circleci.com/docs/" target="_blank">我们的文档</a>或<a href="https://circleci.com/blog/">博客</a>中搜索最新信息。</p>
          <hr/>
        

        <p><em>TL:DR；</em> <strong> CircleCI 2.0现在支持直接从Docker executor向AWS EC2容器注册中心(ECR)认证。这意味着您可以使用ECR中的私有Docker映像作为您的构建映像。<a href="https://circleci.com/docs/configuration-reference/#docker--machine-executor">查看文件</a>。</strong></p>



<p>CircleCI 2.0带来了原生Docker支持。一个项目可以构建在2.0之上，使用一个公共Docker映像作为执行环境。精心制作一个轻量级的CI环境，根据您的项目的确切需求进行定制，并且可以对其进行快照以便反复使用，这已经变得很平常了。用户喜欢拥有这种能力，但表示他们也希望支持私有图像。不久之后，<code>auth</code>键被引入来支持登录到Docker注册表，以获取私有映像作为您的执行环境:</p>

<pre><code>jobs:
  build:
    docker:
      - image: acme-private/private-image:321
        auth:
          username: mydockerhub-user  # can specify string literal values
          password: $DOCKERHUB_PASSWORD  # or project UI environment variable reference
</code></pre>

<p>这对于支持标准<code>docker login</code>凭证的注册管理机构(即Docker Hub)来说非常有效。如果您有Docker注册中心的用户名和密码，并且这是您所需要的，那么您就很好。输入AWS的ECR。</p>

<p><a href="https://circleci.com/docs/1.0/continuous-deployment-with-aws-ec2-container-service/"> AWS ECR </a>提供Docker注册服务，但不提供适当的<code>docker login</code>凭证。相反，根据<a href="http://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_AWSCLI.html"> AWS CLI文档</a>，您需要运行<code>aws ecr get-login</code>，这将生成一个带有临时登录凭证的<code>docker login</code> shell命令。这些凭据仅持续12小时，因此不适合在CI环境中使用。</p>

<p>我们现在增加了专门针对AWS ECR的内置支持。您可以通过以下三种方式之一从ECR开始使用私有映像:</p>

<ol>
  <li>使用<a href="https://circleci.com/docs/deployment-integrations/#aws-deployment"> CircleCI AWS集成</a>设置您的AWS凭证。</li>
  <li>使用标准的<a href="https://circleci.com/docs/env-vars/#adding-environment-variables-in-the-app"> CircleCI私有环境变量</a>设置您的AWS凭证。</li>
  <li>使用<code>aws_auth</code>在<code>.circleci/config.yml</code>中指定您的AWS凭证:</li>
</ol>

<pre><code>version: 2
jobs:
  build:
    docker:
      - image: account-id.dkr.ecr.us-east-1.amazonaws.com/org/repo:0.1
        aws_auth:
          aws_access_key_id: AKIAQWERVA  # can specify string literal values
          aws_secret_access_key: $ECR_AWS_SECRET_ACCESS_KEY  # or project UI envar reference
</code></pre>

<p>选项2和3实际上是相同的，只是选项3允许您为凭证指定任何想要的变量名。当您对不同的基础设施有不同的AWS凭证时，这就很方便了。例如，假设您的SaaS应用运行速度更快的测试，并在每次提交时部署到暂存基础架构，而对于Git标签推送，我们在部署到生产之前运行全面的测试套件:</p>

<pre><code>version: 2
jobs:
  build:
    docker:
      - image: account-id.dkr.ecr.us-east-1.amazonaws.com/org/repo:0.1
        aws_auth:
          aws_access_key_id: $AWS_ACCESS_KEY_ID_STAGING
          aws_secret_access_key: $AWS_SECRET_ACCESS_KEY_STAGING
    steps:
      - run:
          name: "Every Day Tests"
          command: "testing...."
      - run:
          name: "Deploy to Staging Infrastructure"
          command: "something something darkside.... cli"
  deploy:
    docker:
      - image: account-id.dkr.ecr.us-east-1.amazonaws.com/org/repo:0.1
        aws_auth:
          aws_access_key_id: $AWS_ACCESS_KEY_ID_STAGING
          aws_secret_access_key: $AWS_SECRET_ACCESS_KEY_STAGING
    steps:
      - run:
          name: "Full Test Suite"
          command: "testing...."
      - run:
          name: "Deploy to Production Infrastructure"
          command: "something something darkside.... cli"

workflows:
  version: 2
  main:
    jobs:
      - build:
          filters:
            tags:
              only: /^\d{4}\.\d+$/
      - deploy:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d{4}\.\d+$/
</code></pre>

<p>在CircleCI 2.0上享受使用来自<a href="https://circleci.com/docs/1.0/continuous-deployment-with-aws-ec2-container-service/"> AWS ECR </a>的私人图像。始终注意验证您没有从映像或私有envars的构建输出中泄漏任何敏感信息。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>