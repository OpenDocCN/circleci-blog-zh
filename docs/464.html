<html>
<head>
<title>Optimizing React Native Camera's Build | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>优化React原生相机的构建| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/optimizing-react-native-camera/#2019-12-03T10:00:00-08:00">https://circleci.com/blog/optimizing-react-native-camera/#2019-12-03T10:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>上个月，<a href="https://github.com/react-native-community/react-native-camera/pull/2550" target="_blank" rel="noreferrer noopener">我的一个拉取请求</a>被合并到流行的社区项目<a href="https://github.com/react-native-community/react-native-camera" target="_blank" rel="noreferrer noopener"> React Native Camera </a>中，以回应<a href="https://twitter.com/sseraphini/status/1184824377206067200" target="_blank" rel="noreferrer noopener">一个维护者的推文</a>。React Native Camera的构建被阻止，因为他们试图使用自由/OSS计划中不可用的资源类。除了解除阻塞，我还做了一些额外的优化。</p>

<p>我在这篇PR中使用的策略可以被推广并用于优化许多其他项目。在这篇文章中，我将分解我对React原生相机项目所做的一些更改，解释它们如何提高性能，并建议您可以使用类似的技术来改进自己的项目。</p>

<h2>缓存步骤放置</h2>

<p>一般来说，人们习惯于将他们的<code>save_cache</code>语句放在构建的末尾。React Native Camera也是这样做的，就像这样:</p>

<pre><code class="language-yaml">jobs:
  build-app:
    # ...environment setup here
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - v1-npm
      - run:
          name: Install Dependencies
          command: yarn install --ignore-engines
      # ...other steps, etc.
      - save_cache:
          key: v1-npm
          paths:
            - node_modules/
      - save_cache:
          key: v1-npm-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - node_modules/
      # ...rest of config
</code></pre>

<p>这不是最佳选择，因为如果作业中的任何其他步骤在<code>save_cache</code>步骤有机会执行之前失败，将不会保存缓存。最好将<code>save_cache</code>步骤放在依赖步骤之后——这保证了只要依赖步骤工作，缓存就会被保存:</p>

<pre><code class="language-yaml">jobs:
  build-app:
    # ...environment setup
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - v1-npm
      - run:
          name: Install Dependencies
          command: yarn install --ignore-engines
      #### MOVED
      - save_cache:
          key: v1-npm
          paths:
            - node_modules/
      - save_cache:
          key: v1-npm-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - node_modules/
      #### /MOVED
      # ...rest of config
</code></pre>

<p>您可以找到更多关于缓存的信息，并在我们的文档中查看示例<a href="https://circleci.com/docs/caching/" target="_blank" rel="noreferrer noopener">。</a></p>

<h2>为Gradle添加缓存</h2>

<p>我做的另一个改变是为Gradle依赖项添加缓存。他们在CircleCI中的<code>Run Checks</code>和<code>Build Sample App</code>步骤是Gradle包装器执行，它们占用了大部分构建时间。在下面的配置中，我存储了Gradle缓存和包装器。</p>

<pre><code class="language-yaml">jobs:
  build-app:
    # ...environment setup
    steps:
      # ...previous build steps
      #### ADDED
      - restore_cache:
          keys: 
            - v1-gradle-{{ checksum "android/gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "examples/basic/android/gradle/wrapper/gradle-wrapper.properties" }}
            - v1-gradle-wrapper
      - restore_cache:
          keys:
            - v1-gradle-cache-{{ checksum "android/build.gradle" }}-{{ checksum "examples/basic/android/build.gradle" }}
            - v1-gradle-cache
      #### /ADDED
      - run:
          name: Run Checks
          command: |
            cd android
            chmod +x ./gradlew &amp;&amp; ./gradlew check
      # ...other step(s)
      - run:
          name: Run Yarn to Generate react.gradle
          command: cd examples/basic/android &amp;&amp; yarn
      - run:
          name: Build Sample App
          command: |
            cd examples/basic/android &amp;&amp; chmod +x ./gradlew &amp;&amp; ./gradlew build
      #### ADDED
      - save_cache:
          key: v1-gradle-wrapper-{{ checksum "examples/basic/android/gradle/wrapper/gradle-wrapper.properties" }}
          paths:
            - ~/.gradle/wrapper
      - save_cache:
          key: v1-gradle-cache-{{ checksum "examples/basic/android/build.gradle" }}
          paths:
            - ~/.gradle/caches
      #### /ADDED
      # ...rest of config
</code></pre>

<h2>从报表制作工件</h2>

<p>您知道我们的工件就像一个静态文件服务器吗？这对于存储测试套件的HTML报告和像访问网页一样访问它们是很有用的。我添加了一个工件步骤来存储林挺命令生成的输出。这允许你在<a href="https://app.circleci.com/pipelines/github/react-native-community/react-native-camera/jobs/1143" target="_blank" rel="noreferrer noopener">工件标签</a>上浏览工件，并像访问网页一样访问那些文件<a href="https://1143-33218414-gh.circle-artifacts.com/0/app/lint-results.html" target="_blank" rel="noreferrer noopener"/>。</p>

<pre><code class="language-yaml">jobs:
  build-app:
    # ...environment setup
    steps:
      # ...previous build steps
      - run:
          name: Run Checks
          command: |
            cd android
            chmod +x ./gradlew &amp;&amp; ./gradlew check
      #### ADDED
      - store_artifacts:
          path: android/build/reports
      #### /ADDED
      # ...other step(s)
      - run:
          name: Build Sample App
          command: |
            cd examples/basic/android &amp;&amp; chmod +x ./gradlew &amp;&amp; ./gradlew build
      #### ADDED
      - store_artifacts:
          path: examples/basic/android/app/build/reports
          destination: app
      #### /ADDED
      # ...rest of config
</code></pre>

<p>你可以在我们的文档中找到更多关于创建工件<a href="https://circleci.com/docs/artifacts/" target="_blank" rel="noreferrer noopener">的信息。</a></p>

<h2>结论</h2>

<p>在这个pull请求中所做的小改动只是您可以用来优化CircleCI构建的一些特性的例子。<a href="https://circleci.com/docs/" target="_blank" rel="noreferrer noopener">我们平台</a>的文档内容丰富，包含各种示例和教程。T2的CircleCI博客也是一个很好的资源。如果你被困住了，试着发微博给我们<a href="https://twitter.com/CircleCI" target="_blank" rel="noreferrer noopener"> @CircleCI </a>！</p>

<p>要了解更多优化特性和技术，请阅读我们在CircleCI 上发布的<a href="https://circleci.com/blog/optimizing-open-source-projects-on-circleci/" target="_blank" rel="noreferrer noopener">优化开源项目。</a></p>

<p>感谢阅读，并快乐建设！</p>



        
          
          
        
      </div>
    </div>    
</body>
</html>