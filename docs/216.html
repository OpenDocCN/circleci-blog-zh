<html>
<head>
<title>Create automated build, test, and deploy workflows for orbs | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>为orbs | CircleCI创建自动化的构建、测试和部署工作流</h1>
<blockquote>原文：<a href="https://circleci.com/blog/creating-automated-build-test-and-deploy-workflows-for-orbs/#2019-02-26T08:15:00-08:00">https://circleci.com/blog/creating-automated-build-test-and-deploy-workflows-for-orbs/#2019-02-26T08:15:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>距离CircleCI orbs 的<a href="https://circleci.com/blog/announcing-orbs-technology-partner-program/" target="_blank" rel="noreferrer noopener">发布已经过去了15周，在</a><a href="https://circleci.com/developer/orbs" target="_blank" rel="noreferrer noopener">orbs Registry</a>中有超过405个orbs。也就是说每周有25个以上的新球体！</p>

<p>令人惊讶的是，这些球体中的大部分都是由您，我们令人惊叹的用户社区，或者是由我们新的<a href="https://circleci.com/partners/technology/" target="_blank" rel="noreferrer noopener">技术合作伙伴计划</a>中的人们贡献的。然而，CircleCI已经发布了近30个orb，作为CircleCI的第一个社区&amp;合作伙伴工程师，我在过去的几个月里一直致力于为这些orb开发一个可持续发展的管道——这个管道将允许在尽可能少的人工干预下进行构建、测试和部署。</p>



<p>这是一个不小的壮举，因为每个球都是不同的。有些安装和配置第三方工具和服务。有些允许您部署到各种云提供商，或者在外部环境中测试您的代码。而且，有些只是现有CircleCI配置特性的语法糖，让人们更容易使用我们的平台。</p>

<p>我们可以使用哪种<a href="https://circleci.com/continuous-integration/" target="_blank" rel="noreferrer noopener">持续集成</a>和持续部署工具来支持所有这些不同类型的orb的开发？更重要的是，如何在自己的orb开发中利用这个工具呢？在一天结束的时候，没有人希望每次有人将一个拉请求合并到一个orb存储库时，坐在他们的计算机前输入<code>git pull</code>和<code>circleci orb publish</code>。</p>

<p>如果你正在读这篇文章，我会假设你已经知道一些关于球体的知识。也许你已经出版了一本，或者你已经开始在你的CircleCI项目中使用它们。如果没有，我鼓励你看看我们以前的一些orbs博客帖子！支持工程师Kyle Tryon为编写你的第一个球体提供了一些奇妙的<a href="https://circleci.com/blog/tips-for-writing-your-first-orb/" target="_blank" rel="noreferrer noopener">技巧；他还发表了</a><a href="https://circleci.com/blog/how-to-make-an-easy-and-valuable-open-source-contribution-with-circleci-orbs/" target="_blank" rel="noreferrer noopener">一篇关于他创造</a><a href="https://circleci.com/developer/orbs/orb/circleci/slack" target="_blank" rel="noreferrer noopener"> CircleCI的Slack orb </a> ( <a href="https://github.com/circleci-public/slack-orb" target="_blank" rel="noreferrer noopener"> GitHub link </a>)的经历的概述，这是迄今为止我们最受欢迎的orb。对于那些寻找更基础的入门者来说，<a href="https://circleci.com/docs/creating-orbs/" target="_blank" rel="noreferrer noopener">创建球体</a>和<a href="https://circleci.com/docs/reusing-config/" target="_blank" rel="noreferrer noopener">重用配置</a>文档非常有帮助。</p>

<p>在这篇文章中，我将讨论为一个新的orb设置理想的自动化CI/CD过程。在我的下一篇文章中，我将全面介绍Azure CLI orb和我们内置的自动化。</p>

<p>现在，让我们进入新orb的自动化流程。这样一个过程可能有什么样的目标？</p>

<h2>版本控制</h2>

<p>CircleCI位于DevOps生态系统的中心，是“基础设施即代码”概念的核心信奉者。orb是基础设施，表示为代码，因此它们应该像任何其他软件一样被构建、测试和部署。为此，您的orb需要驻留在git存储库中。</p>

<p>有些球体非常小。你的球可能只会做一件简单的事情。其他的要大得多(查看我们的<a href="https://circleci.com/developer/orbs/orb/circleci/aws-ecs" target="_blank" rel="noreferrer noopener"> AWS ECS orb </a>)。对于较小的orb，尤其是那些不太依赖外部服务的orb，某种orbs monorepo可能是合适的；实际上有很多东西可以测试，即使是在有多个orb的存储库中。你可以在我们的<a href="https://github.com/CircleCI-Public/circleci-orbs" target="_blank" rel="noreferrer noopener"> circleci-orbs知识库</a>中看到这种方法的例子，这里是一些circleci发布的第一批orbs的所在地。</p>

<p>随着时间的推移，我们很快发现，对于许多更复杂的orb，例如那些专注于第三方部署的orb，需要更多的粒度。在这些情况下，1:1-orb:repository关系是理想的。请记住，我们所有的CI/CD逻辑都必须存在于我们的<code>config.yml</code>文件中，并且试图在一个配置文件中管理多个大型orb的集成测试和自动化发布将很快变得难以承受。</p>

<h2>多级测试</h2>

<p>正如您会在开发管道的多个点上以多种方式测试一个网站或应用程序一样，我们也应该对orb做同样的事情。在orbs生态系统中，这些不同级别的测试是什么？</p>

<p>套用最初的orbs SDK预览版:</p>
<ol>
  <li><strong>模式验证</strong>:这可以用一个CLI命令来完成，它检查orb是否是用格式良好的YAML编写的，是否符合orb模式。</li>
  <li>运行时测试:这需要建立单独的测试，并在CircleCI构建中运行它们。</li>
  <li><strong>集成测试</strong>:这可能是相当高级的orb或专门设计为第三方服务的公共、稳定接口的orb所需的唯一测试。进行orb集成测试需要定制构建和您自己的外部测试环境。</li>
</ol>

<p>还有扩展测试的概念:由于orb本质上是CircleCI配置的抽象片段，我们可以测试给定的orb是否生成了我们期望的CircleCI配置语法。在实践中，我发现成本效益比有点低，因为不仅需要维护orb源代码本身，还需要维护其相应的所需扩展配置语法，然后手动保持两者同步，以便扩展测试保持准确。不过，对某些球体来说，这可能是有帮助的。CircleCI的解决方案总监Eddie Webb发布了一篇关于这种方法的精彩的<a href="https://discuss.circleci.com/t/testing-orbs/26500/2" target="_blank" rel="noreferrer noopener">解释</a> ( <a href="https://github.com/eddiewebb/circleci-dmz-orb" target="_blank" rel="noreferrer noopener">并附有示例！</a>)在<a href="https://discuss.circleci.com/" target="_blank" rel="noreferrer noopener"> CircleCI讨论</a>上的一个测球讨论中。</p>

<h2>自动化部署</h2>

<p>对我来说，这是自动化orb开发过程的最终目标。没有这种自动化，我不可能维持CircleCI不断增长的球体舰队！</p>

<p>作为一个新的orb作者，一开始简单地手动发布可能很有诱惑力。毕竟，我们只是在讨论一些简单的shell命令。让我警告你不要屈服于这种诱惑。在内部，我们已经回答了orb作者的多个问题，他们想知道为什么在将一个pull请求合并到他们的orb存储库后，他们在注册表中看不到他们更新的orb，只是意识到他们从未真正自动化他们的orb测试和发布过程的部署部分。<strong>相信我，因为根据我的经验，从一开始就实现自动化比回头再添加要顺利得多。</strong></p>

<p>自动化orb部署有一些细微差别。CircleCI CLI提供了三种不同的发布生产orb的方式:</p>

<ol>
  <li>您可以通过<code>circleci orb publish</code><a href="https://circleci-public.github.io/circleci-cli/circleci_orb_publish.html" target="_blank" rel="noreferrer noopener"><em>将</em> </a>的<code>orb.yml</code>文件直接发布到注册表中</li>
  <li>您可以<a href="https://circleci-public.github.io/circleci-cli/circleci_orb_publish_promote.html" target="_blank" rel="noreferrer noopener"> <em>通过<code>circleci orb publish promote</code>将</em> </a>一个先前发布的<code>dev</code>版本的orb提升为一个语义版本化的生产orb</li>
  <li>你可以<a href="https://circleci-public.github.io/circleci-cli/circleci_orb_publish_increment.html" target="_blank" rel="noreferrer noopener"> <em>增加</em> </a>一个现有的生产orb版本，例如，从<code>foo/bar@1.1.0</code>到<code>foo/bar@1.1.1</code>(补丁发布)，或者<code>1.2.0</code>(小版本)，或者<code>2.0.0</code>(大版本)</li>
</ol>

<p>在实践中，我发现<i>将</i><code>dev</code>orb升级为生产orb是最有用的自动化部署机制。它允许您在每次提交时对orb源代码进行基本的测试/验证，然后有条件地发布orb的<code>dev</code>版本，然后在<code>dev</code> orb上运行更广泛的测试，最后，有条件地将您刚刚发布的<code>dev</code> orb升级到生产版本。</p>

<h2>把所有的放在一起</h2>

<p>那么，对于以这种方式构建、测试和部署的orb来说,<code>config.yml</code>看起来像什么呢？首先，没那么复杂！我们已经将自动化orb开发的大部分基本机制抽象成了一个orb 。要查看功能示例，请查看我们上个月发布的<a href="https://circleci.com/developer/orbs/orb/circleci/azure-cli" target="_blank" rel="noreferrer noopener"> Azure CLI orb </a>，因为它足够小和简单，容易理解，但也有点复杂，因为它确实与第三方云提供商Microsoft Azure集成。这个orb的<a href="https://github.com/CircleCI-Public/azure-cli-orb/blob/master/.circleci/config.yml" target="_blank" rel="noreferrer noopener"> <code>config.yml</code> </a>包含两个不同的工作流:一个用于基本验证和<code>dev</code>发布，另一个用于集成/使用测试和可能的orb生产部署。在<a href="https://circleci.com/blog/creating-automated-build-test-and-deploy-workflows-for-orbs-part-2/">的后续文章</a>中，我将对Azure CLI orb和这两个工作流做一个全面的介绍。</p>

<p>Orbs是CircleCI不断增长的开源生态系统的核心，因此，当<i>你</i>参与进来时，它们会更好。用我们的<code>circleci-orbs</code> <a href="https://github.com/search?q=topic%3Acircleci-orbs&amp;type=Repositories" target="_blank" rel="noreferrer noopener">话题标签</a>在GitHub或Bitbucket上标记你的宝珠，这样其他人可以更容易地发现它们，并且请在CircleCI讨论的<a href="https://discuss.circleci.com/c/orbs" target="_blank" rel="noreferrer noopener">宝珠部分发表任何问题或评论。</a></p>

<hr/>
<p>阅读更多信息:</p>




        
          
          
        
      </div>
    </div>    
</body>
</html>