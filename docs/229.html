<html>
<head>
<title>Deploy autoscaling self-hosted runners using AWS CDK | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用AWS CDK | CircleCI部署自动缩放自托管跑步者</h1>
<blockquote>原文：<a href="https://circleci.com/blog/deploy-autoscaling-self-hosted-runners-using-aws-cdk/#2023-02-15T23:00:00-08:00">https://circleci.com/blog/deploy-autoscaling-self-hosted-runners-using-aws-cdk/#2023-02-15T23:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <blockquote>
  <p>本教程涵盖:</p>
  <ol>
    <li>定义AWS CDK应用程序和AWS Lambda处理器</li>
    <li>创建自宿主运行程序资源类</li>
    <li>部署应用程序，然后自动化部署</li>
  </ol>
</blockquote>

<p>您可以使用CircleCI的云资源来运行您的CI/CD作业，但有时您可能希望在您的基础架构上运行它们。如果您的团队强加了特权访问和控制要求，自托管基础架构可能最适合运行您的工作。CircleCI的<a href="https://circleci.com/docs/runner-overview">自主跑步者</a>让你做到这一点。很容易<a href="https://circleci.com/blog/install-runner-in-five-minutes/">开始</a>并开始使用自托管运行器。</p>

<p>如果您发现您的团队的资源需求每天都在波动，那么您可以考虑实现一个自动伸缩的解决方案来根据需求增加资源。</p>

<p>在本教程中，您将学习如何使用由AWS开发的基础设施代码(IaC)工具<a href="https://aws.amazon.com/cdk/" target="_blank" rel="noreferrer noopener"> AWS CDK </a>来设置自动缩放。如果你对使用AWS GUI控制台实现自动缩放的<a href="https://circleci.com/blog/autoscale-self-hosted-runners-aws/">感兴趣，有一个配套教程。</a></p>

<h2>先决条件</h2>

<p>请参考此列表来设置本教程所需的一切。</p>



<h2>创建新的AWS CDK项目</h2>

<p>为您的CDK项目创建一个新目录，并导航到其中。</p>

<pre><code class="language-bash">mkdir circleci-self-hosted-runner-autoscaling
cd circleci-self-hosted-runner-autoscaling
</code></pre>

<p>使用CDK CLI运行<code>cdk init</code>命令，该命令使用Typescript创建一个新的CDK项目。<code>app</code>参数指定您将用于初始化项目的模板。</p>

<pre><code class="language-bash">cdk init app --language typescript
</code></pre>

<p>这个命令用几个文件创建一个新的CDK项目。</p>

<p>确保<code>aws-cdk-lib &gt;= 2.32.0</code>在<code>package.json</code>中定义。如果现有版本较低，请手动更新CDK库版本。</p>

<h2>为自动缩放添加Lambda函数</h2>

<p>在本节中，您将定义一个AWS Lambda函数来根据当前需求设置所需的运行实例数量。</p>

<p>在CDK项目的根目录下创建一个<code>lambda/auto-scaling-lambda</code>目录。在<code>lambda/auto-scaling-lambda</code>目录中，添加一个用于定义依赖关系的<code>package.json</code>文件。</p>

<p>在<code>package.json</code>文件中，定义项目的名称并添加您的处理程序将使用的<code>node-fetch</code>依赖项。</p>

<pre><code class="language-json">{
  "name": "auto-scaling-lambda",
  "version": "0.1.0",
  "dependencies": {
    "node-fetch": "^2.6.7"
  }
}
</code></pre>

<p>一旦添加了依赖项，运行<code>lambda/auto-scaling-lambda</code>目录中的<code>npm install</code>命令来安装软件包。</p>

<p>接下来，在<code>lambda/auto-scaling-lambda</code>目录中添加一个<code>index.js</code>文件来定义Lambda处理程序。该函数将调用<a href="https://circleci.com/docs/runner-api#get-api-v2-tasks"> CircleCI runner tasks API </a>来获取挂起作业的数量。根据响应，它将更新AWS自动缩放组中的实例计数。</p>

<p>将此代码添加到<code>index.js</code>文件中:</p>

<pre><code class="language-js">const AWS = require("aws-sdk");
const fetch = require("node-fetch");
AWS.config.update({ region: "us-west-2" });
const { env } = require("process");

const SECRET_NAME = env.SECRET_NAME;
const SECRET_REGION = env.SECRET_REGION;
const AUTO_SCALING_MAX = env.AUTO_SCALING_MAX;
const AUTO_SCALING_GROUP_NAME = env.AUTO_SCALING_GROUP_NAME;
const AUTO_SCALING_GROUP_REGION = env.AUTO_SCALING_GROUP_REGION;

exports.handler = async (event, context) =&gt; {
  return await getTasks().then(async (data) =&gt; {
    let numInstances = 0;
    if (data["unclaimed_task_count"] &lt; AUTO_SCALING_MAX) {
      numInstances = data["unclaimed_task_count"];
    } else {
      numInstances = AUTO_SCALING_MAX;
    }

    await updateNumInstances(numInstances);
    return numInstances;
  });
};

async function updateNumInstances(numInstances) {
  const autoScaling = new AWS.AutoScaling({ region: AUTO_SCALING_GROUP_REGION });
  const params = {
    AutoScalingGroupName: AUTO_SCALING_GROUP_NAME,
    MinSize: 0,
    MaxSize: AUTO_SCALING_MAX,
    DesiredCapacity: numInstances,
  };
  await autoScaling.updateAutoScalingGroup(params).promise();
}

async function getTasks() {
  const secret = await getSecret();
  const url = `https://runner.circleci.com/api/v2/tasks?resource-class=${secret["resource_class"]}`;
  const headers = {
    "Circle-Token": secret["circle_token"],
  };

  const response = await fetch(url, {
    headers: headers,
  });
  const data = await response.json();
  return data;
}

async function getSecret() {
  const params = {
    SecretId: SECRET_NAME,
  };
  const data = await new AWS.SecretsManager({ region: SECRET_REGION })
    .getSecretValue(params)
    .promise();
  if ("SecretString" in data) {
    let secret = JSON.parse(data.SecretString);
    return secret;
  } else {
    let buff = new Buffer(data.SecretBinary, "base64");
    let decodedBinarySecret = buff.toString("ascii");
    return JSON.parse(decodedBinarySecret);
  }
}
</code></pre>

<p>请注意:</p>
<ul>
  <li>Lambda函数使用<a href="https://aws.amazon.com/secrets-manager/"> AWS Secrets Manager </a>来检索认证任务API所需的CircleCI令牌。它接收机密名称作为环境变量。</li>
  <li>该函数还接收AWS EC2自动缩放组名称作为环境变量。它使用NodeJS的AWS SDK调用自动缩放服务API来更新实例计数。</li>
</ul>

<h2>定义AWS EC2启动脚本</h2>

<p>一旦启动，您需要在AWS EC2实例上配置并运行CircleCI自托管runner服务。定义一个shell脚本，该脚本安装所需的软件包，创建CircleCI runner服务，并启动该服务以使其可被发现。在<code>scripts/install_runner.sh</code>处创建一个文件，并添加以下代码片段:</p>

<pre><code class="language-bash">#!/bin/bash

#-------------------------------------------------------------------------------
# CircleCI Runner installation script
# Based on the documentation at https://circleci.com/docs/2.0/runner-installation/
#-------------------------------------------------------------------------------

# Prerequisites:
# Complete these:
# https://circleci.com/docs/2.0/runner-installation/#authentication
# This script must be run as root
# This script was tested on Ubuntu 22.04

platform="linux/amd64"                                  # Runner platform: linux/amd64 || linux/arm64 || platform=darwin/amd64
prefix="/opt/circleci"                                  # Runner install directory

CONFIG_PATH="/opt/circleci/launch-agent-config.yaml"    # Determines where Runner config will be stored
SERVICE_PATH="/opt/circleci/circleci.service"           # Determines where the Runner service definition will be stored
TIMESTAMP=$(date +"%g%m%d-%H%M%S-%3N")                  # Used to avoid Runner naming collisions

AUTH_TOKEN="&lt;SELF_HOSTED_RUNNER_AUTH_TOKEN&gt;"  # Auth token for CircleCI
RUNNER_NAME="&lt;SELF_HOSTED_RUNNER_NAME&gt;"           # A runner name - this is not the same as the Resource class - keep it short, and only with letters/numbers/dashes/underscores
UNIQUE_RUNNER_NAME="$RUNNER_NAME-$TIMESTAMP"            # Runners must have a unique name, so we'll append a timestamp
USERNAME="circleci"                                     # The user which the runner will execute as

#-------------------------------------------------------------------------------
# Update; install dependencies
#-------------------------------------------------------------------------------

apt update
apt install coreutils curl tar gzip -y

#-------------------------------------------------------------------------------
# Download, install, and verify the binary
#-------------------------------------------------------------------------------

sudo mkdir -p "$prefix/workdir"
base_url="https://circleci-binary-releases.s3.amazonaws.com/circleci-launch-agent"
echo "Determining latest version of CircleCI Launch Agent"
agent_version=$(curl "$base_url/release.txt")
echo "Using CircleCI Launch Agent version $agent_version"
echo "Downloading and verifying CircleCI Launch Agent Binary"
curl -sSL "$base_url/$agent_version/checksums.txt" -o checksums.txt
file="$(grep -F "$platform" checksums.txt | cut -d ' ' -f 2 | sed 's/^.//')"
sudo mkdir -p "$platform"
echo "Downloading CircleCI Launch Agent: $file"
curl --compressed -L "$base_url/$agent_version/$file" -o "$file"
echo "Verifying CircleCI Launch Agent download"
grep "$file" checksums.txt | sha256sum --check &amp;&amp; chmod +x "$file"; sudo cp "$file" "$prefix/circleci-launch-agent" || echo "Invalid checksum for CircleCI Launch Agent, please try download again"

#-------------------------------------------------------------------------------
# Install the CircleCI runner configuration
# CircleCI Runner will be executing as the configured $USERNAME
# Note the short idle timeout - this script is designed for auto-scaling scenarios - if a runner is unclaimed, it will quit and the system will shut down as defined in the below service definition
#-------------------------------------------------------------------------------

sudo bash -c 'cat &gt; /opt/circleci/launch-agent-config.yaml' &lt;&lt; EOF
api:
  auth_token: $AUTH_TOKEN
runner:
  name: $UNIQUE_RUNNER_NAME
  command_prefix: ["sudo", "-niHu", "$USERNAME", "--"]
  working_directory: /opt/circleci/workdir/%s
  cleanup_working_directory: true
  idle_timeout: 5m
  max_run_time: 5h
  mode: single-task
EOF

# Set correct config file permissions and ownership
chown root: /opt/circleci/launch-agent-config.yaml
chmod 600 /opt/circleci/launch-agent-config.yaml

#-------------------------------------------------------------------------------
# Create the circleci user &amp; give permissions to working directory
# This user should NOT already exist
#-------------------------------------------------------------------------------

adduser --disabled-password --gecos GECOS "$USERNAME"
chown -R "$USERNAME" "$prefix/workdir"

#-------------------------------------------------------------------------------
# Create the service
# The service will shut down the instance when it exits - that is, the runner has completed with a success or error
#-------------------------------------------------------------------------------

sudo bash -c 'cat &gt; /opt/circleci/circleci.service' &lt;&lt; EOF
[Unit]
Description=CircleCI Runner
After=network.target
[Service]
ExecStart=$prefix/circleci-launch-agent --config $CONFIG_PATH
ExecStopPost=shutdown now -h
Restart=no
User=root
NotifyAccess=exec
TimeoutStopSec=18300
[Install]
WantedBy = multi-user.target
EOF

#-------------------------------------------------------------------------------
# Configure your runner environment
# This script must be able to run unattended - without user input
#-------------------------------------------------------------------------------
sudo apt install -y nodejs npm

#-------------------------------------------------------------------------------
# Enable CircleCI Runner service and start it
# This MUST be done last, as it will immediately advertise to the CircleCI server that the runner is ready to use
#-------------------------------------------------------------------------------
sudo systemctl enable $prefix/circleci.service
sudo systemctl start circleci.service
</code></pre>

<p>请注意，该脚本包含作为虚拟值的<code>&lt;SELF_HOSTED_RUNNER_AUTH_TOKEN&gt;</code>和<code>&lt;SELF_HOSTED_RUNNER_NAME&gt;</code>，它们将被环境变量中的值替换。在下一节中，CDK堆栈中的AWS EC2自动缩放组将使用shell脚本。</p>

<h2>为应用程序定义CDK结构</h2>

<p>在本节中，您将为您的应用程序定义所有的CDK构造。AWS CDK构造是云组件，封装了配置细节并粘合了使用一个或多个AWS服务的逻辑。CDK为最常用的AWS服务提供了一个构造库。</p>

<p>当您使用<code>app</code>模板生成CDK项目时，会为您创建包含<code>CircleciSelfHostedRunnerAutoscalingStack</code>类的<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件。您将在该文件中定义CDK构造。</p>

<pre><code class="language-typescript">//  The snippet shows the original contents for reference. You do not need to replace the file contents.
import { Stack, StackProps } from "aws-cdk-lib";
import { Construct } from "constructs";

export class CircleciSelfHostedRunnerAutoscalingStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // we will add all the constructs here
  }
}
</code></pre>

<p>首先，将<code>StackProps</code>扩展到<code>CircleciSelfHostedRunnerAutoscalingStackProps</code>并定义一些额外的属性。您正在扩展<code>StackProps</code>，以便堆栈可以从CDK应用程序接收一些自定义参数。</p>

<pre><code class="language-typescript">import { Stack, StackProps } from "aws-cdk-lib";
import { Construct } from "constructs";

// extend StackProps
export interface CircleciSelfHostedRunnerAutoscalingStackProps extends StackProps {
  maxInstances: string;
  keypairName: string;
  runnerName: string;
}

export class CircleciSelfHostedRunnerAutoscalingStack extends Stack {
  // use CircleciSelfHostedRunnerAutoscalingStackProps instead of StackProps
  constructor(scope: Construct, id: string, props?: CircleciSelfHostedRunnerAutoscalingStackProps) {
    super(scope, id, props);
  }
}
</code></pre>

<p>接下来，列出所有需要在堆栈中定义的自动缩放结构:</p>
<ul>
  <li>一个<a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html" target="_blank" rel="noreferrer noopener"> VPC </a>，一个<a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" target="_blank" rel="noreferrer noopener">安全组</a>，以及一个<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" target="_blank" rel="noreferrer noopener"> AMI </a>用于您的AWS EC2实例。</li>
  <li>AWS EC2的自动缩放组，在启动时执行自定义用户脚本。</li>
  <li>使用AWS secret manager存储CircleCI令牌和资源类。</li>
  <li>AWS Lambda函数，每分钟运行一次，以更新所需的实例计数。</li>
</ul>

<h3>定义AWS EC2的结构</h3>

<p>在本节中，您将为创建AWS EC2自动缩放组时所需的内容定义AWS CDK结构。您需要为EC2实例定义一个VPC、一个安全组和一个AMI。</p>

<p>要定义一个VPC，在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>内添加一个CDK构造。</p>

<pre><code class="language-typescript">import { Stack,
    StackProps,
    //update the existing import to add aws_ec2
    aws_ec2 as ec2,
 } from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props?: CircleciSelfHostedRunnerAutoscalingStackProps) {
    super(scope, id, props);

    // we will add all the constructs here
    // provide a unique name for your S3 bucket
    const circleCIVpc = new ec2.Vpc(this, "CircleCISelfHostedRunnerVPC", {
        maxAzs: 1,
        subnetConfiguration: [{
        name: 'public-subnet-1',
        subnetType: ec2.SubnetType.PUBLIC,
        cidrMask: 24,
        }]
    });
}
</code></pre>

<p>要定义一个安全组，将这个代码片段添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中。</p>

<pre><code class="language-typescript">import { Stack,
    StackProps,
    //update the existing import to add aws_ec2
    aws_ec2 as ec2,
 } from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props?: CircleciSelfHostedRunnerAutoscalingStackProps) {
    super(scope, id, props);

    // add the security group below the existing constructs
    const circleCISecurityGroup = new ec2.SecurityGroup(this, 'CircleCISelfHostedRunnerSecurityGroup', {
        vpc: circleCIVpc,
    });

    circleCISecurityGroup.addIngressRule(
        ec2.Peer.anyIpv4(),
        ec2.Port.tcp(22),
        'allow SSH access from anywhere',
    );
}
</code></pre>

<p>要为EC2实例定义一个AMI，将这个代码片段添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中。一个文件是可用的<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy.html"> AWS SAM参数</a>用于获取所选AWS区域的Ubuntu实例的AMI ID。</p>

<pre><code class="language-typescript">import { Stack,
    StackProps,
    //update the existing import to add aws_ec2
    aws_ec2 as ec2,
 } from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props?: CircleciSelfHostedRunnerAutoscalingStackProps) {
    super(scope, id, props);

    // add the AMI below the existing constructs
    const amiSamParameterName = '/aws/service/canonical/ubuntu/server/focal/stable/current/amd64/hvm/ebs-gp2/ami-id'

    const ami = ec2.MachineImage.fromSsmParameter(
      amiSamParameterName, {
      os: ec2.OperatingSystemType.LINUX
    });
}
</code></pre>

<h3>定义自动缩放组</h3>

<p>接下来，定义一个AWS EC2自动缩放组来管理您的实例。将这段代码添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中。</p>

<pre><code class="language-typescript">import {
    StackProps,
    aws_ec2 as ec2,
    //update the existing import to add aws_autoscaling
    aws_autoscaling as autoscaling,
} from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    const instanceTypeName = "t3.micro"
    const instanceType = new ec2.InstanceType(instanceTypeName);

    const circleCiAutoScalingGroup = new autoscaling.AutoScalingGroup(this, 'CircleCiSelfHostedRunnerASG', {
        vpc: circleCIVpc,
        instanceType: instanceType,
        machineImage: ami,
        securityGroup: circleCISecurityGroup,
        keyName: props!!.keypairName,
        vpcSubnets: {
            subnetType: ec2.SubnetType.PUBLIC
        },
        minCapacity: 0,
        maxCapacity: Number(props!!.maxInstances),
    });
}
</code></pre>

<p>如果您想要SSH到EC2实例，您需要使用AWS控制台手动<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html" target="_blank" rel="noreferrer noopener">创建EC2密钥对</a>。否则，您可以在定义自动缩放构造时省略<code>keyName</code>属性。</p>

<p>自动缩放CDK构造允许您附加一个将在实例启动时执行的用户数据脚本。通过在堆栈文件中添加以下代码片段，将用户数据脚本附加到自动缩放组:</p>

<pre><code class="language-typescript">import { readFileSync } from 'fs';
const { env } = require("process");

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    let userDataScript = readFileSync('./scripts/install_runner.sh', 'utf8');

    userDataScript = userDataScript.replace('&lt;SELF_HOSTED_RUNNER_AUTH_TOKEN&gt;', env.SELF_HOSTED_RUNNER_AUTH_TOKEN);
    userDataScript = userDataScript.replace('&lt;SELF_HOSTED_RUNNER_NAME&gt;', props!!.runnerName);

    circleCiAutoScalingGroup.addUserData(userDataScript);
}
</code></pre>

<p>请注意，用户数据脚本中的auth token占位符被替换为环境变量中的值，而runner name占位符被替换为stack属性值。</p>

<h3>使用AWS Secret Manager存储凭据</h3>

<p>CircleCI令牌和资源类名应该安全地存储。您将使用<a href="https://aws.amazon.com/secrets-manager/" target="_blank" rel="noreferrer noopener"> AWS Secret Manager </a>来存储凭证，而不是将它们存储为明文。将这个代码片段添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中，以创建一个新的秘密。</p>

<pre><code class="language-typescript">import {
    //update the existing import to add aws_secretsmanager
    aws_secretsmanager as secretsmanager,
    SecretValue,
  } from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    const circleCISecret = new secretsmanager.Secret(this, 'CircleCiSelfHostedRunnerSecret', {
        secretName: 'circleci-self-hosted-runner-secret',
        secretObjectValue: {
            "resource_class": SecretValue.unsafePlainText(env.SELF_HOSTED_RUNNER_RESOURCE_CLASS),
            "circle_token": SecretValue.unsafePlainText(env.CIRCLECI_TOKEN),
        }
    });
}
</code></pre>

<p>请注意，您正在从CircleCI环境变量中获取凭证。AWS Lambda函数将在调用CircleCI tasks API之前从secrets manager获取这些凭证。您还可以将凭证设置为AWS Lambda环境变量，但是任何有权访问AWS控制台的人都可以查看这些值。</p>

<h3>创建AWS Lambda函数</h3>

<p>首先，为AWS Lambda函数定义一个执行角色。执行角色应该有权限从秘密管理器获取凭证并更新自动缩放计数。将这段代码添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中。</p>

<pre><code class="language-ts">import {
    //update the existing import to add aws_iam
    aws_iam as iam,
} from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    const lambdaPolicyDocument = new iam.PolicyDocument({
        statements: [
            new iam.PolicyStatement({
                resources: [circleCiAutoScalingGroup.autoScalingGroupArn],
                actions: ["autoscaling:UpdateAutoScalingGroup"],
            }),
            new iam.PolicyStatement({
                resources: [circleCISecret.secretArn],
                actions: ["secretsmanager:GetSecretValue"],
            })
        ],
    });

    const inferenceLambdaRole = new iam.Role(this, `CircleCIAutoScalingLambdaRole`, {
        assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
        description: "Role assumed by auto scaling lambda",
        inlinePolicies: {
            lambdaPolicy: lambdaPolicyDocument,
        },
        managedPolicies: [
            iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AWSLambdaBasicExecutionRole")
        ]
    });
}
</code></pre>

<p>要定义一个AWS Lambda函数，添加一个CDK构造，在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>内创建一个AWS Lambda函数。</p>

<pre><code class="language-ts">import {
    //update the existing import to add aws_lambda and Duration
    aws_lambda as lambda,
    Duration,
} from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    const autoScalingLambda = new lambda.Function(this, 'CircleCiSelfHostedRunnerAutoScalingLambda', {
        functionName: 'CircleCiSelfHostedRunnerAutoScalingLambda',
        code: lambda.Code.fromAsset('./lambda/auto-scaling-lambda/'),
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: "index.handler",
        environment: {
            "SECRET_NAME": circleCISecret.secretName,
            "SECRET_REGION": props?.env?.region || 'us-west-2',
            "AUTO_SCALING_MAX": props!!.maxInstances,
            "AUTO_SCALING_GROUP_NAME": circleCiAutoScalingGroup.autoScalingGroupName,
            "AUTO_SCALING_GROUP_REGION": props?.env?.region || 'us-west-2'
        },
        timeout: Duration.minutes(1),
        role: inferenceLambdaRole
    });
}
</code></pre>

<h3>安排Lambda定期运行</h3>

<p>最后，安排AWS Lambda函数每分钟触发一次。您可以根据预期的工作量选择不同的频率。将这段代码添加到在<code>lib/circleci-self-hosted-runner-autoscaling-stack.ts</code>文件中定义的<code>constructor</code>中。</p>

<pre><code class="language-ts">import {
    //update the existing import to add aws_lambda and Duration
    aws_events as events,
    aws_events_targets as targets,
} from 'aws-cdk-lib';

constructor(scope: Construct, id: string, props ?: CircleciSelfHostedRunnerAutoscalingStackProps) {

    // add the following code snippet below the existing constructs
    const eventRule = new events.Rule(this, 'CircleCiLambdaSchedule', {
        schedule: events.Schedule.rate(Duration.minutes(1)),
    });

    eventRule.addTarget(new targets.LambdaFunction(autoScalingLambda))
}
</code></pre>

<h2>更新CDK应用程序</h2>

<p>堆栈接受一些需要从T2 CDK应用程序传递过来的参数。用以下代码片段替换<code>bin/circleci-self-hosted-runner-autoscaling.ts</code>文件中的代码:</p>

<pre><code class="language-ts">import "source-map-support/register";
import * as cdk from "aws-cdk-lib";
import { CircleciSelfHostedRunnerAutoscalingStack } from "../lib/circleci-self-hosted-runner-autoscaling-stack";
const { env } = require("process");

const app = new cdk.App();
new CircleciSelfHostedRunnerAutoscalingStack(app, "CircleciSelfHostedRunnerAutoscalingStack", {
  maxInstances: "4",
  keypairName: env.AWS_KEYPAIR_NAME,
  runnerName: "aws-runner",
});
</code></pre>

<p>请注意，您对最大实例数和流道名称的值进行了硬编码。另外，<code>AWS_KEYPAIR_NAME</code>是从一个环境变量中获取的。</p>

<h2>部署CDK堆栈</h2>

<p>现在，您可以继续将应用程序部署到AWS帐户。首先手动部署应用程序，以确保在自动化部署之前一切正常。</p>

<p><strong>注意:</strong> <i>本地部署要求您在机器上设置AWS CLI、AWS CDK CLI和一些环境变量。如果您想直接使用CircleCI测试您的CDK堆栈，您可以跳过这一节。</i></p>

<p>在第一次部署之前，您需要使用<code>cdk</code> CLI引导项目。应用程序的引导提供了AWS CDK部署应用程序可能需要的资源。从项目的根目录发出以下命令:</p>

<pre><code class="language-bash">cdk bootstrap
</code></pre>

<blockquote>
  <p>确保您在系统上配置了AWS凭据。请参考配置AWS凭据的先决条件部分中的链接。如果配置了凭据，CDK将自动使用它们。</p>
</blockquote>

<p>接下来，将应用程序部署到AWS帐户。</p>

<pre><code class="language-bash">cdk deploy
</code></pre>
<p>在部署堆栈之前，确保在本地设置了所需的环境变量。您需要设置<code>AWS_KEYPAIR_NAME</code>、<code>SELF_HOSTED_RUNNER_RESOURCE_CLASS</code>、<code>SELF_HOSTED_RUNNER_AUTH_TOKEN</code>和<code>CIRCLECI_TOKEN</code>来部署app。</p>

<p>执行该命令后，可能会提示您确认应用于您的帐户的IAM角色/策略更改。如果应用程序设置正确，部署应该会成功。</p>

<h2>使用CircleCI自动部署</h2>

<p>干得好！您可以使用命令行手动部署CDK应用程序。现在，您可以自动化工作流，这样，每当您将代码推送到主分支时，就可以自动打包和部署基础结构的更改。要自动化部署，请执行以下操作:</p>
<ol>
  <li>更新。gitignore</li>
  <li>更新NPM脚本</li>
  <li>添加配置脚本</li>
  <li>为应用程序创建一个CircleCI项目</li>
  <li>设置环境变量</li>
</ol>

<h3>更新。gitignore</h3>

<p>由<code>cdk init</code>命令生成的代码包含一个默认忽略所有<code>.js</code>文件的<code>.gitignore</code>文件。用以下代码片段替换<code>.gitignore</code>的内容:</p>

<pre><code class="language-bash">!jest.config.js
*.d.ts
node_modules

# CDK asset staging directory
.cdk.staging
cdk.out
</code></pre>

<h3>更新NPM脚本</h3>

<p>您的CircleCI部署配置使用NPM脚本来执行deploy和diff命令。将这些脚本添加到根级<code>package.json</code>文件:</p>

<pre><code class="language-json">// update the aws-cdk-lambda-circle-ci/package.json file with the following scripts
{
  ...
  "scripts": {
    ...
    // add the ci_diff and ci_deploy scripts
    "ci_diff": "cdk diff -c env=${ENV:-stg} 2&gt;&amp;1 | sed -r 's/\\x1B\\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g' || true",
    "ci_deploy": "cdk deploy -c env=${ENV:-stg} --require-approval never"
  },
  ...
}
</code></pre>

<h3>添加配置脚本</h3>

<p>在项目的根目录中添加一个<code>.circleci/config.yaml</code>脚本(包含CI管道的配置文件)。将以下代码片段添加到其中:</p>

<pre><code class="language-yaml">version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0.6
executors:
  default:
    docker:
      - image: "cimg/node:14.18.2"
    environment:
      AWS_REGION: "us-west-2"
jobs:
  build:
    executor: "default"
    steps:
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY
          aws-secret-access-key: AWS_ACCESS_SECRET
          aws-region: AWS_REGION_NAME
      - checkout
      - run:
          name: "install_lambda_packages"
          command: |
            cd lambda/auto-scaling-lambda &amp;&amp; npm install
            cd ../
      - run:
          name: "build"
          command: |
            npm install
            npm run build
      - run:
          name: "cdk_diff"
          command: |
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              export ENV=stg
              if [ "${CIRCLE_BRANCH}" == "develop" ]; then
                export ENV=prd
              fi 
              pr_number=${CIRCLE_PULL_REQUEST##*/}
              block='```'
              diff=$(echo -e "cdk diff (env=${ENV})\n${block}\n$(npm run --silent ci_diff)\n${block}")
              data=$(jq -n --arg body "$diff" '{ body: $body }') # escape
              curl -X POST -H 'Content-Type:application/json' \
                -H 'Accept: application/vnd.github.v3+json' \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -d "$data" \
                "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues/${pr_number}/comments"
            fi
      - run:
          name: "cdk_deploy"
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              ENV=prd npm run ci_deploy
            elif [ "${CIRCLE_BRANCH}" == "develop" ]; then
              ENV=stg npm run ci_deploy
            fi
</code></pre>

<p>CI脚本使用<a href="https://circleci.com/developer/orbs/orb/circleci/aws-cli"> CircleCI的aws-cli orb </a>来设置aws配置(访问密钥和密码)。<code>build</code>作业安装包，计算差异，并部署更改。<code>cdk_diff</code>步骤只在pull请求上执行，并在PR上添加一个总结基础设施变更的注释。</p>

<p><code>cdk_deploy</code>命令检查分支并部署在<code>prd</code>或<code>stg</code>环境中。注意，<code>cdk_deploy</code>命令执行在<code>package.json</code>文件中定义的<code>ci_deploy</code>脚本。</p>

<p>您的管道配置将负责构建、打包和部署CDK堆栈到指定的AWS帐户。提交更改并将其推送到GitHub存储库。</p>

<p><strong>注意:</strong> <i>如果与您所在地区不同，请不要忘记更换上面指定的<code>AWS_REGION</code>。</i></p>

<h3>为应用程序创建一个CircleCI项目</h3>

<p>使用<a href="https://app.circleci.com/"> CircleCI控制台</a>将存储库设置为CircleCI项目。在CircleCI控制台上，点击<strong>项目</strong>，搜索GitHub repo名称，并为您的项目点击<strong>设置项目</strong>。</p>

<p><img src="../Images/f9bbe07a178e1aaeb920fb561bd032ff.png" alt="Circle CI set up project" class="zoomable" srcset="https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/7vEs4rFPmbmF1GoZWx7ZWJ/3a5145fa8b0bf249640166187e3187ac/2023-02-16-aws-cdk-self-hosted-autoscaling-setup-project.png"/></p>

<p>系统将提示您手动添加新的配置文件或使用现有的配置文件。因为您已经将所需的配置文件推送到代码库，所以选择<strong>最快的</strong>选项。输入承载配置文件的分支的名称。点击<strong>设置项目</strong>继续。</p>

<p><img src="../Images/061a1e4ecdd65ffd454df242b832ff59.png" alt="Circle CI project configuration" class="zoomable" srcset="https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/72Xo0LJpqCY3b5ChnEt2NK/45f93e648a0d17a31d96a031a2113c78/2023-02-16-aws-cdk-self-hosted-autoscaling-configure-project.png"/></p>

<p>完成设置将触发管道。不出所料，管道将在第一次运行时失败，因为您还没有定义环境变量。</p>

<h3>设置环境变量</h3>

<p>从项目仪表盘中点击<strong>项目设置</strong>，进入<strong>环境变量</strong>选项卡。点击<strong>添加环境变量</strong>按钮，添加新的键值。</p>

<p>您需要添加这些环境变量:</p>

<ul>
  <li><code>AWS_ACCESS_KEY</code>是创建AWS凭证时获得的访问密钥。</li>
  <li><code>AWS_ACCESS_SECRET</code>是创建AWS凭证时获得的密码。</li>
  <li><code>AWS_REGION_NAME</code>是您希望部署应用程序的区域。</li>
  <li><code>AWS_KEYPAIR_NAME</code>是使用AWS控制台创建的EC2密钥对的名称。</li>
  <li><code>SELF_HOSTED_RUNNER_RESOURCE_CLASS</code>是您在创建自托管运行程序资源类时设置的运行程序名称。</li>
  <li><code>SELF_HOSTED_RUNNER_AUTH_TOKEN</code>是在创建自托管runner资源类时获得的令牌。</li>
  <li><code>CIRCLECI_TOKEN</code>是CircleCI个人访问令牌。它与CircleCI runner令牌不同。</li>
</ul>

<p><img src="../Images/615c58843e1963bd9f141eadb70877e0.png" alt="Circle CI set up environment variables" class="zoomable" srcset="https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/6q05bKo1qi72UB2EID2J0E/8de1c21cf31c24b92a4289e3dd59ea58/2023-02-16-aws-cdk-self-hosted-autoscaling-environment-variables.png"/></p>

<p>配置好环境变量后，重新运行管道。这一次它应该会成功构建。</p>

<p><img src="../Images/68dd5ca6bdf5cdac2172538e8750e51d.png" alt="Circle CI pipeline builds successfully" class="zoomable" srcset="https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/20Zh7ECnFlKWDTbGwFHKIz/5e3e37c1aa194dfb2acbc3c5d90195fd/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-deployment.png"/></p>

<h2>测试自动缩放设置</h2>

<p>现在，您的自动缩放堆栈已经成功部署，您可以使用它来运行一些作业。为了测试设置，使用示例NodeJS应用程序，您可以使用这个链接来<a href="https://github.com/CIRCLECI-GWP/example-nodejs-app" target="_blank" rel="noreferrer noopener">克隆它。</a></p>

<p>要使用自托管运行器运行作业，请确保作业配置使用您之前创建的自托管资源类。参考下面的代码片段作为设置<code>resource_class</code>的示例:</p>

<pre><code class="language-yml">version: 2.1
workflows:
  testing:
    jobs:
      - runner-test

jobs:
  runner-test: # this can be any name you choose
    machine: true
    resource_class: tutorial-gwp/auto-scaling-st ack
    steps:
      - checkout # checkout source code
      - run:
          name:
          command: npm test
</code></pre>

<p>按照上一节中的步骤为NodeJS应用程序创建一个CircleCI项目。在CircleCI项目页面，点击<strong>触发管道</strong>为您的应用程序触发一个作业。您可以多次单击它，让多个作业同时运行。</p>

<p><img src="../Images/8a65533b0d5940ff631d7686354d4b7f.png" alt="Trigger pipeline for the NodeJS application" class="zoomable" srcset="https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/6lW5CjrIjdpeq6zLqpZPR2/174af122ce4d6e7b4811cf18180966d2/2023-02-16-aws-cdk-self-hosted-autoscaling-trigger-pipeline.png"/></p>

<p>转到AWS EC2控制台，注意新实例正在旋转。正在运行的实例数量将等于挂起作业的数量。</p>

<p><img src="../Images/4e29ed55846bafe2dab876534e552de0.png" alt="AWS instances spinning up" class="zoomable" srcset="https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/3UogpKpzxmQ34V5lISPyQj/e838f6ff5d9cd85e5c2650f05b915c2f/2023-02-16-aws-cdk-self-hosted-autoscaling-aws-ec2-instances-spinning-up.png"/></p>

<p>如果挂起作业的数量超过AWS EC2自动缩放组的<code>maxCapacity</code>,那么只有<code>maxCapacity</code>数量的实例将被加速。一旦其中一个作业完成执行，其他未决作业将被处理。</p>

<p>几分钟后，您会注意到所有的作业都已成功完成。</p>

<p><img src="../Images/77144d550300d96ec5842c66a7e17706.png" alt="All NodeJS jobs completing successfully" class="zoomable" srcset="https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/7FU1Inv3oxEnsRkvwXtQwd/55196fd188d1b32dfa7013fe58724f84/2023-02-16-aws-cdk-self-hosted-autoscaling-successful-nodejs-jobs.png"/></p>

<h2>结论</h2>

<p>在本教程中，您学习了如何使用AWS CDK根据需求自动缩放自托管跑步者。借助AWS CDK，您可以使用自己熟悉的语言为应用程序提供资源。AWS CDK允许您在定义应用程序时使用逻辑语句和面向对象的技术。CircleCI的自托管运行器满足独特的架构要求、特权访问和控制要求。通过自动扩展自托管跑步者资源，您可以优化成本并根据需求增加额外资源。</p>

<p>在GitHub上查看本教程中使用的<a href="https://github.com/CIRCLECI-GWP/circleci-self-hosted-runner-autoscaling" target="_blank" rel="noreferrer noopener">完整源代码</a>。如果您试图定义一个类似的堆栈，GitHub项目也可以用作模板。</p>

<p>示例NodeJS应用程序的源代码可以在<a href="https://github.com/CIRCLECI-GWP/example-nodejs-app" target="_blank" rel="noreferrer noopener">这里</a>找到。</p>


        
          
          
            <hr/>
            <p>Vivek Kumar Maskara是JP摩根的一名软件工程师。他喜欢写代码，开发应用程序，创建网站，并写关于他的经历的技术博客。他的简介和联系方式可以在<a href="https://www.maskaravivek.com/">maskaravivek.com</a>找到。</p>

            <p><a href="/blog/author/vivek-maskara/" class="arrow-link">阅读更多Vivek Maskara的帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>