<html>
<head>
<title>Firebase Hosting - Deploying to Firebase Hosting - Deploying a Gatsby site | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Firebase Hosting -部署到Firebase Hosting -部署Gatsby站点| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/automatically-deploy-a-gatsby-site-to-firebase-hosting/#2019-06-18T05:14:00-07:00">https://circleci.com/blog/automatically-deploy-a-gatsby-site-to-firebase-hosting/#2019-06-18T05:14:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p><a href="https://firebase.google.com/products/hosting" target="_blank" rel="noreferrer noopener"> Firebase Hosting </a>是Google的一个web应用托管平台。通过这项服务，你可以在谷歌的基础设施上托管你的网络应用。它支持简单的一步部署，并具有其他很酷的功能，如从cdn快速托管和回滚。在<a href="https://firebase.google.com/docs/hosting/" target="_blank" rel="noreferrer noopener"> Firebase托管文档</a>中有一个很好的服务概述。</p>

<p>Gatsby是一个框架，可以让你快速创建基于React的应用和网站。它允许你用从各种来源获取的数据建立这些网站，包括降价文件、API，甚至CMS。然后，它将这些数据与基于React的前端架构相结合，构建速度极快的交互式网站。Gatsby将web应用程序编译成优化的静态文件，我们将把这些文件部署到Firebase主机上。我觉得很神奇，很高兴和大家分享！</p>

<p>在本文中，我们将设置一个简单的Gatsby站点，将代码托管在GitHub存储库中，并使用CircleCI将web应用程序自动部署到Firebase主机。</p>

<h2>先决条件</h2>

<p>为了完成本教程，您需要安装以下软件:</p>
<ol>
  <li><a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git" target="_blank" rel="noreferrer noopener">去</a></li>
  <li><a href="https://nodejs.org" target="_blank" rel="noreferrer noopener"> Node.js </a></li>
</ol>

<p><i> <strong>注意:</strong>你还需要有一个谷歌账户才能使用Firebase主机。</i></p>

<h2>为什么是盖茨比？</h2>

<p>我选择盖茨比只是因为它能让我们专注于高层次的细节。例如，我们不会从头开始构建页面、找出路径、添加404页面等等，而是将所有这些都内置到我们即将生成的starter项目中。Gatsby为我们提供了这些现成的优势，但托管的概念仍然适用于任何其他类型的web应用程序，这些应用程序可以编译为静态文件，包括Vue和Angular应用程序，甚至是由静态站点生成器生成的网站。</p>

<h2>Gatsby项目设置</h2>

<p>首先，我们需要在本地开发环境中安装Gatsby。我们可以通过运行以下命令来实现:</p>

<pre><code class="language-bash">npm install --global gatsby-cli
</code></pre>
<p>安装完成后，我们将可以使用<code>gatsby</code>命令。现在，让我们使用Gatsby CLI来生成一个新站点:</p>

<pre><code class="language-bash">gatsby new gatsby-site
</code></pre>
<p>接下来，我们需要将目录更改为新创建的<code>gatsby-site</code>文件夹:</p>

<pre><code class="language-bash">cd gatsby-site
</code></pre>
<p>最后，我们可以通过启动开发服务器来浏览我们生成的站点:</p>

<pre><code class="language-bash">gatsby develop
</code></pre>
<p>您的新网站现在可以在<code>http://localhost:8000</code>访问。</p>

<p>如果一切运行成功，您现在就有了一个在本地运行的Gatsby站点。继续探索这个网站。看起来是这样的:</p>

<p><img src="../Images/8d522b97f8d3106c5b902a2fd2d51935.png" alt="Gatsby starter page" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1548226687837_Screen+Shot+2019-01-23+at+09.41.58.png"/></p>

<p>如果您浏览一下生成的文件，您会发现Gatsby的文件夹结构很容易理解。例如，主页的代码可以在<code>src/pages/index.js</code>中找到。还要注意，不同页面之间的链接工作正常，我们还设置了一个404页面。你可以通过去一个不存在的路线来测试404页面。</p>

<p>Gatsby提供了这些底层细节，比如路由，并为我们提供了一个功能性的web应用程序，我们现在可以将它部署到Firebase主机上。</p>

<h3>推送至GitHub</h3>

<p>此时，让我们初始化一个新的Git存储库，并将代码推送到GitHub。继续在<code>gatsby-site</code>文件夹中初始化一个新的Git存储库，并使用以下代码行创建一个初始提交:</p>

<pre><code class="language-bash">git init
git add -all
git commit -m "Generate Gatsby site"
</code></pre>
<p>之后，继续在GitHub上创建一个新的存储库，并将代码推送到存储库。</p>

<p>如果你不熟悉GitHub，这个指南是一个很好的参考资料。</p>

<h2>Firebase设置</h2>

<p>现在，我们有了一个功能性的网站，可以部署到Firebase主机上了。在此之前，我们需要使用以下三个简单的步骤在Firebase上创建一个新项目:</p>



<p><img src="../Images/6d555f06f5e5ec3fe327f8742c1251f0.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553424582894_Screen+Shot+2019-03-24+at+13.49.18.png"/><br/>T2】</p>
<ul>
  <li>在弹出的模式中给你的项目命名，然后点击<strong>创建项目</strong>。</li>
</ul>

<p><img src="../Images/50d421b4157bbcce1cddcf5e59462d9e.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553424636354_Screen+Shot+2019-03-24+at+13.50.18.png"/> <br/> <br/>一旦创建了项目，我们需要在本地设置Firebase，以便将我们的本地存储库链接到Firebase项目。通过运行以下命令安装Firebase命令行工具:</p>

<pre><code class="language-bash">npm install -g firebase-tools
</code></pre>
<p>我们还需要在本地将<code>firebase-tools</code>包作为<code>devDependency</code>安装到我们的项目中。这将在以后与CircleCI集成时派上用场，circle ci默认不允许全局安装包。所以让我们现在就安装它:</p>

<pre><code class="language-bash">npm install -D firebase-tools
</code></pre>
<p>之后，我们需要登录Firebase，将CLI连接到在线Firebase帐户。我们可以通过运行以下命令来实现:</p>

<pre><code class="language-bash">firebase login
</code></pre>
<p>一旦您登录，我们现在可以初始化我们的项目:</p>

<pre><code class="language-bash">firebase init
</code></pre>
<p>此操作将产生此提示，我们将在其中选择托管的<strong>:</strong></p>

<p><img src="../Images/898a7a52bf70e8261feb8e5064349874.png" alt="Firebase init prompt" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1548229025490_Screen+Shot+2019-01-23+at+10.35.48.png"/></p>

<p>对于其余的提示，选择如下一个屏幕截图所示的选项:</p>

<p><img src="../Images/df1e6c444845623919f242b0f0f44655.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1548229602015_Screen+Shot+2019-01-23+at+10.45.39.png"/></p>

<p>提示完成后，Firebase CLI会生成两个文件:</p>

<ul>
  <li><code>.firebaserc</code></li>
  <li><code>firebase.json</code></li>
</ul>

<p><i> <strong>注:</strong><code>firebase.json</code>文件支持配置自定义托管行为。要了解这方面的更多信息，请访问Firebase <a href="https://firebase.google.com/docs/hosting/full-config" target="_blank" rel="noreferrer noopener">全配置</a>文档。</i></p>

<p>如果Firebase CLI没有加载您的项目，您可以在生成的<code>.firebaserc</code>文件中手动添加项目ID:</p>

<pre><code class="language-json">{
  "projects": {
    "default": "gatsby-site-43ac5"
  }
}
</code></pre>

<p>这也是将新文件提交到我们的存储库并将代码推送到GitHub的好时机。</p>

<p>这样，我们就将代码连接到了Firebase项目，现在我们可以在开发环境中尝试手动部署了。</p>

<h3>手动部署到Firebase</h3>

<p>手动部署的第一步是生成优化的生产版本。在我们的例子中，<code>gatsby</code>包含了我们，因为它默认包含了这个。要生成它，请运行以下命令:</p>

<pre><code class="language-bash">gatsby build
</code></pre>
<p>这将在<code>public</code>目录中生成一个优化的静态站点。这是我们将部署到Firebase主机的目录。要手动将<code>public</code>目录部署到Firebase主机，只需要一个命令:</p>

<pre><code class="language-bash">firebase deploy
</code></pre>
<p>如果一切按预期运行，Firebase将部署我们的站点，并给我们一个已部署站点的URL链接。</p>

<p><img src="../Images/bde8147199aac975993485707e011688.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553495036359_Screen+Shot+2019-03-25+at+09.23.37.png"/></p>

<p>您还会注意到Firebase创建了一个新的<code>.firebase</code>文件夹来存储它的缓存。由于我们不希望这个文件夹出现在我们的存储库中，我们可以将文件夹名添加到<code>.gitignore</code>文件中，这样Git就会忽略它。</p>

<p>在下一步中，我们将使用CircleCI自动化部署，这样我们就可以立即部署新的变更到存储库中。</p>

<h2>圆形构型</h2>

<p>要用CircleCI构建我们的项目，我们需要添加一个配置文件，指示CircleCI构建我们的web应用程序，并在每次修改代码时自动将其部署到Firebase。</p>

<p>在我们项目的根文件夹中，创建一个名为<code>.circleci</code>的文件夹，并在其中创建一个<code>config.yml</code>文件。CircleCI要求配置文件位于此处。</p>

<p>下面是我们将在项目中使用的配置文件:</p>

<pre><code class="language-yaml"># CircleCI Firebase Deployment Config
version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10
    working_directory: ~/gatsby-site
    steps:
      - checkout
      - restore_cache:
          keys:
            # Find a cache corresponding to this specific package-lock.json
            - v1-npm-deps-{{ checksum "package-lock.json" }}
            # Fallback cache to be used
            - v1-npm-deps-
      - run:
          name: Install Dependencies
          command: npm install
      - save_cache:
          key: v1-npm-deps-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - run:
          name: Gatsby Build
          command: npm run build
      - run:
          name: Firebase Deploy
          command: ./node_modules/.bin/firebase deploy --token "$FIREBASE_TOKEN"
</code></pre>

<p>让我们快速回顾一下配置文件。</p>

<ul>
  <li>首先，<code>version</code>键使我们能够指定我们正在使用CircleCI 2.0。</li>
  <li>接下来，我们指定代码将在其中运行的基本Docker映像。在这种情况下，是一个基于<code>Node 10</code>的容器，这是撰写本文时的当前版本。如果有更新的版本，您可以使用。</li>
  <li><code>working_directory</code>选项指定了我们的代码将被克隆的位置。</li>
  <li>接下来是<code>restore_cache</code>部分，它指示CircleCI恢复任何以前安装的依赖项。这里我们使用<code>package-lock.json</code>文件的校验和来检测是重新安装依赖项还是使用缓存来恢复之前下载的包。</li>
  <li>下一步是通过<code>npm install</code>命令安装依赖项。</li>
  <li><code>save_cache</code>部分指示CircleCI在安装完依赖项后保存它们。</li>
  <li>然后我们运行<code>Gatsby Build</code>命令。这将构建站点的优化生产版本，并准备好进行部署。</li>
  <li>最后，我们运行<code>Firebase Deploy</code>命令，将我们的代码部署到Firebase主机。在这一步中，您会注意到我们需要一个Firebase令牌来允许将应用程序部署到我们的帐户。该命令指定应该从环境变量<code>FIREBASE_TOKEN</code>中获取令牌。我们一会儿会得到这个代币。</li>
</ul>

<p>此外，请注意我们如何从本地安装的依赖项运行<code>firebase</code>命令的变化，而不是作为一个全局命令。如前所述，用CircleCI全局安装软件包可能是一个问题，所以我们在项目中本地安装我们需要的所有软件包。</p>

<h3>集成CircleCI和GitHub</h3>

<p>我们现在有了一个配置文件，可以继续将CircleCI与我们之前创建的GitHub存储库集成。</p>

<ul>
  <li>如果您还没有，请在<a href="https://circleci.com/" target="_blank" rel="noreferrer noopener"> CircleCI </a>上创建一个帐户。</li>
  <li>登录后，确保在左上角选择您的帐户。</li>
</ul>

<p><img src="../Images/ecae1fedb8adf74f8eb78712bbd9f0fc.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1548668858675_image_preview.png"/><br/>T2】</p>

<ul>
  <li>点击左侧工具条上的<strong>添加项目</strong>。</li>
  <li>在下一页，搜索您的GitHub库的名称，然后点击它旁边的<code>Set Up Project</code>。</li>
</ul>

<p><img src="../Images/fdd82a39019c728b7f2d0a28abe64c09.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553426079477_output+1.png"/><br/>T2】</p>

<ul>
  <li>在下一页，有一个构建我们的项目所需的步骤列表，其中最重要的一个是添加CircleCI配置文件。因为我们的回购中已经有了这个文件，所以让我们一直滚动到底部，然后单击<code>Start Building</code>。</li>
</ul>

<p><img src="../Images/7c8b63f93e1726a816d74ba89da3229f.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553426275956_Start+building.png"/><br/>T2】</p>

<p>我们的构建将最终开始运行，但是它在Firebase部署步骤中不出所料地失败了。😢<img src="../Images/f9de7d127c0d0bb82cf21f91e2092e51.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553426484260_Screen+Shot+2019-03-24+at+14.21.13.png"/> <br/> <br/>幸运的是，我知道部署失败的原因。这是因为我们还没有将Firebase部署令牌添加到CircleCI中。让我们在下一部分解决这个问题。</p>

<h3>获取用于部署的Firebase登录令牌</h3>

<p>在最后一步，我们将需要生成一个Firebase令牌，我们将使用它来允许访问我们的帐户。这个令牌将使CircleCI能够代表我们部署到Firebase，因为我们不能在CI环境中使用Firebase的交互提示符登录。</p>

<p>在我们的本地开发环境中，让我们运行以下命令来生成令牌:</p>

<pre><code class="language-bash">firebase login:ci
</code></pre>
<p>这将打开一个浏览器窗口，提示您登录Firebase帐户。登录后，将会生成一个令牌。通过web浏览器进行身份验证后，您应该会得到类似以下的结果。</p>

<p><img src="../Images/23ee8e902acf1c4fe006d833b1d07617.png" alt="Obtaining a Firebase token" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553429299275_Login+token.png"/></p>

<p>现在我们有了令牌，剩下的就是在CircleCI中将令牌作为一个<a href="https://circleci.com/docs/env-vars/#setting-an-environment-variable-in-a-project" target="_blank" rel="noreferrer noopener">环境变量</a>添加，这样我们就可以在我们的项目中使用它了。我们的部署命令期望在<code>FIREBASE_TOKEN</code>环境变量中找到值。</p>

<h3>将Firebase令牌添加到CircleCI</h3>

<p>我们需要采取以下步骤来添加令牌:</p>

<ul>
  <li>通过点按项目旁边的齿轮图标，转到项目的设置。</li>
  <li>在<strong>构建设置</strong>部分下，点击<strong>环境变量</strong>。</li>
  <li>点击<strong>添加变量</strong>。</li>
  <li>在出现的模态中，在<code>name</code>字段中输入<strong> FIREBASE_TOKEN </strong>，在<code>value</code>字段中添加我们从FIREBASE获得的令牌，最后点击<strong>添加变量</strong>完成变量的添加。</li>
</ul>

<p><img src="../Images/467e2b63ed14b5f0681d866b22e92f3b.png" alt="Adding an Environment variable to CircleCI" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553430184942_Screen+Shot+2019-03-24+at+15.22.37.png"/><br/>T2】</p>

<ul>
  <li>完成这一步后，我们现在可以通过点击CircleCI项目页面右侧的<strong>重新运行工作流</strong>来重新运行我们的构建。</li>
</ul>

<p><img src="../Images/6f6a5659b138e173c208432489f55fb0.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553430549251_Screen+Shot+2019-03-24+at+15.28.16.png"/><br/>T2】</p>

<p>我们现在已经使用CircleCI成功地将我们的web应用程序部署到Firebase主机上了！🎉</p>

<p><img src="../Images/75d28aa375acfed7b32da27608a5b30d.png" alt="Firebase deployment successful" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_5322E278AD353022C7B4ED10D5386AC64E40B18B6A7F47AB74A65650952F148A_1553430853003_Screen+Shot+2019-03-24+at+15.33.57.png"/></p>

<h2>结论</h2>

<p>我们对使用CircleCI将web应用程序部署到Firebase的探索到此结束。从现在开始，当我们对Gatsby站点进行更新并将这些更改推送到GitHub时，它们将自动部署到Firebase主机上。这真是一个伟大的组合。</p>

<p>这种方法适用于任何其他前端项目，并不是Gatsby特有的。Firebase为web应用程序提供主机服务，CircleCI帮助实现自动化并简化流程。前进并展开！🚀</p>

<p>有关这些技术的更多信息，请参见以下资源:</p>




        
          
          
            <hr/>
            <p>Kevin Ndung'u是一名软件开发人员和开源爱好者，目前在<a href="https://andela.com/" target="_blank" rel="noreferrer noopener"> Andela </a>担任软件工程师。他热衷于通过博客帖子和开源代码分享他的知识。当不构建web应用程序时，您可以发现他在看足球比赛。</p>

            <p><a href="/blog/author/kevin-ndungu/" class="arrow-link">阅读凯文·恩东乌的更多帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>