<html>
<head>
<title>HTTP request testing with k6 | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用k6 | CircleCI进行HTTP请求测试</h1>
<blockquote>原文：<a href="https://circleci.com/blog/http-request-testing-with-k6/#2022-01-05T00:00:00-08:00">https://circleci.com/blog/http-request-testing-with-k6/#2022-01-05T00:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <blockquote>
  <p>本教程涵盖:</p>
  <ol>
    <li>什么是k6，它是如何工作的</li>
    <li>编写和执行k6测试</li>
    <li>分析k6测试结果</li>
  </ol>
</blockquote>

<p>开发团队每天部署的许多多面应用程序是松散耦合的，每个服务的存在都是为了支持另一个服务。大多数开发fullstack应用程序的团队都知道测试这些服务之间的通信是必不可少的。该过程的一部分是测试HTTP请求端点，本教程正是关注于此。我将带领您学习如何扩展k6框架来测试我们的HTTP端点。您还将学习如何设置k6和，以及如何利用其他API测试框架中没有的特性。本教程在k6 的<a href="/blog/api-performance-testing-with-k6/">性能测试API中继续。</a></p>

<h2>先决条件</h2>
<p>要学习本教程，您需要:</p>

<ol>
  <li><a href="https://www.JavaScript.com/" target="_blank" rel="noreferrer noopener"> JavaScript </a>的基础知识</li>
  <li>HTTP请求和测试的基本知识</li>
  <li>您系统上安装的<a href="https://nodejs.org" target="_blank" rel="noreferrer noopener"> Node.js </a>(版本&gt; = 10.13)</li>
  <li>一个<a href="https://circleci.com/signup/">圆</a>的账户</li>
  <li>GitHub的一个账户</li>
</ol>

<blockquote><p>我们的教程是平台无关的，但是使用CircleCI作为例子。如果你没有CircleCI账号，请在 注册一个免费的<a href="https://circleci.com/signup/"> <strong>。</strong></a></p></blockquote>

<h2>k6是什么？</h2>
<p>k6是一个开源框架，旨在为开发人员带来性能测试的乐趣。此时，您可能会问自己，这与HTTP请求测试有什么关系？测试性能意味着向API端点发出请求。我们已经在使用该工具进行HTTP请求，为什么不用它来测试那些端点呢？发出请求会将您带到测试端点的中途。我将在本教程的后面描述如何完成测试。</p>

<p><img src="../Images/c84907edc8fc6287d028581b4c64fc72.png" alt="k6 Logo" srcset="https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-01-05-k6-logo.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-01-05-k6-logo.png"/></p>

<p>k6用<a href="https://github.com/dop251/goja" target="_blank" rel="noreferrer noopener"> goja </a>语言编写，是纯Go语言的Ecmascript 5.1实现。这种实现纯粹是出于性能原因，它包含了一些很棒的特性，使得具有JavaScript经验的软件开发人员可以很容易地进行测试。k6附带了一个有用的CLI，用于制作API支持的k6命令。k6 APIs提供了对JavaScript ES2015/ES6的支持，以及负载测试的工具和功能，我们将在本教程的后续部分使用这些工具和功能。</p>

<p>既然我们知道了k6下运行的是什么，为什么不开始设置k6来运行我们的HTTP测试呢？</p>

<p>首先，<a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository" target="_blank" rel="noreferrer noopener">从<a href="https://github.com/CIRCLECI-GWP/api-testing-with-k6" target="_blank" rel="noreferrer noopener"> Github库</a>中克隆</a>示例应用程序。</p>

<h2>安装k6</h2>
<p>与JavaScript模块不同，k6必须使用包管理器安装。在macOS中你可以使用<a href="https://brew.sh/">自制</a>。在Windows操作系统中，你可以使用<a href="https://github.com/chocolatey/choco" target="_blank" rel="noreferrer noopener">巧克力糖</a>。k6文档中有更多适用于其他操作系统的安装选项。对于本教程，我们将遵循macOS安装指南。在homebrew中执行此命令:</p>

<pre><code>brew install k6
</code></pre>

<p>这是您开始编写k6测试时需要运行的唯一命令。</p>

<p>安装k6后，我们需要创建一个文件夹来存储我们的项目。我们将通过在我们想要存储测试的目录中执行以下命令来做到这一点:</p>

<pre><code>$ mkdir http-request-testing-with-k6;
$ touch todos-testing.js
</code></pre>
<p>这些命令将创建一个空项目，并创建我们的测试文件<code>todos-testing.js</code>。</p>

<h2>k6测试结构</h2>
<p>k6使用的测试结构与大多数开发人员习惯的测试结构有点不同，尤其是那些来自JavaScript背景的开发人员。下面的代码片段显示了一个用k6编写的示例测试，声明我们正在从一个开源的todo应用程序API获得响应，我们将在本教程中使用该API进行测试。您可以向刚刚创建的项目中添加相同的测试。</p>

<pre><code>// snippet from ./todos-testing.js
import http from 'k6/http';
import { check } from 'k6';
 
export let options = {
   vus: 1,
};
 
export default function () {
   group('API uptime check', () =&gt; {
       const response = http.get('https://todo-app-barkend.herokuapp.com/todos/');
       check(response, {
           "status code should be 200": res =&gt; res.status === 200,
       });
   })

</code></pre>
<p>首先，如果您仔细观察测试，它类似于JavaScript测试代码，但是文件格式与我们通常编写JavaScript测试的方式不同。让我给你分解一下测试结构。</p>

<p>因为我们k6使用<code>goja</code>而不是JavaScript，所以我们只能使用JavaScript的某些方面来执行我们的测试。因此，我们不能访问像通常我们可以访问的<code>describe</code>或<code>it</code>块这样的方法，也不能访问像<code>chai</code>这样的断言库。k6提供了<code>group()</code>和<code>check()</code>方法，它们的工作方式与我们使用<code>describe</code>和<code>assert</code>的方式相同。<code>group()</code>块允许我们在一个文件中编写多个测试，但是为了可读性，也可以将不同测试的配置分开。</p>

<p>k6还捆绑了一个默认的<code>HTTP</code>请求模块，我们可以用它来发出所有的API请求，无论是<code>GET</code> <code>POST</code>、<code>PUT</code>还是<code>DELETE</code>。当用纯JavaScript编写测试时，这个<code>http()</code>方法相当于<code>fetch()</code>。对于测试的其余部分，我们使用<code>check()</code>方法断言响应是<code>200</code>，并且我们可以继续使用这个断言块断言我们需要的任何其他响应。</p>

<p><strong>提示</strong>:<i>k6测试中的<code>options = {}</code>对象对于运行HTTP测试是可选的，但是当我们使用K6运行负载测试时，它非常方便。在这个特定的测试中，我们告诉k6，我们希望只使用单个虚拟用户(vus)或者单个迭代来运行测试，这对于这个测试的上下文是有意义的。</i></p>

<h2>k6测试的生命周期</h2>
<p>k6遵循一个<code>init code</code>、<code>setup code</code>、<code>VU code</code>和<code>teardown code</code>的生命周期。这个循环显示了测试通常是如何运行的，以及测试在执行时可以访问哪些资源。下面是展示k6测试生命周期的示例代码块:</p>

<pre><code>// 1. init code

export function setup() {
  // 2. setup code
}

export default function (data) {
  // 3. VU code
}

export function teardown(data) {
  // 4. teardown code
}

</code></pre>
<p><code>init</code>和<code>VU</code>阶段作为测试入口点，而<code>teardown</code>和<code>setup</code>提供了API测试可以在测试完成执行之前和之后运行的脚本。拆卸和安装方法是可选的，所以k6中最简单的测试形式可以只使用<code>VU</code>代码方法，如下面的代码片段所示:</p>

<pre><code>// snippet from ./todos-testing.js
export default function () {
    const response = http.get('https://todo-app-barkend.herokuapp.com/todos/');
    check(response, {
        "status code should be 200": res =&gt; res.status === 200,
    });
}
</code></pre>
<p>默认函数<code>VU code</code>中的代码在为单次迭代(一次VU)或者为负载测试的多次迭代调用测试时运行。</p>

<p><code>VU</code>代码发出API HTTP请求并执行断言，但是它不能导入其他模块或从文件系统加载文件。这就是k6在不同的执行模式下执行时知道哪些测试应该保存在内存中的原因。这种策略提高了k6的性能，优化了测试设计。</p>

<p>现在这变得有趣了，是时候将CI/CD集成到我们的应用程序中，这样您就可以执行测试了。对于本教程，我们将使用CircleCI为应用程序设置CI/CD。</p>

<p><strong>注意</strong> : <i>如果您已经克隆了项目存储库，那么您可以跳过这部分教程。如果你想学习如何建立自己的项目，我在这里添加了一些步骤。</i></p>

<h2>设置Git并推送到CircleCI</h2>

<p>要设置CircleCI，通过运行以下命令初始化项目中的Git存储库:</p>

<pre><code>git init
</code></pre>

<p>接下来，在根目录下创建一个<code>.gitignore</code>文件。在文件中添加<code>node_modules</code>来防止npm生成的模块被添加到您的远程存储库中。然后，添加一个提交，<a href="https://circleci.com/blog/pushing-a-project-to-github/">将你的项目推送到GitHub </a>。</p>

<p>登录CircleCI并转到项目仪表板。您可以从与您的GitHub用户名或您的组织相关联的所有GitHub存储库列表中选择您想要设置的存储库。本教程的项目名为<code>http-request-testing-with-k6</code>。在“项目”面板上，选择设置所需项目的选项。选择使用现有配置的选项。</p>

<p><strong>注意:</strong> <i>在启动构建之后，预计您的管道会失败。您仍然需要将定制的<code>.circleci/config.yml</code>配置文件添加到GitHub中，以便正确构建项目。</i></p>

<h2>设置CircleCI</h2>

<p>在根目录下创建一个<code>.circleci</code>目录，然后添加一个<code>config.yml</code>文件。配置文件保存每个项目的CircleCI配置。在此配置中使用CircleCI k6 <code>orb</code>执行k6测试:</p>

<pre><code># snippet from .circleci/config.yml configuration file 
version: 2.1
orbs:
 k6io: k6io/test@1.1.0
workflows:
 load_test:
   jobs:
     - k6io/test:
         script: todos-testing.js

</code></pre>

<h3>使用第三方球体</h3>

<p>CircleCI orbs是yaml配置的可重用包，它将代码压缩成一行。要允许使用像<code>python@1.2</code>这样的第三方球体，您可能需要:</p>

<ul>
  <li>如果您是管理员，请启用组织设置，或者</li>
  <li>向您组织的CircleCI管理员请求权限。</li>
</ul>

<p>设置好配置后，<a href="https://docs.github.com/en/get-started/using-git/pushing-commits-to-a-remote-repository" target="_blank" rel="noreferrer noopener">将</a>配置推送到GitHub。CircleCI将开始建设这个项目。</p>

<p>瞧啊。转到CircleCI仪表板，展开构建详细信息。验证测试运行成功，并集成到CircleCI中。</p>

<p><img src="../Images/1f999507b194d96c30d67b39963d7243.png" alt="Pipeline Setup Success" srcset="https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-01-05-pipeline-setup-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-01-05-pipeline-setup-success.png"/></p>

<p>现在您已经设置了CI管道，您可以继续用k6编写更多的HTTP请求测试。</p>

<h2>验证k6响应</h2>

<p>既然您已经了解了k6的结构以及如何编写一个基本的测试，下一步就是用k6编写可伸缩的测试。使用您的<code>todo</code> API创建一个名为<code>write k6 tests</code>的todo项目:</p>

<pre><code>// snippet from ./todos-testing.js
  group('Create a Todo', () =&gt; {
       const response = http.post('https://todo-app-barkend.herokuapp.com/todos/',
       {"task": "write k6 tests"}
       );
       todoID = response.json()._id;
       check(response, {
           "status code should be 200": res =&gt; res.status === 200,
       });
       check(response, {
           "Response should have created todo": res =&gt; res.json().completed === false,
       });
   })

</code></pre>

<p>该代码块传递一个todo项，并向我们的todo应用程序API发出HTTP请求，这样就创建了您的Todo项。很简单，对吧？</p>

<p>为了使这更有趣，添加另一个测试来获取创建的todo项。这里的挑战是进入之前测试的范围。要做到这一点，需要为前面的测试返回的响应创建一个全局范围。然后在后续测试中使用todo项的<code>Id</code>。这里有一个例子:</p>

<pre><code>// snippet from ./todos-testing.js
group('get a todo item', () =&gt; {
    const response = http.get(`https://todo-app-barkend.herokuapp.com/todos/${todoID}`
       );
    check(response, {
        "status code should be 200": res =&gt; res.status === 200,
    });
    check(response, {
        "response should have the created todo": res =&gt; res.json()[0]._id === todoID,
    });
    check(response, {
        "response should have the correct state": res =&gt; res.json()[0].completed === false,
    });
   })

</code></pre>
<p>该测试验证创建的todo项与您创建的是同一项，并且其属性没有更改。在本地运行这个测试成功通过，表明就像在JavaScript测试中一样，k6可以在测试中共享状态。</p>

<p>这个示例代码中还显示，使用<code>groups()</code>来分离不相关的测试会在测试失败时增加松散耦合。它还提高了测试的可读性。</p>

<h2>使用场景为多个环境配置k6</h2>

<p>作为一个负载测试工具，k6附带了一些很棒的特性，可以在不同的环境中执行一些操作，比如编写测试，而不需要太多的配置。<code>scenario</code>特性就是一个很好的例子。<a href="https://k6.io/docs/using-k6/scenarios/" target="_blank" rel="noreferrer noopener">场景</a>提供k6测试的深度配置，使得根据配置偏好配置每个单独的<a href="https://k6.io/docs/using-k6/scenarios/executors/per-vu-iterations/" target="_blank" rel="noreferrer noopener"> <code>VU</code> </a>成为可能。</p>

<pre><code>export let options = {
   scenarios: {
     example_scenario: {
       env: { EXAMPLEVAR: 'testing' },
       tags: { example_tag: 'testing' },
     },
   }
 }
</code></pre>
<p>这个代码块展示了如何将场景对象捆绑在k6 <code>options</code>对象中。它传递包含不同环境的环境配置的<code>env</code>对象。金矿！</p>

<p>要自己做这件事，创建一个名为<code>environmentConfig.js</code>的文件，或者使用克隆的存储库中的文件。为开发和试运行环境添加一个配置，并将它们传递给不同的测试。</p>

<pre><code>// snippet from ./environmentConfig.js
export function developmentConfig(filename) {
   let envConfig = {
     BASE_URL: "http://todo-app-barkend.herokuapp.com/todos/",
     ENV: "DEVELOPMENT",
   };
   return Object.assign({}, envConfig, filename);
 }
  export function stagingConfig(filename) {
   let envConfig = {
     BASE_URL: "https://todo-app-barkend.herokuapp.com/todos/",
     ENV: "STAGING",
   };
   return Object.assign({}, envConfig, filename);
 }
</code></pre>

<p>这个代码块展示了如何为不同的环境配置测试。注意，它为开发环境使用了一个<code>HTTP</code>(非SSL) URL，为登台环境使用了一个<code>HTTPS</code>(支持SSL)URL。</p>

<p>一旦您为单个环境设置了变量，您就可以使用场景使用<code>options</code>对象将它们导入到不同的测试中。创建两个新文件来测试这个特性，一个用于开发环境，一个用于测试环境。将此代码片段用于开发环境测试:</p>

<pre><code>// snippet from scenario-tests/todos-development-tests.js
import { developmentConfig } from '../environmentConfig.js';
 
export const options = {
   scenarios: {
     example_scenario: {
       env: developmentConfig(),
       executor: 'shared-iterations',
       vus: 1
     }
   }
 };
 
export default function () {
   group('API uptime check - development', () =&gt; {
       const response = http.get(`${__ENV.BASE_URL}`);
       check(response, {
           "status code should be 200": res =&gt; res.status === 200,
       });
   });
…
});
</code></pre>

<p>这个代码块展示了如何利用<code>scenarios</code>配置，同时在不同的环境中运行同一组测试。</p>

<p><strong>注意</strong> : <i>可以在克隆的存储库中的<code>scenarios-tests</code>文件夹中找到不同配置的用于测试和开发的完整测试。</i></p>

<p>使用这种方法，您可以在<code>DEV</code>、<code>UAT</code>，甚至<code>PROD</code>环境中运行测试，即使相同测试的配置对于每个环境是不同的。为了验证成功，您可以运行<code>scenario-tests</code>文件夹中的测试。</p>

<p>对于开发环境/配置，运行:</p>

<pre><code>K6 run scenario-tests/todos-development-tests.js
</code></pre>

<p>对于暂存环境，运行:</p>

<pre><code>K6 run scenario-tests/todos-staging-tests.js
</code></pre>

<p>为了确保这些测试在CI/CD管道上运行，您需要修改<code>.circleci/config.yml</code>来包含这些运行命令:</p>

<pre><code># snippet from .circleci/config.yml configuration file 
    jobs:
      - k6io/test:
          script: todos-testing.js
      # Add more jobs here
      - k6io/test:
          script: scenario-tests/todos-development-tests.js
      - k6io/test:
          script: scenario-tests/todos-development-tests.js 
</code></pre>

<p>场景允许您将k6测试配置为单独的迭代。当您希望在一个文件中编写多个负载测试场景，并为每个场景使用不同的配置时，它们提供了可扩展性。</p>

<h2>在CircleCI验证管道成功</h2>

<p>通过本教程，我们已经能够成功地运行我们的测试，但是这并不能证明它们将总是在CI上工作。为了增加我们对这个过程的信心，让我们提交我们的更改并再次推送到GitHub。由于我们已经配置了CircleCI，一旦更改被推送到GitHub远程存储库，构建应该会自动开始。</p>

<p><img src="../Images/becd1f05d0776645750c7b0ef84894f2.png" alt="Pipeline Run Success" srcset="https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-01-05-multiple-pipelines-success-state.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-01-05-multiple-pipelines-success-state.png"/></p>

<p>万岁！我们对三个测试文件的所有构建都进行了绿色检查。这只能意味着一件事:庆祝时间！</p>

<h2>结论</h2>

<p>在本教程中，我们了解了什么是k6框架以及它是如何工作的。我们了解到它是用<code>goja</code>语言创建的，但是是为使用ES6 JavaScript语法而编写的，这优化了它作为负载测试工具的性能。我们还学习了k6测试的不同生命周期阶段，以及如何编写和断言k6测试。我们学习了如何在多种环境中配置k6，并利用了k6中的<code>options</code>和<code>scenarios</code>对象。现在前进，走向成功！</p>

<p>通过完成使用k6 的<a href="/blog/api-performance-testing-with-k6/">性能测试API教程，以您所学为基础。</a></p>



        
          
          
            <hr/>
            <p>Waweru Mwaura是一名软件工程师，也是一名专门研究质量工程的终身学习者。他是Packt的作者，喜欢阅读工程、金融和技术方面的书籍。你可以在<a href="https://waweruh.github.io/" target="_blank" rel="noreferrer noopener">他的网页简介</a>上了解更多关于他的信息。</p>

            <p><a href="/blog/author/waweru-mwaura/" class="arrow-link">阅读更多Waweru Mwaura的帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>