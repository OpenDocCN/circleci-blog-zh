<html>
<head>
<title>Creating integrations, dashboards, notifications, and more using CircleCI webhooks | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用CircleCI webhooks | CircleCI创建集成、仪表板、通知等</h1>
<blockquote>原文：<a href="https://circleci.com/blog/using-circleci-webhooks/#2021-09-02T04:00:00-07:00">https://circleci.com/blog/using-circleci-webhooks/#2021-09-02T04:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>Webhooks允许服务和API之间的通信，这使它们成为我们互连的、基于云的应用环境的粘合剂。如果你熟悉API，你可以学习使用webhooks。CircleCI为我们的CI/CD平台提供了一个webhooks特性，允许您订阅和响应CircleCI事件，例如工作流和作业完成。</p>

<p>本教程展示了webhooks特性，并给出了入门步骤。它是为那些已经在使用CircleCI进行项目建设的人设计的。还有一个免费的<a href="https://github.com/CircleCI-Public/webhooks-consumer-sample">样本NodeJS webhook消费者项目</a>。</p>

<h2>webhooks和API有什么不同？</h2>

<p>webhooks和API的主要区别在于，对于开发者来说，API是一种<i>拉</i>体验，而webhooks是一种<i>推</i>体验。客户端从API请求数据。如果客户端需要更多数据，或者需要检查数据是否已经更新，它会发出另一个请求。使用webhook，一个服务(客户端)被设置为webhook端点，您将该端点交给另一个服务。另一个服务(在我们的例子中是CircleCI)在您感兴趣的事件发生时调用您的webhook端点。webhooks有很多用途，从GitHub集成到Discord聊天机器人、Slack通知等等。有成百上千种可能性。</p>

<p>CircleCI允许您为项目中的工作流和作业完成事件设置webhooks。当每个事件成功或不成功完成时，都会触发这些事件。</p>

<p>如果没有webhooks，这只能通过重复轮询CircleCI APIs来实现。为了以这种方式使用API，服务必须重复请求以获得最新的数据。这种方法对于开发团队来说并不理想，因为他们必须维护一个每天发出数百个(如果不是数千个)请求的服务。重复的API请求对CircleCI来说也不是什么好事，因为我们必须满足所有成千上万的请求。</p>

<h2>webhooks解锁的用例有哪些？</h2>

<p>在CI/CD环境中，webhooks允许您构建各种集成，如仪表板、数据记录和项目管理工具。Webhooks使您的团队能够自动通知下游客户，例如，通知他们需要更新的新版本。您可以在单个项目或多个项目上设置webhooks，然后聚合它们的事件。然后，您可以在后端以适合您的用例的方式处理它们。</p>

<h2>设置CircleCI webhook</h2>

<p>要使用CircleCI web界面在单个项目上设置新的webhook，请转到您的CircleCI项目的项目设置。选择<strong> Webhooks </strong>部分，然后点击<strong>添加Webhook </strong>按钮。</p>

<p><img src="../Images/a4f54e87bec78bccdd31810462debd41.png" alt="Setting up a webhook interface" srcset="https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_setup_2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-06-01-webhooks_setup_2.png"/></p>

<p>创建webhook时可以传递的选项有:</p>
<ul>
  <li>名字</li>
  <li>webhook将发送到的端点的URL</li>
  <li>要发送哪些事件</li>
  <li>证书验证</li>
  <li>秘密价值</li>
</ul>

<p>在示例图像中，我们使用Ngrok隧道从本地服务器生成的临时URL和一个秘密令牌<code>super-secret-1234</code>。当然，这只是举例说明一个观点；你的秘密将会不同。</p>

<p>点击<strong>保存网页挂钩</strong>将其打开。CircleCI会将所有工作流完成事件发送到您在URL字段中输入的端点。</p>

<h2>处理有效负载并响应webhook</h2>

<p>webhook将有效负载作为POST请求主体发送到您在设置它时指定的端点。</p>

<p>处理webhook <i>的服务器必须</i>发送一个200状态码作为响应，否则webhook可能会被重新发送多次，这可能会导致您这边出现重复事件。最佳实践是将所有传入的webhook有效负载传递给一个消息队列，比如RabbitMQ或亚马逊SQS，并异步处理它们。</p>

<h2>webhook有效负载中有什么？</h2>

<p>有效负载包含有关已完成工作流的信息，包括其名称、状态、计时、项目和管道、与之关联的提交以及开始管道执行的触发器。对于VCS提交请求，流水线触发器的值将是<code>webhook</code>。另外两个选项是:<code>api</code>和<code>schedule</code>。</p>

<p>以下是完整工作流有效负载的示例:</p>

<pre><code>{
  type: 'workflow-completed',
  id: 'f85a2fd5-108d-38e2-a990-fb49e7001515',
  happened_at: '2021-06-01T11:23:14.146Z',
  webhook: {
    id: '1154a973-e434-407c-8051-9259d8a53e99',
    name: 'Workflow Completed'
  },
  workflow: {
    id: '89b02ea5-7fca-4017-a902-747e68235ffd',
    name: 'do-all-the-things',
    status: 'success',
    created_at: '2021-06-01T11:23:07.441Z',
    stopped_at: '2021-06-01T11:23:13.942Z',
    url: 'https://app.circleci.com/pipelines/github/zmarkan/very-simple-non-app/26/workflows/89b02ea5-7fca-4017-a902-747e68235ffd'
  },
  pipeline: {
    id: 'ac0cc08f-67a2-4adb-9fa6-db633e390670',
    number: 26,
    created_at: '2021-06-01T11:23:07.371Z',
    trigger: { type: 'webhook' },
    vcs: {
      provider_name: 'github',
      origin_repository_url: 'https://github.com/zmarkan/very-simple-non-app',
      target_repository_url: 'https://github.com/zmarkan/very-simple-non-app',
      revision: 'f1e37011b5ff2d1703d4de9143c52ba650acae53',
      commit: [Object],
      branch: 'streamline'
    }
  },
  project: {
    id: 'e5c5dce3-7ef8-4227-9888-6b2b97b0a5ab',
    name: 'very-simple-non-app',
    slug: 'github/zmarkan/very-simple-non-app'
  },
  organization: { id: '8995ddc0-b07a-4bc2-8eb6-816c67a512fa', name: 'zmarkan' }
}
</code></pre>

<p>webhook中的所有对象都包含唯一的<code>id</code>字段。如果您需要来自CircleCI的更多上下文，您可以使用一个<code>id</code>来查询CircleCI APIs。</p>

<h2>验证webhook签名</h2>

<p>你的webhook端点可以从web上的任何地方接收事件，而不仅仅是CircleCI，不管是谁知道端点地址。您无法控制请求来自何处，因此验证事件发送方的完整性非常重要。你需要确保你没有让恶意的请求进来。</p>

<p>为了确保请求的安全性，webhooks允许秘密验证。当你建立一个新的webhook时，你可以传入一个<code>secret</code>值。在示例中，我们使用了<code>super-secret-1234</code>。CircleCI可以使用它来创建webhook请求体的HMAC SHA256摘要。当webhook有效载荷被接收时，秘密摘要在一个<code>circleci-signature</code>报头中。该值将是形式为<code>circleci-signature: v1=YOUR_HMAC_SHA256_DIGEST</code>的<code>v1</code>参数。</p>

<p>您可以通过使用相同的密钥和相同的算法创建您自己的请求主体的摘要来验证请求，然后将它们与<code>circleci-signature</code>头中的内容进行比较。如果两个值相同，您可以假设它确实来自CircleCI。不匹配的签名可能意味着它是由恶意参与者发送的。</p>

<p>下面是来自样本NodeJS Express应用程序的<a href="https://github.com/CircleCI-Public/webhooks-consumer-sample/blob/main/server.js#L38-L51">示例片段</a>:</p>

<pre><code>// req, res are Express objects

let signature = req.headers["circleci-signature"].substring(3)
const key = "super-secret-1234" // Same string as used in webhook setup
let testDigest = crypto.createHmac('sha256', key).update(JSON.stringify(req.body)digest('hex')

if (testDigest !== crypto.sign) {
    console.log("Webhook signature not matching")
    console.log(`Signature: ${signature}`)
    console.log(`Test digest: ${testDigest}`)
    res.status(403).send("Invalid signature")
}

</code></pre>

<h2>使用webhooks创建仪表板集成</h2>

<p>一旦您能够接收和处理webhooks，您就可以用它们构建许多类型的集成。我已经创建了一个示例仪表板，它显示了使用Vue和Express进入的工作流的状态。</p>

<p><img src="../Images/27fad929618427543f8a81c65a7b988a.png" alt="Sample webhooks dashboard" srcset="https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-06-01-webhooks_list.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-06-01-webhooks_list.png"/></p>

<p>你可以<a href="https://github.com/CircleCI-Public/webhooks-consumer-sample">在GitHub </a>上找到源代码。我用来测试webhooks的项目在GitHub 上也有<a href="https://github.com/zmarkan/very-simple-non-app">。</a></p>

<h2>结论</h2>

<p>CircleCI webhooks是将CircleCI pipelines与您的其他业务相集成的强大方法。从仪表板到项目跟踪再到通知，webhooks为创建获取和共享信息的新方法提供了许多可能性。在本教程中，您已经学习了如何开始为项目设置webhook，以便在工作流完成时通知您。既然您已经了解了一些处理webhooks和确保系统安全的最佳实践，我希望您和您的团队能够找到许多方法在自己的项目中使用它们。</p>

<p>如果你对我接下来要讨论的话题有任何反馈或建议，请通过<a href="https://twitter.com/zmarkan/"> Twitter - @zmarkan </a>联系我。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>