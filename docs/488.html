<html>
<head>
<title>Continuous deployment for Android libraries to Maven Central with Gradle | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Gradle | CircleCI将Android库持续部署到Maven Central</h1>
<blockquote>原文：<a href="https://circleci.com/blog/publishing-java-android-libraries/#2021-05-21T11:00:00-07:00">https://circleci.com/blog/publishing-java-android-libraries/#2021-05-21T11:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>本文将带您使用Gradle为构建、测试和发布库到Maven Central设置CI/CD集成。随着jCenter的关闭，Maven Central再次成为所有Android和Java库的主要目的地。在jCenter关闭后，库发布者需要将他们的库移植到Maven Central，以保持他们的库可用。</p>

<p>本文主要关注CI/CD集成。为手动发布设置库本身不在讨论范围之内，但是您可以找到一些有用的文章和入门指南的链接。</p>

<h2>先决条件</h2>

<p>要从这篇文章中获得最大的收获，您需要几样东西:</p>

<ul>
  <li>Android或Java的一些经验</li>
  <li>与格拉德的经历</li>
  <li>熟悉Java或Android库发布流程</li>
  <li>一个<a href="https://circleci.com/signup">圆</a>的账户</li>
</ul>

<h2>关于项目</h2>

<p><a href="https://github.com/zmarkan/Android-Espresso-ScrollableScroll">样本库</a>是我在2016年发布的测试工具。相关部分都在Gradle构建脚本和CircleCI配置:<code>.circleci/config.yaml</code>中。</p>

<p>有两个模块:</p>

<ul>
  <li>库模块<code>scrollableScroll</code>是正在发布的库</li>
  <li>Android应用模块<code>sample</code>是我们用来测试库的应用</li>
</ul>

<p>注意: <i>单独测试一个库有些困难。</i></p>

<h2>使用Gradle将库发布到Maven Central</h2>

<p>如果您以前没有使用Gradle to Maven Central发布过库，这一节是为您准备的。如果你做到了这一点，你可以跳到下一节。</p>

<p>Maven Central或者也叫Sonatype OSSRH(OSS Repository Hosting)提供了一个<a href="https://central.sonatype.org/publish/publish-guide/">官方指南</a>。</p>

<p>该过程需要几个步骤:</p>

<ol>
  <li><strong>注册一个<code>group</code>来发布。</strong>这可以是你的包名；对于我的项目，我使用了<code>com.zmarkan</code>。您需要创建一个吉拉帐户，并为Sonatype Nexus开一张票，以便为您创建一个群组。您将在该组下发布您的所有项目。请注意，如果您使用<code>com.[domain name]</code>命名法，您可能会被要求证明您拥有该域名。</li>
  <li><strong>准备你的图书馆出版和签名。</strong> Gradle有<code>maven-publish</code>和<code>signing</code>插件可以帮助解决这个问题。有几篇<a href="https://proandroiddev.com/publishing-your-first-android-library-to-mavencentral-be2c51330b88">文章</a>涵盖了这一过程。也有官方的分级指南——出版指南<a href="https://docs.gradle.org/current/userguide/publishing_maven.html">、签约指南</a>和签约指南<a href="https://docs.gradle.org/current/userguide/signing_plugin.html#using_in_memory_ascii_armored_openpgp_subkeys">。</a></li>
  <li>创建一个<a href="https://www.gnupg.org/gph/en/manual/c14.html"> GPG键</a>。这是你用来签署包裹的东西。</li>
</ol>

<p>您可以在GitHub 上的<a href="https://github.com/zmarkan/Android-Espresso-ScrollableScroll">我的示例项目中找到完整的示例。</a></p>

<p>如果你已经手动设置好了一切，你应该让<code>./gradlew assemble publish</code>开始工作，这意味着你已经准备好了。手动发布过程还要求您登录到web上的Maven Central，并且您需要手动关闭和发布在Gradle publish任务期间创建的临时存储库。</p>

<h2>使用Gradle持续部署库</h2>

<p>当然，上一节描述的过程适用于本地发布。在CI/CD环境中，这将略有不同。首先，我们不想执行所有这些手动任务。我使用的是Gradle Nexus发布插件，它建立在<code>maven-publish</code>配置的基础上，可以自动完成发布的最后一部分。</p>

<p>其次，我们需要确保所有的密钥都被安全地存储，并且在为<i>签名</i>的CI/CD过程中是可访问的。正确的<i>版本</i>也必须到位。</p>

<h3>使用Gradle Nexus发布插件自动发布</h3>

<p>这个Gradle插件提供了两个新的Gradle任务来代替现有的<code>publish</code> Gradle任务:</p>

<ul>
  <li><code>publishToSonatype</code></li>
  <li><code>closeAndReleaseSonatypeStagingRepository</code></li>
</ul>

<p>要包含插件，将其添加到项目级<code>build.gradle</code>文件:</p>

<pre><code>plugins {
    id "io.github.gradle-nexus.publish-plugin" version "1.0.0"
}

group = 'com.zmarkan' //Or whatever your Nexus publishing group is
version = findProperty('LIBRARY_VERSION')

// Rest of the setup ...

nexusPublishing {
    repositories {
        sonatype {  
            //only for users registered in Sonatype after 24 Feb 2021
            nexusUrl.set(uri("https://s01.oss.sonatype.org/service/local/"))
            snapshotRepositoryUrl.set(uri("https://s01.oss.sonatype.org/content/repositories/snapshots/"))
            username = findProperty('OSSRH_USERNAME')
            password = findProperty('OSSRH_PASSWORD')
        }
    }
}
</code></pre>
<p>在本例中，<code>username</code>和<code>password</code>值是我的Sonatype OSSRH凭证，与web界面和吉拉问题跟踪器相同。如果您不想使用自己的凭证，也可以在<a href="https://s01.oss.sonatype.org/#profile;User%20Token"> Sonatype OSSRH web UI </a>中创建单独的令牌。</p>

<p>您需要将凭证存储在您的<a href="https://circleci.com/docs/env-vars/#setting-an-environment-variable-in-a-project"> CircleCI环境变量</a>中，命名为<code>ORG_GRADLE_PROJECT_OSSRH_USERNAME</code>和<code>ORG_GRADLE_PROJECT_OSSRH_PASSWORD</code>。</p>

<p><strong>注意:</strong> <i>务必保留<code>ORG_GRADLE_PROJECT_</code>前缀。如果没有前缀，Gradle中的<code>findProperty</code>查找将不起作用。</i></p>

<h3>部署流程</h3>

<p>库的CI/CD管道做了几件事:</p>

<ul>
  <li>在每次提交时测试库。库测试在相应的示例应用程序上运行。这将尽快捕获任何会破坏构建的提交</li>
  <li><strong>从<code>main</code>分支释放一个<i>快照</i>。</strong>世界协调时每天午夜都会发生这种情况。它允许通过指向快照存储库来测试最新版本</li>
  <li>在每个标签上发布一个新版本。这是大多数最终用户在使用该库时会与之交互的版本</li>
</ul>

<p>建立一个CI/CD管道来发布你的库意味着你的发布过程将会一直工作，不管你的开发机器发生了什么，或者谁在做开发。您还将保护所有凭据或签名密钥的安全。</p>

<p>设置签名密钥是这个过程中最复杂的部分，所以我们应该开始了。</p>

<h3>签名密钥</h3>

<p>在CI/CD环境中对项目进行签名需要一个签名密钥，您可以在构建时将它传递给Gradle。为此，您需要以字符串格式导出密钥，并将密钥本身及其密码存储在CircleCI的环境变量中。最后，您需要在构建时将密钥本身注入到项目的<code>gradle.properties</code>中。</p>

<p>这意味着在你的库模块的<code>build.gradle</code>中，你可以使用<code>useInMemoryPgpKeys</code>函数来代替。这个函数使用基于字符串的<code>signingKey</code>而不是密匙环文件。这两个键都可以存储为Gradle属性或环境变量:</p>

<pre><code>def signingKey = findProperty('SIGNING_KEY')
def signingKeyPwd = findProperty('SIGNING_KEY_PWD')

signing {
    useInMemoryPgpKeys(signingKey, signingKeyPwd)
    sign publishing.publications
}
</code></pre>

<p>当您运行命令导出签名密钥时，请用用于生成密钥的电子邮件替换your_email@example.com。您将被要求提供创建签名密钥时使用的密码。</p>

<pre><code>gpg --armor --export-secret-keys zan@circleci.com \
    | awk -v ORS='\\n' '1' \
    | pbcopy
</code></pre>

<p>该命令的第一部分<code>gpg --armor --export-secret-keys</code>将您的密钥导出为ASCII字符串。<code>awk</code>命令用<code>\n</code>替换任何换行符，<code>pbcopy</code>将它存储在剪贴板中进行粘贴。</p>

<p>导出的密钥如下所示(注意中间大量的乱码行):</p>

<pre><code>-----BEGIN PGP PRIVATE KEY BLOCK-----

[hundreds of lines of crypto gibberish]

-----END PGP PRIVATE KEY BLOCK-----

</code></pre>

<p>然后，您可以在项目的环境设置中创建新的CircleCI签名变量<code>GPG_SIGNING_KEY</code>时粘贴它:</p>

<p><img src="../Images/4e66cfe7aa9b689b36f8e950824f34f8.png" alt="Setting the GPG key as environment variable" srcset="https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2021-04-maven-publish-environment-variable.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2021-04-maven-publish-environment-variable.png"/></p>

<p>您还需要添加该密钥的密码，作为用于签名的环境变量:<code>ORG_GRADLE_PROJECT_SIGNING_KEY_PWD</code>。注意，如果你想在Gradle中用<code>findProperty</code>直接使用密码，前缀<code>ORG_GRADLE_PROJECT_</code>是必需的。</p>

<p>至于键本身，我发现Gradle不喜欢它被存储为环境变量。我不得不在编译之前用<code>.circleci/config.yml</code>中的这个运行调用将它写入<code>gradle.properties</code>:</p>

<pre><code>- run:
    name: Inject Maven signing key
    command: |
      echo $GPG_SIGNING_KEY \
        | awk 'NR == 1 { print "SIGNING_KEY=" } 1' ORS='\\n' \
        &gt;&gt; gradle.properties
</code></pre>

<h3>用Git标签对库进行版本控制</h3>

<p>Maven Central中的所有项目都需要进行正确的版本控制。我喜欢使用Git标签来驱动版本控制，因为我们可以从命令行创建它们，并且它们总是与提交绑定在一起。</p>

<p>对于任何带标签的提交，CircleCI会将标签作为环境变量<code>$CIRCLE_TAG</code>出现。我用那个标签来表示一个发布版本的版本。对于所有其他缺少标记的提交，我将它们视为快照构建。</p>

<p>我们将把它存储为另一个环境变量<code>$ORG_GRADLE_PROJECT_LIBRARY_VERSION</code>,可以在Gradle中获取。使其可用的方法是在CircleCI的<code>run</code>步骤中将任何变量推送到<code>$BASH_ENV</code>。</p>

<p>这是我用的剧本。它或者将当前的Git标签设置为环境变量(例如<code>1.0.21</code>)，或者如果它丢失了，则使用最近使用的标签并在标签后附加<code>-SNAPSHOT</code>。</p>

<pre><code>- run:
    name: Define ORG_GRADLE_PROJECT_LIBRARY_VERSION Environment Variable at Runtime
    command: |
      if [ $CIRCLE_TAG ]
        then
          echo 'export ORG_GRADLE_PROJECT_LIBRARY_VERSION=$CIRCLE_TAG' &gt;&gt; $BASH_ENV
        else
          echo "export ORG_GRADLE_PROJECT_LIBRARY_VERSION=`git tag | tail -1`-SNAPSHOT" &gt;&gt; $BASH_ENV
      fi
      source $BASH_ENV
</code></pre>

<h3>将工件发布到Sonatype OSSRH</h3>

<p>发布的最后一步是在运行<code>assemble</code>之后立即运行两个Gradle publishing命令:</p>

<ul>
  <li><code>publishToSonatype</code></li>
  <li><code>closeAndReleaseSonatypeStagingRepository</code></li>
</ul>

<p>这将使用Sonatype Staging插件部署库及其所有工件，并将其发布到产品中。</p>

<pre><code>- run:
    name: Publish to Maven Central
    command: ./gradlew assemble publishToSonatype closeAndReleaseSonatypeStagingRepository
</code></pre>

<p>我的<code>.circleci/config.yml</code>中的完整部署工作:</p>

<pre><code>jobs:
  ...
  deploy-to-sonatype:
    executor:
      name: android/android-machine
      resource-class: xlarge
    steps:
      - checkout
      - run:
          name: Define ORG_GRADLE_PROJECT_LIBRARY_VERSION Environment Variable at Runtime
          command: |
            if [ $CIRCLE_TAG ]
              then
                echo 'export ORG_GRADLE_PROJECT_LIBRARY_VERSION=$CIRCLE_TAG' &gt;&gt; $BASH_ENV
              else
                echo "export ORG_GRADLE_PROJECT_LIBRARY_VERSION=`git tag | tail -1`-SNAPSHOT" &gt;&gt; $BASH_ENV
            fi
            source $BASH_ENV
      - run:
          name: Inject Maven signing key
          command: |
            echo $GPG_SIGNING_KEY \
              | awk 'NR == 1 { print "SIGNING_KEY=" } 1' ORS='\\n' \
              &gt;&gt; gradle.properties
      - run:
          name: Publish to Maven
          command: ./gradlew assemble publishToSonatype closeAndReleaseSonatypeStagingRepository
</code></pre>

<p>要让CircleCI运行此作业，您需要将其包含在工作流中。</p>

<h3>发布发布版本</h3>

<p>我的发布工作流程如下所示:</p>

<pre><code>workflows:
  build-test-deploy:
    jobs:
      - android/run-ui-tests:
          name: build-and-test
          system-image: system-images;android-23;google_apis;x86
          test-command: ./gradlew assemble sample:connectedDebugAndroidTest
          filters:
            tags:
              only: /^[0-9]+.*/
      - hold-for-approval:
          type: approval
          requires:
            - build-and-test
          filters:
            tags:
              only: /^[0-9]+.*/
            branches:
              ignore: /.*/
      - deploy-to-sonatype:
          name: Deploy to Maven Central
          requires:
            - hold-for-approval
          filters:
            tags:
              only: /^[0-9]+.*/
</code></pre>

<p>最佳实践是将测试设置为在任何分支的每一次提交时运行，但是只有在提交被标记为版本时才继续部署。这是第<code>filters</code>节所允许的。在这种情况下，部署作业只在以数字和句点开头的版本化标记上运行，比如<code>1.something</code>。这样，您仍然可以将标签用于其他目的，但是它们不会触发发布版本。</p>

<pre><code>filters:
  tags:
    only: /^[0-9]+.*/
  branches:
    ignore: /.*/
</code></pre>

<p>我还添加了一个<code>hold-for-approval</code>，这是一个<code>approval</code>作业，需要在部署库之前进行手动确认。这是可选的，但我发现手动步骤令人放心。</p>

<h3>发布快照</h3>

<p>快照是特殊类型的发布，发布速度更快，而且很容易被覆盖，不像常规的版本发布，不能被覆盖。这使得快照对于测试新版本的库非常有用。</p>

<p>要发布快照，您需要做的就是将<code>-SNAPSHOT</code>附加到版本字符串的末尾。该过程将在本文的版本控制一节中介绍。我已经设置了我的快照部署管道，以便使用CircleCI的预定触发器特性在世界协调时的每晚午夜构建库:</p>

<pre><code>  nightly-snapshot:
    triggers: #use the triggers key to indicate a scheduled build
      - schedule:
          cron: "0 0 * * *" # use cron syntax to set the schedule
          filters:
            branches:
              only:
                - main
    jobs:
      - android/run-ui-tests:
          name: build-and-test
          system-image: system-images;android-23;google_apis;x86
          test-command: ./gradlew assemblesample:connectedDebugAndroidTest
      - deploy-to-sonatype:
          name: Deploy Snapshot to Sonatype
          requires:
            - build-and-test
</code></pre>

<h2>结论</h2>

<p>在本文中，我介绍了如何使用Gradle为Maven Central的Android或Java库建立一个持续的部署管道。您已经学习了如何设置库签名的秘密，如何使用Git标记对库进行版本控制，以及如何在每次发布新标记时自动发布库。我希望这对您自己的项目有用。</p>

<p>如果你对我接下来应该报道的话题有任何反馈或建议，请通过<a href="https://twitter.com/zmarkan/"> Twitter - @zmarkan </a>联系我。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>