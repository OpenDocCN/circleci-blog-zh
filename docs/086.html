<html>
<head>
<title>Clojure web framework Duct - Build a Clojure web app | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Clojure webæ¡†æ¶ç®¡é“-æ„å»ºä¸€ä¸ªClojure webåº”ç”¨ç¨‹åº| CircleCI</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://circleci.com/blog/build-a-clojure-web-app-using-duct/#2019-02-12T07:01:00-08:00">https://circleci.com/blog/build-a-clojure-web-app-using-duct/#2019-02-12T07:01:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://clojure.org" target="_blank" rel="noreferrer noopener"> Clojure </a>å’Œä¸€ä¸ªåä¸º<a href="https://github.com/duct-framework/duct" target="_blank" rel="noreferrer noopener"> Duct </a>çš„æ¡†æ¶æ¥æ„å»ºä¸€ä¸ªæœåŠ¡å™¨ç«¯webåº”ç”¨ç¨‹åºã€‚ä¸ºä»€ä¹ˆæ˜¯ç®¡é“ï¼Ÿå¤§å¤šæ•°Clojure webåº”ç”¨ç¨‹åºéƒ½æ˜¯ä»¥å®šåˆ¶çš„æ–¹å¼æ„å»ºçš„ï¼Œä½¿ç”¨çš„æ˜¯ç”±å¼€å‘äººå‘˜æŒ‘é€‰å¹¶ç»„åˆåœ¨ä¸€èµ·çš„åº“é›†åˆã€‚Ductæä¾›äº†ä¸€ä¸ªæ¨¡å—åŒ–æ¡†æ¶ï¼Œå‡å°‘äº†æœç´¢è¿™äº›åº“çš„å·¥ä½œé‡ï¼Œä½¿æ‚¨èƒ½å¤Ÿæ›´å¿«åœ°å¯åŠ¨å’Œè¿è¡Œä¸€ä¸ªåŸºæœ¬çš„æœåŠ¡å™¨ç«¯webåº”ç”¨ç¨‹åºã€‚è¿˜æœ‰å…¶ä»–Clojure webæ¡†æ¶ï¼Œä½†æ˜¯Ductæœ‰å¾ˆå¥½çš„é»˜è®¤ç»„åˆï¼Œä¸éœ€è¦å¤ªå¤šçš„å­¦ä¹ æ›²çº¿ã€‚</p>



<p>æˆ‘å‡è®¾ä½ æœ‰ä¸€å®šçš„ClojureåŸºç¡€çŸ¥è¯†ã€‚å¦‚æœä½ æ˜¯Clojureçš„æ–°æ‰‹ï¼Œçœ‹çœ‹<a href="https://www.braveclojure.com/" target="_blank" rel="noreferrer noopener">clo jure for the Brave and True</a>ã€<a href="https://aphyr.com/posts/301-clojure-from-the-ground-up-welcome" target="_blank" rel="noreferrer noopener">clo jure from the ground</a>ï¼Œæˆ–è€…<a href="https://clojurebridgelondon.github.io/" target="_blank" rel="noreferrer noopener">ä¼¦æ•¦ClojureBridgeç½‘ç«™</a>ä¸Šçš„å¤§é‡æœ‰ç”¨èµ„æºã€‚</p>

<p>å¦‚æœä½ æƒ³çœ‹å®Œæ•´çš„ä»£ç ï¼Œæˆ‘å·²ç»æŠŠå®ƒæäº¤åˆ°GitHub <a href="https://github.com/chrishowejones/blog-film-ratings" target="_blank" rel="noreferrer noopener">è¿™é‡Œ</a>ã€‚</p>

<h2>å…ˆå†³æ¡ä»¶</h2>

<p>ä¸ºäº†æ„å»ºè¿™ä¸ªwebåº”ç”¨ç¨‹åºï¼Œæ‚¨éœ€è¦å®‰è£…ä»¥ä¸‹è½¯ä»¶:</p>

<ol>
  <li><a href="https://openjdk.java.net/install/" target="_blank" rel="noreferrer noopener"> Java JDK 8æˆ–æ›´é«˜ç‰ˆæœ¬</a> - Clojureè¿è¡Œåœ¨Javaè™šæ‹Ÿæœºä¸Šï¼Œäº‹å®ä¸Šï¼Œå®ƒåªæ˜¯ä¸€ä¸ªJavaåº“(JAR)ã€‚æˆ‘ç”¨ç‰ˆæœ¬8æ„å»ºäº†è¿™ä¸ªï¼Œä½†æ˜¯ä¸€ä¸ªæ›´å¥½çš„ç‰ˆæœ¬åº”è¯¥ä¹Ÿå¯ä»¥ã€‚</li>
  <li><a href="https://leiningen.org/" target="_blank" rel="noreferrer noopener"> Leiningen </a> - Leiningenï¼Œé€šå¸¸ç®€ç§°ä¸ºlein(è¯»ä½œâ€˜lineâ€™)ï¼Œæ˜¯æœ€å¸¸ç”¨çš„Clojureæ„å»ºå·¥å…·ã€‚</li>
  <li>Git  -æ— å¤„ä¸åœ¨çš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚</li>
</ol>

<h2>è·å¾—åŸºæœ¬çš„webåº”ç”¨ç¨‹åº</h2>

<p>å…³äºDuctçš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒçš„leinæ¨¡æ¿ç»™ä½ ä¸€ä¸ªç°æˆçš„webåº”ç”¨ç¨‹åºæ¡†æ¶ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒä¸ºæ‚¨çš„webåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªèµ·ç‚¹ï¼Œå…è®¸æ‚¨è¾“å…¥å¹¶åˆ—å‡ºæ¯éƒ¨ç”µå½±çš„æè¿°å’Œè¯„çº§ã€‚å¯¹äºè¿™ä¸ªå…¥é—¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SQLiteä½œä¸ºå¼€å‘çš„æ•°æ®åº“å¼•æ“ã€‚åœ¨ä»¥åçš„åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ­¤è¿›è¡Œé‡æ„ä»¥ä½¿ç”¨PostgreSQLã€‚ä»¥ä¸‹å‘½ä»¤å°†ä¸ºæ‚¨æä¾›ä¸€ä¸ªå…·æœ‰æˆ‘ä»¬æ‰€éœ€çš„åŸºæœ¬ç»“æ„çš„åˆå§‹é¡¹ç›®:</p>

<pre><code class="language-bash">$ lein new duct film-ratings +site +ataraxy +sqlite +example
</code></pre>

<p>è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸ºâ€œç”µå½±åˆ†çº§â€çš„æ–°ç›®å½•ï¼Œå…¶ç»“æ„å¦‚ä¸‹:</p>

<pre><code>.
â”œâ”€â”€ db
â”œâ”€â”€ dev
â”‚   â”œâ”€â”€ resources
â”‚   â”‚   â””â”€â”€ dev.edn
â”‚   â””â”€â”€ src
â”‚       â”œâ”€â”€ dev.clj
â”‚       â””â”€â”€ user.clj
â”œâ”€â”€ project.clj
â”œâ”€â”€ README.md
â”œâ”€â”€ resources
â”‚   â””â”€â”€ film_ratings
â”‚       â”œâ”€â”€ config.edn
â”‚       â”œâ”€â”€ handler
â”‚       â”‚   â””â”€â”€ example
â”‚       â”‚       â””â”€â”€ example.html
â”‚       â””â”€â”€ public
â”œâ”€â”€ src
â”‚   â””â”€â”€ film_ratings
â”‚       â”œâ”€â”€ boundary
â”‚       â”œâ”€â”€ handler
â”‚       â”‚   â””â”€â”€ example.clj
â”‚       â””â”€â”€ main.clj
â””â”€â”€ test
    â””â”€â”€ film_ratings
        â”œâ”€â”€ boundary
        â””â”€â”€ handler
            â””â”€â”€ example_test.clj
</code></pre>

<p>æˆ‘ä»¬ç¨åå°†ç ”ç©¶è¿™äº›æ–‡ä»¶ï¼Œä½†æ˜¯ç°åœ¨ï¼Œæ‚¨éœ€è¦ä¸ºDuctç”Ÿæˆæœ¬åœ°é…ç½®ã€‚è¿™ä¸ªé…ç½®åªæ˜¯ä¸ºæ‚¨çš„æœºå™¨å‡†å¤‡çš„ï¼Œå¹¶ä¸”ä¼šä½¿ç”¨åœ¨<code>.gitignore</code>æ–‡ä»¶ä¸­ä¸ºæ‚¨ç”Ÿæˆçš„æ¡ç›®è‡ªåŠ¨ä»Gitå­˜å‚¨åº“ä¸­æ’é™¤ã€‚è¦ç”Ÿæˆæ­¤æœ¬åœ°é…ç½®ï¼Œè¯·è¾“å…¥:</p>

<pre><code class="language-bash">$ lein duct setup
</code></pre>

<h2>è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å®ƒæ˜¯å¦è¿è¡Œ</h2>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥è¿è¡Œåº”ç”¨ç¨‹åºæ¥æ£€æŸ¥æˆ‘ä»¬çš„è®¾ç½®æ˜¯å¦æ­£å¸¸ã€‚ä¸ºæ­¤ï¼Œè¯·è¾“å…¥ä»¥ä¸‹å‘½ä»¤:</p>

<pre><code class="language-bash">$ lein repl
nREPL server started on port 37347 on host 127.0.0.1 - nrepl://127.0.0.1:37347
REPL-y 0.3.7, nREPL 0.2.12
Clojure 1.9.0
...
user=&gt; (dev)
:loaded
dev=&gt; (go)
:duct.server.http.jetty/starting-server {:port 3000}
:initiated
dev=&gt;
</code></pre>

<p>è¿™å°†å¯åŠ¨åº”ç”¨ç¨‹åºç›‘å¬ç«¯å£<code>3000</code>ã€‚æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ç½‘å€<code>http://localhost:3000/</code>ï¼Œä½ ä¼šçœ‹åˆ°:</p>

<p><img src="../Images/bb9a9f906d5cfcb4db4fcda9dd0d30fb.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545428593521_resource-not-found.png"/></p>

<p>è¿™å¯èƒ½çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Œä½†æ˜¯æœåŠ¡å™¨æ­£åœ¨å·¥ä½œã€‚åªæ˜¯ä½ æ²¡æœ‰è·¯å¾„<code>/</code>çš„è·¯çº¿ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹åº”ç”¨ç¨‹åºçš„é…ç½®ã€‚åœ¨æ‚¨æœ€å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨æˆ–IDEä¸­æ‰“å¼€æ–‡ä»¶<code>film-ratings/resources/film_ratings/config.edn</code>,æ‚¨ä¼šçœ‹åˆ°:</p>

<pre><code class="language-clojure">{:duct.core/project-ns  film-ratings
 :duct.core/environment :production
    
 :duct.module/logging {}
 :duct.module.web/site {}
 :duct.module/sql {}
    
 :duct.module/ataraxy
 {[:get "/example"] [:example]}
    
 :film-ratings.handler/example
 {:db #ig/ref :duct.database/sql}}
</code></pre>

<p>è¿™æ˜¯ç®¡é“çš„åŸºæœ¬é…ç½®æ–‡ä»¶ã€‚å®ƒæŒ‡å®šäº†é¡¹ç›®åç§°ç©ºé—´ã€ç›®æ ‡ç¯å¢ƒ(åœ¨æœ¬ä¾‹ä¸­æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå°½ç®¡æ‚¨å°†åœ¨åé¢æŸ¥çœ‹å¼€å‘é…ç½®)ï¼Œä»¥åŠæ—¥å¿—ã€ç«™ç‚¹å’ŒSQLé…ç½®çš„ä¸€äº›å ä½ç¬¦ã€‚</p>

<p>è¯¥æ–‡ä»¶ä¸­æœ€æœ‰è¶£çš„è¡Œæ˜¯:</p>

<pre><code class="language-clojure"> :duct.module/ataraxy
 {[:get "/example"] [:example]}
    
 :film-ratings.handler/example
 {:db #ig/ref :duct.database/sql}}
</code></pre>

<p>å®ƒä»¬æŒ‡å®šå¦‚ä½•å°†URLæ˜ å°„åˆ°å¤„ç†URLçš„HTTPè¯·æ±‚çš„å¤„ç†å‡½æ•°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåä¸º<code>ataraxy</code>çš„åº“æ¥æŒ‡å®šä»URLåˆ°å‡½æ•°çš„è·¯å¾„ã€‚æ‚¨å¯ä»¥åœ¨<code>:duct.module/ataraxy</code>æ˜ å°„æ¡ç›®ä¸­çœ‹åˆ°ï¼Œæ¨¡æ¿ç”Ÿæˆäº†ä¸€ä¸ªè·¯ç”±ï¼Œå°†å¯¹URL <code>/example</code>çš„HTTP GETè¯·æ±‚æ˜ å°„åˆ°å…³é”®å­—<code>:example</code>ã€‚</p>

<p>ç”±äºå·²ç»ä¸º<code>/example</code>å®šä¹‰äº†ä¸€æ¡è·¯çº¿ï¼Œæ‚¨å¯ä»¥åœ¨æµè§ˆå™¨ä¸­é”®å…¥<code>http://localhost:3000/example</code>,æ‚¨å°†ä¼šçœ‹åˆ°:</p>

<p><img src="../Images/43928505688996c5221b23ec150d127e.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545431102460_example-handler.png"/></p>

<h2>å¤„ç†è¯·æ±‚</h2>

<p><code>{[:get "/example"] [:example]}</code>è·¯ç”±å¦‚ä½•æœåŠ¡äºè¿™ä¸ªç¤ºä¾‹å¤„ç†ç¨‹åºé¡µé¢ï¼Ÿ</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDuctå‡è®¾è·¯ç”±å€¼(<code>:example</code>)ä¸­çš„å…³é”®å­—å°†ä»¥<code>{{project-ns}}.handler</code>ä¸ºå‰ç¼€ï¼Œå®ƒå°†æŸ¥æ‰¾è¯¥å…³é”®å­—æ¥ç¡®å®šå¤„ç†ç¨‹åºé…ç½®ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>film-ratings.handler/example</code>åœ¨å®ƒçš„é€‰é¡¹å€¼ä¸­å®šä¹‰äº†ä¸€ä¸ªå¯¹<code>:duct.database/sql</code>é”®çš„é›†æˆå¼•ç”¨ã€‚<a href="https://github.com/weavejester/integrant" target="_blank" rel="noreferrer noopener"> Integrant </a>æ˜¯ä¸€ä¸ªå¾®æ¡†æ¶ï¼Œå®ƒæ„å»ºä¸€ä¸ªé…ç½®ï¼Œç„¶åé€šè¿‡ä»¥æ­£ç¡®çš„é¡ºåºå¯åŠ¨é…ç½®ä¸­å®šä¹‰çš„ç»„ä»¶æ¥æ„å»ºä¸€ä¸ªè¿è¡Œç³»ç»Ÿã€‚ç¨åæˆ‘ä»¬å°†å†æ¬¡è®¨è®ºæ•°æ®åº“é€‰é¡¹ã€‚ç°åœ¨ï¼Œåªéœ€æ³¨æ„ï¼ŒDuctå¯»æ‰¾ä¸€ä¸ªæ•´åˆé”®æ¥ç¡®å®šå“ªä¸ªå‡½æ•°å……å½“å¤„ç†ç¨‹åºã€‚</p>

<p>æ‚¨å°†åœ¨æ–‡ä»¶<code>film-ratings/src/film_ratings/handler/example.clj</code>ä¸­æ‰¾åˆ°å¤„ç†å‡½æ•°:</p>

<pre><code class="language-clojure">(defmethod ig/init-key :film-ratings.handler/example [_ options]
  (fn [{[_] :ataraxy/result}]
    [::response/ok (io/resource "film_ratings/handler/example/example.html")]))
</code></pre>

<p>å¤„ç†ç¨‹åºæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›å¦ä¸€ä¸ªæ¥å—HTTPè¯·æ±‚å¹¶è¿”å›å“åº”çš„å‡½æ•°ã€‚è¿™é‡Œçš„å†…éƒ¨å‡½æ•°åªæ˜¯è¿”å›ä¸€ä¸ªå‘é‡ï¼Œå‘Šè¯‰ataraxyè¿”å›ä¸€ä¸ªçŠ¶æ€200 (OK)å’Œä½œä¸ºå“åº”ä¸»ä½“çš„<code>example.html</code>æ–‡ä»¶ã€‚</p>

<p>Integrantæ ¹æ®é…ç½®ä¸ºå¤„ç†ç¨‹åºæä¾›åˆå§‹åŒ–é€‰é¡¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ä½¿ç”¨è¿™äº›é€‰é¡¹ï¼Œä½†è¿™æ˜¯ä¸€ç§å¤„ç†æ•°æ®åº“ç­‰èµ„æºçš„æ–¹å¼ã€‚</p>

<h2>è®¾ç½®æŒç»­é›†æˆ</h2>

<p>åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æäº¤åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ‰€æ‹¥æœ‰çš„Gitå¹¶å»ºç«‹æˆ‘ä»¬çš„æŒç»­é›†æˆæ„å»ºã€‚</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨æœ¬åœ°åˆ›å»ºGitå­˜å‚¨åº“ã€‚æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ä¼šè¯(ä¿æŒè¿è¡Œçš„ç»ˆç«¯ä¼šè¯<code>lein</code>æ‰“å¼€),å¹¶ä»<code>film-handler</code>æ ¹ç›®å½•è¾“å…¥ä»¥ä¸‹å‘½ä»¤:</p>

<pre><code class="language-bash">$ git init
$ git add .
$ git commit -m "Duct app generated w/ +site +ataraxy +sqlite +example"
</code></pre>

<p>æ­¤æ—¶ï¼Œæ‚¨å°†éœ€è¦ä¸€ä¸ªGitHubå¸æˆ·ã€‚å¦‚æœä½ æ²¡æœ‰ï¼Œåœ¨<a href="https://github.com"> GitHub </a>æ³¨å†Œã€‚ç™»å½•æ‚¨çš„å¸æˆ·ï¼Œæ·»åŠ ä¸€ä¸ªåä¸º<code>film-handler</code>çš„æ–°å­˜å‚¨åº“ã€‚å¤åˆ¶å­˜å‚¨åº“çš„URLï¼Œå¹¶åœ¨ä»¥ä¸‹å‘½ä»¤ä¸­ä½¿ç”¨å®ƒ:</p>

<pre><code class="language-bash">$ git remote add origin &lt;github repo url&gt;
$ git push --set-upstream origin master
</code></pre>

<p>å¦‚æœæ‚¨çš„URLæ˜¯<code>https</code>ç‰ˆæœ¬ï¼Œæ‚¨å°†è¢«æç¤ºè¾“å…¥æ‚¨çš„GitHubç”¨æˆ·åå’Œå¯†ç (å¦‚æœæ‚¨å¯ç”¨äº†å¤šé‡èº«ä»½éªŒè¯ï¼Œæ‚¨å°†éœ€è¦åœ¨GitHubä¸­ç”Ÿæˆä¸€ä¸ª<a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/" target="_blank" rel="noreferrer noopener">ä¸ªäººè®¿é—®ä»¤ç‰Œ</a>ä»¥ç”¨ä½œå¯†ç )ã€‚</p>

<p>æ‚¨ç°åœ¨åœ¨GitHubä¸­æœ‰äº†è‡ªå·±çš„ä»£ç ã€‚æˆ‘ä»¬å°†ä½¿ç”¨CircleCIæ¥è¿è¡ŒæŒç»­é›†æˆæ„å»ºã€‚å»<a href="https://circleci.com/" target="_blank" rel="noreferrer noopener">https://circleci.com/</a>åˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼Œç”¨ä½ çš„GitHubè¯ä¹¦æ³¨å†Œã€‚</p>

<p>åœ¨å‘Šè¯‰CircleCIå¦‚ä½•è¿è¡Œä¸€ä¸ªæ„å»ºä¹‹å‰ï¼Œæœ‰å¿…è¦æ‰‹åŠ¨è¿è¡Œä¸€ä¸ª:</p>

<pre><code class="language-bash">$ lein do test, uberjar
    
lein test film-ratings.handler.example-test
    
Ran 1 tests containing 1 assertions.
0 failures, 0 errors.
Compiling film-ratings.main
Compiling film-ratings.handler.example
Created .../film-ratings/target/film-ratings-0.1.0-SNAPSHOT.jar
Created .../film-ratings/target/film-ratings-0.1.0-SNAPSHOT-standalone.jar
</code></pre>

<p>æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œè¿™è¿è¡Œäº†ä¸€ä¸ªæµ‹è¯•ï¼Œç„¶åå°†åº”ç”¨ç¨‹åºæ‰“åŒ…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„Uber jar(Uber jaræ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰æ‰€éœ€åº“çš„å•ä¸€å½’æ¡£æ–‡ä»¶)ã€‚è®©æˆ‘ä»¬é€šè¿‡ç¼–è¾‘<code>project.clj</code>æ–‡ä»¶å¹¶æ·»åŠ ä¸€ä¸ªuberjar-nameé”®å€¼æ¥ç®€åŒ–uberjarçš„åç§°:</p>

<pre><code class="language-clojure">...
  :main ^:skip-aot film-ratings.main
  :uberjar-name "film-ratings.jar"
  :resource-paths ["resources" "target/resources"]
...
</code></pre>

<p>å¦‚æœæ‚¨é‡æ–°è¿è¡Œ<code>lein do test, uberjar</code>ï¼Œæ‚¨å°†çœ‹åˆ°jaråç§°è¢«æ›´æ”¹ä¸º<code>film-ratings.jar</code>ã€‚ç°åœ¨æ˜¯æ—¶å€™ç»™æ ¹<code>film-handler</code>ç›®å½•æ·»åŠ ä¸€ä¸ª<code>.circleci</code>ç›®å½•å’Œä¸€ä¸ª<code>config.yml</code>ç›®å½•äº†ã€‚</p>

<pre><code class="language-bash">$ mkdir .circleci
$ cd .circleci
$ touch config.yml
$ cd ..
</code></pre>

<p>ç°åœ¨ç¼–è¾‘ç©ºçš„<code>config.yml</code>å¾—åˆ°ä¸‹é¢å‡ è¡ŒYAMLä»£ç ã€‚</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    working_directory: ~/cci-film-ratings # directory where steps will run
    docker:
      - image: circleci/clojure:lein-2.8.1
    environment:
      LEIN_ROOT: nbd
      JVM_OPTS: -Xmx3200m # limit the maximum heap size to prevent out of memory errors
    steps:
      - checkout
      - restore_cache:
          key: film-ratings-{{ checksum "project.clj" }}
      - run: lein deps
      - save_cache:
          paths:
            - ~/.m2
          key: film-ratings-{{ checksum "project.clj" }}
      - run: lein do test, uberjar
</code></pre>

<p>ç„¶åæˆ‘ä»¬éœ€è¦å°†ç¼–è¾‘å¥½çš„<code>project.clj</code>æ–‡ä»¶å’ŒCircleCIé…ç½®æ·»åŠ åˆ°GitHubä¸­ã€‚</p>

<pre><code class="language-bash">$ git add .
$ git commit -m "Added circleci"
$ git push origin
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œè¿›å…¥ä½ çš„CircleCIè´¦æˆ·ï¼Œé€‰æ‹©<strong>æ·»åŠ é¡¹ç›®</strong>ã€‚ä»åˆ—è¡¨ä¸­é€‰æ‹©æ‚¨çš„å›è´­ï¼Œç„¶åç‚¹å‡»<strong>è®¾ç½®é¡¹ç›®</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ“ä½œç³»ç»Ÿå’Œè¯­è¨€åº”è¯¥é¢„å…ˆé€‰æ‹©ä¸º<code>Linux</code>å’Œ<code>Clojure</code>ï¼Œæ‰€ä»¥åªéœ€ç‚¹å‡»<strong>å¼€å§‹æ„å»º</strong>ã€‚å¦‚æœæ‚¨éšåå•å‡»<strong> Building </strong>å¹¶è¿›å…¥æ„å»ºä½œä¸šï¼Œæ‚¨å°†çœ‹åˆ°æ„å»ºæ­£åœ¨è¿è¡Œï¼Œæœ€ç»ˆæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªæˆåŠŸçš„æ„å»ºã€‚</p>

<p><img src="../Images/e7cdf313e334e9e7093eba38c97765cd.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545470033153_circleci-build.png"/></p>

<h2>æ·»åŠ ç´¢å¼•é¡µ</h2>

<p>æ‚¨å¹¶ä¸çœŸçš„éœ€è¦è¿™ä¸ªç¤ºä¾‹é¡µé¢ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åšä¸€äº›æ›´æ”¹æ¥åˆ é™¤å®ƒï¼Œå¹¶ä¸º<code>/</code>è·¯çº¿æ·»åŠ ä¸€ä¸ªç´¢å¼•é¡µé¢ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ç¼–è¾‘<code>config.edn</code>æ¥åˆ é™¤ç¤ºä¾‹è·¯ç”±å¹¶æ·»åŠ æ–°çš„ç´¢å¼•è·¯ç”±ã€‚é…ç½®åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:</p>

<pre><code class="language-clojure">{:duct.core/project-ns  film-ratings
 :duct.core/environment :production
    
 :duct.module/logging {}
 :duct.module.web/site {}
 :duct.module/sql {}
    
 :duct.module/ataraxy
 {[:get "/"] [:index]}
    
 :film-ratings.handler/index {}
}
</code></pre>

<p>æ‚¨ç°åœ¨éœ€è¦ä¸ºç´¢å¼•é¡µé¢åˆ›å»ºä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œå› æ­¤åœ¨<code>film-ratings/src/film_ratings/handler</code>ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>index.clj</code>çš„æ–‡ä»¶ã€‚å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ç´¢å¼•æ–‡ä»¶ä¸­:</p>

<pre><code class="language-clojure">(ns film-ratings.handler.index
  (:require [ataraxy.core :as ataraxy]
            [ataraxy.response :as response]
            [film-ratings.views.index :as views.index]
            [integrant.core :as ig]))
    
(defmethod ig/init-key :film-ratings.handler/index [_ options]
  (fn [{[_] :ataraxy/result}]
    [::response/ok (views.index/list-options)]))
</code></pre>

<p>è¿™ä¸ª<code>defmethod</code>ç”¨ä¸€ä¸ªå¤„ç†å‡½æ•°åˆå§‹åŒ–<code>:film-ratings.handler/index</code>é”®ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°æ¥å—ä¸€ä¸ªè¯·æ±‚å¹¶è§£ç»“æ„ataraxyè·¯ç”±çš„ç»“æœã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰å‘½åå®ƒï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«ä½¿ç”¨ã€‚æ‚¨è¿˜å¯ä»¥çœ‹åˆ°<code>defmethod</code>çš„ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå°†æ˜¯å…³é”®å­—keyï¼Œ<code>:film-ratings.handler/index</code>ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨configä¸­å®šä¹‰çš„ä»»ä½•åˆå§‹åŒ–çš„é€‰é¡¹ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¹Ÿæ²¡æœ‰ä½¿ç”¨ã€‚</p>

<p>è¿™ä¸ªå¤„ç†ç¨‹åºç°åœ¨å¼•ç”¨äº†ä¸€ä¸ªä¸å­˜åœ¨çš„<code>film-ratings.views.index</code>åç§°ç©ºé—´ä¸­çš„<code>list-options</code>å‡½æ•°ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚æ·»åŠ ä¸€ä¸ªåä¸º<code>film-ratings/src/film_ratings/views</code>çš„æ–°ç›®å½•ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„<code>index.clj</code>æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«:</p>

<pre><code class="language-clojure">(ns film-ratings.views.index
  (:require [film-ratings.views.template :refer [page]]))
    
(defn list-options []
  (page
    [:div.container.jumbotron.bg-white.text-center
     [:row
      [:p
       [:a.btn.btn-primary {:href "/add-film"} "Add a Film"]]]
     [:row
      [:p
       [:a.btn.btn-primary {:href "/list-films"} "List Films"]]]]))
</code></pre>

<p>æ‚¨å¯ä»¥çœ‹åˆ°,<code>list-options</code>å‡½æ•°è¿”å›äº†ä¸€ä¸ªç±»ä¼¼HTMLçš„æ•°æ®ç»“æ„ï¼Œè¯¥ç»“æ„å°è£…åœ¨å¯¹<code>page</code>å‡½æ•°çš„å‡½æ•°è°ƒç”¨ä¸­ï¼›å†è¯´ä¸€éï¼Œé‚£è¿˜ä¸å­˜åœ¨ã€‚ä½¿ç”¨ä¸€ä¸ªåä¸º<a href="https://github.com/weavejester/hiccup" target="_blank" rel="noreferrer noopener"> hiccup </a>çš„åº“å°†è¿™ç§ç±»ä¼¼HTMLçš„æ•°æ®ç»“æ„è½¬æ¢æˆçœŸæ­£çš„HTMLã€‚ä¸ºäº†ä½¿ç”¨hiccupï¼Œæ‚¨éœ€è¦å°†å®ƒä½œä¸ºä¸€ä¸ªä¾èµ–é¡¹æ·»åŠ åˆ°<code>project.clj</code>æ–‡ä»¶ä¸­:</p>

<pre><code class="language-clojure">  :dependencies [[org.clojure/clojure "1.9.0"]
                 [duct/core "0.6.2"]
                 [duct/module.logging "0.3.1"]
                 [duct/module.web "0.6.4"]
                 [duct/module.ataraxy "0.2.0"]
                 [duct/module.sql "0.4.2"]
                 [org.xerial/sqlite-jdbc "3.21.0.1"]
                 [hiccup "1.0.5"]]
</code></pre>

<p>ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ç´¢å¼•è§†å›¾åç§°ç©ºé—´ä¸­å¼•ç”¨çš„<code>page</code>å‡½æ•°ã€‚åˆ›å»ºä¸€ä¸ª<code>film-ratings/src/film_ratings/views/template.clj</code>æ–‡ä»¶:</p>

<pre><code class="language-clojure">(ns film-ratings.views.template
  (:require [hiccup.page :refer [html5 include-css include-js]]
            [hiccup.element :refer [link-to]]
            [hiccup.form :as form]))
    
(defn page
  [content]
  (html5
    [:head
     [:meta {:name "viewport" :content "width=device-width, initial-scale=1, shrink-to-fit=no"}]
     [:title "Film Ratings"]
     (include-css "https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css")
     (include-js
       "https://code.jquery.com/jquery-3.3.1.slim.min.js"
       "https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
       "https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js")
     [:body
      [:div.container-fluid
       [:div.navbar.navbar-dark.bg-dark.shadow-sm
        [:div.container.d-flex.justify-content-between
         [:h1.navbar-brand.align-items-center.text-light "Film Ratings"]
         (link-to {:class "py-2 text-light"} "/" "Home")]]
       [:section
        content]]]]))
    
(defn labeled-radio [group]
  (fn [checked? label]
    [:div.form-check.col
     (form/radio-button {:class "form-check-input"} group checked? label)
     (form/label {:class "form-check-label"} (str "label-" label) (str label))]))
</code></pre>

<p>æ‚¨è¿˜å¯ä»¥çœ‹åˆ°å¦ä¸€ä¸ªå‡½æ•°<code>labeled-radio</code>ï¼Œå®ƒè¿”å›å•é€‰æŒ‰é’®çš„hiccupã€‚ä½ ä»¥åä¼šéœ€è¦è¿™ä¸ªçš„ã€‚æ‚¨ç°åœ¨å¯ä»¥åˆ é™¤<code>film-ratings/src/film_ratings/handler/example.clj</code>å’Œ<code>film-ratings/test/film_ratings/handler/example_test.clj</code>æ–‡ä»¶ä»¥åŠ<code>film-ratings/resources/handler/example</code>ç›®å½•å’Œå†…å®¹ã€‚</p>

<h2>è¿è¡Œæ–°çš„ç´¢å¼•é¡µé¢</h2>

<p>è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ç´¢å¼•é¡µé¢æ˜¯å¦æ­£ç¡®å‘ˆç°ã€‚</p>

<p>å›åˆ°æ‚¨æ­£åœ¨è¿è¡Œçš„<code>lein repl</code>ç»ˆç«¯ã€‚é€šå¸¸ï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨replä¸­è¿è¡Œ<code>(reset)</code>æ¥åˆ·æ–°åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ä¾èµ–é¡¹(hiccup)ã€‚è¿™éœ€è¦é€šè¿‡é‡æ–°å¯åŠ¨replæ¥é‡æ–°åŠ è½½ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<pre><code class="language-bash">user=&gt; (quit)
Bye for now!
$ lein repl
...
user=&gt; (dev)
:loaded
dev=&gt; (go)
:duct.server.http.jetty/starting-server {:port 3000}
:initiated
dev=&gt;
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œæ‰“å¼€æµè§ˆå™¨è¿›å…¥<code>http://localhost:3000/</code> URLï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°:</p>

<p><img src="../Images/871fabf192991a749354c2eef90a2f64.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545474237654_index.png"/></p>

<p>åœ¨æäº¤è¿™äº›æ›´æ”¹ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºç´¢å¼•é¡µé¢æ·»åŠ ä¸€ä¸ªæµ‹è¯•ï¼Œä»¥é˜²æˆ‘ä»¬åœ¨æŸä¸ªæ—¶å€™æ„å¤–ç ´åå®ƒã€‚åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„æ–‡ä»¶<code>film-ratings/test/film_ratings/handler/index_test.clj</code>:</p>

<pre><code class="language-clojure">(ns film-ratings.handler.index-test
  (:require [film-ratings.handler.index]
            [clojure.test :refer [deftest testing is]]
            [ring.mock.request :as mock]
            [integrant.core :as ig]))
    
(deftest check-index-handler
  (testing "Ensure that the index handler returns two links for add and list films"
    (let [handler (ig/init-key :film-ratings.handler/index {})
          response (handler (mock/request :get "/"))]
      (is (= :ataraxy.response/ok (first response)))
      (is (= "href=\"/add-film\""
            (re-find #"href=\"/add-film\"" (second response))))
      (is (= "href=\"/list-films\""
            (re-find #"href=\"/list-films\"" (second response)))))))
</code></pre>

<p>ç„¶åè¿è¡Œæµ‹è¯•:</p>

<pre><code class="language-bash">$ lein test
    
lein test film-ratings.handler.index-test
    
Ran 1 tests containing 3 assertions.
0 failures, 0 errors.
</code></pre>

<p>ç°åœ¨æäº¤è¿™äº›æ›´æ”¹å¹¶å°†å…¶æ¨é€åˆ°GitHubã€‚</p>

<pre><code class="language-bash">$ git add .
$ git commit -m "Added index page"
$ git push
</code></pre>

<p>è¿™å°†å¯åŠ¨CircleCIä¸Šçš„ä¸€ä¸ªæ„å»ºï¼Œä½ å¯ä»¥åœ¨ä½ çš„CircleCIæ§åˆ¶å°ä¸Šçœ‹åˆ°ã€‚</p>

<h2>æ·»åŠ ç”µå½±</h2>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå®ƒåªæ˜¾ç¤ºäº†ä¸€ä¸ªç´¢å¼•é¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ä¸Šæœ‰ä¸€äº›æŒ‰é’®ï¼Œä½†æ²¡æœ‰é“¾æ¥åˆ°ä»»ä½•ä¸œè¥¿ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªå¤„ç†ç¨‹åºæ¥æ·»åŠ ç”µå½±å’Œä¸€ä¸ªå¤„ç†ç¨‹åºæ¥åˆ—å‡ºç”µå½±ã€‚æˆ‘ä»¬è¿˜éœ€è¦æŠŠè¿™ä¸ªè¾“å…¥æ•°æ®åº“ã€‚</p>

<p>è®©æˆ‘ä»¬ä»åŠ å…¥æˆ‘ä»¬çš„æ•°æ®åº“å¼€å§‹ã€‚å¦‚æœä½ æŸ¥çœ‹<code>film-ratings/dev/resources</code>ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ª<code>dev.edn</code>æ–‡ä»¶ã€‚åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨æ—¶(è¿™æ˜¯æ‚¨ç›®å‰è¿è¡Œåº”ç”¨ç¨‹åºçš„æ–¹å¼)ï¼Œåœ¨Integrantå¯åŠ¨åº”ç”¨ç¨‹åºä¹‹å‰ï¼ŒDuctä¼šå°†è¯¥å¼€å‘é…ç½®æ–‡ä»¶ä¸ç”Ÿäº§é…ç½®æ–‡ä»¶åˆå¹¶ã€‚</p>

<pre><code class="language-clojure">{:duct.core/environment :development
 :duct.core/include ["film_ratings/config"]
    
 :duct.module/sql
 {:database-url "jdbc:sqlite:db/dev.sqlite"}}
</code></pre>

<p>å¦‚æ‚¨æ‰€è§ï¼Œè¿™å°†æŠŠ<code>:duct.module/sql</code>è®¾ç½®ä¸ºä¸€ä¸ªSQLiteæ•°æ®åº“çš„å¼•ç”¨ï¼ŒIntegrantåœ¨æ‚¨å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶å¯åŠ¨è¯¥æ•°æ®åº“ã€‚åœ¨å¯åŠ¨æ—¶ï¼Œè¿™å°†æ˜¯å¯¹åŒ…å«æ­£åœ¨è¿è¡Œçš„æ•°æ®åº“è¿æ¥çš„æ˜ å°„çš„å¼•ç”¨ã€‚</p>

<p>ç›®å‰ï¼Œè¿™å¼•ç”¨äº†ä¸€ä¸ªç©ºæ•°æ®åº“ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Ductçš„Ragtimeæ¨¡å—æ¥ä½¿ç”¨æ•°æ®åº“è¿ç§»åº“<a href="https://github.com/weavejester/ragtime" target="_blank" rel="noreferrer noopener"> Ragtime </a>ï¼Œç”¨ç”µå½±è¡¨å¡«å……æ•°æ®åº“ã€‚å°†ä»¥ä¸‹å‡ è¡Œæ·»åŠ åˆ°<code>film-ratings/resources/film_ratings/config.edn</code>:</p>

<pre><code class="language-clojure"> :film-ratings.handler/index {}
    
 :duct.migrator/ragtime
 {:migrations [#ig/ref :film-ratings.migrations/create-film]}
    
 [:duct.migrator.ragtime/sql :film-ratings.migrations/create-film]
 {:up ["CREATE TABLE film (id INTEGER PRIMARY KEY, name TEXT UNIQUE, description TEXT, rating INTEGER)"]
  :down ["DROP TABLE film"]}
    
    
 }
</code></pre>

<p>è®©æˆ‘ä»¬ä¸ºadd filmsè¡¨å•è§†å›¾å’Œpostè¯·æ±‚æ·»åŠ å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿å°†ç”µå½±æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚é¦–å…ˆï¼Œå°†è·¯çº¿æ·»åŠ åˆ°<code>film-ratings/resources/film_ratings/config.edn</code>æ–‡ä»¶ä¸­:</p>

<pre><code class="language-clojure"> :duct.module/ataraxy
 {[:get "/"] [:index]
  "/add-film"
  {:get [:film/show-create]
   [:post {film-form :form-params}] [:film/create film-form]}}
</code></pre>

<p>æ–°çš„<code>add-film</code> URLç°åœ¨è¢«æ˜ å°„åˆ°ä¸¤ä¸ªå¤„ç†ç¨‹åºï¼Œä¸€ä¸ªç”¨äºGETæ–¹æ³•ï¼Œä¸€ä¸ªç”¨äºPOSTæ–¹æ³•ã€‚æ³¨æ„ï¼Œpost routeä½¿ç”¨Clojureææ„ä»è¯·æ±‚ä¸­æå–è¡¨å•å‚æ•°ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>:film/create</code>å¤„ç†ç¨‹åºã€‚</p>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰<code>:film/create</code>æˆ–:<code>film/show-create</code> Integranté”®åŠå…¶é€‰é¡¹ã€‚ä¸ºæ­¤ï¼Œåœ¨<code>config.edn</code>ä¸­æ·»åŠ è¿™äº›è¡Œ:</p>

<pre><code class="language-clojure"> :film-ratings.handler/index {}
 :film-ratings.handler.film/show-create {}
 :film-ratings.handler.film/create {:db #ig/ref :duct.database/sql}
</code></pre>

<p><code>create</code>é”®æœ‰ä¸€ä¸ªå¯¹æ•°æ®åº“çš„é›†æˆå¼•ç”¨ï¼Œå®ƒå°†è¢«ä¼ é€’ç»™é€‰é¡¹æ˜ å°„ä¸­çš„å¤„ç†ç¨‹åºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸¤ä¸ªé”®åˆ›å»ºå¤„ç†ç¨‹åºã€‚è¿™äº›é”®çš„å‘½åç©ºé—´ä¸º<code>film-ratings.handler.film</code>ã€‚è¿™æ˜¯å‘½åç©ºé—´ç®¡é“ï¼ŒIntegrantå°†å¯»æ‰¾å®ƒæ¥æ‰¾åˆ°åˆå§‹åŒ–å¤„ç†ç¨‹åºé”®çš„å‡½æ•°ã€‚æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªåç§°ç©ºé—´åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œ<code>film-ratings/src/film_ratings/handler/film.clj</code>:</p>

<pre><code class="language-clojure">(ns film-ratings.handler.film
  (:require [ataraxy.core :as ataraxy]
            [ataraxy.response :as response]
            [film-ratings.boundary.film :as boundary.film]
            [film-ratings.views.film :as views.film]
            [integrant.core :as ig]))
    
(defmethod ig/init-key :film-ratings.handler.film/show-create [_ _]
  (fn [_]
    [::response/ok (views.film/create-film-view)]))
    
(defmethod ig/init-key :film-ratings.handler.film/create [_ {:keys [db]}]
  (fn [{[_ film-form] :ataraxy/result :as request}]
    (let [film (reduce-kv (fn [m k v] (assoc m (keyword k) v))
                          {}
                          (dissoc film-form "__anti-forgery-token"))
          result (boundary.film/create-film db film)
          alerts (if (:id result)
                   {:messages ["Film added"]}
                   result)]
      [::response/ok (views.film/film-view film alerts)])))
</code></pre>

<p><code>:film-ratings.handler.film/show-create</code> defmethodè¿”å›ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œè¯¥å¤„ç†ç¨‹åºç®€å•åœ°è¿”å›è°ƒç”¨<code>create-film-view</code>çš„ç»“æœï¼Œè¯¥ç»“æœè¢«åŒ…è£…åœ¨ä¸€ä¸ªå¸¦æœ‰<code>::response/ok</code>å…³é”®å­—çš„å‘é‡ä¸­ï¼Œç”±<code>ataraxy</code>å‘ˆç°ä¸ºä¸€ä¸ªçŠ¶æ€ä¸º200çš„HTTPå“åº”ã€‚</p>

<p><code>:film-ratings.handler.film/create</code> defmethodå°†æ•°æ®åº“ä½œä¸ºä¸€ä¸ªé€‰é¡¹ï¼Œå…¶åŒ…å«çš„å¤„ç†å‡½æ•°ä»<code>ataraxy</code>ç»“æœä¸­åˆ†è§£å‡ºèƒ¶ç‰‡æ ¼å¼ã€‚ç”µå½±è¡¨å•å°†æ˜¯HTMLè¡¨å•çš„æ˜ å°„(æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»º)ã€‚è¯¥æ˜ å°„çš„é”®æ˜¯å­—ç¬¦ä¸²å½¢å¼çš„è¡¨å•å­—æ®µçš„åç§°ï¼Œæ­¤å¤–å®ƒè¿˜æœ‰ä¸€ä¸ªé˜²ä¼ªæ ‡è®°ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ<code>let</code>çš„ç¬¬ä¸€è¡Œåˆ é™¤äº†é˜²ä¼ªæ ‡è®°ï¼Œå°†å­—ç¬¦ä¸²å¯†é’¥æ”¹ä¸ºå…³é”®å­—ã€‚ç„¶åè°ƒç”¨ä¸€ä¸ª<code>create-film</code>å‡½æ•°ï¼Œå°†æ•°æ®åº“å’Œç”µå½±å½¢å¼ä½œä¸ºå‚æ•°ã€‚è¿™å°†è¿”å›ä¸€ä¸ªåº”è¯¥æœ‰ä¸€ä¸ª<code>:id</code>æˆ–<code>:messages</code>é”®å€¼å¯¹çš„ç»“æœæ˜ å°„ã€‚ç„¶åï¼Œå¤„ç†å‡½æ•°è¿”å›å¯¹<code>film-view</code>è°ƒç”¨çš„å“åº”ã€‚</p>

<p>æ­¤æ—¶ï¼Œviewså‡½æ•°å’Œ<code>create-film</code>å‡½æ•°éƒ½ä¸å­˜åœ¨ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è§†å›¾æ–‡ä»¶ï¼Œ<code>film-rating/src/film_ratings/views/film.clj</code>:</p>

<pre><code class="language-clojure">(ns film-ratings.views.film
  (:require [film-ratings.views.template :refer [page labeled-radio]]
            [hiccup.form :refer [form-to label text-field text-area submit-button]]
            [ring.util.anti-forgery :refer [anti-forgery-field]]))
    
(defn create-film-view
  []
  (page
   [:div.container.jumbotron.bg-light
    [:div.row
     [:h2 "Add a film"]]
    [:div
     (form-to [:post "/add-film"]
              (anti-forgery-field)
              [:div.form-group.col-12
               (label :name "Name:")
               (text-field {:class "mb-3 form-control" :placeholder "Enter film name"} :name)]
              [:div.form-group.col-12
              (label :description "Description:")
               (text-area {:class "mb-3 form-control" :placeholder "Enter film description"} :description)]
              [:div.form-group.col-12
               (label :ratings "Rating (1-5):")]
              [:div.form-group.btn-group.col-12
               (map (labeled-radio "rating") (repeat 5 false) (range 1 6))]
              [:div.form-group.col-12.text-center
               (submit-button {:class "btn btn-primary text-center"} "Add")])]]))
    
(defn- film-attributes-view
  [name description rating]
  [:div
   [:div.row
    [:div.col-2 "Name:"]
    [:div.col-10 name]]
   (when description
     [:div.row
      [:div.col-2 "Description:"]
       [:div.col-10 description]])
   (when rating
     [:div.row
      [:div.col-2 "Rating:"]
      [:div.col-10 rating]])])
    
(defn film-view
  [{:keys [name description rating]} {:keys [errors messages]}]
  (page
   [:div.container.jumbotron.bg-light
    [:div.row
     [:h2 "Film"]]
    (film-attributes-view name description rating)
    (when errors
      (for [error (doall errors)]
       [:div.row.alert.alert-danger
        [:div.col error]]))
    (when messages
      (for [message (doall messages)]
       [:div.row.alert.alert-success
        [:div.col message]]))]))
</code></pre>

<p><code>create-film-view</code>è¿”å›hiccupï¼Œæ˜¾ç¤ºä¸€ä¸ªè¡¨å•æ¥è¾“å…¥ç”µå½±åç§°ã€æè¿°å’Œ1åˆ°5ä¹‹é—´çš„è¯„åˆ†ã€‚æ³¨æ„æ¥è‡ª<code>film-ratings.view.template</code>åç§°ç©ºé—´çš„<code>page</code>å‡½æ•°è¢«ç”¨æ¥å°†æ¥è‡ª<code>create-film-view</code>çš„hiccupå°è£…åˆ°æä¾›å¯¼èˆªæ¡ç­‰çš„hiccupä¸­ã€‚<code>film-view</code>å‡½æ•°è·å–ä¸€ä¸ªè¡¨ç¤ºç”µå½±çš„åœ°å›¾å’Œä¸€ä¸ªåŒ…å«é”™è¯¯æˆ–æ¶ˆæ¯çš„åœ°å›¾ï¼Œå¹¶æ¸²æŸ“hiccupä»¥æ˜¾ç¤ºç”µå½±ä»¥åŠé”™è¯¯å’Œæ¶ˆæ¯è­¦æŠ¥ã€‚æ¸²æŸ“ç”µå½±å±æ€§çš„æ‰“å—å£°å·²ç»è¢«æå–åˆ°å®ƒè‡ªå·±çš„å‡½æ•°<code>film-attributes-view</code>ä¸­ï¼Œå› ä¸ºæ‚¨å°†åœ¨ç”µå½±åˆ—è¡¨ä¸­é‡ç”¨å®ƒã€‚</p>

<h2>æ·»åŠ æ•°æ®åº“å‡½æ•°ä½œä¸ºè¾¹ç•Œ</h2>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨å®ç°ä¸»è¦å¤„ç†HTTPè¯·æ±‚å’Œå“åº”çš„å‡½æ•°å’Œé…ç½®ã€‚æˆ‘ä»¬å·²ç»æ·»åŠ äº†è¿ç§»ä»¥åœ¨å¼€å‘SQLiteæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ª<code>Film</code>è¡¨å’Œå¯¹è¯¥æ•°æ®åº“çš„Integrantå¼•ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰å¯¹è¯¥æ•°æ®åº“åšä»»ä½•äº‹æƒ…ã€‚</p>

<p>æ˜¯æ—¶å€™æ·»åŠ ä¸€ä¸ªè¾¹ç•Œåç§°ç©ºé—´æ¥å¤„ç†æ•°æ®åº“äº¤äº’äº†ã€‚è¾¹ç•Œæ˜¯ä¸€ä¸ªç®¡é“æ¦‚å¿µï¼Œç”¨äºå°†å¤–éƒ¨ä¾èµ–é¡¹ä¸ä»£ç çš„å…¶ä½™éƒ¨åˆ†éš”ç¦»å¼€æ¥ã€‚è¾¹ç•Œæ˜¯Clojureåè®®å’Œç›¸å…³çš„å®ç°ã€‚Clojureåè®®æ˜¯ä¸å…¶ä»–è¯­è¨€ä¸­çš„æ¥å£ç±»ä¼¼çš„æ¦‚å¿µã€‚</p>

<p>å½“å‰é…ç½®å°†ä¼ é€’ç»™<code>:film-ratings.handler.film/create</code>å¤„ç†ç¨‹åºçš„é€‰é¡¹æ˜ å°„åˆ°<code>:duct.database/sql</code>é”®ï¼ŒIntegrantå°†é€šè¿‡å¼•ç”¨ä¸€ä¸ª<code>duct.database.sql.Boundary</code>è®°å½•æ¥åˆå§‹åŒ–è¿™ä¸ªé”®ã€‚åœ¨å¤„ç†ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯¹ç°åœ¨éœ€è¦å®ç°çš„å‡½æ•°çš„å¼•ç”¨ã€‚</p>

<p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨<code>film-ratings.boundary.film</code>åç§°ç©ºé—´ä¸­çš„<code>create-film</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°éœ€è¦åœ¨ä¸€ä¸ªåè®®ä¸­å®šä¹‰ï¼Œè¯¥åè®®ä½¿ç”¨æˆ‘ä»¬çš„<code>create-film</code>å‡½æ•°çš„å®ç°æ¥æ‰©å±•ç®¡é“æ¡†æ¶ä¸­çš„<code>duct.database.sql.Boundary</code>è®°å½•ã€‚</p>

<p>è®©æˆ‘ä»¬ç»§ç»­åˆ›å»ºé‚£ä¸ª<code>film-ratings/src/film_ratings/boundary/film.clj</code>æ–‡ä»¶:</p>

<pre><code class="language-clojure">(ns film-ratings.boundary.film
  (:require [clojure.java.jdbc :as jdbc]
            duct.database.sql)
  (:import java.sql.SQLException))
    
(defprotocol FilmDatabase
  (list-films [db])
  (create-film [db film]))
    
(extend-protocol FilmDatabase
  duct.database.sql.Boundary
  (list-films [{db :spec}]
    (jdbc/query db ["SELECT * FROM film"]))
  (create-film [{db :spec} film]
    (try
     (let [result (jdbc/insert! db :film film)]
       (if-let [id (val (ffirst result))]
         {:id id}
         {:errors ["Failed to add film."]}))
     (catch SQLException ex
       {:errors [(format "Film not added due to %s" (.getMessage ex))]}))))
</code></pre>

<p>è®©æˆ‘ä»¬ä¸“æ³¨äº<code>create-film</code>å‡½æ•°ã€‚è¯¥åŠŸèƒ½åœ¨æ‚¨çš„<code>FilmDatabase</code>åè®®ä¸­å®šä¹‰ã€‚ç„¶åï¼Œè¿™ä¸ªåè®®è¢«å®ç°ä¸ºç”¨æ‚¨çš„<code>create-film</code>çš„å®ç°æ¥æ‰©å±•<code>duct.database.sql.Boundary</code>è®°å½•ã€‚</p>

<p>ä¸å‡ºæ‰€æ–™ï¼Œ<code>create-film</code>å‡½æ•°å¼•ç”¨äº†<code>FilmDatabase</code>(åœ¨å¯åŠ¨æ—¶ç”±Integranté€šè¿‡å®æ—¶æ•°æ®åº“è¿æ¥ä¸ºæ‚¨åˆå§‹åŒ–)å’Œä¸€ä¸ªæ¥è‡ªå¤„ç†ç¨‹åºè§£æçš„è¡¨å•å‚æ•°çš„ç”µå½±åœ°å›¾å¼•ç”¨ã€‚è¯¥å‡½æ•°ä½¿ç”¨<code>clojure.java.jdbc/insert!</code>å‡½æ•°å°†ç”µå½±åœ°å›¾æ’å…¥ç”µå½±è¡¨ã€‚è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå¸¦æœ‰æ–°æ’å…¥è®°å½•çš„idçš„æ˜ å°„ï¼Œæˆ–è€…å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯çš„æ˜ å°„ã€‚</p>

<h2>æ·»åŠ ç”µå½±</h2>

<p>æˆ‘ä»¬ç°åœ¨æœ‰è¶³å¤Ÿçš„å®ç°æ¥å°†ç”µå½±æ·»åŠ åˆ°æ•°æ®åº“ä¸­ã€‚å¦‚æœæ‚¨çš„replä»ç„¶åœ¨ç»ˆç«¯ä¼šè¯ä¸­è¿è¡Œï¼Œé‚£ä¹ˆåˆ‡æ¢å›ç»ˆç«¯ä¼šè¯ã€‚å¦‚æœæ²¡æœ‰ï¼Œå¯åŠ¨ä¸€ä¸ªæ–°çš„replã€‚ç„¶åé‡ç½®åº”ç”¨ç¨‹åºä»¥é‡æ–°åŠ è½½æ–°ä»£ç :</p>

<pre><code class="language-bash">dev=&gt; (reset)
:reloading (film-ratings.boundary.film film-ratings.handler.film film-ratings.main film-ratings.views.film film-ratings.handler.example dev user)
:duct.migrator.ragtime/applying :film-ratings.migrations/create-film#5fc9a814
:resumed
dev=&gt;
</code></pre>

<p>å¦‚æœæ‚¨ç°åœ¨è½¬åˆ°<code>http://localhost:3000/</code>å¹¶ç‚¹å‡»<code>Add Film</code>æŒ‰é’®ï¼Œæ‚¨ä¼šçœ‹åˆ°:</p>

<p><img src="../Images/d52d8c999f9d0fa7a756e7324787f3ff.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545567489747_add-film.png"/></p>

<p>ç»§ç»­å¡«å†™è¡¨æ ¼å¹¶ç‚¹å‡»<strong>æ·»åŠ </strong>ã€‚</p>

<p><img src="../Images/d70f03633491201410710e1191337b9f.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545567798659_film-added.png"/></p>

<p>æˆ‘ä»¬æ·»åŠ äº†å¤§é‡ä»£ç ã€‚è®©æˆ‘ä»¬æäº¤å®ƒå¹¶æ¨é€åˆ°GitHubã€‚</p>

<pre><code class="language-bash">$ git add .
$ git commit -m "Add films functionality."
$ git push
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è½¬åˆ°<a href="https://app.circleci.com/dashboard">ä»ªè¡¨æ¿</a>æ¥æ£€æŸ¥CircleCIï¼Œçœ‹çœ‹æˆ‘ä»¬çš„æ„å»ºæ˜¯å¦å·²ç»æ­£ç¡®è¿è¡Œã€‚</p>

<h2>åˆ—å‡ºç”µå½±</h2>

<p>æœ€åï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°åˆ—å‡ºç”µå½±çš„é…ç½®ã€å¤„ç†ç¨‹åºå’Œè§†å›¾ã€‚</p>

<p>æ›´æ”¹ataraxyè·¯ç”±ï¼Œå¹¶åœ¨config.ednä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„åˆ—è¡¨å¤„ç†ç¨‹åºé”®:</p>

<pre><code class="language-clojure"> :duct.module/ataraxy
 {[:get "/"] [:index]
  "/add-film"
  {:get [:film/show-create]
   [:post {film-form :form-params}] [:film/create film-form]}
  [:get "/list-films"] [:film/list]}
    
 :film-ratings.handler/index {}
 :film-ratings.handler.film/show-create {}
 :film-ratings.handler.film/create {:db #ig/ref :duct.database/sql}
 :film-ratings.handler.film/list {:db #ig/ref :duct.database/sql}
</code></pre>

<p>å°†ä»¥ä¸‹å¤„ç†å‡½æ•°æ·»åŠ åˆ°<code>film-ratings/src/film_ratings/handler/film.clj</code>æ–‡ä»¶:</p>

<pre><code class="language-clojure">(defmethod ig/init-key :film-ratings.handler.film/list [_ {:keys [db]}]
  (fn [_]
    (let [films-list (boundary.film/list-films db)]
      (if (seq films-list)
       [::response/ok (views.film/list-films-view films-list {})]
       [::response/ok (views.film/list-films-view [] {:messages ["No films found."]})]))))
</code></pre>

<p>æˆ‘ä»¬å·²ç»å®šä¹‰äº†åœ¨å¤„ç†ç¨‹åºä¸­è°ƒç”¨çš„<code>list-films</code>å‡½æ•°ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ å®ƒã€‚</p>

<p>å°†æ–°çš„<code>list-film-view</code>å‡½æ•°æ·»åŠ åˆ°<code>film-ratings/src/film_ratings/views/film.clj</code>æ–‡ä»¶ä¸­:</p>

<pre><code class="language-clojure">(defn list-films-view
  [films {:keys [messages]}]
  (page
   [:div.container.jumbotron.bg-light
    [:div.row [:h2 "Films"]]
    (for [{:keys [name description rating]} (doall films)]
      [:div
       (film-attributes-view name description rating)
       [:hr]])
    (when messages
      (for [message (doall messages)]
       [:div.row.alert.alert-success
        [:div.col message]]))]))
</code></pre>

<p>å› ä¸ºè¿™å°†ä¸ºæ¯éƒ¨ç”µå½±è°ƒç”¨å…ˆå‰å®šä¹‰çš„<code>film-attributes-view</code>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿æ–‡ä»¶ä¸­çš„<code>list-films-view</code>åœ¨<code>film-attributes-view</code>ä¹‹åã€‚</p>

<p>é€šè¿‡å†æ¬¡é‡ç½®replæ¥æµ‹è¯•è¿™æ˜¯å¦æœ‰æ•ˆ:</p>

<pre><code class="language-bash">dev=&gt; (reset)
:reloading (film-ratings.views.film film-ratings.handler.film)
:resumed
dev=&gt;
</code></pre>

<p>è½¬åˆ°ç´¢å¼•é¡µé¢<code>http://localhost:3000/</code>å¹¶é€‰æ‹©<code>List Films</code>æŒ‰é’®ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ‚¨æ·»åŠ çš„æ‰€æœ‰ç”µå½±çš„åˆ—è¡¨ã€‚</p>

<p><img src="../Images/1202ccd4c780d40132fe7b04560ac5ec.png" alt="" data-original-src="https://d2mxuefqeaa7sj.cloudfront.net/s_54F7345C04C9D2238488334051A9DF49564E6D88A069EF842D0E5EC23257D43E_1545583202958_list-films.png"/></p>

<p>æœ€åï¼Œå‘Gitæ·»åŠ å¹¶æäº¤æ‚¨çš„æ›´æ”¹ã€‚</p>

<h2>æ‘˜è¦</h2>

<p>æ­å–œæ‚¨ï¼Œæ‚¨å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŠŸèƒ½æ€§çš„ç®¡é“ç½‘ç»œåº”ç”¨ç¨‹åºï¼ğŸ‰ç›®å‰ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ªä¸ºå¼€å‘é…ç½®æ–‡ä»¶å®šä¹‰çš„æ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ„å»ºä¸­åˆ›å»ºçš„uberjarå®é™…ä¸Šä¸ä¼šå·¥ä½œï¼Œå› ä¸ºç”Ÿäº§SQLæ¨¡å—æ˜¯ä¸€ä¸ªç©ºæ˜ å°„<code>:duct.module/sql {}</code>ã€‚</p>

<p>æˆ‘å°†æŠŠè¿™ä½œä¸ºä¸€ä¸ªç»ƒä¹ ç•™ç»™è¯»è€…ï¼Œä½†å¦‚æœä½ æ„Ÿè§‰ä¸å¤Ÿè‡ªä¿¡ï¼Œæˆ–è€…å¦‚æœä½ åœ¨è¿™æ–¹é¢æœ‰æ‰€æŒ£æ‰ï¼Œæˆ‘å°†åœ¨éšåçš„åšå®¢ä¸­è¯¦ç»†ä»‹ç»å¦‚ä½•å°†ç”Ÿäº§æ•°æ®åº“æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œå¦‚ä½•ä½¿ç”¨Docker æ‰“åŒ…ï¼Œä»¥åŠå¦‚ä½•è®©circle ci<a href="https://circleci.com/blog/deploy-a-clojure-web-application-to-aws-using-terraform/" target="_blank" rel="noreferrer noopener">å°†å…¶éƒ¨ç½²åˆ°AWS </a>ã€‚</p>

<p>é˜…è¯»æ›´å¤šä¿¡æ¯:</p>




        
          
          
            <hr/>
            <p>Chris Howe-Jonesæ˜¯é¡¾é—®CTOã€è½¯ä»¶æ¶æ„å¸ˆã€ç²¾ç›Š/æ•æ·è”»é©°ã€å¼€å‘äººå‘˜å’ŒDevCycleçš„æŠ€æœ¯å¯¼èˆªå‘˜ã€‚ä»–ä¸»è¦ä»äº‹Clojure/ClojureScriptã€Javaå’ŒScalaæ–¹é¢çš„å·¥ä½œï¼Œå®¢æˆ·ä»è·¨å›½ç»„ç»‡åˆ°å°å‹åˆ›ä¸šå…¬å¸ã€‚</p>

            <p><a href="/blog/author/chris-howe-jones/" class="arrow-link">é˜…è¯»æ›´å¤šå…‹é‡Œæ–¯Â·è±ª-ç¼æ–¯çš„æ–‡ç« </a></p>
          
        
      </div>
    </div>    
</body>
</html>