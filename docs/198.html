<html>
<head>
<title>Continuous integration for Salesforce applications | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Salesforce应用程序的持续集成| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/continuous-integration-for-salesforce-applications/#2020-08-11T05:00:00-07:00">https://circleci.com/blog/continuous-integration-for-salesforce-applications/#2020-08-11T05:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p><strong>来自发布者</strong>的说明:<i>这篇文章由Gabriel smell于2020年8月11日更新，添加了新的<a href="https://circleci.com/developer/orbs/orb/circleci/salesforce-apex"> Salesforce SFDX Apex orb </a>。</i></p>

<p>好消息，Salesforce应用程序开发人员！🎉我们通过CircleCI简化了构建、测试和部署您的Salesforce应用程序的过程。现在，您可以借助我们与Salesforce的集成创建一个自动化开发管道:<a href="https://circleci.com/developer/orbs/orb/circleci/salesforce-sfdx"> Salesforce SFDX CLI orb </a>和新的<a href="https://circleci.com/developer/orbs/orb/circleci/salesforce-apex"> Salesforce SFDX Apex orb </a>。</p>

<p>Salesforce SFDX CLI orb已更新，专门关注SFDX CLI。我们创建了一个新的orb，Salesforce SFDX Apex orb，专注于测试和部署您的应用程序的流程。</p>

<p>本文将向您展示如何在CircleCI上快速启动并运行自动化开发管道。我们将利用Salesforce提供的<a href="https://github.com/trailheadapps/ebikes-lwc"> ebikes-lwc </a>示例应用程序以及我们新的<a href="https://circleci.com/developer/orbs/orb/circleci/salesforce-apex"> Salesforce SFDX Apex orb </a>。如果您完全不熟悉Salesforce应用程序开发，此存储库也是开始学习的好地方。或者，如果您有自己的Salesforce应用程序，您可以使用它来代替ebikes-lwc示例应用程序。</p>

<h2>什么是CI渠道？</h2>

<p>对于第一次来CircleCI的人，我想就<a href="https://circleci.com/continuous-integration/">持续集成</a>如何改进您的开发工作流程做一个<a href="https://circleci.com/docs/about-circleci/#section=welcome">快速概述</a>。</p>

<p>CircleCI帮助您更快地构建、测试和发布代码。CircleCI管道允许您对应用程序进行更改，并在部署之前快速测试这些更改。如果你的测试失败了，CircleCI会马上通知你。一旦您对代码有了信心，您就可以手动或自动地将这些更改部署到您的用户。</p>

<h2>设置</h2>
<p>在我们开始创建<a href="https://circleci.com/blog/what-is-a-ci-cd-pipeline/"> CI管道</a>之前，我们有一些设置任务要完成:</p>

<ol>
  <li>
    <p>第一个很简单，我们需要<a href="https://developer.salesforce.com/docs/atlas.en-us.sfdx_setup.meta/sfdx_setup/sfdx_setup_enable_devhub.htm">为您的帐户启用开发中心</a>。这允许您创建和管理临时组织，这是在安全、可任意使用的环境中测试应用程序所必需的。</p>
  </li>
  <li>
    <p>我们需要做的下一件事是创建我们自己的自签名SSL证书和私钥。当使用Salesforce CLI进行身份验证时，您通常会启动浏览器窗口并登录，但是在我们没有人工交互的CI环境中，我们需要一种替代的身份验证方法。</p>

    <p>对于我们基于JWT的授权，我们将创建一个证书，Salesforce将持有我们的证书，CircleCI将持有我们的私钥。我们一会儿会回到这个话题。按照此处的说明<a href="https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_key_and_cert.htm">创建您的证书和密钥。</a></p>
  </li>
  <li>
    <p>最后，在我们开始管道之前，我们必须创建一个连接的应用程序。连接的应用程序是我们在云环境中连接到Salesforce实例的方式。这将允许我们利用我们在上一步中创建的证书向JWT进行身份验证。</p>

    <p>您可以在Salesforce网站<a href="https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_connected_app.htm">这里</a>按照步骤创建连接应用。您将看到，在此步骤中，我们将使用Salesforce存储我们的<code>server.crt</code>文件。稍后，我们将向CircleCI添加服务器密钥。一定要记下创建的应用程序给出的消费者键值。</p>
  </li>
</ol>

<p>此时，是时候开始准备我们的项目了。如果你已经有了一个项目，你可以从它开始。否则，从克隆我们之前提到的<a href="https://github.com/trailheadapps/ebikes-lwc"> ebikes-lwc </a>例子开始。我们最终想要一个由GitHub或BitBucket等VCS提供商托管的Salesforce应用程序项目。</p>

<p>一旦我们在GitHub或BitBucket上托管了一个项目，我们就可以开始组装管道了。</p>

<h2>将项目添加到CircleCI</h2>
<p>我们的项目还没有完成，我们需要添加一个CircleCI配置文件，但是我们马上就会添加。我们还需要先做最后一点准备工作。</p>

<p><a href="https://circleci.com/vcs-authorize/">使用CircleCI授权您的VCS </a>并登录。一旦你在你的<a href="https://circleci.com/dashboard">仪表板</a>，点击<strong> <a href="https://app.circleci.com/projects/project-dashboard/github/circleci/">添加项目</a> </strong>，这应该呈现一个来自你的账户的项目列表。点击<strong>为您的Salesforce应用程序设置项目</strong>。</p>

<p><img src="../Images/2ab6d2497260a838327d26de39ce8946.png" class="img-auto" alt="" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-1.png?imgix=false"/></p>

<p>在下一页，您可以忽略默认值。我们一会儿会回到这个话题。点击<strong>开始建造</strong>。</p>

<p><img src="../Images/b995266d354746cc484ee4690ad81f33.png" class="img-auto" alt="" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-2.png?imgix=false"/></p>

<p>在下一页，你会马上看到我们的工作失败了，但是不要担心！那是可以预料的。我们还没有将我们的<a href="https://circleci.com/docs/configuration-reference/">配置文件</a>添加到我们的集成中，也没有设置我们的<a href="https://circleci.com/docs/env-vars/">环境变量</a>。</p>

<p><img src="../Images/24f21c02ef1b9eac57948423b845cb80.png" alt="2019-12-11-salesforce-3.png" srcset="https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-3.png"/></p>

<h2>添加环境变量</h2>

<p>让我们将所需的<a href="https://circleci.com/docs/env-vars/#setting-an-environment-variable-in-a-project">环境变量</a>添加到这个新添加的项目中。在屏幕左侧的导航栏中，是您添加到CircleCI的项目列表，旁边有一个嵌齿轮。单击我们的Salesforce应用程序旁边的齿轮进入设置页面。</p>

<p><img src="../Images/f8dc0827346ba459ea0ab73a6bae75a8.png" class="img-auto" alt="" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-4.png?imgix=false"/></p>

<p>从那里你可以点击位于<strong>构建设置</strong>下的<strong>环境变量</strong>。</p>

<p><img src="../Images/5bf4e221e7db08ee0e72c10c324aa85f.png" class="img-auto" alt="" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-5.png?imgix=false"/></p>

<p>我们必须添加两个秘密来进行身份验证。</p>

<table>
  <thead>
    <tr>
      <th>环境变量</th>
      <th>价值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>JWT钥匙</td>
      <td>该值必须包含私有server.key文件的base64编码值。</td>
    </tr>
    <tr>
      <td>SFDX _消费者密钥</td>
      <td>Salesforce的已连接应用程序的消费者密钥。</td>
    </tr>
  </tbody>
</table>

<p><br/>消费者密钥在之前的步骤中生成。只需添加一个名为<code>SFDX_CONSUMER_KEY</code>的新环境变量和来自Salesforce的值。</p>

<p>要获得Base64编码的JWT密钥，请导航到包含您之前创建的自签名证书文件的目录，并输入以下命令:<code>base64 server.key</code>。一旦有了base64编码的值，复制它并将其添加到项目环境变量中的<code>SFDX_JWT_KEY</code>键下。</p>

<p><img src="../Images/9e43baaca606acec8f24bdcfc7b5176f.png" alt="2019-12-11-salesforce-6.png" srcset="https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-12-11-salesforce-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-12-11-salesforce-6.png"/></p>

<h2>添加您的配置</h2>

<p>这就是所有需要的设置！概括地说，到目前为止，您已经:</p>
<ul>
  <li>为您的Salesforce帐户启用开发中心</li>
  <li>创建了一个连接应用程序</li>
  <li>使用您连接的应用启用JWT身份验证</li>
  <li>跟踪CircleCI的项目</li>
  <li>添加了所需的环境变量</li>
</ul>

<p>此时，CircleCI能够通过Salesforce进行身份验证。这将允许我们在配置中使用SFDX Apex orb命令。</p>

<p>在项目存储库的主目录中，添加一个顶级的<code>.circleci</code>文件夹，并在其中创建一个<code>config.yml</code>文件。当新的变更被推送到您的存储库时，CircleCI会自动寻找这个文件。这将作为每次更新要执行的操作的蓝图。如果你不熟悉CircleCI配置，我强烈推荐你看看我们的<a href="https://circleci.com/docs/getting-started/">入门</a>信息。</p>

<p>一旦您创建了您的<code>config.yml</code>文件，让我们开始从<a href="https://circleci.com/developer/orbs/orb/circleci/salesforce-sfdx"> SFDX Apex orb </a>复制包含的使用示例。</p>

<pre><code>version: 2.1
  orbs:
    apex: circleci/salesforce-apex@x.y
  jobs:
    install_authenticate:
      docker:
        - image: cimg/node:14.5
      steps:
        - checkout
        - apex/setup:
           defaultusername: user@email.com
        - run:
            name: Run your SFDX commands here
            command: |
              echo "You now have access to the sfdx cli and may execute commands against it. https://developer.salesforce.com/docs/atlas.en-us.sfdx_cli_reference.meta/sfdx_cli_reference/cli_reference.htm"
  workflows:
    basic-test:
      jobs:
        - install_authenticate
</code></pre>

<h2>配置细分</h2>
<p>我们来分析一下。</p>
<pre><code>version: 2.1
 orbs:
   sfdx: circleci/salesforce-apex@x.y
</code></pre>

<p>访问“orbs”需要circle ci config 2.1版。这应该是默认设置，但是明确设置配置的版本总是一个好主意，特别是因为将来会更新。</p>

<p>节允许我们定义和导入我们的orb包。在这个例子中，我们只需要<code>circleci/salesforce-apex</code>球体。你可以看到我们将它作为<code>apex</code>导入，我们将能够在配置的其他地方引用它。</p>

<p>另外，注意在我们的import语句的末尾有一个<code>@x.y</code>版本标签。这是一个占位符值。我鼓励你访问<a href="https://circleci.com/developer/orbs"> orb注册中心</a>，不仅查看最新的文档，还确保你导入的是最新版本的orb。</p>

<p>orb是永远版本化的，所以您可以导入一个完全版本化的版本，比如<code>1.0.0</code>。但是，我们建议使用次要版本，这样您可以自动获取补丁发布。</p>

<h3>乔布斯</h3>
<p>在orb导入下面，您会发现我们的<code>jobs</code>节，其中有一个名为<code>install_authenticate</code>的作业。</p>
<pre><code>  jobs:
    install_authenticate:
</code></pre>

<p>这是我们在配置文件中手动定义的作业。您的工作可以命名为任何名称，根据您的工作流程有多个工作并不罕见。在此工作流中，我们将展示如何在单个作业中安装CLI工具并对其进行身份验证。</p>

<h3>Docker图像</h3>
<p>CircleCI提供了各种各样的<a href="https://circleci.com/docs/circleci-images/">预建Docker图像</a>。在这种情况下，我们将利用<code>cimg/node:14.5</code>图像。此映像提供了预安装的<code>nodejs</code>，允许我们安装Salesforce CLI的节点版本，而无需单独安装节点和npm。</p>

<pre><code>      docker:
        - image: cimg/node:14.5
</code></pre>

<h3>步伐</h3>

<p><a href="https://circleci.com/docs/jobs-steps/#steps-overview">步骤</a>是我们希望按顺序执行的可执行命令的集合。</p>

<pre><code>        - checkout
        - apex/setup:
           defaultusername: user@email.com
</code></pre>
<ul>
  <li><strong>check out:</strong>circle ci自带的一个内置命令，它将从您的存储库中获取源代码。这不是集成所必需的，但通常是任何项目的第一步。</li>
  <li><strong> apex/setup: </strong>由circleci/salesforce-apex orb提供的orb命令，它将安装最新的单机版CLI，然后使用已设置的凭据向salesforce进行身份验证。</li>
</ul>

<p>从这一点开始，您可以利用orb中的其他命令，或者使用其他命令直接与SFDX交互。这里有一个例子:</p>

<pre><code>     - run:
         name: Check Auth List
         command: sfdx force:auth:list
</code></pre>

<h3>工作流程</h3>

<p>工作流是CircleCI的一个特性，它允许您编排我们想要运行的作业和运行顺序。我们的工作流程中只有一项任务。在我们的例子中，我们希望它在每次提交时运行，所以我们不包括任何过滤器。我们将创建一个名为<code>basic-test</code>的工作流，并列出我们的<code>install_authenticate</code>作业。</p>

<pre><code>  workflows:
    basic-test:
      jobs:
        - install_authenticate
</code></pre>
<h2>你还可以用Salesforce SFDX Apex orb做什么？</h2>



<p>我们想听听Salesforce开发人员的意见！发微博给@CircleCI ，告诉我们你是如何使用我们的宝珠的。</p>



        
          
          
        
      </div>
    </div>    
</body>
</html>