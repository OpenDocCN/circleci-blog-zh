<html>
<head>
<title>CircleCI incident report for January 4, 2023 security incident</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>2023年1月4日安全事件的CircleCI事件报告</h1>
<blockquote>原文：<a href="https://circleci.com/blog/jan-4-2023-incident-report/#2023-01-13T07:00:00-08:00">https://circleci.com/blog/jan-4-2023-incident-report/#2023-01-13T07:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p><a href="https://circleci.com/blog/january-4-2023-security-alert/">2023年1月4日，我们提醒客户</a>发生了安全事故。今天，我们想与您分享发生了什么，我们学到了什么，我们的计划是什么，以不断改善我们未来的安全态势。</p>

<p>我们要感谢我们的客户对轮换和撤销机密的关注，并为此次事件可能对您的工作造成的任何中断表示歉意。我们鼓励尚未采取行动的客户采取行动，以防止未经授权访问第三方系统和商店。此外，我们要感谢我们的客户和我们的社区，感谢您在我们进行彻底调查期间的耐心。为了实现负责任的披露，我们已尽最大努力在信息共享速度和保持调查完整性之间取得平衡。</p>

<p><strong>该报告将涵盖:</strong></p>


<p><a name="what-happened" class="deep-link-anchor"/></p>
<h2>发生了什么事？</h2>

<p>除非另有说明，所有日期和时间均以UTC表示。</p>

<p>2022年12月29日，我们的一个客户提醒我们注意可疑的GitHub OAuth活动。这一通知引发了CircleCI的安全团队与GitHub的深入审查。</p>

<p>2022年12月30日，我们得知该客户的GitHub OAuth令牌已被未经授权的第三方攻破。尽管该客户能够快速解决问题，但出于谨慎，我们在2022年12月31日代表我们的客户主动启动了所有GitHub OAuth令牌的轮换流程。尽管与GitHub合作提高了API速率限制，但轮换过程需要时间。虽然目前还不清楚其他客户是否受到影响，但我们继续扩大了分析范围。</p>

<p>到2023年1月4日，我们的内部调查已经确定了未经授权的第三方入侵的范围和攻击的进入路径。到目前为止，我们已经了解到，未经授权的第三方利用部署到CircleCI工程师笔记本电脑上的恶意软件来窃取有效的2FA支持的SSO会话。这台机器在2022年12月16日被入侵。我们的防病毒软件没有检测到恶意软件。我们的调查表明，该恶意软件能够执行会话cookie窃取，使他们能够在远程位置模拟目标员工，然后提升对我们生产系统子集的访问权限。</p>

<p>因为目标员工拥有生成生产访问令牌的特权，这是该员工日常职责的一部分，所以未经授权的第三方能够访问和泄露数据库和存储的子集的数据，包括客户环境变量、令牌和密钥。我们有理由相信，未经授权的第三方在2022年12月19日从事了侦察活动。2022年12月22日，发生了泄漏，这是我们生产系统中未授权活动的最后记录。尽管所有泄漏的数据都是静态加密的，但第三方从正在运行的进程中提取加密密钥，使他们有可能访问加密的数据。</p>

<p>虽然我们对内部调查的结果充满信心，但我们已经聘请了第三方网络安全专家来协助我们的调查并验证我们的调查结果。迄今为止，我们的发现基于对我们的身份验证、网络和监控工具的分析，以及我们的合作伙伴提供的系统日志和日志分析。</p>

<p>针对这一事件，我们采取了以下措施:</p>

<ul>
  <li>世界协调时2023年1月4日16:35，我们关闭了该员工的所有访问权限，因为他的帐户受到了威胁。</li>
  <li>世界协调时2023年1月4日18:30，我们关闭了几乎所有员工的生产访问权限，将运营问题的访问权限限制在一个极小的小组。在调查过程中，我们从未有任何证据表明任何其他员工或其设备的凭据遭到破坏，但我们采取了这一行动，以限制潜在的影响范围。</li>
  <li>2023年1月4日22:30 UTC，我们轮换了所有潜在暴露的生产主机，以确保生产机器的清洁。</li>
  <li>2023年1月5日03:26 UTC，我们撤销了所有项目API令牌。</li>
  <li>2023年1月6日05:00 UTC，我们撤销了2023年1月5日00:00 UTC之前创建的所有个人API令牌。</li>
  <li>2023年1月6日06:40 UTC，我们开始与Atlassian的合作伙伴合作，代表我们的客户轮换所有Bitbucket令牌。这项工作于2023年1月6日10:15 UTC完成。</li>
  <li>2023年1月7日07:30 UTC，我们完成了我们于2022年12月31日04:00 UTC开始的GitHub OAuth令牌轮换。</li>
  <li>2023年1月7日18:30 UTC，我们开始与我们在AWS的合作伙伴合作，通知客户可能受影响的AWS令牌。我们了解到，这些通知已于2023年1月12日00:00 UTC完成。</li>
</ul>

<p>在此期间，我们在外部调查人员的支持下继续我们的取证调查，在我们的平台上推出了额外的安全层，并构建和分发了额外的工具(更多详细信息见下文)来支持我们的客户保护他们的秘密。</p>

<p><a name="how-do-we-know-this-attack-vector-is-closed-and-its-safe-to-build" class="deep-link-anchor"/></p>
<h2>我们怎么知道这个攻击媒介是封闭的，并且是安全的呢？</h2>

<p>我们相信客户可以安全地在CircleCI上进行构建。</p>

<p>自从意识到这种攻击后，我们已经采取了许多措施来消除攻击媒介并增加额外的安全层，包括:</p>

<ul>
  <li>通过我们的MDM和A/V解决方案，针对此次攻击中使用的恶意软件表现出的特定行为增加了检测和阻止功能。</li>
  <li>在我们实施额外的安全措施时，限制数量非常有限的员工进入生产环境。我们对我们平台的安全性充满信心，没有迹象表明任何其他员工的设备受到了威胁。</li>
  <li>对于保留生产访问权限的员工，我们增加了额外的逐步身份认证步骤和控制。这将帮助我们防止可能的未经授权的生产访问，即使是在被盗的2FA支持的SSO会话的情况下。</li>
  <li>针对我们在此场景中确定的特定行为模式，跨多个触发器并通过各种第三方供应商实施监控和警报。</li>
</ul>

<p>我们知道安全工作永远不会结束。除了关闭这一特定媒介，我们还进行了强化和持续的审查，以确保对潜在攻击的更强防御。</p>

<p><a name="communication-and-support-for-customers" class="deep-link-anchor"/></p>
<h2>对客户的沟通和支持</h2>

<p>在2023年1月4日22:30 UTC完成所有生产主机的轮换后，我们确信我们已经消除了攻击媒介和潜在的持续损坏主机。</p>

<p>太平洋标准时间2023年1月4日下午6:30/世界标准时间2023年1月5日02:30，我们发送了披露电子邮件，在我们的博客上发布了<a href="https://circleci.com/blog/january-4-2023-security-alert/">安全通知，通过我们的社交媒体账户和我们的</a><a href="https://discuss.circleci.com/t/circleci-security-alert-rotate-any-secrets-stored-in-circleci/46479">讨论论坛</a>通知了客户，并创建了一篇关于如何执行建议的安全步骤的<a href="https://support.circleci.com/hc/en-us/articles/11816211460891">支持文章</a>。</p>

<p>我们建议所有客户轮换他们的秘密，包括OAuth令牌、项目API令牌、SSH密钥等等(更多细节见<a href="https://circleci.com/blog/january-4-2023-security-alert/">博客文章</a>或<a href="https://discuss.circleci.com/t/circleci-security-alert-rotate-any-secrets-stored-in-circleci/46479">讨论文章</a>)。</p>

<p>这一披露开启了一个与我们的客户进行积极和持续沟通的时期。我们要感谢我们的客户对这一事件的一致反应，以及帮助我们寻找机会为您提供额外的工具。我们采纳了这一反馈意见，作为回应，我们构建并发布了新工具，并修改了现有工具，以通过以下方式加快客户的补救:</p>

<ul>
  <li>用于秘密发现的<a href="https://github.com/CircleCI-Public/CircleCI-Env-Inspector" target="_blank" rel="noreferrer noopener">脚本，以便创建秘密轮换的可操作列表。</a></li>
  <li>CircleCI API的两个关键变化:<ul>
      <li>为了更好地匹配GitHub用户界面，新功能返回SHA-256签名。</li>
      <li>将<code>updated_at</code>字段添加到上下文API中，以便客户可以验证这些变量的成功循环。</li>
    </ul>
  </li>
  <li>免费和付费计划的所有客户都可以访问审计日志，以帮助客户审查CircleCI平台的活动。</li>
</ul>

<p>我们感谢客户对我们可以改进沟通的所有反馈，包括让事件在我们的渠道中更加明显的机会。</p>

<p><a name="how-do-i-know-if-i-was-impacted" class="deep-link-anchor"/></p>
<h2>我如何知道我是否受到影响？</h2>

<p><strong>我的数据有风险吗？</strong></p>

<p>在此事件中，未经授权的参与者于2022年12月22日泄露了客户信息，其中包括第三方系统的环境变量、密钥和令牌。如果您在此期间在我们的平台上存储了机密，请假设它们已被访问，并采取建议的缓解措施。我们建议您从2022年12月16日开始调查您系统中的可疑活动，并在2023年1月4日我们披露后结束您的秘密轮换。2023年1月5日之后进入系统的任何东西都可以被认为是安全的。</p>

<p>是否有未经授权的参与者使用这些数据访问我的任何系统？</p>

<p>因为这一事件涉及第三方系统的密钥和令牌的泄露，我们无法知道您的秘密是否被用于对这些第三方系统的未授权访问。我们在下面提供了一些详细信息，以帮助客户进行调查。</p>

<p>在本文发布时，只有不到5家客户告知我们，此事件导致了对第三方系统的未授权访问。</p>

<p><a name="details-that-may-help-your-team-with-internal-investigations" class="deep-link-anchor"/></p>
<h2>可能有助于您的团队进行内部调查的详细信息</h2>

<p>在第三方法医调查员的帮助下，我们最近确认了可能有助于客户审计和调查的其他细节。</p>

<p><strong>影响日期:</strong></p>
<ul>
  <li>我们在2022年12月19日看到未经授权的第三方访问，在2022年12月22日发生数据泄露。</li>
  <li>在2022年12月19日之前，我们没有任何影响客户活动的证据。出于谨慎，我们建议您调查2022年12月16日的损坏日期到2023年1月4日之后您轮换您的机密的日期之间的这段时间，以发现您系统中的异常活动。</li>
</ul>

<p><strong>被识别为威胁参与者使用的IP地址:</strong></p>
<ul>
  <li>178.249.214.10</li>
  <li>89.36.78.75</li>
  <li>89.36.78.109</li>
  <li>89.36.78.135</li>
  <li>178.249.214.25</li>
  <li>72.18.132.58</li>
  <li>188.68.229.52</li>
  <li>111.90.149.55</li>
</ul>

<p><strong>被确定为威胁参与者使用的数据中心和VPN提供商:</strong></p>
<ul>
  <li>数据营有限公司</li>
  <li>Globalaxs魁北克Noc</li>
  <li>汉迪网络有限责任公司</li>
  <li>马尔瓦德虚拟专用网</li>
</ul>

<p><strong>要搜索和删除的恶意文件:</strong></p>
<ul>
  <li>/private/tmp/.svx856.log</li>
  <li>/private/tmp/。ptslog</li>
  <li>PTX-player . dmg(sha 256:8913 e 38592228 ADC 067d 82 f 66 c 150d 87004 EC 946 e 579d 4 a 00 c 53 b 61444 ff 35 BF)</li>
  <li>PTX应用程序</li>
</ul>

<p><strong>阻止以下域:</strong></p>


<p><strong>检查GitHub审计日志文件中的意外命令，例如:</strong></p>


<p><a name="what-we-learned-from-this-incident-and-what-we-will-do-next" class="deep-link-anchor"/></p>
<h2>我们从这次事件中学到了什么，我们下一步要做什么</h2>

<p>我们了解到:虽然我们拥有阻止和检测攻击的工具，但仍然有机会加强我们的安全态势。 <br/>我们拥有的身份验证、安全和跟踪工具使我们能够全面诊断和修复问题。随着恶意行为者变得越来越狡猾，我们也在不断改进我们的安全标准，并推行最佳实践来应对未来的威胁。我们将越来越积极地使用安全工具。展望未来，为了支持更保守的立场，防止不良行为者不正当地访问我们的系统，我们将优化现有工具的配置，以创建额外的防御层。</p>

<p><strong>我们的计划:</strong> <br/>首先，我们将为所有客户启动定期自动OAuth令牌轮换。我们的计划还包括从OAuth到GitHub应用程序的转变，使我们能够在令牌内实施更细粒度的权限。我们还计划完成对我们所有工具配置的全面分析，包括第三方审查。我们将继续采取额外的措施，包括扩大警报范围、降低会话信任度、增加额外的身份认证因素，以及执行更常规的访问轮换。最后，我们将使我们的系统权限更加短暂，严格限制从类似事件中获得的任何令牌的目标值。</p>

<p>我们了解到:我们可以让客户更容易采用我们最先进的安全功能。 <br/>通过CircleCI的发展，我们不断推出新功能来提高客户构建管道的安全性。虽然客户可以使用高级安全功能，但我们可以做更多工作来提高这些功能的采用率。</p>

<p><strong>我们的计划:</strong> <br/>客户必须能够更轻松地无缝采用最新、最先进的安全功能，包括OIDC和IP范围。我们还在探索其他主动步骤，例如，自动令牌过期和未使用机密的通知。我们将让我们的客户更简单、更方便地创建和维护高度安全的管道，在智能管理风险的同时充分利用云的优势。</p>

<p><a name="a-note-on-employee-responsibility-vs-systems-safeguards" class="deep-link-anchor"/></p>
<h2>关于雇员责任与系统保护的说明</h2>

<p>我们想搞清楚。虽然一名员工的笔记本电脑通过这种复杂的攻击被利用，但安全事故是系统故障。作为一个组织，我们的责任是构建多层防护措施来抵御所有攻击媒介。</p>

<p><a name="security-best-practices" class="deep-link-anchor"/></p>
<h2>安全最佳实践</h2>

<p>鉴于日益增多的高度复杂和动机不良的行为者，我们致力于与我们的客户分享最佳做法，以加强我们对未来不可避免的企图的集体防御。以下是客户可以采纳的提高管道安全性的建议:</p>
<ul>
  <li>尽可能使用<a href="https://circleci.com/docs/openid-connect-tokens/"> OIDC令牌</a>以避免在CircleCI中存储长期有效的凭证。</li>
  <li>利用<a href="https://circleci.com/docs/ip-ranges/"> IP范围</a>将到您系统的入站连接限制为仅已知的IP地址。</li>
  <li>使用<a href="https://circleci.com/docs/contexts/">上下文</a>来合并共享的秘密，并限制特定项目对秘密的访问，然后可以通过API 自动<a href="https://circleci.com/docs/contexts/#rotating-environment-variables">轮换。</a></li>
  <li>对于特权访问和附加控制，您可以选择使用<a href="https://circleci.com/docs/runner-overview/#circleci-runner-use-cases"> runners </a>，它允许您将CircleCI平台连接到您自己的计算和环境，包括IP限制和IAM管理。</li>
</ul>

<p><a name="closing-thoughts" class="deep-link-anchor"/></p>
<h2>结束语</h2>

<p>我们知道没有方便的时间来响应关键系统上的安全事件，我们要真诚感谢所有在事件发生后立即采取行动的客户。通过这一集体行动，我们将能够更有力地应对未来的威胁。我们也亲眼目睹了我们客户群体的力量和慷慨，许多人来到我们的<a href="https://discuss.circleci.com">讨论论坛</a>分享知识并相互帮助。感谢您在我们努力解决此事件时给予的支持和耐心。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>