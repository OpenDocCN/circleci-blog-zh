<html>
<head>
<title>Deploy with Terraform to AWS - Deploy a Clojure app | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Terraform部署到AWS -部署Clojure应用程序| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/deploy-a-clojure-web-application-to-aws-using-terraform/#2022-11-01T06:01:00-07:00">https://circleci.com/blog/deploy-a-clojure-web-application-to-aws-using-terraform/#2022-11-01T06:01:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>这是关于构建、测试和部署Clojure web应用程序的系列文章的第三篇。你可以在这里找到第一个帖子<a href="https://circleci.com/blog/build-a-clojure-web-app-using-duct/" target="_blank" rel="noreferrer noopener">，在这里</a>找到第二个<a href="https://circleci.com/blog/package-a-clojure-web-application-using-docker/" target="_blank" rel="noreferrer noopener">。</a></p>

<p>在本帖中，我们将重点关注如何使用<a href="https://www.terraform.io/" target="_blank" rel="noreferrer noopener"> HashiCorp Terraform </a>建立一个相当复杂的基础设施，用PostgreSQL容器托管我们的web应用Docker容器，然后使用CircleCI在零宕机的情况下部署到我们的基础设施。如果你不想从头开始创建前两篇文章中描述的web应用程序，你可以通过分叉<a href="https://github.com/chrishowejones/blog-film-handler" target="_blank" rel="noreferrer noopener">这个</a>库并检查<code>part-2</code>分支来获得源代码。</p>

<p>尽管我们正在构建一个Clojure应用程序，但是只需要有限的Clojure知识就可以完成本系列的这一部分。</p>

<h2>先决条件</h2>

<p>为了构建这个web应用程序，您需要安装以下软件:</p>

<ol>
  <li><a href="https://openjdk.java.net/install/" target="_blank" rel="noreferrer noopener"> Java JDK 8或更高版本</a>——clo jure运行在Java虚拟机上，实际上只是一个Java库(JAR)。我用版本8构建了这个，但是一个更好的版本应该也可以。</li>
  <li><a href="https://leiningen.org/" target="_blank" rel="noreferrer noopener"> Leiningen </a> - Leiningen，通常被称为lein(读作‘line’)是最常用的Clojure构建工具。</li>
  <li>Git  -无处不在的分布式版本控制工具。</li>
  <li>Docker——一个工具，旨在通过使用容器来简化应用程序的创建、部署和运行。</li>
  <li>Docker Compose  -一个定义和运行多容器Docker应用程序的工具。</li>
  <li>HashiCorp Terraform  -以可预测和可复制的方式创建和改变基础设施的工具。这个博客是用V0.12.2版测试的。</li>
  <li>SSH作为命令行实用程序安装。如果你还没有安装SSH的话，你可能需要使用搜索引擎来获得安装说明，因为它依赖于你的操作系统。</li>
</ol>

<p>您还需要注册:</p>

<ol>
  <li><a href="https://circleci.com/" target="_blank" rel="noreferrer noopener"> CircleCI账号</a> - CircleCI是一个持续集成和交付平台。</li>
  <li>GitHub账户 - GitHub是一个基于网络的托管服务，使用Git进行版本控制。</li>
  <li>Docker Hub帐户 - Docker Hub是一个基于云的存储库，Docker用户和合作伙伴可以在其中创建、测试、存储和分发容器映像。</li>
  <li><a href="https://aws.amazon.com/" target="_blank" rel="noreferrer noopener"> AWS账户</a>——亚马逊网络服务提供按需计算平台。</li>
</ol>

<p><strong>注意:</strong> <i>我们将要构建的基础设施在支持我们所需的AWS服务方面会涉及少量成本。如果您离开服务大约一个小时来完成本教程，费用将在$0.50到$1.00之间。</i></p>

<p>你还需要设置你的CircleCI、Docker Hub和Web应用Github账户，如本系列的第1部分和第2部分所述。</p>

<h2>创建AWS帐户和凭据</h2>

<p>首先，我们需要注册一个<a href="https://portal.aws.amazon.com/billing/signup?nc2=h_ct&amp;src=header_signup&amp;redirect_url=https%3A%2F%2Faws.amazon.com%2Fregistration-confirmation#/start" target="_blank" rel="noreferrer noopener"> AWS账户</a>。虽然你可以选择“免费”账户，但由于我们将使用的资源，仍然需要付费。一旦你完成了，你会想要拆除基础设施，我会在这篇博客中告诉你怎么做。</p>

<p>拥有AWS帐户后，以root用户身份登录。您用来注册的电子邮件是您的用户名，但请确保您点击<strong>作为根帐户</strong>登录。登录后，从<strong>服务</strong>菜单中选择<strong> IAM </strong>(身份访问和管理)。</p>

<p>从屏幕左侧的导航栏中选择<strong>用户</strong>，点击<strong>添加用户</strong>。创建一个用户，并确保您给它编程和控制台访问。</p>

<p><img src="../Images/34261c80920452b9af4aa4809b6a1c88.png" alt="Add user" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-add-user.png"/></p>

<p>通过创建新角色或直接附加现有策略，为用户提供<code>Administrator Access</code>。</p>

<p><img src="../Images/46243ac62c3e78324e7b99811afed71a.png" alt="Admin access" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-admin-access.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-admin-access.png"/></p>

<p>您可以保留默认设置并接受设置向导中的其他内容，但是在您离开添加用户成功屏幕之前，请务必仔细记下<code>AWS_ACCESS_KEY_ID</code>和<code>AWS_SECRET_ACCESS_KEY</code>。</p>

<p><img src="../Images/586619830dd5cfb0de4eb9dfc266132e.png" alt="Add user success" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-add-user-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-add-user-success.png"/></p>

<p>创建IAM用户后，记下您的帐户id ( <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html#FindingYourAWSId">如何找到您的AWS帐户id </a>)，选择帐户名称或号码旁边的向下箭头并从下拉菜单中选择“注销”，注销root用户。</p>


<p>现在，以新创建的IAM用户身份登录您的帐户。如果您看到<strong>根用户登录</strong>，请确保选择<strong>登录不同的账户</strong>。使用您之前记下的AWS帐户id、您设置的用户名(在我的例子中是filmappuser)以及您为管理控制台访问设置的密码。</p>

<p>登录后，从<strong>服务</strong>下拉菜单中选择<strong> EC2 </strong>，并点击EC2仪表板上<strong>资源</strong>中的<strong>密钥对</strong>。</p>



<p>点击<strong>创建密钥对</strong>并输入密钥对名称。我在地形中使用了<code>film_ratings_key_pair</code>,所以如果你不想编辑地形，就用它作为名字。将自动下载的<code>.pem</code>文件复制到您的<code>.ssh/</code>目录下，并对该文件设置权限，如下所示:</p>

<pre><code class="language-bash">chmod 400 ~/.ssh/film_ratings_key_pair.pem
</code></pre>

<h2>让应用程序等待数据库</h2>

<p>这一步不是绝对必要的，但是它加速了弹性容器服务(ECS)资源的设置，所以值得一做。当web应用程序在其ECS任务容器中启动时，它必须通过负载平衡器连接到数据库任务容器。我们将在下一节看到更多这方面的内容。然而，负载平衡器可能需要几分钟来注册数据库容器，如果我们让web应用程序尝试立即连接，它将会失败，然后ECS将不得不销毁应用程序容器并启动一个新的容器，这需要更多时间。</p>

<p>为了尽量减少这种情况，我们将添加一个<a href="https://github.com/vishnubob/wait-for-it" target="_blank" rel="noreferrer noopener">借用脚本</a>来等待数据库连接。在web应用项目的根目录下创建一个<code>wait-for-it.sh</code>文件，并将该文件的<a href="https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh" target="_blank" rel="noreferrer noopener">内容剪切并粘贴到您新创建的文件中。</a></p>

<p>然后将电影分级web应用程序项目中的<code>Dockerfile</code>改为如下所示:</p>

<pre><code class="language-dockefile">FROM openjdk:8u181-alpine3.8

WORKDIR /

RUN apk update &amp;&amp; apk add bash

COPY wait-for-it.sh wait-for-it.sh

COPY target/film-ratings.jar film-ratings.jar
EXPOSE 3000

RUN chmod +x wait-for-it.sh

CMD ["sh", "-c", "./wait-for-it.sh --timeout=90 $DB_HOST:5432 -- java -jar film-ratings.jar"]

</code></pre>
<p>这确保了<code>wait-for-it.sh</code>脚本运行并反复尝试连接到端口5432上的<code>DB_HOST</code>。如果它在90秒内连接上，它就会运行<code>java -jar film-ratings.jar</code>。</p>

<p>另外，将您的<code>project.clj</code>文件中的版本更新为<code>0.1.1</code>:</p>

<pre><code class="language-clojure">(defproject film-ratings "0.1.1"
...
</code></pre>

<p>完成这些更改后，将它们添加并提交到Git，然后推送到电影分级项目的GitHub存储库:</p>

<pre><code class="language-bash">$ git add . --all
$ git commit -m "Add wait for it script"
[master 45967e8] Add wait for it script
2 files changed, 185 insertions(+), 1 deletion(-)
create mode 100644 wait-for-it.sh
$ git push
</code></pre>

<p>您可以在您的CircleCI <a href="https://circleci.com/dashboard" target="_blank" rel="noreferrer noopener">仪表板</a>中检查CircleCI构建是否运行正常。</p>

<p>现在将您的更改标记为<code>0.1.1</code>和<code>push</code>，这样CircleCI就会将它发布为最新版本:</p>

<pre><code class="language-bash">$ git tag -a 0.1.1 -m "v0.1.1"
$ git push origin 0.1.1
...
 * [new tag]         0.1.1 -&gt; 0.1.1
</code></pre>

<p>在CircleCI上检查<code>build_and_deploy</code>工作流是否将Docker图像发布到Docker Hub。</p>

<p><img src="../Images/341c804877418b8bd398b303bc9c3f23.png" alt="Deploy successful" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-deploy-success.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-deploy-success.png"/></p>

<h2>使用Terraform的AWS基础设施</h2>

<p>我们将使用Terraform在AWS中构建一个类似生产的基础设施。这是相当多的Terraform配置，所以我不打算遍历我已经定义的每个资源。您可以在闲暇时随意查看这些代码。</p>

<p>首先，使用库标题右边的fork按钮将我的<a href="https://github.com/chrishowejones/film-ratings-terraform">film-ratings-terra form</a>repo分支到GitHub中，并将分支后的版本克隆到本地机器上。</p>

<pre><code class="language-bash">$ git clone &lt;the github URL for your forked version of chrishowejones/film-ratings-terraform&gt;
</code></pre>

<p>既然您已经派生并克隆了Terraform存储库，让我们来看看它的一些重要部分。Terraform的总体功能是什么？</p>

<p>下图是基础设施中几个更重要部分的极其简化的版本。</p>

<p><img src="../Images/8f3f0fd75bcf08943cb8137acd63a16f.png" alt="Simplified AWS Infrastructure" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-simplified-AWS.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-simplified-AWS.png"/></p>
<p>简化的AWS基础设施</p>
<p><br/></p>

<p>这表明我们将设置两个名为<code>film_ratings_app</code>和<code>film_ratings_db</code>的ECS任务，它们将在ECS容器中运行，包含两个应用程序实例和一个数据库实例。app和db任务将在它们自己的服务中运行，类似地分别称为<code>film_ratings_app_service</code>和<code>film_ratings_db_service</code>(图中未显示)。</p>

<p>以下是应用服务和应用任务定义:</p>

<pre><code class="language-terraform">resource "aws_ecs_service" "film_ratings_app_service" {
  name            = "film_ratings_app_service"
  iam_role        = "${aws_iam_role.ecs-service-role.name}"
  cluster         = "${aws_ecs_cluster.film_ratings_ecs_cluster.id}"
  task_definition = "${aws_ecs_task_definition.film_ratings_app.family}:${max("${aws_ecs_task_definition.film_ratings_app.revision}", "${data.aws_ecs_task_definition.film_ratings_app.revision}")}"
  depends_on      = [ "aws_ecs_service.film_ratings_db_service"]
  desired_count   = "${var.desired_capacity}"
  deployment_minimum_healthy_percent = "50"
  deployment_maximum_percent = "100"
  lifecycle {
    ignore_changes = ["task_definition"]
  }

  load_balancer {
    target_group_arn  = "${aws_alb_target_group.film_ratings_app_target_group.arn}"
    container_port    = 3000
    container_name    = "film_ratings_app"
  }
}
</code></pre>

<p>film-ratings-app-service.tf</p>
<p><br/></p>

<p><strong>注:</strong> <i>最低健康百分比为50%。这允许服务停止一个容器任务(只留下一个在运行)，以便在我们进行滚动部署时使用释放的资源来启动容器任务的新版本。</i></p>

<pre><code class="language-terraform">data "aws_ecs_task_definition" "film_ratings_app" {
  task_definition = "${aws_ecs_task_definition.film_ratings_app.family}"
  depends_on = ["aws_ecs_task_definition.film_ratings_app"]
}

resource "aws_ecs_task_definition" "film_ratings_app" {
  family                = "film_ratings_app"
  container_definitions = &lt;&lt;DEFINITION
[
  {
    "name": "film_ratings_app",
    "image": "${var.film_ratings_app_image}",
    "essential": true,
    "portMappings": [
      {
        "containerPort": 3000,
        "hostPort": 3000
      }
    ],
    "environment": [
      {
        "name": "DB_HOST",
        "value": "${aws_lb.film_ratings_nw_load_balancer.dns_name}"
      },
      {
        "name": "DB_PASSWORD",
        "value": "${var.db_password}"
      }
    ],
    "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "film_ratings_app",
          "awslogs-region": "${var.region}",
          "awslogs-stream-prefix": "ecs"
        }
    },
    "memory": 1024,
    "cpu": 256
  }
]
DEFINITION
}
</code></pre>

<p>film-ratings-app-task-definition.tf</p>
<p><br/></p>

<p>应用程序实例需要通过端口5432与数据库实例通信。为了做到这一点，他们需要通过网络负载平衡器(<code>film-ratings-nw-load-balancer</code>)路由他们的请求，因此当我们设置<code>film_ratings_app</code>任务时，我们需要将网络负载平衡器的DNS名称传递给容器，以便容器中的应用程序可以使用它作为与数据库对话的<code>DB_HOST</code>。</p>

<pre><code class="language-terraform">...
resource "aws_lb_target_group" "film_ratings_db_target_group" {
  name                = "film-ratings-db-target-group"
  port                = "5432"
  protocol            = "TCP"
  vpc_id              = "${aws_vpc.film_ratings_vpc.id}"
  target_type         = "ip"

  health_check {
    healthy_threshold   = "3"
    unhealthy_threshold = "3"
    interval            = "10"
    port                = "traffic-port"
    protocol            = "TCP"
  }

  tags {
    Name = "film-ratings-db-target-group"
  }
}

resource "aws_lb_listener" "film_ratings_nw_listener" {
  load_balancer_arn = "${aws_lb.film_ratings_nw_load_balancer.arn}"
  port              = "5432"
  protocol          = "TCP"

  default_action {
    target_group_arn = "${aws_lb_target_group.film_ratings_db_target_group.arn}"
    type             = "forward"
  }
}
</code></pre>

<p>network-load-balancer.tf</p>
<p><br/></p>

<p>应用程序负载平衡器(<code>film-ratings-alb-load-balancer</code>)是我们将用来指向我们的浏览器。它将负责将HTTP请求路由到<code>film_ratings_app</code>容器的两个实例之一，为我们将默认端口80映射到端口3000。</p>

<pre><code class="language-terraform">...
resource "aws_alb_target_group" "film_ratings_app_target_group" {
  name                = "film-ratings-app-target-group"
  port                = 3000
  protocol            = "HTTP"
  vpc_id              = "${aws_vpc.film_ratings_vpc.id}"
  deregistration_delay = "10"

  health_check {
    healthy_threshold   = "2"
    unhealthy_threshold = "6"
    interval            = "30"
    matcher             = "200,301,302"
    path                = "/"
    protocol            = "HTTP"
    timeout             = "5"
  }

  stickiness {
    type  = "lb_cookie"
  }

  tags = {
    Name = "film-ratings-app-target-group"
  }
}

resource "aws_alb_listener" "alb-listener" {
  load_balancer_arn = "${aws_alb.film_ratings_alb_load_balancer.arn}"
  port              = "80"
  protocol          = "HTTP"

  default_action {
    target_group_arn = "${aws_alb_target_group.film_ratings_app_target_group.arn}"
    type             = "forward"
  }
}

resource "aws_autoscaling_attachment" "asg_attachment_film_rating_app" {
  autoscaling_group_name = "film-ratings-autoscaling-group"
  alb_target_group_arn   = "${aws_alb_target_group.film_ratings_app_target_group.arn}"
  depends_on = [ "aws_autoscaling_group.film-ratings-autoscaling-group" ]
}
</code></pre>

<p>application-load-balancer.tf</p>
<p><br/></p>

<p>所示基础设施的另一个重要部分是,<code>film_ratings_db</code>容器装载了一个卷，该卷被映射到一个弹性文件系统卷，以便在运行容器的EC2实例之外持久存储数据。我们这样做是为了，如果我们必须放大或缩小实例(或者如果实例死亡)，我们不会丢失数据库中的数据。</p>

<pre><code class="language-terraform">resource "aws_ecs_task_definition" "film_ratings_db" {
  family                = "film_ratings_db"
  volume {
    name = "filmdbvolume"
    host_path = "/mnt/efs/postgres"
  }
  network_mode = "awsvpc"
  container_definitions = &lt;&lt;DEFINITION
[
  {
    "name": "film_ratings_db",
    "image": "postgres:alpine",
    "essential": true,
    "portMappings": [
      {
        "containerPort": 5432
      }
    ],
    "environment": [
      {
        "name": "POSTGRES_DB",
        "value": "filmdb"
      },
      {
        "name": "POSTGRES_USER",
        "value": "filmuser"
      },
      {
        "name": "POSTGRES_PASSWORD",
        "value": "${var.db_password}"
      }
    ],
    "mountPoints": [
        {
          "readOnly": null,
          "containerPath": "/var/lib/postgresql/data",
          "sourceVolume": "filmdbvolume"
        }
    ],
    "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "film_ratings_db",
          "awslogs-region": "${var.region}",
          "awslogs-stream-prefix": "ecs"
        }
    },
    "memory": 512,
    "cpu": 256
  }
]
DEFINITION
}
</code></pre>

<p>film-ratings-db-task-definition.tf</p>
<p><br/></p>

<p>启动配置确保当EC2实例启动时，通过<code>user_data</code>条目挂载EFS卷。</p>

<pre><code class="language-terraform">...
  user_data                   = &lt;&lt;EOF
                                  #!/bin/bash
                                  echo ECS_CLUSTER=${var.ecs_cluster} &gt;&gt; /etc/ecs/ecs.config
                                  mkdir -p /mnt/efs/postgres
                                  cd /mnt
                                  sudo yum install -y amazon-efs-utils
                                  sudo mount -t efs ${aws_efs_mount_target.filmdbefs-mnt.0.dns_name}:/ efs
                                  EOF
</code></pre>

<p>启动-配置. tf</p>
<p><br/></p>

<h2>创建AWS基础设施</h2>

<p>我们几乎已经准备好运行我们的Terraform了，但在此之前，我们需要确保我们有各种变量的所有正确值。我们来看一下<code>terraform.tfvars</code>文件。</p>

<pre><code class="language-terraform"># You may need to edit these variables to match your config
db_password= "password"
ecs_cluster="film_ratings_cluster"
ecs_key_pair_name="film_ratings_key_pair"
region= "eu-west-1"
film_ratings_app_image= "chrishowejones/film-ratings-app:latest"

# no need to change these unless you want to
film_ratings_vpc = "film_ratings_vpc"
film_ratings_network_cidr = "210.0.0.0/16"
film_ratings_public_01_cidr = "210.0.0.0/24"
film_ratings_public_02_cidr = "210.0.10.0/24"
max_instance_size = 3
min_instance_size = 1
desired_capacity = 2 
</code></pre>

<p>泰若人</p>
<p><br/></p>

<p>如果需要，您可以编辑密码，但是对于这个演示来说，这并不是真正必要的。您也可以通过设置环境变量<code>TF_VAR_db_password</code>来覆盖密码。<code>ecs_key_pair_name</code>值必须与您之前在<code>.ssh/</code>目录中为AWS用户创建的密钥对的名称相匹配。您还必须将<code>film_ratings_app_image</code>更改为您的图像的Docker Hub存储库图像名称，而不是我的(确保您已经发布了名称正确的Docker Hub存储库图像——如果您已经完成了本博客系列的<a href="https://circleci.com/blog/package-a-clojure-web-application-using-docker/">第2部分</a>,您应该已经发布了)。</p>

<p>如果您想使用与我正在使用的不同的AWS区域，您将需要更改<code>region</code>值。<code>data.tf</code>文件确保<code>${data.aws_ami.latest_ecs.id}</code>变量被设置为适合您所在地区的<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html" target="_blank" rel="noreferrer noopener"> ECS优化AMI映像</a>。</p>

<p>不应该有理由去改变其他任何东西。</p>

<h2>运行地形</h2>

<p>一旦正确设置了<code>terraform.tfvars</code>值，就需要在克隆的<code>film-ratings-terraform</code>目录中初始化Terraform:</p>

<pre><code class="language-bash">$ terraform init

Initializing provider plugins...
- Checking for available provider plugins on https://releases.hashicorp.com...
...
Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
</code></pre>

<p>然后，您可以运行一个Terraform计划来检查应用该计划时将会创建哪些资源。系统将提示您输入AWS访问密钥id和AWS秘密访问密钥。如果您厌倦了输入这些，您可以在您的终端会话中设置环境变量<code>TF_VAR_aws_access_key_id</code>和<code>TF_VAR_aws_secret_access_key</code>。</p>

<pre><code class="language-bash">$ terraform plan
var.aws_access_key_id
  AWS access key

  Enter a value: ...
...
Refreshing Terraform state in-memory prior to plan...
...
Plan: 32 to add, 0 to change, 0 to destroy.

------------------------------------------------------------------------

Note: You didn't specify an "-out" parameter to save this plan, so Terraform
can't guarantee that exactly these actions will be performed if
"terraform apply" is subsequently run.

 
To actually build the AWS resources listed in the plan, use the following command (enter `yes` when prompted with `Do you want to perform these actions?`):


$ terraform apply
data.aws_iam_policy_document.ecs-instance-policy: Refreshing state...
data.aws_availability_zones.available: Refreshing state...
data.aws_iam_policy_document.ecs-service-policy: Refreshing state...
...
Plan: 32 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
...
aws_autoscaling_group.film-ratings-autoscaling-group: Creation complete after 1m10s (ID: film-ratings-autoscaling-group)

Apply complete! Resources: 32 added, 0 changed, 0 destroyed.

Outputs:

app-alb-load-balancer-dns-name = film-ratings-alb-load-balancer-895483441.eu-west-1.elb.amazonaws.com
app-alb-load-balancer-name = film-ratings-alb-load-balancer
ecs-instance-role-name = ecs-instance-role
ecs-service-role-arn = arn:aws:iam::731430262381:role/ecs-service-role
film-ratings-app-target-group-arn = arn:aws:elasticloadbalancing:eu-west-1:731430262381:targetgroup/film-ratings-app-target-group/8a35ef20a2bab372
film-ratings-db-target-group-arn = arn:aws:elasticloadbalancing:eu-west-1:731430262381:targetgroup/film-ratings-db-target-group/5de91812c3fb7c63
film_ratings_public_sg_id = sg-08af1f2ab0bb6ca95
film_ratings_public_sn_01_id = subnet-00b42a3598abf988f
film_ratings_public_sn_02_id = subnet-0bb02c32db76d7b05
film_ratings_vpc_id = vpc-06d431b5e5ad36195
mount-target-dns = fs-151074dd.efs.eu-west-1.amazonaws.com
nw-lb-load-balancer-dns-name = film-ratings-nw-load-balancer-4c3a6e6a0dab3cfb.elb.eu-west-1.amazonaws.com
nw-lb-load-balancer-name = film-ratings-nw-load-balancer
region = eu-west-1
</code></pre>

<p>Terraform可能需要五分钟才能运行，负载平衡器和ECS服务可能还需要五分钟才能正确识别彼此。您可以通过登录AWS控制台并从<strong>服务</strong>下拉列表中选择<strong> ECS </strong>，选择您的集群(默认情况下名为<code>film_ratings_cluster</code>，并检查附加到每个服务的日志来检查进度。<code>film_ratings_app_service</code>可能需要一点时间来连接，有时，即使使用<code>wait-for-it.sh</code>脚本，第一个启动的任务可能无法连接到数据库，您必须等待自动缩放来启动另一个任务实例。</p>

<p>一旦ECS服务和任务启动，您就可以使用<code>app-alb-load-balancer-dns-name</code>值作为URL，尝试通过您的浏览器连接到应用程序(在上面的输出中显示为<code>film-ratings-alb-load-balancer-895483441.eu-west-1.elb.amazonaws.com</code>，但是您的值会有所不同)。</p>

<p>如果您最初看到HTTP状态502或503，请不要担心，因为即使在ECS服务启动后，应用程序负载平衡器也需要几分钟时间来检测一切是否正常。最后，如果您在浏览器中输入alb负载平衡器DNS名称的URL，在我的示例中为<code>film-ratings-alb-load-balancer-895483441.eu-west-1.elb.amazonaws.com</code>，您应该会看到这个。</p>

<p><img src="../Images/32597fb566c47837d758be80ed996230.png" alt="Film ratings page" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-film-ratings-page.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-film-ratings-page.png"/></p>

<p>在这一点上，值得注意的是，要拆除所有这些资源，您可以发出<code>terraform destroy</code>命令(如果您真的想销毁所有资源，在提示时输入‘yes’)。</p>

<h2>让CircleCI部署到ECS集群</h2>

<p>接下来，我们希望使用我们的持续集成服务CircleCI来为我们发布Docker实例。</p>

<p>到目前为止，在我们的CircleCI配置中，每当我们向GitHub推送更改时，我们都在构建和测试我们的应用程序，每当我们在GitHub中标记我们的项目时，我们都在构建、测试、打包为Docker容器，并将Docker容器发布到Docker Hub。</p>

<p>在本文的这一部分，我们将添加配置，以便在标记项目时将打包的Docker容器推送到我们的ECS集群，但是我们将添加一个手动批准步骤，该步骤允许我们控制开始部署到ECS的时间。由于我们已将ECS服务设置为使用滚动部署，因此该流程将在零宕机的情况下部署我们已更改、已标记的应用程序。</p>

<p>现在我们的<code>.circleci/config.yml</code>有三份工作，<code>build</code>、<code>build-docker</code>和<code>publish-docker</code>。在<code>publish-docker</code>下面再加一个工作叫<code>deploy</code>。</p>

<pre><code class="language-yaml">  ...
  deploy:
    docker:
      - image: circleci/python:3.6.1
    environment:
      AWS_DEFAULT_OUTPUT: json
      IMAGE_NAME: chrishowejones/film-ratings-app
    steps:
      - checkout
      - restore_cache:
          key: v1-{{ checksum "requirements.txt" }}
      - run:
          name: Install the AWS CLI
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
      - save_cache:
          key: v1-{{ checksum "requirements.txt" }}
          paths:
            - "venv"
      - run:
          name: Deploy
          command: |
            . venv/bin/activate
            ./deploy.sh
...
</code></pre>

<p>。圆形/config.yml</p>
<p><br/></p>

<p>该作业将使用<code>pip</code>(Python包管理器)通过读取CLI包要求的<code>requirements.txt</code>文件来安装AWS CLI工具。然后运行步骤<code>Deploy</code>运行一个我们还没有创建的<code>deploy.sh</code>脚本。<i>记住将</i> <code>IMAGE_NAME</code> <i>更改为您的映像而不是我的映像的Docker Hub存储库映像名称。在我们继续之前，让我们将我们需要的额外工作添加到<code>build_and_deploy</code>工作流程的末尾。</i></p>

<pre><code class="language-yaml">...
      - hold:
          requires:
            - publish-docker
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+$/
      - deploy:
          requires:
            - hold
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+$/
</code></pre>
<p>。圆形/config.yml</p>
<p><br/></p>

<p>我们已经向<code>build_and_deploy</code>工作流添加了两个新任务。第一个是<code>hold</code>，要求前面的<code>publish-docker</code>步骤在执行之前完成，类型为“批准”。“批准”类型是一个内置的CircleCI类型，它将停止工作流，并要求用户单击<strong>批准</strong>以继续任何后续步骤。</p>

<p><code>deploy</code>工作依赖于<code>hold</code>被批准。</p>

<p><strong>注意:</strong> <i>和<code>build_and_deploy</code>工作流中的每一个步骤一样，这些步骤只有在语义版本样式标签被推送时才会被触发(如0.1.1)。</i></p>

<p>让我们在项目根目录中添加<code>requirements.txt</code>文件，以确保CircleCI安装了AWS CLI工具。该文件的内容应该是:</p>

<pre><code>awscli&gt;=1.16.0

</code></pre>
<p>requirements.txt</p>
<p><br/></p>

<p>让我们通过在我们项目的根目录中创建这个新文件来添加在<code>deploy</code>作业中引用的<code>deploy.sh</code>脚本。</p>

<pre><code class="language-bash">#!/usr/bin/env bash

# more bash-friendly output for jq
JQ="jq --raw-output --exit-status"

configure_aws_cli(){
        aws --version
        aws configure set default.region eu-west-1 # change this if your AWS region differs
        aws configure set default.output json
}

deploy_cluster() {

    family="film_ratings_app"

    make_task_def
    register_definition
    if [[ $(aws ecs update-service --cluster film_ratings_cluster  --service film_ratings_app_service --task-definition $revision | \
                   $JQ '.service.taskDefinition') != $revision ]]; then
        echo "Error updating service."
        return 1
    fi

    # wait for older revisions to disappear
    # not really necessary, but nice for demos
    for attempt in {1..15}; do
        if stale=$(aws ecs describe-services --cluster film_ratings_cluster --services film_ratings_app_service | \
                       $JQ ".services[0].deployments | .[] | select(.taskDefinition != \"$revision\") | .taskDefinition"); then
            echo "Waiting for stale deployments:"
            echo "$stale"
            sleep 45
        else
            echo "Deployed!"
            return 0
        fi
    done
    echo "Service update took too long."
    return 1
}

make_task_def(){
        task_template='[
                {
                    "name": "film_ratings_app",
                    "image": "%s:%s",
                    "essential": true,
                    "portMappings": [
                      {
                          "containerPort": 3000,
                          "hostPort": 3000
                      }
                    ],
                    "environment": [
                      {
                        "name": "DB_HOST",
                        "value": "%s"
                      },
                      {
                        "name": "DB_PASSWORD",
                        "value": "%s"
                      }
                    ],
                    "logConfiguration": {
                      "logDriver": "awslogs",
                      "options": {
                        "awslogs-group": "film_ratings_app",
                        "awslogs-region": "eu-west-1",
                        "awslogs-stream-prefix": "ecs"
                      }
                    },
                    "memory": 1024,
                    "cpu": 256
                }
        ]'

        task_def=$(printf "$task_template" $IMAGE_NAME $CIRCLE_TAG $DB_HOST $DB_PASSWORD)
}

register_definition() {

    if revision=$(aws ecs register-task-definition --container-definitions "$task_def" --family $family | $JQ '.taskDefinition.taskDefinitionArn'); then
        echo "Revision: $revision"
    else
        echo "Failed to register task definition"
        return 1
    fi

}

configure_aws_cli
deploy_cluster
</code></pre>

<p>deploy.sh</p>
<p><br/></p>

<p>这个脚本将为我们的<code>film_ratings_app</code>任务创建一个新的任务定义。如果你看一下配置，它反映了<code>film-ratings-app-task-definition.tf</code>中的地形定义。然后，它将这个新任务部署到集群中。</p>

<p>请注意，<code>make_task_def</code>函数中设置的<code>task_def</code>会替换名为<code>$IMAGE_NAME</code>、<code>$CIRCLE_TAG</code>、<code>$DB_HOST</code>和<code>$DB_PASSWORD</code>的变量的值。稍后我们将在CircleCI项目环境变量中设置这些变量。</p>

<p><strong>注意:</strong> <i>如果您使用的是与<code>eu-west-1</code>不同的AWS区域，您需要更改第8 &amp; 67行的条目。</i></p>

<p>在继续之前，让我们使这个新的脚本文件可执行。</p>

<pre><code class="language-bash">$ chmod +x deploy.sh
</code></pre>
<p>现在，让我们将这些变量和我们需要的AWS变量添加到CircleCI配置中。</p>

<p>进入你的CircleCI <a href="https://circleci.com/dashboard" target="_blank" rel="noreferrer noopener">仪表盘</a>选择你的电影分级项目的设置，在<strong>构建设置</strong>下选择<strong>环境变量</strong>，输入以下变量:</p>

<p><img src="../Images/fa439b71bc4f85e9fe6e294109ffc6ad.png" alt="CircleCI environment variables" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-env-vars.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-env-vars.png"/></p>

<p><strong>注意:</strong> <i>这里应该已经设置了<code>DOCKERHUB_PASS</code>和<code>DOCKERHUB_USERNAME</code>。</i></p>

<p>使用创建用户时获得的AWS访问密钥id和AWS秘密访问密钥(与运行Terraform时设置的值相同)。记住你可以在这里找到你的AWS账户id<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html#FindingYourAWSId" target="_blank" rel="noreferrer noopener"/>。将您的<code>DB_PASSWORD</code>设置为您在<code>terraform.tfvars</code>文件中使用的任何值。</p>

<p><code>DB_HOST</code>值需要是将TCP请求路由到<code>film_ratings_db</code>任务实例的网络负载平衡器的DNS名称。您可以在<code>terraform apply</code>命令的输出中找到这一点，或者登录到您的AWS管理控制台，从<strong>服务</strong>导航到<strong> EC2 </strong>，并从那里导航到<strong>负载平衡器</strong>，如果您选择<code>film-ratings-nw-load-balancer</code>条目，您应该会看到DNS名称(在<strong>基本配置</strong>部分)。</p>

<pre><code class="language-bash">nw-lb-load-balancer-dns-name = film-ratings-nw-load-balancer-4c3a6e6a0dab3cfb.elb.eu-west-1.amazonaws.com
nw-lb-load-balancer-name = film-ratings-nw-load-balancer
region = eu-west-1
</code></pre>
<p>terraform应用命令的输出</p>
<p><br/></p>

<p>在这里的例子中，CircleCI中的<code>DB_HOST</code>变量应该设置为<code>film-ratings-nw-load-balancer-4c3a6e6a0dab3cfb.elb.eu-west-1.amazonaws.com</code>。</p>

<p><strong>注意:</strong> <i>如果您已经销毁了您的AWS资源，您将需要使用<code>film-ratings-terraform</code>目录中的<code>terraform apply</code>命令重新设置它们，以设置AWS资源来获得网络负载平衡器DNS。</i></p>

<p>一旦设置了环境变量，就可以提交对CircleCI配置和新部署脚本文件的更改，并将它们推送到GitHub。</p>

<pre><code class="language-bash">$ git add . --all
$ git commit -m "Added config to deploy to ECS"
$ git push origin master
</code></pre>

<h2>更改应用程序并部署</h2>

<p>现在，我们将通过向我们的应用程序添加一些功能，然后对其进行标记并将更改部署到ECS群集，来证明CircleCI配置正在工作。</p>

<p>让我们在应用程序中添加一个搜索特性。</p>

<p>首先，将路由和处理程序键的映射添加到<code>resources/film_ratings/config.edn</code>文件中，以显示搜索表单并处理搜索表单的post:</p>

<pre><code class="language-edn">... 
:duct.module/ataraxy
 {\[:get "/"\] [:index]
  "/add-film"
  {:get [:film/show-create]
   \[:post {film-form :form-params}\] [:film/create film-form]}
  \[:get "/list-films"\] [:film/list]
  "/find-by-name"
  {:get [:film/show-search]
   \[:post {search-form :form-params}\] [:film/find-by-name search-form]}}

 :film-ratings.handler/index {}
 :film-ratings.handler.film/show-create {}
 :film-ratings.handler.film/create {:db #ig/ref :duct.database/sql}
 :film-ratings.handler.film/list {:db #ig/ref :duct.database/sql}
 :film-ratings.handler.film/show-search {}
 :film-ratings.handler.film/find-by-name {:db #ig/ref :duct.database/sql}
...
</code></pre>

<p>resources/film _ ratios/config . edn</p>
<p><br/></p>

<p>接下来，让我们将<code>show-search</code>和<code>find-by-name</code>键的处理程序添加到<code>src/film_ratings/handler/film.clj</code>文件的底部:</p>

<pre><code class="language-clojure">...

(defmethod ig/init-key :film-ratings.handler.film/show-search [_ _]
  (fn [_]
    [::response/ok (views.film/search-film-by-name-view)]))

(defmethod ig/init-key :film-ratings.handler.film/find-by-name [_ {:keys [db]}]
  (fn [{[_ search-form] :ataraxy/result :as request}]
    (let [name (get search-form "name")
          films-list (boundary.film/fetch-films-by-name db name)]
      (if (seq films-list)
        [::response/ok (views.film/list-films-view films-list {})]
        [::response/ok (views.film/list-films-view [] {:messages [(format "No films found for %s." name)]})]))))
</code></pre>

<p>src/film _ ratings/handler/film . clj</p>
<p><br/></p>

<p>让我们在<code>src/film_ratings/views/index.clj</code>文件的索引视图中添加一个新按钮:</p>

<pre><code class="language-clojure">(defn list-options []
  (page
    [:div.container.jumbotron.bg-white.text-center
     [:row
      [:p
       [:a.btn.btn-primary {:href "/add-film"} "Add a Film"]]]
     [:row
      [:p
       [:a.btn.btn-primary {:href "/list-films"} "List Films"]]]
     [:row
      [:p
       [:a.btn.btn-primary {:href "/find-by-name"} "Search Films"]]]]))
</code></pre>

<p>src/film _ ratings/handler/index . clj</p>
<p><br/></p>

<p>现在我们需要在<code>src/film_ratings/views/film.clj</code>文件底部的<code>search-films-by-name-view</code>视图:</p>

<pre><code class="language-clojure">...

(defn search-film-by-name-view
  []
  (page
   [:div.container.jumbotron.bg-light
    [:div.row
     [:h2 "Search for film by name"]]
    [:div
     (form-to [:post "/find-by-name"]
              (anti-forgery-field)
              [:div.form-group.col-12
               (label :name "Name:")
               (text-field {:class "mb-3 form-control" :placeholder "Enter film name"} :name)]
              [:div.form-group.col-12.text-center
               (submit-button {:class "btn btn-primary text-center"} "Search")])]]))
</code></pre>

<p>src/film _ ratings/views/film . clj</p>
<p><br/></p>

<p>数据库边界协议和相关实现需要在<code>find-by-name</code>处理程序中引用的<code>fetch-films-by-name</code>函数。在<code>src/film_ratings/boundary/film.clj</code>文件中为协议添加适当的功能和协议扩展，如下所示:</p>

<pre><code class="language-clojure">...
(defprotocol FilmDatabase
  (list-films [db])
  (fetch-films-by-name [db name])
  (create-film [db film]))

(extend-protocol FilmDatabase
  duct.database.sql.Boundary
  (list-films [{db :spec}]
    (jdbc/query db ["SELECT * FROM film"]))
  (fetch-films-by-name [{db :spec} name]
    (let [search-term (str "%" name "%")]
     (jdbc/query db ["SELECT * FROM film WHERE LOWER(name) like LOWER(?)" search-term])))
  (create-film [{db :spec} film]
    (try
     (let [result (jdbc/insert! db :film film)]
       (if-let [id (val (ffirst result))]
         {:id id}
         {:errors ["Failed to add film."]}))
     (catch SQLException ex
       (log/errorf "Failed to insert film. %s\n" (.getMessage ex))
       {:errors [(format "Film not added due to %s" (.getMessage ex))]}))))
</code></pre>

<p>src/film _ ratings/boundary/film . clj</p>
<p><br/></p>

<p>另外，将项目文件中构建的版本号更改为<code>0.2.0</code>。</p>

<pre><code class="language-clojure">(defproject film-ratings "0.2.0"
...
</code></pre>

<p>现在，您应该能够通过运行以下命令对此进行测试:</p>

<pre><code class="language-bash">$ lein repl
nREPL server started on port 43477 on host 127.0.0.1 - nrepl://127.0.0.1:43477
REPL-y 0.3.7, nREPL 0.2.12
Clojure 1.9.0
Java HotSpot(TM) 64-Bit Server VM 1.8.0_191-b12
    Docs: (doc function-name-here)
          (find-doc "part-of-name-here")
  Source: (source function-name-here)
 Javadoc: (javadoc java-object-or-class-here)
    Exit: Control+D or (exit) or (quit)
 Results: Stored in vars *1, *2, *3, an exception in *e

user=&gt; (dev)
:loaded
dev=&gt; (go)
:duct.server.http.jetty/starting-server {:port 3000}
:initiated
dev=&gt; 
</code></pre>

<p>如果你打开浏览器到<a href="http://localhost:3000/" target="_blank" rel="noreferrer noopener"> http://localhost:3000/ </a>，你应该在索引上看到<strong>搜索电影</strong></p>

<p><img src="../Images/838627192575549845e9eabbb74ca565.png" alt="Search films added" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-search-films.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-search-films.png"/></p>

<p>现在将一些电影添加到您的测试(SQLite)数据库中，并使用<strong>搜索电影</strong>将您带到搜索表单。填写你的一部或多部电影的部分名称。</p>

<p><img src="../Images/ee25f385ec0f1b317296f48d543c31d7.png" alt="Search for a film by name" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-search-film-by-name.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-search-film-by-name.png"/></p>

<p>按下<strong>搜索</strong>，查看搜索结果是否符合您的预期。</p>

<p><img src="../Images/91463a9fab5aeb0e5321f68003bbc197.png" alt="Film search results" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-film-search-results.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-film-search-results.png"/></p>

<p>也可以尝试非匹配搜索。</p>

<p><img src="../Images/fbd054ab590894af5cd9a8124c8d2af5.png" alt="Non-matching search results" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-non-matching-search.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-non-matching-search.png"/></p>

<p>是时候将您的更改提交到GitHub了。</p>

<pre><code class="language-bash">$ git add . --all
$ git commit -m "Added search for films"
$ git push origin master
</code></pre>

<p>您可以在您的CircleCI <a href="https://circleci.com/dashboard" target="_blank" rel="noreferrer noopener">仪表板</a>中检查CircleCI构建是否运行正常。</p>

<p>接下来，我们将用新版本<code>0.2.0</code>标记我们的构建。</p>

<pre><code class="language-bsh">$ git tag -a 0.2.0 -m "v0.2.0"
$ git push origin 0.2.0         
...
 * [new tag]         0.2.0 -&gt; 0.2.0
</code></pre>
<p>这将触发CircleCI中的<code>build_and_deploy</code>工作流</p>

<p>大约几分钟后，您应该看到工作流完成发布到Docker Hub，然后继续等待。</p>

<p><img src="../Images/b6f149f650c121cd8704e6a6b96938d5.png" alt="Workflow complete" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2019-06-27-workflow-complete.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2019-06-27-workflow-complete.png"/></p>

<p>如果您单击暂停作业，然后<strong>批准</strong>它，工作流将继续并部署到ECS。部署步骤可能需要几分钟，AWS弹性容器服务可能需要五分钟来滚动部署这两个实例。您可以在ECS控制台中检查ECS部署的进度。如果您尝试在大约5分钟后在浏览器中输入应用程序负载平衡器DNS名称，您应该会看到新的搜索按钮，您可以添加电影并搜索它们。</p>

<p><strong>运行</strong> <code>film-ratings-terraform</code> <strong>目录中的</strong> <code>terraform destroy</code> <strong>命令，不要忘了销毁AWS资源。</strong></p>

<h2>摘要</h2>

<p>恭喜你！如果您已经阅读了整个博客系列，那么您已经使用PostgreSQL数据库创建了一个Clojure web应用程序，测试了它，构建了它，将其打包到Docker容器中，发布了该容器，建立了一个AWS弹性容器服务，并使用Terraform部署到集群🎉！</p>

<p>这是一个相当现实的设置，虽然有点简单，但可以用在实时web应用程序中。您可能希望添加一个指向应用程序负载平衡器的web域，使用TLS证书保护通信，并添加更多的监控，但是您已经构建了所需的大部分内容。</p>


        
          
          
            <hr/>
            <p>Chris Howe-Jones是顾问CTO、软件架构师、精益/敏捷蔻驰、开发人员和DevCycle的技术导航员。他主要从事Clojure/ClojureScript、Java和Scala方面的工作，客户从跨国组织到小型创业公司。</p>

            <p><a href="/blog/author/chris-howe-jones/" class="arrow-link">阅读更多克里斯·豪-琼斯的文章</a></p>
          
        
      </div>
    </div>    
</body>
</html>