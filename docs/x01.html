<html>
<head>
<title>Testing Commander.js command line applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>测试Commander.js命令行应用程序</h1>
<blockquote>原文：<a href="https://circleci.com/blog/testing-command-line-applications/#2022-06-10T09:00:00-07:00">https://circleci.com/blog/testing-command-line-applications/#2022-06-10T09:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <blockquote>
  <p>本教程涵盖:</p>
  <ol>
    <li>CLI应用程序如何工作</li>
    <li>为CLI应用程序编写测试</li>
    <li>使用CircleCI自动化命令行应用程序测试</li>
  </ol>
</blockquote>

<p>生产中的突破性变化是不方便的，而且修复起来可能会很昂贵。使用类似于<code>git clone &lt; some GitHub repository &gt;</code>的命令，在您的终端上执行是一种常见的做法，称为使用命令行。这种做法比使用GUI更快更有效。在本教程中，我将带您了解测试命令行应用程序<code>git</code>的过程，解释您为什么需要命令行应用程序，并详细描述它们是如何工作的。</p>

<h2>先决条件</h2>

<p>完成本教程需要以下项目:</p>



<blockquote><p>我们的教程是平台无关的，但是使用CircleCI作为例子。如果你没有CircleCI账号，请在 注册一个免费的<a href="https://circleci.com/signup/"> <strong>。</strong></a></p></blockquote>

<h2>设置应用程序</h2>

<p>为了帮助你完成本教程，我创建了一个Github库供你克隆。您需要通过在终端中运行以下命令来安装项目的依赖项:</p>

<pre><code>git clone https://github.com/CIRCLECI-GWP/palatial-cakes-cli-app.git

cd palatial-cakes-cli-app

npm install
</code></pre>

<h2>为什么要使用CLI应用程序？</h2>

<p>复杂的图形用户界面(GUI)带来的技术进步是惊人的，但我们不能否认命令行应用程序(CLI)引发了软件革命。</p>

<p>那么，到底什么是<code>CLI</code>应用呢？命令行界面(CLI)应用程序是一种程序，它允许通过计算机终端输入文本命令，然后主机将这些命令解释为正在执行的程序。</p>

<p>让我们看看为什么在某些情况下CLI应用程序比GUI应用程序更好。</p>

<ol>
  <li>了解CLI命令及其工具可以提高开发人员的工作效率。使用命令行实现自动化(重复任务)比使用GUI更快更有效。</li>
  <li>与GUI应用程序相比，CLI应用程序需要更少的内存和机器处理能力。</li>
  <li>由于其基于文本的界面，CLI应用程序可以在低分辨率显示器上完美运行，并受到大量操作系统的支持。</li>
</ol>

<h2>CLI应用程序如何工作的描述</h2>

<p>使用CLI应用程序需要在主机终端输入并执行文本命令。一些CLI应用程序允许用户从提供的默认<code>options</code>中进行选择，而其他应用程序除了提供的选项之外还需要手动文本输入。</p>

<p>让我们来看看执行<code>fetch</code>命令时,<code>git</code>命令行应用程序的命令行接口结构和语法示例。</p>

<p><img src="../Images/b9c57244e6ac5b37522757d5a0921229.png" alt="Git fetch CLI command" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-06-10-git-fetch-cli-command.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-06-10-git-fetch-cli-command.png"/></p>

<p>在这种情况下，<code>Program</code>关键字是实际程序的名称，通常是一个名词。<code>command</code>(一个动词)描述了程序做什么或者我们指示程序做什么。<code>Arguments</code>允许CLI接受正在处理的值。修改命令行为的一种有记录的参数类型被称为<code>option</code>。这些字符以连字符为前缀输入。</p>

<h2>概述我们的示例CLI应用程序如何工作</h2>

<p>在本教程中，我创建了一个实践CLI，它将帮助您学习如何测试命令行应用程序。CLI应用程序允许您订购蛋糕，并创建所有可订购蛋糕的列表。</p>

<p>运行我们的CLI应用程序有两个不同的命令:一个用于订购蛋糕，另一个用于获取可以订购的蛋糕列表。</p>

<h3>订购蛋糕</h3>

<p>要运行命令行蛋糕订单:</p>

<pre><code>npm run order-cake
</code></pre>

<h3>列出所有蛋糕</h3>

<p>要获取所有可用蛋糕的列表，请运行以下命令:</p>

<pre><code>npm run list-cakes
</code></pre>

<p>下面是使用CLI订购和列出蛋糕的两种不同工作流的图示。</p>

<p><img src="../Images/a103194eb532795bc38109335911e484.png" alt="Palatial cakes application flows" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-06-10-palatial-cakes-applicaton.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-06-10-palatial-cakes-applicaton.png"/></p>

<h2>为我们的CLI应用程序编写测试</h2>

<p>既然您已经看到了我们的CLI应用程序是如何工作的，那么最好仔细检查添加更多的更改不会破坏代码。测试还有助于您深入了解潜在的易出错区域。为此，您将向现有的cake应用程序逻辑添加测试。然后您将使用<a href="https://jestjs.io/" target="_blank" rel="noreferrer noopener"> Jest </a>来测试您的应用程序。</p>

<h2>理解蛋糕订购逻辑</h2>

<p>处理蛋糕订单的逻辑是这样实现的:</p>

<pre><code>/** lib/order.js **/
const inQuirerOder = async () =&gt; {
  const answers = await inquirer.prompt(orderDetailsQuestions);
  return Object.keys(answers).map(
    (key, index) =&gt; `\n${index + 1}:${key} =&gt; ${answers[key]}`
  );
};
</code></pre>

<p>使用<code>Inquirer.js</code>的<code>prompt()</code>方法，您为用户提供一个选项列表。对于每个问题，您使用其答案检索用户选择的答案。</p>

<p>根据<a href="https://www.npmjs.com/package/inquirer" target="_blank" rel="noreferrer noopener"> Inquirer.js </a>的文档，prompt方法接受一个包含问题对象和另一个参数的数组:answers，一个包含以前回答的问题的值的对象。默认情况下，answers对象为空:</p>

<pre><code>inquirer.prompt(questions, answers) -&gt; promise
</code></pre>

<p>为了测试这个逻辑，我们将提供问题和预期的答案，而不仅仅是提供问题，这将通过CLI提示输入。这导致询问者避免提示回答。</p>

<p>因为这个方法返回一个承诺，所以我们可以使用<code>[async-await](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function)</code>模式来获取响应对象。</p>

<p>接下来，您将测试订购各种蛋糕，因此将相关的测试分组到一个测试套件中是一个很好的实践。下面提供了使用<code>describe()</code>方法对几个相关测试进行分组的语法，以及三个测试块，为您的蛋糕提供不同类型的测试。</p>

<pre><code>/** Order.spec.js **/

describe('Order different types of cakes', () =&gt; {
 test('order cake: type A', async () =&gt; {
   ...
 });
 test('order cake: type B', async () =&gt; {
   ...
 });

 test('order cake: type C', async () =&gt; {
   ...
 });
});
</code></pre>

<h3>断言入门</h3>

<p>从文件顶部的<code>order.js</code>文件和<code>inquirer</code>模块导入所有内容。</p>

<pre><code>/** __tests__/order.spec.js **/

const order = require("../lib/order");
const inquirer = require("inquirer");
</code></pre>

<p>现在您已经拥有了所需的模块，您可以在第一个测试块中快速创建一个cake对象；这将是我们的答案。您将从导入的订单文件中得到您的问题。</p>

<pre><code>/** __tests__/order.spec.js **/
cakeA = {
  Coating: "Butter",
  type: "Strawberry",
  "Cake Size": "Medium",
  Toppings: "Fruit",
};
</code></pre>

<p>第一个cake对象包含<code>key-value</code>对，这些键来自原始的question对象。其他两个测试块之间的唯一区别是cake对象和对象名称的值。</p>

<p>如前所述，我们将为询问者提示方法提供各种问题和答案:</p>

<pre><code>const order_cli = await inquirer.prompt(order.orderDetailsQuestions, cakeA);
</code></pre>

<p>返回的承诺是一个对象，包含用户在使用CLI时可能已经选择的答案。因此，我们可以断言这些被嘲笑的反应。</p>

<pre><code>expect(order_cli).toMatchObject(cakeA);
</code></pre>

<p>如果你想回顾整个<code>order.spec.js</code>测试文件，你可以在这里找到它<a href="https://github.com/mwaz/palatial-cakes-cli-app/blob/main/__tests__/order.spec.js" target="_blank" rel="noreferrer noopener">。</a></p>

<p>就像这样，您现在能够测试蛋糕订单命令的各种输入和输出。</p>

<h2>列出蛋糕</h2>

<p>测试处理蛋糕渲染的逻辑将会很简单。您将提供一个蛋糕列表，然后根据您的CLI呈现的蛋糕列表断言它。</p>

<p>全面实施:</p>

<pre><code>/** __tests__/cakes-list.spec.js **/
const renderCakes = require("../lib/cakes-list");

const results = [
  "\n1 =&gt; Strawberry",
  "\n2 =&gt; Vanilla",
  "\n3 =&gt; Mint",
  "\n4 =&gt; White Chocolate",
  "\n5 =&gt; Black Forest",
  "\n6 =&gt; Red Velvet",
  "\n7 =&gt; Fruit Cake",
];

test("renders cakes list", () =&gt; {
  expect(renderCakes()).toEqual(results);
});
</code></pre>

<p>这个代码片段导入了<code>cakes-list</code>模块，然后使用<code>renderCakes</code>方法断言蛋糕列表与之前在命令行应用程序中声明的列表相同。</p>

<h2>设置错误处理</h2>

<p>您可能希望确保在您的CLI应用程序中检测和处理错误，以便在错误发生时修复错误。您将在这里编写的测试将涵盖<code>unknown options</code>、<code>commands</code>，以及<code>undefined</code>选项的使用。在这个测试中，您将不会测试输出，而是测试是否检测到错误。</p>

<h3>检查分隔符后选项的检测</h3>

<p>您可以从发现当参数包含未定义的选项时会发生什么开始。在<code>–</code>之后提供了可能的选项。</p>

<p>在声明程序变量之前，您需要使它可用:</p>

<pre><code>const { Command } = require("commander");
</code></pre>

<p><code>Commander.js</code>建议创建一个本地命令对象以在测试时使用。稍后，您将在每个测试块中这样做，就像这样:</p>

<pre><code>const program = new Command();
</code></pre>

<p>考虑下面的测试片段:</p>

<pre><code>/** handle-errors.spec.js **/
test("when arguments includes -- then stop processing options", () =&gt; {
  const program = new Command();
  program
    .option("-c, --coatings [value]", "cake coatings to apply")
    .option("-t, --type &lt;cake-type&gt;", "specify the type of cake");
  program.parse([
    "node",
    "palatial-cakes-cli",
    "--coatings",
    "--",
    "--type",
    "order-cake",
  ]);
  const opts = program.opts();
  expect(opts.coatings).toBe(true);
  expect(opts.type).toBeUndefined();
  expect(program.args).toEqual(["--type", "order-cake"]);
});
</code></pre>

<p>第一个<code>—</code>非选项参数应该被接受为指示选项结束的分隔符。即使它们以字符<code>-</code>开始，任何后续的参数都应该被视为操作数。</p>

<p>因为<code>—-coatings</code>选项出现在<code>--</code>之前，所以它被视为有效选项，您可以执行断言来查看这是否正确。接下来的<code>-–type</code>应该被视为一个<code>undefined</code>选项。</p>

<p><img src="../Images/65c62216cdb12328a23dd86aa637f2fe.png" alt="Valid and invalid CLI options" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-06-10-valid-and-invalid-comand-options.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-06-10-valid-and-invalid-comand-options.png"/></p>

<p><code>program.parse(arguments)</code>将处理参数，程序没有接受的任何选项都将留在<code>program.args</code>数组中。因为<code>–type</code>选项被忽略了，所以可以断定它属于<code>program.args</code>数组。</p>

<h3>检查未知选项的检测</h3>

<pre><code>/** handle-errors.spec.js **/
test("unknown option, then handle error", () =&gt; {
  const program = new Command();
  program
    .exitOverride()
    .command("order-cake")
    .action(() =&gt; {});
  let caughtErr;
  try {
    program.parse(["node", "palatial-cakes-cli", "order-cake", "--color"]);
  } catch (err) {
    caughtErr = err;
  }
  expect(caughtErr.code).toBe("commander.unknownOption");
});
</code></pre>

<p>上面的测试块没有什么异常。它只是将一个未知选项<code>–-color</code>传递给<code>program.parse()</code>方法，并检查它是否被检测为错误。你可以确认这个错误是<code>commander.unknownOption</code>的一个实例，正如预期的那样。</p>

<p>然后，通过将错误整齐地记录到终端来处理错误。如果您在<code>handle-errors.spec.js</code>文件中运行上面的代码块<code>npm test</code>，您应该得到一个通过测试的错误消息:<code>error: unknown option '--color'</code>。</p>

<h3>检查未知命令的检测</h3>

<p>就像您测试一个未知选项一样，您可以检测一个未知命令，然后在终端上整齐地记录一条错误消息。</p>

<p>下面是测试片段的实现:</p>

<pre><code>/** handle-errors.spec.js **/
test("unknown command, then handle error", () =&gt; {
  const program = new Command();
  program
    .exitOverride()
    .command("order-cake")
    .action(() =&gt; {});
  let caughtErr;
  try {
    program.parse(["node", "palatial-cakes-cli", "make-order"]);
  } catch (err) {
    caughtErr = err;
  }
  expect(caughtErr.code).toBe("commander.unknownCommand");
});
</code></pre>

<p>这提供了<code>program.parse()</code>方法中预期参数的列表，但是带有一个未知的CLI命令<code>make-order</code>。您可以预期抛出的错误是<code>commander.unknownCommand</code>的一个实例，因此您可以针对该错误断言它。在CI环境中设置测试之前，运行您的测试应该验证它们都在本地通过。</p>

<p>在下一节中，您将把您的GitHub帐户连接到CircleCI。然后，您将把您编写的所有测试推送到您的Github帐户，以便您可以配置它们在CI环境中运行。</p>

<h2>配置CircleCI</h2>

<p>要配置CircleCI，创建一个名为<code>.circleci</code>的目录并添加一个名为<code>config.yml</code>的文件。在<code>.circleci/config.yml</code>文件中，添加以下配置:</p>

<pre><code># .circleci/config.yml
version: 2.1
jobs:
  build:
    working_directory: ~/palatial-cakes-cli-app
    docker:
      - image: cimg/node:10.16.3
    steps:
      - checkout
      - run:
          name: update npm
          command: "npm install -g npm@5"
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: install dependencies
          command: npm install
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - run:
          name: run tests
          command: npm test
      - store_artifacts:
          path: ~/palatial-cakes-cli-app/__tests__
</code></pre>

<p>现在您可以提交并<a href="https://docs.github.com/en/get-started/using-git/pushing-commits-to-a-remote-repository" target="_blank" rel="noreferrer noopener">将您的更改推</a>到存储库中。然后在<a href="https://app.circleci.com/dashboard"> CircleCI仪表盘</a>上设置你的项目。</p>

<p>在CircleCI仪表板上，转到项目。将列出与您的GitHub用户名或组织相关的所有GitHub存储库。本教程的存储库是<code>palatial-cakes-cli-app</code>。在“项目”面板上，选择设置项目的选项。使用分支<code>main</code>中现有配置的选项。</p>

<p><img src="../Images/6aa2245dd36f4ac97752a5108b92eee8.png" alt="Setting up CircleCI" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-06-10-setting-up-circleci.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-06-10-setting-up-circleci.png"/></p>

<p>瞧啊。在检查CircleCI仪表板并展开构建细节时，您可以验证您已经成功运行了CLI应用程序测试并将其集成到CircleCI中。</p>

<p><img src="../Images/65c618f02053c415b8023426f9bfd35a.png" alt="Successful test execution" class="zoomable" srcset="https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-06-10-successful-test-execution.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-06-10-successful-test-execution.png"/></p>

<p>现在，任何时候你对你的应用程序进行更改，CircleCI都会自动运行你的测试，并验证所做的更改是否会破坏你的应用程序。</p>

<h2>结论</h2>

<p>在本教程中，您了解了CLI应用程序及其工作原理。您设置了一个简单的CLI应用程序，了解了它的工作原理，并为它编写了测试。然后，您配置CircleCI来运行您的测试，并验证这些测试是否成功。</p>

<p>虽然已经创建并配置了示例应用程序，但是浏览这些文件可能是值得的。这可以帮助您更好地理解当CLI应用程序由<code>commander.js</code>运行时会发生什么。</p>

<p>一如既往，我很高兴为您创建本教程，我希望您会发现它很有价值。直到下一个，继续学习，继续建设！</p>



        
          
          
            <hr/>
            <p>Waweru Mwaura是一名软件工程师，也是一名专门研究质量工程的终身学习者。他是Packt的作者，喜欢阅读工程、金融和技术方面的书籍。你可以在<a href="https://waweruh.github.io/" target="_blank" rel="noreferrer noopener">他的网页简介</a>上了解更多关于他的信息。</p>

            <p><a href="/blog/author/waweru-mwaura/" class="arrow-link">阅读更多Waweru Mwaura的帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>