<html>
<head>
<title>Build private CircleCI orbs on any organization | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在任何组织| CircleCI上建造私人CircleCI球体</h1>
<blockquote>原文：<a href="https://circleci.com/blog/building-private-orbs/#2022-01-13T02:00:00-08:00">https://circleci.com/blog/building-private-orbs/#2022-01-13T02:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>使用CircleCI的orbs是跨项目共享CI/CD配置的一个好方法。公共orb能够很好地被广泛采用，但是私有orb对于需要以安全、非公共的方式共享公共内部配置的组织来说是很有帮助的。私有orb只在发布它们的组织内工作。</p>

<p>我们最近向所有CircleCI客户开放了私人orbs，包括那些参加了<a href="/blog/new-cicd-free-plan-what-devs-get/">免费计划</a>的客户。这种新的访问方式为您的管道开辟了许多新的可能性。</p>

<p>在这篇文章中，你将了解到私有球体以及如何在你自己的组织中使用它们。我们将使用我构建的示例orb，它包含一个命令和一个作业，允许您使用cURL在其他项目中触发CircleCI管道。你可以在<a href="https://github.com/zmarkan-demos/api-requester-orb-sample" target="_blank" rel="noreferrer noopener">这个资源库</a>中找到该项目的源代码。</p>

<h2>先决条件</h2>

<p>本文假设:</p>
<ul>
  <li><a href="https://circleci.com/docs/"> CircleCI </a>的工作知识</li>
  <li>了解管道的工作原理</li>
  <li>在您的机器上本地安装和配置的CircleCI CLI </li>
  <li>您正在GitHub上使用项目组织或您的个人组织</li>
</ul>

<h2>私有球体的用例</h2>

<p>与一般的orb一样，私有orb对于共享多个项目共有的步骤和任务非常有用。</p>

<p>许多组织都有自己的框架和跨许多团队使用的内部工具。有了私人宝珠，他们可以轻松地分享这些工具，而无需向更广阔的世界开放。私有orb的一些用例包括部署到您专有的Kubernetes集群或其他基础设施，处理定制硬件，一直到日志记录或常见的管理任务。</p>

<h2>初始设置</h2>

<p>我们将使用CircleCI CLI来完成此任务。使用CLI，您将创建一个新的orb，并将其注册到CircleCI，以便它可以被其他CircleCI管道引用。CLI允许您发布orb的新版本。</p>

<p>整个orb创建过程<a href="https://circleci.com/docs/local-cli/">记录在CircleCI文档</a>中。本文将对其进行快速回顾，并解释相关步骤。</p>

<p>创建一个空的git存储库并记下它的路径。我在我的<code>zmarkan-demos</code>组织下创建了我的，命名为<code>api-requester-orb-sample</code>，所以路径是:<code>git@github.com:zmarkan-demos/api-requester-orb-sample.git</code>。</p>

<p>接下来，使用CLI的<code>circleci orb init</code>命令创建实际的orb，传递您希望orb源所在的本地路径。该目录必须是新的；不要使用已经存在的。对我来说，这是:</p>

<pre><code>circleci orb init ~/github/api-requester-orb-sample --private
</code></pre>

<p>公共球体和私有球体的主要区别在于末尾的<code>--private</code>标志。</p>

<p>CLI要求您要么按照指导设置，这是我做的，要么自己做。我推荐使用自动化过程，因为它将使用一个空的orb模板设置目录中的所有内容，并将其链接到您的存储库，为您的orb创建一个名称空间，并为新的orb创建一个CircleCI项目，只需确保从您之前创建的存储库中复制git URL。</p>

<p>最后，您需要将本地代码推送到远程存储库-</p>

<pre><code>cd ~/github/api-requester-orb-sample
git push origin master
</code></pre>

<p>注意:所有orb都存在于您组织内的一个名称空间中。这对于您已经注册的任何跑步代理都是一样的。</p>

<p>你也可以在你的组织设置中查看你的新的私有球体，它们在<code>type</code>部分被清楚地标记为私有。</p>

<p><img src="../Images/ff493e1eedfbe017f9b1d68fd9e46674.png" alt="List of orbs in the UI" srcset="https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-list-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-01-06-private-orb-list-ui.png"/></p>

<h2>开发一个球体</h2>

<p>orb开发过程取决于您是选择自动化指导过程还是遵循您自己的过程。与设置部分一样，CircleCI文档涵盖了这两种情况。</p>

<p>如果您遵循了快速设置路线，那么CLI将从模板中为您生成整个项目。它包含命令、作业、执行器的示例，以及对它的测试。</p>

<p><img src="../Images/8f3a936e51a9a5c47669042100dfdff7.png" alt="Orb project view" srcset="https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2022-01-06-private-orb-generated-ui.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2022-01-06-private-orb-generated-ui.png"/></p>

<p>你可以移除任何你不需要的部分。在我的例子中，我删除了脚本和执行器，保留了命令和作业。orb只是CircleCI配置脚本的集合，当您运行管道时，这些脚本会被解析和绑定。</p>

<p>我们创建了2个脚本:</p>
<ul>
  <li>一个<code>commands/trigger-pipeline.yml</code>命令</li>
  <li>一份工作</li>
</ul>

<p>作业包装命令并在基本Docker执行器中执行。</p>

<h3>使用触发器管道命令</h3>

<p><code>trigger-pipeline</code>命令有4个参数和一个单步，如以下代码示例所示:</p>

<pre><code>description: &gt;
  This command triggers CircleCI pipeline specified.
  The job execution environment must have cURL utility available

parameters:
  repo-name:
    type: string
    description: "Repo name to trigger pipeline for"

  branch-name:
    type: string
    default: main
    description: "Branch name to trigger"

  trigger-params-json:
    type: string
    default: "{}"
    description: Pipeline trigger parameters in JSON format

  circle-token-env-var:
    type: env_var_name
    default: CIRCLE_TOKEN
    description: Environment variable containing your CircleCI API Key. Default is $CIRCLECI_API_KEY

steps:
  - run:
      name: Run cURL request
      command: |
        curl --request POST \
            --url "https://circleci.com/api/v2/project/gh/${CIRCLE_PROJECT_USERNAME}/&lt;&lt; parameters.repo-name &gt;&gt;/pipeline" \
            --header "Circle-Token: ${&lt;&lt; parameters.circle-token-env-var &gt;&gt;}" \
            --header "content-type: application/json" \
            --data '{"branch":"&lt;&lt; parameters.branch-name &gt;&gt;","parameters":&lt;&lt; parameters.trigger-params-json &gt;&gt;}"'
</code></pre>

<p>与完整的CircleCI管道配置不同，这个配置不需要一个<code>version</code>节。由于只有一个命令源，它也没有<code>jobs</code>或<code>workflows</code>。与完整的CircleCI配置中可用的管道参数不同，所有4个参数也专用于该命令。</p>

<p>run步骤中的<code>curl</code>命令点击CircleCI API来触发另一个管道。在这篇博文中有详细的描述。</p>

<h3>使用触发器循环管道作业</h3>

<p>编写一个使用我们刚刚创建的命令的作业非常简单。在同一个orb中，您可以使用该命令，就像它是您在配置中定义的本地命令一样。在我们的<code>jobs/trigger-circleci-pipeline.yml</code>示例中，看起来是这样的:</p>

<pre><code>description: &gt;
  Job that trigger CircleCI pipeline in another project with the payload specified

docker:
  - image: cimg/base:2021.12

parameters:
  repo-name:
    type: string
    description: "Repo name to trigger pipeline for"
  branch-name:
    type: string
    default: main
    description: "Branch name to trigger"

  trigger-params-json:
    type: string
    default: "{}"
    description: Pipeline trigger parameters in JSON format

  circle-token-env-var:
    type: env_var_name
    default: CIRCLE_TOKEN
    description: Environment variable containing your CircleCI API Key. Default is $CIRCLECI_API_KEY

steps:
  - trigger-pipeline:
      repo-name: &lt;&lt; parameters.repo-name &gt;&gt;
      branch-name: &lt;&lt; parameters.branch-name &gt;&gt;
      trigger-params-json: &lt;&lt; parameters.trigger-params-json &gt;&gt;
      circle-token-env-var: &lt;&lt; parameters.circle-token-env-var &gt;&gt;
</code></pre>

<p>这个命令有参数，和CircleCI中的所有其他作业一样，我们需要执行程序:<code>docker</code>。<code>steps</code>节包含一个单独的步骤，使用我们设置的任何参数调用之前的<code>trigger-pipeline</code>命令。</p>

<h2>测试和部署orb</h2>

<p>为了构建、测试和部署我们的orb，orb模板项目使用CircleCI本身。在<code>.circleci/config.yml</code>的配置中，几乎所有东西都是为您预先准备好的。你需要做的就是为它编写测试。默认情况下，它包含一个名为<code>integration-test-1</code>的作业，您可以修改它以使用您自己的orb。下面是调用<code>trigger-pipeline</code>命令的一个片段:</p>

<pre><code>jobs:
  integration-test-1:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - api-requester-orb-sample/trigger-pipeline:
          repo-name: pinging-me-softly
          branch-name: main
          trigger-params-json: '{"image-name": "cimg/base:2021.12"}'
</code></pre>

<p>要发布发布版本，您需要:</p>
<ul>
  <li>从默认的<code>alpha</code>分支变为<code>master</code>或<code>main</code>分支</li>
  <li>在提交中包含一条<code>[semver:patch|minor|major]</code>消息</li>
</ul>

<h2>结论</h2>

<p>在这篇文章中，你已经学习了如何为CircleCI建造私人球体，现在CircleCI的所有客户都可以使用。私有orb允许您在多个项目之间共享CI/CD管道配置。组织中的任何团队成员都可以使用这些私有orb，而不会有将您的配置公开的风险。</p>

<p>整个过程对于发布公共orb几乎是相同的。只需在<code>circleci orb init</code>命令中添加<code>--private</code>标志。</p>

<p>要阅读更多关于orb开发的内容，请查看创作orb的文档页面。</p>

<p>要了解如何使用BATS和ShellCheck在orb中测试和验证bash脚本，<a href="https://circleci.com/docs/testing-orbs/">请查看orb测试方法的文档页面</a>。</p>

<p>如果你对这篇文章有任何问题或建议，或者对未来的文章和指南有什么想法，请通过<a href="https://twitter.com/zmarkan" target="_blank" rel="noreferrer noopener"> Twitter - @zmarkan </a>或<a href="mailto:zan@circleci.com" target="_blank" rel="noreferrer noopener"> email给我</a>联系我。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>