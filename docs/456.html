<html>
<head>
<title>Integrate CircleCI with HashiCorp Vault using OIDC - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用OIDC - CircleCI将CircleCI与HashiCorp Vault集成</h1>
<blockquote>原文：<a href="https://circleci.com/blog/oidc-with-vault/#2023-02-02T23:00:00-08:00">https://circleci.com/blog/oidc-with-vault/#2023-02-02T23:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>设计良好的机密管理是安全性和可用性之间微妙的平衡。在构建和部署时，机密必须容易被正确的用户访问，但同时它们也必须得到很好的保护，并且容易轮换。本文将介绍如何通过将CircleCI与HashiCorp Vault集成，并使用短期的OpenID Connect (OIDC)身份验证令牌来检索机密，从而实现这一目标。</p>

<h2>机密管理反模式</h2>

<p>在过去，许多团队选择可用性而不是安全性。他们将秘密嵌入到CI/CD平台配置中，甚至将它们签入版本控制中，通常采用“一劳永逸”的方式。这需要很少的努力，而且通常是作为一种临时措施。但临时措施往往会变成永久性的，这些秘密往往比预期的时间长得多。他们成了潜在的攻击媒介——比如说，如果源代码泄露或一名工程师离开公司，他们能以多快的速度轮换？即使在有定期人工秘密轮换计划的团队中，轮换也经常会迟到、不完整，或者根本就没有发生。尽管这些秘密很容易获取，但该公司的安全态势却岌岌可危。</p>

<p>另一方面，一些团队在不方便的解决方案(如密码管理器)背后锁定了对秘密的所有访问，这些解决方案只能手动访问，或者在每次与服务交互时手动访问MFA。这不仅降低了开发速度，而且具有讽刺意味的是，它还经常削弱安全性，因为许多工程师只是在本地复制凭证或使用后门帐户来绕过繁琐的官方流程。虽然秘密在理论上是非常安全的，但在实践中，它们经常被非法地存储在不安全的位置，开发人员的敏捷性受到阻碍。</p>

<p>OIDC认证在这两个极端之间提供了一个折中的方法，既保持了可用性又保证了平台的安全性。CircleCI的OIDC支持允许开发人员在其构建、测试和部署作业中使用短暂的身份验证令牌，从而消除了长期凭据中固有的风险。实现OIDC增强了安全性，并减少了项目的整个CI/CD管道中的摩擦，从而导致更快、更有效的开发。在之前的一篇博客文章中，我们已经介绍了OIDC的基础知识，以及如何使用CircleCI OIDC令牌通过AWS和Google Cloud进行认证。今天我们将讲述如何使用OIDC来认证HashiCorp Vault。</p>

<h2>什么是哈希公司金库？</h2>

<p>HashiCorp Vault是一个基于身份的秘密和加密管理系统。随着技术组织越来越多地转向GitOps和基础设施即代码实践，他们经常遇到如何安全地存储和访问信息的难题，这些信息太敏感而无法签入版本控制，并且应用太广泛而不能留在某人的工作站上。Vault使开发人员和平台工程师能够在一个安全、集中的系统中方便地存储、访问和轮换机密。使用OIDC从CircleCI到Vault进行身份验证增加了一层安全性，因为您的工程师不再需要在Vault本身之外存储长期有效的凭据。</p>

<p>在本教程中，我们将介绍如何使用CircleCI的OIDC令牌对现有的Vault集群进行认证。</p>

<h2>步骤0:开始之前</h2>

<p>开始时，您需要具备以下条件:</p>



<p>您还应该从CircleCI UI中收集以下信息:</p>

<ul>
  <li>您的组织名称和ID:打开CircleCI webapp并在<a href="https://app.circleci.com/"> CircleCI web app </a>上导航至<strong>组织设置</strong> &gt; <strong>概述</strong>以找到两者</li>
  <li>您的项目ID:打开<a href="https://app.circleci.com/"> CircleCI web app </a>，导航至您的项目页面，点击<strong>项目设置</strong> &gt; <strong>概述</strong></li>
  <li>个人访问令牌:<a href="https://circleci.com/docs/managing-api-tokens/#creating-a-personal-api-token">参见这里的说明</a>了解如何创建一个。</li>
</ul>

<p><strong>注意:</strong> <i> CircleCI必须能够连接到您的Vault实例。如果该实例可以公开访问，您可以通过将CircleCI的IP范围列入白名单来限制访问，这样只有CircleCI机器可以发送流量。如果实例在专用网络上，您可以在专用网络内的<a href="https://circleci.com/docs/runner-overview/"> CircleCI Runner </a>上运行您的Vault认证作业。</i></p>

<h2>步骤1:配置Vault</h2>

<p>您需要在Vault实例中启用JWT身份验证方法。登录到Vault并启用JWT验证方法:</p>

<pre><code class="language-sh">export VAULT_ADDR="your vault instance address"
export VAULT_TOKEN="your vault token"
vault login $VAULT_TOKEN
vault auth enable jwt
</code></pre>

<p>接下来，配置JWT身份验证方法以接受来自CircleCI组织的OIDC令牌:</p>

<pre><code class="language-sh">vault write auth/jwt/config \
    oidc_discovery_url="https://oidc.circleci.com/org/&lt;your org id&gt;" \
    bound_issuer="https://oidc.circleci.com/org/&lt;your org id&gt;" 
</code></pre>

<p>使用以下命令验证配置:</p>

<pre><code class="language-sh">curl --header "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/auth/jwt/config" | jq
</code></pre>

<p>接下来，为您的存储库角色创建一个<a href="https://developer.hashicorp.com/vault/docs/concepts/policies" target="_blank" rel="noreferrer noopener">存储库策略</a>。在本教程中，您将授予CircleCI对路径<code>secret/circleci-demo/</code>下所有秘密的读取权限</p>

<pre><code class="language-sh">vault policy write circleci-demo-policy - &lt;&lt;EOF
# Grant CircleCI project &lt;your project name&gt; RO access to secrets under the 'secret/data/circleci-demo/*' path
path "secret/data/circleci-demo/*" { 
  capabilities = ["read", "list"] 
}
EOF
</code></pre>

<p>使用以下命令验证策略创建:</p>

<pre><code class="language-sh">vault policy read circleci-demo-policy
</code></pre>

<p>在名为<code>circleci-demo</code>的JWT认证方法下为CircleCI创建一个Vault角色。该角色的属性告诉Vault OIDC令牌将来自哪里，应该向令牌持有者授予什么权限，以及应该包含在令牌中的任何附加声明。这些附加声明可用于存储库角色的<code>bound_claims</code>字段，以限制角色对特定项目和/或具有特定上下文访问权限的作业的访问权限。</p>

<p>在本教程中，您将使用<code>project_id</code>附加声明来限制对您的教程项目的访问。您可以在我们的<a href="https://circleci.com/docs/openid-connect-tokens/#format-of-the-openid-connect-id-token"> OIDC文档</a>中找到更多关于CircleCI OIDC token索赔的详细信息。</p>

<pre><code class="language-sh">vault write auth/jwt/role/circleci-demo -&lt;&lt;EOF
{
  "role_type": "jwt",
  "user_claim": "sub",
  "user_claim_json_pointer": "true",
  "bound_claims": {
    "oidc.circleci.com/project-id": "&lt;your project id&gt;"
  },
  "policies": ["default", "circleci-demo-policy"],
  "ttl": "10m"
}
EOF
</code></pre>

<p>使用以下命令验证角色创建:</p>

<pre><code class="language-sh">vault read auth/jwt/role/circleci-demo
</code></pre>

<p>最后，让我们创建一些从CircleCI访问的秘密。首先，启用安装在<code>secret/</code>的新秘密引擎:</p>

<pre><code class="language-sh">vault secrets enable -version=2 -path=secret kv
</code></pre>

<p>接下来，创造一些秘密:</p>

<pre><code class="language-sh">vault kv put secret/circleci-demo/demo-secrets \
  username="paul.atreides" \
  password="lis@n-al-g4ib"
</code></pre>

<p>验证新密码是使用以下命令创建的:</p>

<pre><code class="language-sh">vault kv get secret/circleci-demo/demo-secrets
</code></pre>

<h2>步骤2:配置CircleCI</h2>

<h3>为Vault连接密码创建CircleCI上下文</h3>

<p>我们可以将它们安全地存储在一个<a href="https://circleci.com/docs/contexts/"> CircleCI context </a>中，而不是将我们的Vault端点和角色名签入版本控制，因为它们可能会被无意中泄露。在本教程中，我们将使用CircleCI CLI创建和填充一个上下文。</p>

<p><strong>注意:</strong> <i>如果您正在使用CircleCI独立组织(例如，如果您正在使用GitLab作为您的VCS)，您将需要创建一个上下文并通过CircleCI UI 而不是CLI填充变量<a href="https://circleci.com/docs/contexts/#create-and-use-a-context">。</a></i></p>

<p>运行以下命令来设置CircleCI CLI。出现提示时，输入您的个人访问令牌。</p>

<pre><code>circleci setup
</code></pre>

<p>配置完CLI后，使用下面的命令创建一个名为<code>circleci-vault-demo</code>的上下文。你的VCS应该是<code>gh</code> (Github)或者<code>bb</code> (Bitbucket)。</p>

<pre><code class="language-sh">export CIRCLE_VCS=&lt;your vcs&gt;
export CIRCLE_ORG_NAME=&lt;your org name&gt;
circleci context create $CIRCLE_VCS $CIRCLE_ORG_NAME circleci-vault-demo
</code></pre>

<p>验证新上下文是使用以下命令创建的:</p>

<pre><code class="language-sh">circleci context list $CIRCLE_VCS $CIRCLE_ORG_NAME
</code></pre>

<p>接下来，使用下面的命令将Vault连接机密添加到新上下文中。在每个命令后，系统会提示您输入密码，因此请务必准备好密码值。下表显示了示例值。</p>

<pre><code class="language-sh">circleci context store-secret $CIRCLE_VCS $CIRCLE_ORG_NAME circleci-vault-demo VAULT_ADDR
circleci context store-secret $CIRCLE_VCS $CIRCLE_ORG_NAME circleci-vault-demo VAULT_ROLE
</code></pre>

<table>
  <thead>
    <tr>
      <th>上下文变量名</th>
      <th>价值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>VAULT_ADDR</code></td>
      <td>您的vault实例的URL，包括端口(例如<code>https://vault.example.com:8200</code>)</td>
    </tr>
    <tr>
      <td><code>VAULT_ROLE</code></td>
      <td>CircleCI将承担的保险库角色(如果您遵循上述步骤，这将是<code>circleci-demo</code>)</td>
    </tr>
  </tbody>
</table>

<p>使用以下命令验证是否已经创建了机密:</p>

<pre><code class="language-sh">circleci context show $CIRCLE_VCS $CIRCLE_ORG_NAME circleci-vault-demo
</code></pre>

<h3>编写一个CircleCI配置，使用OIDC向Vault进行身份验证</h3>

<p>现在，我们将编写一个CircleCI配置文件，该文件使用CircleCI OIDC令牌对Vault进行身份验证，使用<a href="https://developer.hashicorp.com/vault/docs/agent/autoauth" target="_blank" rel="noreferrer noopener"> Vault的自动身份验证功能</a>来检索我们创建的机密，然后最终将它们作为环境变量导出，以便在CircleCI作业中使用。</p>

<p>在您为本教程创建的存储库中，在<code>.circleci/config.yml</code>处创建一个文件，并添加下面的代码。</p>

<pre><code class="language-yaml">version: 2.1
commands: 
  install-vault:
    steps:
      - run:
          name: Install Vault and prereqs
          command: |
            vault -h &amp;&amp; exit 0 || echo "Installing vault"
            # only runs if vault command above fails
            cd /tmp
            wget https://releases.hashicorp.com/vault/1.12.2/vault_1.12.2_linux_amd64.zip
            unzip vault_1.12.2_linux_amd64.zip
            sudo mv vault /usr/local/bin        
            vault -h
  vault-auto-auth:
    description: "Use Vault auto auth to load secrets"
    steps:
      - run:
          name: Auto-authenticate with Vault
          command: |
            # Write the CircleCI provided value to a file read by Vault
            echo $CIRCLE_OIDC_TOKEN &gt; .circleci/vault/token.json
            # Substitute the env vars in our context to render the Vault config file
            sudo apt update &amp;&amp; sudo apt install gettext-base
            envsubst &lt; .circleci/vault/agent.hcl.tpl &gt; .circleci/vault/agent.hcl
            # This config indicates which secrets to collect and how to authenticate     
            vault agent -config=.circleci/vault/agent.hcl
      - run:
          name: Set Environment Variables from Vault
          command: |
            # In order to properly expose values in Environment, we _source_ the shell values written by agent
            source .circleci/vault/setenv
jobs:
  setup-vault-and-load-secrets:
    docker: 
      - image: cimg/base:2023.01
    steps:
      - checkout
      - install-vault
      - vault-auto-auth
      - run: 
          name: Use secrets retrieved from Vault in a subsequent step
          command: |
            echo "Username is $SECRET_DEMO_USERNAME, password is $SECRET_DEMO_PASSWORD"
workflows:
  vault: 
    jobs:
      - setup-vault-and-load-secrets:
          context:
            - circleci-vault-demo
# VS Code Extension Version: 1.5.1
</code></pre>

<p>接下来，我们将使用下面的代码在<code>.circleci/vault/agent.hcl.tpl</code>创建一个模板化的Vault agent配置文件。该文件将告诉Vault代理要连接到哪个Vault服务器以及如何进行身份验证。</p>

<pre><code class="language-hcl">pid_file = "./pidfile"
exit_after_auth = true
vault {
  address = "${VAULT_ADDR}"
  retry {
    num_retries = -1
  }
}
auto_auth {
  method "jwt" {
    config = {
      role = "${VAULT_ROLE}"
      path = ".circleci/vault/token.json"
      remove_jwt_after_reading = false
    }
  }
  sink "file" {
    config = {
      path = "/tmp/vault-token"
    }
  }
}
template_config {
  exit_on_retry_failure = true
}
template {
  source      = ".circleci/vault/secrets.ctmpl"
  destination = ".circleci/vault/setenv"
}
</code></pre>

<p>最后，我们将创建一个Consul模板，它将告诉Vault代理如何处理它检索到的秘密。在本教程中，我们将简单地将它们导出为环境变量，以便在管道中使用。用下面的代码在<code>.circleci/vault/secrets.ctmpl</code>创建一个文件。</p>

<pre><code># Export the secrets as env vars for use in this job 
# Also writes them to $BASH_ENV so that they'll be available as env vars in subsequent jobs for this pipeline
{{ with secret "secret/circleci-demo/demo-secrets" }}
    export SECRET_DEMO_USERNAME="{{ .Data.data.username }}"
    export SECRET_DEMO_PASSWORD="{{ .Data.data.password }}"
    echo "export SECRET_DEMO_USERNAME=\"{{ .Data.data.username }}\"" &gt;&gt; $BASH_ENV
    echo "export SECRET_DEMO_PASSWORD=\"{{ .Data.data.password }}\"" &gt;&gt; $BASH_ENV
{{ end }}
</code></pre>

<p>推动你的改变。这将触发CircleCI的管道。从本地repo目录运行以下命令:</p>

<pre><code>circleci open
</code></pre>

<p>这将在CircleCI webapp中打开您的项目。如果一切都已正确配置，您应该看到最后一步打印从Vault中检索到的机密，如下所示:</p>

<p><img src="../Images/14d61489d219977da32c42e43bfc81b4.png" alt="Success!" class="zoomable" srcset="https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://ctf-cci-com.imgix.net/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://images.ctfassets.net/il1yandlcjgk/6JAIUnsF6tBFtw3TvmCOCQ/f8af5e77b5e0177c30764ac919f9ad55/2023-01-31-vault-final_result.png"/></p>

<h2>结论</h2>

<p>在本文中，我们介绍了如何使用OIDC身份验证从CircleCI安全地存储和访问HashiCorp Vault中的机密。OIDC身份认证消除了在安全系统之外存储长期凭据的需要，在不影响开发速度的情况下增强了组织的安全态势。要了解CircleCI上OIDC认证的更多信息，请访问<a href="https://circleci.com/docs/openid-connect-tokens/">我们的文档</a>或查看以下文章:</p>




        
          
          
        
      </div>
    </div>    
</body>
</html>