<html>
<head>
<title>Building and testing an ASP.NET Core application | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>构建和测试ASP.NET核心应用程序</h1>
<blockquote>原文：<a href="https://circleci.com/blog/building-and-testing-an-asp-net-core-application/#2019-11-15T09:15:00-08:00">https://circleci.com/blog/building-and-testing-an-asp-net-core-application/#2019-11-15T09:15:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>本文探讨了如何使用CircleCI的Windows执行环境在Windows虚拟机上构建和运行一个简单的计算器应用程序，该应用程序是使用ASP.NET核心构建的。它包括应用程序的完整配置文件，并对相关部分进行了分解解释。</p>

<p>web和应用程序开发中有许多框架，每一个都有不同的特性和优势。ASP.NET是一个开源的服务器端web应用程序框架，由微软创建，运行在Windows上，允许开发者创建web应用程序、web服务和动态内容驱动的网站。ASP.NET核心是ASP.NET的一个改进的跨平台版本，可以在每一个主要的计算平台上运行，包括Windows、macOS和Linux。</p>

<p>CircleCI的Windows支持构建和测试您的应用程序的好处是:</p>

<ul>
  <li>支持基于Docker的Windows工作流的Docker引擎企业版</li>
  <li>Windows环境作业基于虚拟机，并提供完全的构建隔离</li>
  <li>PowerShell是默认的Shell，但是Bash和cmd可以通过声明获得</li>
  <li>Windows作业可以访问同一套强大的CircleCI功能，如缓存、工作区、审批作业和受限上下文，并且支持级别相同</li>
</ul>

<h2>先决条件</h2>
<p>要跟进，您需要:</p>


<h2>申请详情</h2>
<p>本教程使用了一个简单的计算器应用程序，您可以在这里找到并派生出<a href="https://github.com/daumie/dotnet-test-app" target="_blank" rel="noreferrer noopener"/>。以下是应用程序的目录结构:</p>

<pre><code>.
├── Dockerfile
├── LICENSE
├── README.md
├── SimpleCalc
│   ├── Controllers
│   ├── Models
│   ├── Program.cs
│   ├── Services
│   ├── SimpleCalc.csproj
│   ├── Startup.cs
│   ├── Views
│   ├── appsettings.Development.json
│   ├── appsettings.json
│   └── wwwroot
├── SimpleCalc.sln
└── test
    └── SimpleCalc.Tests

8 directories, 9 files
</code></pre>

<p>一旦你完成了这个项目，按照<a href="https://circleci.com/docs/getting-started/#setting-up-your-build-on-circleci" target="_blank" rel="noreferrer noopener">的说明在CircleCI </a>上建立你的构建，把它连接到CircleCI。</p>

<h2>配置CircleCI</h2>
<p>为了<a href="https://circleci.com/docs/configuration-reference/" target="_blank" rel="noreferrer noopener">配置CircleCI </a>，我在项目根目录下的<code>.circleci</code>文件夹中添加了一个<code>config.yml</code>文件。以下是该项目的完整配置文件:</p>

<pre><code>version: 2.1

orbs:
  windows: circleci/windows@2.2.0

jobs:
  test:
    description: Setup and run application tests
    executor:
      name: windows/default
    steps:
      - checkout
      - restore_cache:
          keys:
            - dotnet-packages-v1-{{ checksum "SimpleCalc/SimpleCalc.csproj" }}
      - run:
          name: "Install project dependencies"
          command: dotnet.exe restore
      - save_cache:
          paths:
            - C:\Users\circleci\.nuget\packages
          key: dotnet-packages-v1-{{ checksum "SimpleCalc/SimpleCalc.csproj" }}
      - run:
          name: "Run Application Tests"
          command: dotnet.exe test -v n --results-directory:test_coverage --collect:"Code Coverage"
      - run:
          name: "Print Working Directory"
          command: pwd
      - store_artifacts:
          path: C:\Users\circleci\project\test_coverage
  build:
    description: Build application with Release configuration
    executor:
      name: windows/default
    steps:
      - checkout
      - run:
          name: "Build Application according to some given configuration"
          command: dotnet.exe build --configuration Release
workflows:
  test_and_build:
    jobs:
      - test
      - build:
          requires:
            - test
</code></pre>

<p>现在，我们来分解一下配置。</p>

<h3>定义操作系统/环境和运行时</h3>
<p>我们正在使用CircleCI版，它支持使用<a href="https://circleci.com/orbs/" target="_blank" rel="noreferrer noopener"> orbs </a>。CircleCI orbs是可共享的配置元素包，包括作业、命令和执行器。我们正在使用的是<a href="https://circleci.com/developer/orbs/orb/circleci/windows" target="_blank" rel="noreferrer noopener"> Windows orb </a>。它为用户提供了构建Windows项目的工具，如通用Windows平台(UWP)应用程序、. NET可执行文件或特定于Windows的项目(如。NET框架)。</p>
<pre><code>version: 2.1

orbs:
  windows: circleci/windows@2.2.0
</code></pre>

<p>该项目有<code>test</code>和<code>build</code>个作业。构建作业需要通过所有测试才能运行。为了配置这种排序，我们将使用<a href="https://circleci.com/docs/workflows/" target="_blank" rel="noreferrer noopener"> CircleCI的工作流</a>，这是一组用于定义作业集合及其运行顺序的规则。工作流声明位于示例配置文件的末尾。</p>

<pre><code>workflows:
  test_and_build:
    jobs:
      - test
      - build:
          requires:
            - test
</code></pre>

<h3>设置和运行测试</h3>
<p>Windows executor预装了Visual Studio 2019以及许多其他开发工具。我们将使用默认的PowerShell shell，所以它不需要声明。</p>
<pre><code>  test:
    description: Setup and run application tests
    executor:
      name: windows/default
</code></pre>

<p><a href="https://circleci.com/docs/jobs-steps/#steps-overview" target="_blank" rel="noreferrer noopener">步骤</a>是在作业期间运行的可执行命令的集合。在接下来的步骤中，我们将检查我们的代码并恢复我们项目的依赖项。</p>

<pre><code>    steps:
      - checkout
      - restore_cache:
          keys:
            - dotnet-packages-v1-{{ checksum "SimpleCalc/SimpleCalc.csproj" }}
      - run:
          name: "Install project dependencies"
          command: dotnet.exe restore
      - save_cache:
          paths:
            - C:\Users\circleci\.nuget\packages
          key: dotnet-packages-v1-{{ checksum "SimpleCalc/SimpleCalc.csproj" }}
</code></pre>

<p>CircleCI的<a href="https://circleci.com/docs/caching/" target="_blank" rel="noreferrer noopener">缓存文档</a>详细描述了可用的缓存选项以及如何使用它们。<code>dotnet.exe restore</code>命令使用NuGet来恢复依赖项以及项目文件中指定的项目特定工具。默认情况下，依赖项和工具的恢复是并行执行的。</p>

<p>单元测试对于现实世界的应用程序是必不可少的。您还可以从单元测试中收集代码覆盖率。单元测试是一种软件测试方法，通过这种方法对源代码的各个单元进行测试，以确定它们是否适合使用。单元是最小的可测试软件组件。“dotnet.exe测试”是。用于执行单元测试的. NET测试驱动程序。我们的项目使用了xUnit测试框架。如果所有测试都成功，测试运行程序返回0作为退出代码；否则，如果任何测试失败，它将返回1。测试运行器和单元测试库被打包为NuGet包，并被恢复为项目的普通依赖项。</p>

<pre><code>      - run:
         name: "Run Application Tests"
         command: dotnet.exe test -v n --results-directory:test_coverage --collect:"Code Coverage"
</code></pre>
<p>我们将从运行测试中收集的覆盖率作为工件存储在<code>test_coverage</code>文件夹中。ASP.NET核心项目的代码覆盖率报告不是现成的。</p>

<pre><code>      - store_artifacts:
         path: C:\Users\circleci\project\test_coverage
</code></pre>

<h3>构建项目</h3>

<p>在成功运行测试之后，我们想要构建我们的项目。为此，我们定义要使用的构建配置。此项目的可用选项有:</p>
<ul>
  <li>释放；排放；发布</li>
  <li>调试下面的配置显示了我们选择的版本。</li>
</ul>

<pre><code>  build:
    description: Build application with Release configuration
    executor:
      name: windows/default
    steps:
      - checkout
      - run:
          name: "Build Application according to some given configuration"
          command: dotnet.exe build --configuration Release
</code></pre>

<p>从……开始。NET Core 2.0 SDK，您不必运行“dotnet restore”，因为它是由所有需要进行恢复的命令隐式运行的，如“dotnet new”、“dotnet build”和“dotnet run”。</p>

<h2>结论</h2>
<p>在CircleCI上使用Windows executor使得构建和测试ASP.NET核心应用程序变得轻而易举。CircleCI certified Windows orb是一个值得信赖的解决方案，因为它经过了CircleCI的测试和社区的验证。要了解更多关于您的配置中可用的orb的信息，请访问<a href="https://circleci.com/developer/orbs" target="_blank" rel="noreferrer noopener"> orb注册表</a>。</p>

<p>orb节省了原本要花在以下方面的时间:</p>
<ul>
  <li>研究、测试和设置Windows虚拟机</li>
  <li>安装开发工具，例如vs2019、Nuget</li>
  <li>学习使用Windows工具，如PowerShell</li>
</ul>

<p>orb的使用还减少了必须在配置文件中编写的代码行数。这个项目的配置文件有42行代码，更容易理解和维护。</p>



        
          
          
            <hr/>
            <p>Dominic Motuka是Andela 的DevOps工程师，在AWS和GCP支持、自动化和优化生产就绪部署方面拥有4年多的实践经验，利用配置管理、CI/CD和DevOps流程。</p>

            <p><a href="/blog/author/dominic-motuka/" class="arrow-link">阅读多米尼克·莫图卡的更多帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>