<html>
<head>
<title>Automatically deploy private Docker images to Amazon ECR - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>自动将私有Docker映像部署到Amazon ECR - CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/automatically-deploy-private-docker-images-to-aws-ecr/#2020-03-06T08:00:00-08:00">https://circleci.com/blog/automatically-deploy-private-docker-images-to-aws-ecr/#2020-03-06T08:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <h2>使用CircleCI orbs构建Docker映像并将其推送到Amazon ECR</h2>
<p>本文介绍了如何使用CircleCI orbs构建生产级Docker映像并将其推送到Amazon弹性容器注册中心(ECR)进行存储。熟悉本文中使用的工具和技术是首选，但不是必需的。以下是常用术语和技术的简要总结:</p>

<ul>
  <li><strong> Docker: </strong>基于容器构建应用的软件平台。</li>
  <li><strong>容器:</strong>一种虚拟化方法，将应用程序的代码、配置和依赖项打包成构建块，以实现一致性、效率、生产力和版本控制。</li>
  <li>容器映像:一个自包含的软件，其中包含运行应用程序所需的一切:代码、工具和资源。</li>
  <li><strong>容器映像库:</strong>命名和相关容器映像的集合，通常提供相同应用程序或服务的不同版本，由它们的标签标识。</li>
  <li><strong> Docker image registry: </strong>是一种存储集装箱图像的服务，由第三方托管，或者作为公共/私人注册中心，如Docker Hub、AWS (ECR)、GCP (GCR)、Quay等。它们简化了从开发到生产的工作流程。</li>
  <li><strong>容器编排:</strong>容器编排就是管理容器的生命周期，尤其是在大型的动态环境中。</li>
</ul>

<p>让我们深入了解一下Amazon ECR，它是什么，以及CircleCI如何帮助您充分利用这项服务。</p>

<h2>什么是亚马逊ECR？</h2>

<p>亚马逊ECR是一个完全托管的私有Docker容器注册中心，开发者可以很容易地存储、管理和部署Docker容器映像。亚马逊ECR与亚马逊弹性容器服务(<a href="https://aws.amazon.com/ecs/" target="_blank" rel="noreferrer noopener">亚马逊ECSe </a>)和亚马逊弹性Kubernetes服务(<a href="https://aws.amazon.com/eks/" target="_blank" rel="noreferrer noopener">亚马逊EKS </a>)无缝集成。亚马逊ECR也可以和其他云厂商一起使用。</p>

<p><strong>你为什么会想使用像亚马逊ECR这样的私有Docker注册中心？</strong></p>

<ul>
  <li>在许多情况下，分离开发、测试和生产注册是可取的。</li>
  <li>它是完全托管的，因此无需运营自己的容器存储库或担心底层基础架构的扩展。</li>
  <li>很安全。具有扫描功能和基于角色的访问控制的私有容器注册表提供了更多的安全性、治理(IAM)和高效管理。它通过HTTPS传输您的容器图像，并自动加密您的静态图像。</li>
  <li>在运行容器的系统附近运行注册中心可以减少部署延迟并减少网络中断的风险。</li>
</ul>

<p>开发人员需要使用注册表来存储应用程序开发过程中创建的图像。<a href="https://circleci.com/continuous-integration/" target="_blank" rel="noreferrer noopener">持续集成</a>管道连接构建容器图像，并将这些工件推入亚马逊ECR。想象一个管道，其中您推送一个commit，该commit触发CircleCI上的一个构建，该构建将一个新图像推送到Amazon ECR中。然后，您的注册中心可以启动webhook并触发部署。所有这些都不需要人工做任何事情。注册中心使得这种完全自动化的管道更加容易。放在注册表中的容器映像可以在开发的不同阶段使用。在几个步骤中，使用<a href="https://circleci.com/orbs/" target="_blank" rel="noreferrer noopener"> CircleCI orbs </a>，我们将封装一个简单的Node.js应用程序，构建映像，并将其推送到Amazon ECR。</p>

<h2>设置Amazon ECR</h2>

<p>从AWS管理控制台中，选择IAM。此服务允许您管理对AWS资源的访问。</p>

<p align="center"><img src="../Images/7af1d17a249218fc100d3509557e52d3.png" data-original-src="https://circleci.com/blog/media/2020-03-02-pdi1.png"/></p>

<p>创建角色/用户。在这个例子中，我把我的名字叫做<code>ci-cd-ecr</code>，但是任何任意的名字都可以。</p>

<p align="center"><img src="../Images/3b04aad7715f19b284c6d18b92e8730e.png" data-original-src="https://circleci.com/blog/media/2020-03-02-pdi2.png"/></p>

<p>接下来，我们需要使用一个<code>AWS_ACCESS_KEY</code>和一个<code>AWS_SECRET_KEY</code>以编程方式访问我们的Amazon ECR服务。点击新创建的用户，进入<strong>你的安全凭证</strong>页面。在这里，您将能够创建新的访问密钥。请妥善保存密钥，因为我们将使用它从CircleCI访问Amazon ECR服务。密钥的格式如下:</p>

<pre><code>AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
</code></pre>

<p><img src="../Images/ae96f51abe4d3ca6fa7666e101ab74c2.png" alt="" srcset="https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-03-02-pdi3.png"/></p>

<p>接下来，从<strong>策略</strong>部分创建一个策略，并附加前面创建的<code>ci-cd-ecr</code>角色。该政策赋予了亚马逊ECR的完全访问权限。CircleCI orb使用我们新创建的<code>ci-cd-ecr</code>角色，将完全访问我们的Amazon ECR服务，包括创建图像存储库(如果它们不存在的话)。</p>

<pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ecr:*",
                "cloudtrail:LookupEvents"
            ],
            "Resource": "*"
        }
    ]
}
</code></pre>

<p>为用户生成访问密钥和秘密密钥，并将它们存储在安全的地方。在设置CircleCI管道示例时，我们将需要它们。</p>

<h2>使用aws-ecr orb设置CircleCI管道</h2>

<p>这个演示的代码可以在GitHub <a href="https://github.com/daumie/circleci-ecr-orb-demo" target="_blank" rel="noreferrer noopener">这里</a>找到。CircleCI配置文件可以在<code>.circleci/</code>文件夹中找到。正如您将看到的，使用orbs，我们仅使用18行配置就完成了构建一个映像并将其推送到Amazon ECR！要使用orbs，我们需要使用CircleCI版。它是支持球体的版本。aws-ecr orb预装了以下命令:</p>

<ul>
  <li>建立形象</li>
  <li>标记图像(使用<code>HEAD == CIRCLE_SHA1</code>的Git提交散列)</li>
  <li>登录亚马逊ECR</li>
  <li>创建一个Amazon ECR repo(如果不存在)</li>
  <li>将图片推送到亚马逊ECR</li>
</ul>

<p>以下是我们管道的完整配置:</p>

<pre><code>version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@6.7.0

workflows:
  build_and_push_image:
    jobs:
      - aws-ecr/build-and-push-image:
          account-url: AWS_ECR_ACCOUNT_URL
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          create-repo: true
          dockerfile: Dockerfile
          path: .
          region: AWS_REGION
          repo: circleci-ecr-orb-demo
          tag: "$CIRCLE_SHA1"
</code></pre>

<h2>为Amazon ECR设置环境变量</h2>

<p>您可以在配置中看到几个需要设置的环境变量:</p>

<ul>
  <li><code>AWS_ECR_ACCOUNT_URL</code> -存储映射到AWS帐户的Amazon ECR帐户URL的环境变量，例如{ awsAccountNum } . dkr . ECR . us-west-2 . Amazon AWS . com</li>
  <li><code>AWS_ACCESS_KEY_ID</code> -我们之前创建的<code>ci-cd-ecr</code> IAM角色的AWS访问键id。</li>
  <li><code>AWS_SECRET_ACCESS_KEY</code> -我们之前创建的ci-cd-ecr IAM角色的AWS密钥。将此设置为您将设置来保存此值的环境变量的名称，即AWS_SECRET_ACCESS_KEY</li>
  <li><code>AWS_REGION</code> -您的ECR资源将位于的AWS区域。</li>
</ul>

<p><strong>注意:</strong> <i>你不必设置<code>$CIRCLE_SHA1</code>，因为它是所有CircleCI项目中可用的默认变量。这是当前构建的最后一次提交的<code>SHA1</code>散列。使用Git提交散列让您能够跟踪容器中的内容。理想情况下，它允许我们将容器追溯到其Docker映像，然后追溯到映像中包含的Docker文件和代码。在自动化执行环境中，这将带我们回到导致Docker映像构建的提交。</i></p>

<p>上面的配置示例使用了<code>$CIRCLE_SHA1</code>来设置<code>tag:</code>。或者，您可以在您的构建中使用CircleCI构建号(<code>$CIRCLE_BUILD_NUM</code>)作为标签。</p>

<p><img src="../Images/ca00bb075716ce85334c145af14deb31.png" alt="" srcset="https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-03-02-pdi4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-03-02-pdi4.png"/></p>

<p>上面的<code>dockerfile:</code>命令指定了docker文件的路径。我们的演示报告使用以下docker文件:</p>

<pre><code># Set the base image to use for subsequent instructions
FROM node:alpine

# Add metadata to an image 
LABEL app="simple-node-application"
# Directive to set environmental variables key to value pair
ENV NPM_CONFIG_LOGLEVEL warn

# Set the working directory for any subsequent ADD, COPY, CMD, ENTRYPOINT, 
# or RUN instructions that follow it in the Dockerfile
WORKDIR /usr/src/app

# Copy files or folders from source to the dest path in the image's filesystem.
COPY package.json /usr/src/app/
COPY . /usr/src/app/

# Execute any commands on top of the current image as a new layer and commit the results.
RUN npm install --production

# Define the network ports that this container will listen on at runtime.
EXPOSE 3000

# Configure the container to be run as an executable.
ENTRYPOINT ["npm", "start"]
</code></pre>

<p>CircleCI和Amazon ECR都配置好之后，您就可以开始构建映像并将它们推送到存储库了。</p>

<h2>仅用18行配置就将Docker图像推送到Amazon ECR</h2>
<p>仅用18行配置，我们就能够构建Docker映像并将其推送到Amazon ECR。CircleCI orbs通过将预构建的命令、作业和执行器导入CircleCI配置文件来节省时间，并提供与云服务和其他工具的轻松集成。</p>



        
          
          
            <hr/>
            <p>Dominic Motuka是Andela 的DevOps工程师，在AWS和GCP支持、自动化和优化生产就绪部署方面拥有4年多的实践经验，利用配置管理、CI/CD和DevOps流程。</p>

            <p><a href="/blog/author/dominic-motuka/" class="arrow-link">阅读多米尼克·莫图卡的更多帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>