<html>
<head>
<title>Testing locally with CircleCI runners | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用CircleCI转轮进行本地测试| CircleCI</h1>
<blockquote>原文：<a href="https://circleci.com/blog/using-runner-for-local-testing/#2022-01-18T02:00:00-08:00">https://circleci.com/blog/using-runner-for-local-testing/#2022-01-18T02:00:00-08:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <blockquote>
  <p>在本文中，您将学习如何在本地机器上设置CircleCI runner代理来运行测试。您还将学习如何配置CircleCI管道，以便正确调用运行器。</p>
</blockquote>

<p>许多开发团队从运行他们测试的本地构建盒(或者六个)开始他们的CI/CD之旅。例如，在我工作的几个移动团队中，我们有几个插有物理设备的Mac Mini盒子，用于运行本地UI和单元测试。最终，我们迁移到了基于云的解决方案，这给我们带来了更好的稳定性和许多新功能。但是迁移到云也意味着我们的本地硬件过时了。我们不得不依靠仿真，或者选择另一个基于云的设备场来实现。</p>

<p>有了CircleCI的runners，你可以继续使用自己的设备进行测试，同时受益于CircleCI cloud中的其他任何东西。您还可以使用运行器进行测试，这些测试需要在您自己的基础设施上运行，用于安全关键的场景，或者当您正在开发自己的硬件时。</p>

<p>随着<a href="/blog/new-cicd-free-plan-what-devs-get/"> CircleCI免费计划</a>的推出，像跑步者这样的功能现在每个人都可以使用。在本文中，您将学习如何在本地机器上设置CircleCI runner代理来运行测试。您还将学习如何配置CircleCI管道，以便正确调用运行器。</p>

<h2>先决条件</h2>

<p>本教程假设您对CircleCI有所了解，并且了解如何配置管道来构建和测试软件项目。</p>

<p>我已经创建了一个显示流道配置的示例项目。</p>

<p>您还可以在示例项目的CircleCI仪表板中找到它的构建<a href="https://app.circleci.com/pipelines/github/zmarkan-demos/android-testing-runner-example/7/workflows/8feabfe4-c942-4949-bf88-cfed8aca7615/jobs/30" target="_blank" rel="noreferrer noopener">。</a></p>

<p><strong>注意</strong> : <i>这个例子展示了一个Android应用程序和测试，使用了macOS上的runner。然而，其背后的原则可以普遍适用:适用于iOS应用程序、定制硬件或不同基础设施上的runner，如Docker容器、Windows、Linux机器等。</i></p>

<h2>跑步者如何工作</h2>

<p>runner是安装在基础设施上的一个进程，它与CircleCI通信。运行者作为他们自己的资源类。您的<code>config.yml</code>仍然定义管道、作业和工作流，但是您没有使用CircleCI的基于云的资源，如容器和虚拟机，而是自己执行。</p>

<p>首先，在本地安装runner代理。这是一个后台运行的守护进程，检查来自CircleCI的提示。当CircleCI发出必须在运行程序上触发作业的信号时，代理将执行工作负载。它还可以访问与CircleCI云版本相同的凭证，因此它可以无缝运行，并可以从您的存储库中获取代码。</p>

<p>一旦作业完成，结果和任何工件都被发送回云服务。只有实际的作业执行是在您的基础设施上完成的。</p>

<h2>履行</h2>

<p>实施由以下过程组成:</p>
<ul>
  <li>在本地设置运行程序代理</li>
  <li>从你的圈子中调用跑步者<code>config.yml</code></li>
</ul>

<h3>设置跑步者代理</h3>

<p>安装runner代理取决于您使用的平台。请参考<a href="https://circleci.com/docs/runner-installation/"> CircleCI文档</a>中的设置说明。</p>

<p>对于我的示例应用程序，我在Mac计算机上安装了runner代理。</p>

<p><strong>注意</strong> : <i>这些步骤只是一个简要的概述，并不是完整的指南。</i></p>

<p>设置流道的主要步骤是:</p>

<ol>
  <li>在您的组织中注册一名新的跑步者</li>
  <li>按照适用于您的平台的说明安装运行程序代理</li>
  <li>启动runner守护进程，并确保它在系统启动时运行</li>
</ol>

<p>使用<code>circleci</code> CLI工具在您的组织中注册新的跑步者。如果这是您的第一个跑步者，您可能需要在该组织中创建一个名称空间。您将使用完全限定名引用CircleCI配置中的特定runner。对我来说，那就是<code>zan_demos_namespace/mac_runner</code>；<code>mac_runner</code>是跑步者的名字，<code>zan_demos_namespace</code>是我使用的名称空间。</p>

<p>以下是一个命令示例:</p>

<pre><code>$ circleci runner resource-class create zmarkan-demos-namespace/local-mac-runner "Local Mac OS Runner" --generate-token
</code></pre>

<p>这个命令还将为这个runner设置一个新的API令牌，以便与组织中的CircleCI API一起使用。因为有了<code>--generate-token</code>标志，这才成为可能。请确保存储该令牌以备后用。</p>

<p>向CircleCI注册转轮后，按照文档中的<a href="https://circleci.com/docs/runner-installation/">说明安装转轮代理。设置需要预装<code>curl</code>、<code>sha256sum</code>、<code>tar</code>和<code>gzip</code>等软件。可能需要其他软件。</a></p>

<p>设置一些守护程序脚本，并传入这些值:</p>
<ul>
  <li>在上一步中创建的API令牌</li>
  <li>跑步者名称空间</li>
  <li>您指定的名称</li>
</ul>

<p>这些项目的细节因您使用的平台而异。例如，在Mac上你需要创建一个<code>launchd.plist</code>并用<code>launchctl</code>启动它。在Linux上，这将是一个以<code>systemctl</code>开始的新服务。</p>

<h2>从管道调用运行程序</h2>

<p>一旦runner代理开始运行，您就可以从<code>.circleci/config.yml</code>文件中的一个作业调用它。确保用您的运行程序的名称空间和运行程序名称指定<code>machine</code>执行器类型和资源类。这里有一个例子:</p>

<pre><code> runner-test:
    machine: true
    resource_class: zmarkan-demos-namespace/local-mac-runner
    environment:
      JAVA_HOME: /Users/zmarkan/libs/jdk-11.0.2.jdk/Contents/Home
      ANDROID_SDK_ROOT: /Users/zmarkan/Library/Android/sdk
    steps:
      - checkout
      - run:
          name: Run connected check on local runner
          command: |
            ./gradlew connectedDebugAndroidTest
</code></pre>

<p>在我的例子中，我有一些Android设备连接到我的Mac上，所以跑步者可以访问本地硬件来运行测试。</p>

<p>在使用CircleCI自己的基础设施时，我还需要传入一些现成的特定值，比如<code>JAVA_HOME</code>和<code>ANDROID_SDK_ROOT</code>。这是因为它们在CircleCI runner使用的特定shell中不容易访问。在大多数现代MAC电脑上，使用的外壳是ZshCircleCI默认运行Bash。</p>

<p>剩下的步骤很简单，取决于您的应用程序和您想要执行的内容。在我的情况下，就是从回购中检查代码并运行测试。您还可以使用<code>store_artifacts</code>和<code>store_test_results</code>来处理测试并保存输出。然后，您可以在CircleCI云仪表板中看到输出。</p>

<h2>结论</h2>

<p>在本文中，您了解了如何设置一个本地CircleCI运行程序，以便在本地基础设施上执行CircleCI云工作负载。Runner有许多使用案例，从安全性到在定制硬件上的执行，都具有基于云的CircleCI提供的相同CI/CD体验。</p>

<p>如果你对我接下来要讨论的话题有任何反馈或建议，请通过<a href="https://twitter.com/zmarkan/" target="_blank" rel="noreferrer noopener"> Twitter - @zmarkan </a>联系我。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>