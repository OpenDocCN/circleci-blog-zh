# 作为代码的基础设施介绍:使用 Terraform 和 CircleCI

> 原文：<https://circleci.com/blog/an-intro-to-infrastructure-as-code/#2021-10-08T09:00:00-07:00>

作为代码的基础设施(IaC)是使用声明性语言记录基础设施的期望状态的实践。在本文中，我将假设您的团队是从零开始的。也许你的一些构建过程已经被脚本化了，也许有一些手工测试和质量保证工作正在进行。许多读者会发现他们正处于我将要描述的 IaC 采用之旅的中途，或者他们已经错过了一些步骤。

**(要听我们关于[驯服基础设施](https://www.youtube.com/watch?v=fxz5uGhhsz0)的最新见解，请听 HashiCorp 的 Armon Dadgar 关于自信承诺的播客。)**

## 第零步:获得认同

这是最少的技术步骤，也是最重要的。为了成功过渡到 IaC，您需要管理层、同事和团队成员的认同。这为您提供了必要的时间来逐步淘汰不明确、耗时且容易出错的手动流程。这里有一些背景资料可以帮助你开始对话。

## 声明式编程与过程式编程

历史上，开发人员和操作人员会在 Bash 中设置复杂的*过程性*脚本来促进资源的自动化和配置。程序性编程代表一系列逐步的指令；做 x，然后 y，达到 z。

*声明式*编程范例说，如果期望的状态是 z，那么让工具自动处理 x 和 y。我们声明期望的最终状态，然后底层机器执行繁重的工作。作为工程师，我们习惯于在版本控制中存储所有的东西。这包括像 READMEs、工件、测试结果和配置文件这样的资源。为什么不存储我们托管应用程序的底层基础设施的声明性快照呢？我们习惯于尽可能自动化事情。借助现代测试框架，我们能够在所有项目中自动执行测试标准。借助 CircleCI 等工具，我们能够实现部署自动化；借助 Terraform 等工具，我们能够自动配置基础设施。

### 在 CircleCI 使用 Terraform:案例研究

我们在 CircleCI 大量使用 Terraform。我们使用 Terraform 来部署和维护我们复杂的、不断发展的云基础设施。我们用它来设置演示环境和管理我们团队的共享 AWS 资源。CircleCI 的自托管安装通过 Terraform 打包。我们的许多客户使用 Terraform。

我相信你们中的许多人对 [HashiCorp Terraform](https://www.terraform.io/) 很熟悉，但如果不熟悉，这里是 TL；博士:

> Terraform 是一个[神奇的](https://www.brainyquote.com/quotes/arthur_c_clarke_101182)工具，它能够基于声明性模板自动配置基础设施，这些模板是用 HCL (HashiCorp 配置语言)或 JSON 编写的。这些清单代表了您的基础设施的期望状态的声明性快照。强调声明性而非过程性。

让我们谈谈为什么你想在 CircleCI 而不是开发者的本地工作站上执行 Terraform 的几个原因。

### 确定性、可见性和自动化

在 CircleCI 上执行 Terraform 有几个原因:

**决定论**。Terraform 简洁优雅。这是用 Golang (I < 3 Golang)编写的静态二进制文件。在具有统一输入的隔离环境中运行它几乎总是会产生统一的输出。我们在计算机科学(和高阶数学)中称之为参照透明性:相同的输入，相同的输出。不再有“嗯，它在我的机器上工作…我不知道为什么它在你的机器上崩溃”。

**能见度**。每一条管道、每一个工作流程、每一项工作都存储在 CircleCI 上，留给后人。您可以回顾两个月前运行的作业的输出。这有助于可审计性和可见性。其他团队成员可以看到 Terraform 的输出。他们可以计划、查看出现的错误、查看每次运行的输出等。这个很厉害。我们可以查看与每个构建相关联的每个提交。如果出现问题，我们可以 SSH 到一个作业中，查看相应的日志文件。最重要的是，我们将拥有每一次部署的记录。

**自动化**。每次开发人员编写新模块并提交到他们的 VCS 时，都会触发一个工作流，自动验证计划文件并设置部署阶段。可以自动捕获语法错误和格式问题。有了一些[分支级别的过滤](https://circleci.com/blog/wide-world-of-workflows-control/)和一个控制生产部署的手动批准，您可以在每次成功变更时自动部署到一个试运行或 QA 环境。这只是开始；想象一下，能够将基础设施的动态供应作为一系列集成测试的一部分，或者能够自动部署 k8s 集群。

> 提示:获得组织中其他人的认同——这应该是第一步！

## 探索基础设施作为代码的好处

即使 Terraform 对您的团队来说不是正确的选择，但它的许多好处可以普遍应用于 IaC。IaC:

*   通过以清晰明确的方式记录非正式的或手动的过程(如代码),使你的软件开发过程更加清晰可辨
*   向您的团队展示流程中需要改进的步骤，这些步骤…
*   使您的团队能够使用 CircleCI 等 CI/CD 平台编写、测试和衡量这些改进，它…
*   缩短了开发功能和修复错误的时间，从而…
*   使您的公司能够以更快的速度向客户提供价值，并更加敏捷地响应发展重点和市场趋势的变化。

上面列表中最重要的短语是“以增加的速度”代码、CI/CD 和 DevOps 文化等基础设施为您团队的生产力创造了一个积极的反馈循环。

因为生产率的提高是指数级的，越早开始将基础设施定义为代码，从长远来看，生产率的回报就越高。想想储蓄账户的复利。你的公司将从投入 100 个小时的工作来采用基础设施作为代码中获得更多，而不是等到你的团队有足够的带宽来进行改变。剧透:DevOps 团队从来没有足够的带宽。

## 第一步:记录你现在使用的过程

从记录您的构建、测试、部署和发布过程开始，因为它们现在就存在。如果你不确切知道你的过程是什么，你就不能自动化你的过程！

虽然基础设施作为代码显然与部署和发布相关，但是理解构建和测试过程也很重要。这是因为您的测试环境应该尽可能地匹配您的生产环境，以确保您的测试结果是有效的。

> **提示:**盘点您当前的 CI/CD 流程，并详细记录下来。

不要急于编写任何基础设施代码。现在，使用简单、精确的语言，就像你在写烹饪食谱一样。确保您的文档是完整的。

而不是这个:

1.  启动虚拟机
2.  连接 100GB 磁盘
3.  将应用程序代码下载到服务器
4.  安装应用程序

…试试这个:

1.  从 AWS 控制台，在美国东部 1 区使用带有前缀`foobarbaz-wdows2019-hvm-`的最新 AMI 启动 Windows Server 2019 AWS EC2 实例
2.  连接一个 100GB gp2 EBS 卷作为驱动器`E:`
3.  从路径`s3://foobarbaz-code/release/v2.0/appcode.zip`到`C:/Windows/Temp/appcode.zip`的 S3 桶`foobarbaz-code`下载应用程序代码
4.  提取`appcode.zip`到`C:/Windows/Temp/appcode`
5.  运行`C:/Windows/Temp/appcode/install.bat`

这种详细程度很重要。描述中的模糊性会给你的自动化工作制造障碍。含糊不清的指令会导致工程师在编写基础设施代码时做出错误的假设，而这些假设可能需要付出昂贵的代价来修复错误。

不要忘记记录您的变更控制过程，因为这些通常可以在您的 CI/CD 管道中部分或完全自动化。

## 第二步——将所有事情版本化，创造一个真实的来源

一旦你彻底地记录了所有的东西，把它们放进一个版本控制系统(VCS ),比如 GitHub。如果您的流程包括手动步骤，请在自述文件中记下这些步骤，并将其记录到您的 VCS 中。确保每个存储库都有一个自述文件和一个变更日志；以后你会感谢自己的！

### 协作编写代码

仔细阅读 git 分支策略，并考虑哪种策略最适合您的产品。你开发并运行一个 SaaS 应用程序吗？

查看[基于主干的开发](https://circleci.com/blog/trunk-vs-feature-based-dev/)。您开发的移动或企业应用程序需要同时支持多个版本吗？

> **提示:**选择并实施 git 分支和标记策略。

查看 git 流。仔细阅读您的标记策略的语义版本。向您的团队解释您选择的标记和分支策略。不要把这个推迟到以后，否则你的分支最终会像一碗意大利面条，你下一次发布的前一周将会是非常漫长的一周。

## 第三步——迭代地改进你的过程

至此，您已经完整地记录了所有的过程，并将它们签入到版本控制中。现在，您终于准备好开始将您的手动命令式流程转换成自动化的声明式基础架构代码了。

> **提示:**定期分析您的基础架构代码和部署流程，以确定需要改进的地方。

首先，确定流程中哪些部分需要改进。本着“左移”的精神，在错误变成代价高昂的生产中断之前尽早捕捉它们，优先考虑自动化您的构建过程和编写单元测试。在 CircleCI 这样的 CI/CD 平台上运行您的测试。接下来，重点写集成和端到端测试。最后，编写基础设施代码来自动化您的部署和发布过程。您的基础设施代码库应该反映您现有基础设施的理想状态，并包含在万一发生(比如说)一颗巨大的流星摧毁美国西部 2 地区时重新部署该基础设施所必需的一切。

## 我应该使用哪些 IaC 工具？

我们以前写过这个话题，但我会在这里把它分解，并给出一些一般性的建议。

> **提示:**谨慎选择您的基础设施部署工具。

*   **构建和测试。**构建过程和单元测试框架会因语言而异，但是您可以使用 CircleCI 的 orbs 来简化这个过程。下面是[红宝石](https://circleci.com/developer/orbs/orb/circleci/ruby)和[节点](https://circleci.com/developer/orbs/orb/circleci/node)的例子。一旦您编写了您的构建脚本和测试，请查看运行它们的 CI/CD 工具。CircleCI 的 config.yml 语法简单易学，你可以用你的 GitHub 或者 Bitbucket 账号登录，几分钟就可以开始运行构建和测试。您还可以使用 orbs 来集成像 Katalon 或 Cypress 这样的第三方测试服务。
*   **部署和发布。**公共云基础架构通过多种工具进行部署和管理。目前，Terraform 和 [Pulumi](https://www.pulumi.com/) 是两个最流行的用于此目的的多云工具。
*   **配置管理。**如果你的应用程序是有状态的，你也可以考虑使用一个配置管理工具，比如 Ansible 和 CircleCI 的[调度管道](https://circleci.com/blog/using-scheduled-pipelines/)来强制应用程序的状态。

## 结论

IaC 的好处是巨大的。虽然作为代码的基础设施属于基础设施，但是当手动供应服务器/服务时总是发生的相同种类的“配置漂移”同样适用于网络基础设施、子网配置、入口/出口规则、负载平衡器配置等。IaC 缓解了许多这些问题，甚至更多。它是强大的，它是优雅的，它是许多团队和组织在云中管理他们的资源的方式。