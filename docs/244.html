<html>
<head>
<title>Deploying infrastructure with an approval job using Terraform | CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Terraform | CircleCI通过批准作业部署基础架构</h1>
<blockquote>原文：<a href="https://circleci.com/blog/deploy-terraform-behind-approval-job/#2021-04-05T16:00:00-07:00">https://circleci.com/blog/deploy-terraform-behind-approval-job/#2021-04-05T16:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>如果你正在寻找一个基础设施即代码(IaC)工具，那么<a href="https://www.terraform.io/"> Terraform </a>可能是你的首选。在本教程中，您将学习如何使用Terraform和CircleCI工作流自动部署基础架构变更。工作流将使用<a href="https://circleci.com/docs/workflows/#holding-a-workflow-for-a-manual-approval">批准工作</a>。对于这个项目，我们将把我们构建的基础设施部署到<a href="https://cloud.google.com/">谷歌云平台</a> (GCP)。即使你使用另一家云提供商，如<a href="https://digitalocean.com/"> DigitalOcean </a>或<a href="https://aws.amazon.com/"> Amazon Web Services </a> (AWS)，你也能够适应并应用你在这里学到的东西。</p>

<p><strong>注:</strong> <i>我将在本教程的稍后部分更详细地描述Terraform的功能。</i></p>

<h2>先决条件</h2>

<p>要遵循本教程，需要做一些事情:</p>



<h2>关于CircleCI工作流程</h2>

<p>CircleCI工作流是一种声明性的方式，用于指定一系列作业应该如何、何时以及以何种顺序在<a href="https://circleci.com/blog/what-is-a-ci-cd-pipeline/">管道</a>中运行。在本教程中，我们将使用CircleCI工作流在每次提交GitHub存储库的主分支时部署我们的基础设施变更。</p>

<h2>关于Terraform</h2>

<p><a href="https://www.terraform.io/"> Terraform </a>是一个工具，它允许我们使用用一种叫做<strong> Hashicorp配置语言</strong> (HCL)的专门编程语言编写的配置文件来编写基础设施。HCL配置文件使用<code>.tf</code>扩展名。</p>

<p>我们将使用Terraform来编写<a href="https://www.terraform.io/docs/configuration/resources.html"> <code>resources</code> </a>。Terraform资源是基础设施资源的代码表示。资源可以是服务器、防火墙规则、网络地址或基础设施的另一部分。</p>

<p>为了保持资源与云提供商运行的资源同步，Terraform使用了一个<a href="https://www.terraform.io/docs/glossary.html#state"> <code>state</code> </a>。状态可以存储在不同的<a href="https://www.terraform.io/docs/backends/index.html">后端</a>:本地、远程存储服务或状态管理软件。</p>

<h2>安装Terraform CLI</h2>

<p>我发现安装Terraform CLI最简单的方法是从官方下载页面的<a href="https://www.terraform.io/downloads.html">下载为您的平台预先构建的二进制文件，并将其移动到当前位于您的<code>PATH</code>环境变量中的文件夹。</a></p>

<p><strong>注意</strong> : <i> Terraform提供<a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">大量关于安装</a>的文档，如果你想尝试不同的方法。</i></p>

<p>例如，在Linux上，安装Terraform就像运行以下命令一样简单:</p>

<pre><code>wget -O terraform.zip https://releases.hashicorp.com/terraform/0.13.5/terraform_0.13.5_linux_amd64.zip
unzip terraform.zip &amp;&amp; rm terraform.zip
sudo mv terraform /usr/local/bin/
</code></pre>

<p>通过运行以下命令确认安装正确:</p>

<pre><code>terraform version
</code></pre>

<p>它应该会打印出类似于<code>Terraform v0.13.5</code>的内容(Terraform会定期更新，所以如果您的版本有所不同，请不要感到惊讶)</p>

<p>既然Terraform已经开始工作了，我们可以创建我们的项目了。</p>

<h2>设置Google云</h2>

<p>我们的第一个任务是在Google Cloud上创建一个项目来存储与Terraform本身相关的一切，比如状态和服务账户。使用gcloud CLI输入:</p>

<p><strong>注意</strong> : <i>请在运行以下命令之前，通过运行<code>gcloud auth login</code>确认您已登录(使用适当的Google帐户),它会重定向到您的默认浏览器供您登录。</i></p>

<p>如果您使用的是Linux/Unix:</p>

<pre><code>RANDOM_ID=$(perl -pe 'binmode(STDIN, ":bytes"); tr/a-z0-9//dc;' &lt; /dev/urandom | head -c 8; echo)
gcloud projects create terraform-admin-$RANDOM_ID --name terraform-admin --set-as-default
</code></pre>

<p>如果您在Windows上(并且没有使用Linux的WSL - Windows子系统)，请改为运行以下命令:</p>

<pre><code>set RANDOM_ID=%random%%random%
gcloud projects create terraform-admin-%RANDOM_ID% --name terraform-admin --set-as-default
</code></pre>

<p>第一行创建了一个随机id，我们可以用它作为Google Cloud上项目ID的后缀。使用随机ID作为后缀很重要，因为项目ID必须是唯一的。第二行在Google Cloud上创建项目。我们把它命名为<code>terraform-admin</code>。</p>

<p>如果您正在使用Google Cloud上的一个组织，并且您希望这个项目成为它的一部分，请将该组织添加到上面的gcloud命令中，就像这样:<code>--organization [org-id]</code>。</p>

<p>该命令的最后输出应该类似于:</p>

<p><code>Updated property [core/project] to [terraform-admin-0bqjep28]</code></p>

<p>为了使接下来的步骤更容易，我们可以将完整的项目标识符放在一个变量中:</p>

<pre><code>export TERRAFORM_PROJECT_IDENTIFIER=$(gcloud config get-value project)
</code></pre>

<p>运行以下命令，将最近创建的项目链接到您的计费帐户:</p>

<pre><code>gcloud beta billing projects \
	link $TERRAFORM_PROJECT_IDENTIFIER \
	--billing-account [billing-account-id]
</code></pre>

<p>记得用您的账单账户的<i>的实际ID替换<code>billing-account-id</code>。如果不知道使用什么ID，最简单的方法是运行:</i></p>

<pre><code>gcloud beta billing accounts list
</code></pre>

<p>您的ID是输出的第一列。使用<strong>打开</strong>状态(第三列)为<strong>真</strong>的ID。</p>

<p>接下来，在Terraform项目上启用所需的API:</p>

<pre><code>gcloud services enable \
	cloudresourcemanager.googleapis.com \
	cloudbilling.googleapis.com \
	compute.googleapis.com \
	iam.googleapis.com \
	serviceusage.googleapis.com \
	container.googleapis.com
</code></pre>
<h3>创建服务帐户</h3>

<p>创建我们将与Terraform一起使用的服务帐户:</p>

<pre><code>gcloud iam service-accounts create terraform \
  --display-name "Terraform admin account"
</code></pre>

<p>它应该显示如下内容:</p>

<p><code>Created service account [terraform].</code></p>

<p>将服务帐户电子邮件存储在变量中:</p>

<pre><code>export TERRAFORM_SERVICE_ACCOUNT_EMAIL="terraform@$TERRAFORM_PROJECT_IDENTIFIER.iam.gserviceaccount.com"
</code></pre>
<h3>创建服务帐户JSON密钥</h3>

<p>创建服务帐户后，我们需要一个JSON键。JSON密钥是我们将用来作为此服务帐户进行身份验证的文件:</p>

<pre><code>gcloud iam service-accounts keys create \
	--iam-account $TERRAFORM_SERVICE_ACCOUNT_EMAIL \
  ~/gcloud-terraform-admin.json
</code></pre>

<p>您应该会得到类似如下的输出:</p>

<p><code>created key [d4a3ef60690cb42faa1a71c5d75c5c04f6535c5a] of type [json] as [~/gcloud-terraform-admin.json] for [terraform@terraform-admin-0bqjep28.iam.gserviceaccount.com]</code></p>

<p>输出显示Terraform服务帐户密钥是在<code>~/gcloud-terraform-admin.json</code>创建的。记住这条路，因为我们以后会需要它。</p>

<h3>添加角色</h3>

<p>接下来，我们需要创建角色，以便Terraform可以将它们的状态存储在我们稍后将创建的存储桶中。在这一步中，我们将把<code>viewer</code>和<code>storage.admin</code>角色添加到Terraform Google Cloud项目的服务帐户中:</p>

<pre><code>gcloud projects add-iam-policy-binding $TERRAFORM_PROJECT_IDENTIFIER \
  --member serviceAccount:$TERRAFORM_SERVICE_ACCOUNT_EMAIL \
  --role roles/viewer

gcloud projects add-iam-policy-binding $TERRAFORM_PROJECT_IDENTIFIER  \
  --member serviceAccount:$TERRAFORM_SERVICE_ACCOUNT_EMAIL  \
  --role roles/storage.admin
</code></pre>

<p>它应该在每个命令之后输出项目的更新IAM策略。</p>

<p><a href="https://www.terraform.io/docs/state/index.html">地形状态</a>可以本地存储，也可以远程存储。如果你是团队的一员，或者使用多台机器，远程存储效果最好。因为我们使用的是Google Cloud，所以我们将状态直接存储在一个存储桶中。要在Google Cloud上创建bucket，运行:</p>

<pre><code>gsutil mb -p $TERRAFORM_PROJECT_IDENTIFIER gs://$TERRAFORM_PROJECT_IDENTIFIER
gsutil versioning set on gs://$TERRAFORM_PROJECT_IDENTIFIER
</code></pre>

<p>如果您跳过了前面的步骤，将项目链接到您的计费帐户，您将得到类似于:<code>Error: Failed to get existing workspaces: querying Cloud Storage failed: storage: bucket doesn't exist</code>的错误</p>

<p>bucket名称必须是惟一的，所以我们使用了项目标识符。我们还在存储桶中启用了<a href="https://cloud.google.com/storage/docs/object-versioning">版本控制</a>。</p>

<p>现在只剩下几个步骤来完成谷歌云的配置。</p>

<p>创建一个单独的项目来创建我们的Kubernetes集群:</p>

<pre><code>gcloud projects create circleci-k8s-cluster-$RANDOM_ID --name circleci-k8s-cluster
</code></pre>

<p>请注意，我们使用的是我们在之前的项目中使用的命令，但是我们使用的是名称<code>circleci-k8s-cluster</code>。另一个区别是，我们没有将此项目设置为gcloud CLI的默认项目。</p>

<p>将标识符放入变量中，就像我们之前做的那样:</p>

<pre><code>export CIRCLECI_K8S_CLUSTER_PROJECT_IDENTIFIER=circleci-k8s-cluster-$RANDOM_ID
</code></pre>

<p>就像Terraform项目一样，新项目必须链接到您的计费帐户。运行:</p>

<pre><code>gcloud beta billing projects \
	link $CIRCLECI_K8S_CLUSTER_PROJECT_IDENTIFIER \
	--billing-account [billing-account-id]
</code></pre>

<p>记得用您的付费帐户ID替换[<code>billing-account-id</code>]。</p>

<p>要完成Google Cloud设置，请授予Terraform服务帐户对此项目的完全访问权限。给它分配<code>owner</code>角色:</p>

<pre><code>gcloud projects add-iam-policy-binding $CIRCLECI_K8S_CLUSTER_PROJECT_IDENTIFIER \
  --member serviceAccount:$TERRAFORM_SERVICE_ACCOUNT_EMAIL  \
  --role roles/owner
</code></pre>

<h3>保护项目资源的安全</h3>

<p>凭借<code>owner</code>权限，Terraform服务帐户可以完全访问该项目及其所有资源。对服务帐户密钥格外小心可能是明智的。</p>

<p>如果您在Google Cloud上有一个组织，您也可以在组织级别为服务帐户赋予类似的角色。这使得Terraform服务帐户可以访问该组织内的所有项目。我还建议将<code>resourcemanager.projectCreator</code>和<code>roles/billing.user</code>角色赋予组织级别的服务帐户。授予这些角色访问权限，可以让Terraform自己在Google Cloud上创建新项目。对于本教程，我们需要手动创建项目，然后才能在Terraform中使用它们。</p>

<p>现在我们可以转移到Terraform项目本身。</p>

<h2>将我们的基础设施创建为代码项目</h2>

<p>对于本教程，我们将部署一个简单的Kubernetes集群到Google Cloud。我们需要做的第一件事是在GitHub上创建我们的存储库，并在我们的机器上初始化一个指向这个repo的本地存储库。将您的项目命名为<code>circleci-terraform-automated-deploy</code>。</p>

<p>使用GitHub CLI，这就像运行:</p>

<pre><code>gh repo create circleci-terraform-automated-deploy
</code></pre>

<p>将<code>Visibility</code>设置为您想要的，并回答两个问题的<code>Yes</code>。</p>

<p>转到新存储库:</p>

<pre><code>cd circleci-terraform-automated-deploy
</code></pre>

<p>创建新文件:</p>

<pre><code>.
|- backend.tf
|- k8s-cluster.tf
|- main.tf
|- outputs.tf
|- variables.tf
</code></pre>

<p>创建每个文件，将它们留空:</p>

<pre><code>touch backend.tf k8s-cluster.tf main.tf outputs.tf variables.tf
</code></pre>

<p>以下是每个文件的描述:</p>

<ul>
  <li>设置存储我们状态的后端</li>
  <li><code>k8s-cluster.tf</code>为Kubernetes相关资源</li>
  <li><code>main.tf</code>代表资源和配置，比如我们正在使用的提供商</li>
  <li><code>variables.tf</code>对于本教程将为空</li>
  <li><code>outputs.tf</code>对于本教程也是空的</li>
</ul>

<p>通过添加以下内容更新<code>backend.tf</code>:</p>

<pre><code>terraform {
  backend "gcs" {
    bucket = "[full-project-identifier]"
    prefix = "terraform/state"
  }
}
</code></pre>

<p>记得用Terraform正在使用的Google项目的完整标识符替换<code>[full-project-identifier]</code>。它存储在<code>$TERRAFORM_PROJECT_IDENTIFIER</code> shell变量中。我们将我们的bucket命名为与项目标识符完全相同的名称，因此它具有相同的值。</p>

<p>最后，我们将导出一个名为<code>GOOGLE_APPLICATION_CREDENTIALS</code>的新shell变量。我们在Terraform中使用的<code>google</code>提供者检查这个变量以进行身份验证。新变量指向我们之前创建的服务帐户密钥:</p>

<pre><code>export GOOGLE_APPLICATION_CREDENTIALS=~/gcloud-terraform-admin.json
</code></pre>

<p>检查Terraform是否能够通过Google Cloud进行身份验证，以创建初始状态。在您的git存储库中，运行:</p>

<pre><code>terraform init
</code></pre>

<p>如果失败，尝试运行<code>terraform init -reconfigure</code></p>

<p>您应该会看到多行输出，包括:</p>

<blockquote>
  <p>Terraform已成功初始化！</p>
</blockquote>

<p>Terraform在当前目录下创建了一个<code>.terraform</code>文件夹。我们不想将它提交给我们的存储库，所以将其添加到<code>.gitignore</code>:</p>

<pre><code>echo ".terraform" &gt;&gt; .gitignore
</code></pre>

<p>现在我们可以使用Terraform创建我们的Kubernetes集群。首先，让Terraform知道我们想要使用哪个版本的谷歌Terraform提供商。打开<code>main.tf</code>并添加:</p>

<pre><code>provider "google" {
  project = "[circleci-project-full-identifier]"
  region  = "us-west1"
}
</code></pre>

<p>除了Google provider的版本，我们还设置了<code>project</code>和<code>region</code>的默认值。创建资源时，默认情况下将使用这些值。确保用实际值替换<code>[circleci-project-full-identifier]</code>。在我们的例子中，这是<code>$CIRCLECI_K8S_CLUSTER_PROJECT_IDENTIFIER</code> shell变量的值。</p>

<p>因为我们改变了一个提供者，我们也必须重新初始化Terraform状态。运行:</p>

<pre><code>terraform init
</code></pre>

<p>您的输出应该包括:</p>

<blockquote>
  <p>Terraform已成功初始化！</p>
</blockquote>

<p>Terraform资源基于实际的基础设施资源，因此要在Google Cloud上创建Kubernetes集群，我们必须创建两个资源:</p>



<p>链接指向每个资源的Terraform文档。</p>

<p>在存储库中创建一个名为<code>k8s-cluster.tf</code>的新文件(如果还没有创建的话):</p>

<pre><code>touch k8s-cluster.tf
</code></pre>

<p>用你最喜欢的编辑器打开它，写下:</p>

<pre><code>locals {
  k8s_services = [
    "cloudapis.googleapis.com",
    "cloudresourcemanager.googleapis.com",
    "cloudtrace.googleapis.com",
    "compute.googleapis.com",
    "container.googleapis.com",
    "dataflow.googleapis.com",
    "logging.googleapis.com",
    "monitoring.googleapis.com",
    "pubsub.googleapis.com",
    "replicapool.googleapis.com",
    "replicapoolupdater.googleapis.com",
    "servicemanagement.googleapis.com",
    "serviceusage.googleapis.com",
  ]
}

resource "google_project_service" "k8s_cluster" {
  count                      = length(local.k8s_services)
  service                    = local.k8s_services[count.index]
  disable_dependent_services = true
}

resource "google_container_cluster" "circleci_cluster" {
  name     = "circleci-cluster"
  location = "us-west1-a"

  # Kubernetes Version
  min_master_version = "1.17.13-gke.2600"

  # We can't create a cluster with no node pool defined, but we want to use
  # a separately managed node pool. For that, we create the smallest possible
  # default node pool and immediately delete it.
  # This is the recommended way to manage node pools with Terraform.
  remove_default_node_pool = true
  initial_node_count       = 1

  # Setting an empty username and password explicitly disables basic auth
  master_auth {
    username = ""
    password = ""
    client_certificate_config {
      issue_client_certificate = false
    }
  }

  depends_on = [
    google_project_service.k8s_cluster
  ]
}

resource "google_container_node_pool" "circleci_cluster_primary" {
  name     = "primary"
  location = google_container_cluster.circleci_cluster.location
  cluster  = google_container_cluster.circleci_cluster.name

  node_count = 1

  node_config {
    machine_type = "e2-standard-2"

    oauth_scopes = [
      "https://www.googleapis.com/auth/devstorage.read_only",
      "https://www.googleapis.com/auth/logging.write",
      "https://www.googleapis.com/auth/monitoring",
      "https://www.googleapis.com/auth/service.management.readonly",
      "https://www.googleapis.com/auth/servicecontrol",
      "https://www.googleapis.com/auth/trace.append",
    ]
  }
}
</code></pre>

<p>准备好Terraform配置文件后，我们可以测试Terraform action planner将为我们引入的更改输出什么:</p>

<pre><code>terraform plan
</code></pre>

<p>如果一切正常，您应该会看到多行输出，显示当前状态和<code>.tf</code>文件中的不同。它还应该给出变化的摘要:</p>

<blockquote>
  <p>计划:15添加，0更改，0销毁。</p>
</blockquote>

<p>Terraform计划向我们的州添加15个资源，并通过这样做，在谷歌云上创建它们。</p>

<p>应用更改:</p>

<pre><code>terraform apply
</code></pre>

<p>现在，Terraform将显示相同的差异，但它不会在最后退出，而是提示您应用这些更改:</p>

<blockquote>
  <p>计划:15添加，0更改，0销毁。您想执行这些操作吗？Terraform将执行上述操作。只有“是”将被接受批准。</p>
</blockquote>

<p>回答<code>yes</code>。</p>

<p>Terraform CLI成功退出后，Google Cloud上的资源就准备好了。通过访问谷歌云控制台并转到<code>Kubernetes Engine</code>页面来确认这一点。</p>

<p><img src="../Images/05e41a7f65d8e16865ce7d0d64303bc4.png" alt="Kubernetes Cluster created" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-0.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-0.png"/></p>

<p>如果引用一个声称版本不受支持的<em> google api </em>错误不成功，请在此参考在GKE <a href="https://cloud.google.com/kubernetes-engine/docs/release-notes#current_versions">可用的最新次要版本，并用<em>常规</em> <strong> GKE发布渠道</strong>的<strong>默认补丁版本</strong>更新<code>k8s-cluster.tf</code>的第30行；然后重新运行<code>terraform apply</code>。</a></p>

<p>希望现在一切正常。我们将通过运行以下命令来破坏我们的基础设施:</p>

<pre><code>terraform destroy
</code></pre>

<p>输出应包括:</p>

<blockquote>
  <p>计划:0添加，0更改，15销毁。</p>

  <p>真的要破坏所有资源吗？Terraform会毁掉你所有的托管基础设施，如上图。无法撤销。只接受“是”进行确认。</p>
</blockquote>

<p>回答<code>yes</code>整个基础设施将被摧毁，并从国家中移除。</p>

<p>现在是将一切提交给我们的存储库的好时机。不过，在此之前，还有一个非常有用的Terraform命令。在项目根目录下，运行:</p>

<pre><code>terraform fmt
</code></pre>

<p>这个命令将我们的<code>.tf</code>文件重写为规范的格式。</p>

<p>提交您的更改:</p>

<pre><code>git add --all
git commit -m "terraform initial files"
git push -u origin master
</code></pre>

<h2>创建我们的CircleCI配置</h2>

<p>为了使我们的CircleCI配置更容易，我们将使用一个<a href="https://circleci.com/orbs/"> CircleCI Orb </a>。orb是可重用的代码片段，有助于自动化重复的过程，加速项目设置，并使其易于与第三方工具集成。我们要用的宝珠是CircleCI的官方Terraform宝珠:<a href="https://circleci.com/developer/orbs/orb/circleci/terraform"> circleci/terraform </a>。</p>

<p>在git存储库的根目录下创建一个名为<code>.circleci</code>的新文件夹。添加一个名为<code>config.yml</code>的空文件:</p>

<pre><code>mkdir .circleci
touch .circleci/config.yml
</code></pre>

<p>写:</p>

<pre><code>version: 2.1
orbs:
  terraform: "circleci/terraform@1.1.0"
workflows:
  deploy_infrastructure:
    jobs:
      - terraform/fmt:
          checkout: true
          context: terraform
      - terraform/validate:
          checkout: true
          context: terraform
          requires:
            - terraform/fmt
      - terraform/plan:
          checkout: true
          context: terraform
          persist-workspace: true
          requires:
            - terraform/validate
      - terraform/apply:
          attach-workspace: true
          context: terraform
          filters:
            branches:
              only: master
          requires:
            - terraform/plan
</code></pre>

<p>我们正在使用<a href="https://circleci.com/developer/orbs/orb/circleci/terraform"> <code>circleci/terraform</code> </a> orb中的多个作业来为我们完成繁重的工作。工作流会做所有的事情。</p>

<p>对于每次提交，它将验证我们的<code>.tf</code>文件是否被正确格式化(<code>terraform/fmt</code>作业)以及它们是否有效(<code>terraform/validate</code>作业)。工作流还计划了我们对基础设施所做的更改(<code>terraform/plan</code> job)。</p>

<p>如果提交是在<code>master</code>分支中，我们将<code>apply</code>在<code>terraform/plan</code>作业中计划的变更。</p>

<p>这已经是很多自动化了。我们可能不希望在未经某人直接批准的情况下对我们的基础设施进行更改。</p>

<h2>需要批准</h2>

<p>要在应用更改之前获得批准，我们需要对<code>.circleci/config.yml</code>文件进行更改:</p>

<pre><code>version: 2.1
orbs:
  terraform: "circleci/terraform@1.1.0"
workflows:
  deploy_infrastructure:
    jobs:
      - terraform/fmt:
          checkout: true
          context: terraform
      - terraform/validate:
          checkout: true
          context: terraform
          requires:
            - terraform/fmt
      - terraform/plan:
          checkout: true
          context: terraform
          persist-workspace: true
          requires:
            - terraform/validate
      - hold-apply:
          type: approval
          requires:
            - terraform/plan
      - terraform/apply:
          attach-workspace: true
          context: terraform
          filters:
            branches:
              only: master
          requires:
            - hold-apply
</code></pre>

<p>我们在工作流程中引入了一项新的<a href="https://circleci.com/docs/workflows/#holding-a-workflow-for-a-manual-approval">审批工作</a>。该作业将暂停我们的工作流，直到有人批准或取消该请求。现在我们的<code>terraform/apply</code>任务要求<code>hold-apply</code>任务在开始前得到批准。</p>

<p>批准后，<code>terraform/apply</code>作业将开始运行。</p>

<p>将目前为止的所有更改提交到我们的存储库:</p>

<pre><code>git add --all
git commit -m "add circleci config"
git push
</code></pre>

<h2>在CircleCI建立项目</h2>

<p>当你登录到你的<a href="https://app.circleci.com/"> CircleCI账户</a>后，点击侧边栏中的<code>Organization Settings</code>页面。现在我们可以在名为<code>terraform</code>的配置文件中添加我们正在使用的<a href="https://circleci.com/docs/contexts/">上下文</a>。上下文是一种在CircleCI中跨多个项目/作业安全共享环境变量的方式。</p>

<p>在下一页<code>Contexts</code>中，点击<code>Create Context</code>。将上下文命名为<code>terraform</code>，并点击<code>Create Context</code>。从列表中选择新上下文以查看其详细信息。</p>

<p>点击<code>Add Environment Variable</code>。将环境变量命名为<code>GOOGLE_CREDENTIALS</code>。变量的值是我们的terraform服务帐户的<code>.json</code>键的全部内容。我们将该文件保存到<code>~/gcloud-terraform-admin.json</code>。要获取内容，请运行:</p>

<pre><code>cat ~/gcloud-terraform-admin.json
</code></pre>

<p>将环境变量的值设置为JSON密钥文件的内容后，单击<code>Add Environment Variable</code>。</p>

<p>现在我们已经完成了上下文的创建，返回到CircleCI中的项目页面(通过点击右上角的X图标)。搜索您为基础设施创建的GitHub存储库。点击<code>Set Up Project</code>。</p>

<p><img src="../Images/3b654ac28d85de420236bbc2ee3e9771.png" alt="Setting Up Project on CircleCI" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-1.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-1.png"/></p>

<p>点击<code>Use Existing Config</code>。</p>

<p><img src="../Images/1f88f70c27739cca5c1475779eb153fa.png" alt="Config file Wizard" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-2.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-2.png"/></p>

<p>然后<code>Start Building</code>。</p>

<p><img src="../Images/365a0cbad91ddf565cd0901f00c08959.png" alt="Config file Wizard confirmation modal" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-3.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-3.png"/></p>

<p>这将运行我们存储库的第一次构建。</p>

<p><img src="../Images/c02a6758df867a302f4d9fec09577f48.png" alt="Repository first build running" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-4.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-4.png"/></p>

<p>如果一切正常，UI将显示一个不同的图标，它到达<code>hold-apply</code>任务。</p>

<p><img src="../Images/0415b079b0155608814aed509ff51a29.png" alt="First build on hold" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-5.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-5.png"/></p>

<p>点击<code>terraform/plan</code>任务，查看<code>terraform plan</code>步骤的输出。如果正确，返回工作流程页面，点击<code>hold-apply</code>作业。您可以批准或取消它。</p>

<p><img src="../Images/5f63d147246e4c6501274a9239cd645f.png" alt="Workflow job approval dialog" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-6.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-6.png"/></p>

<p>批准它开始<code>terraform/apply</code>。</p>

<p><img src="../Images/3e6c5d43d47d3b6f4ef09221ddfb99ee.png" alt="Workflow running after approval" srcset="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=449 449w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=898 898w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1347 1347w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=720 720w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1440 1440w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2160 2160w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=779 779w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1558 1558w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2337 2337w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=750 750w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=1500 1500w,&#10;https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;w=2250 2250w" sizes="(min-width: 1200px) 750px,&#10;(min-width: 992px) 779px,&#10;(min-width: 768px) 720px,&#10;(min-width: 480px) 720px,&#10;(min-width: 0px) 449px" data-full-size-src="https://production-cci-com.imgix.net/blog/media/2020-11-09-image-7.png?ixlib=rb-3.2.1&amp;auto=format&amp;fit=max&amp;q=60&amp;ch=DPR%2CWidth%2CViewport-Width%2CSave-Data&amp;fm=jpg" data-original-src="https://circleci.com/blog/media/2020-11-09-image-7.png"/></p>

<p>这项工作可能需要一段时间才能完成。一旦它结束，基础设施应该可以在谷歌云控制台上使用，我们的建设将是绿色的。</p>

<p>成功！</p>

<p>当您不再需要基础结构时，您可以运行(本地):</p>

<pre><code>terraform destroy
</code></pre>

<h2>结论</h2>

<p>通过Terraform将基础设施作为代码使用，不仅可以提高应用新变更的速度，还可以跟踪这些变更的所有权。使用CircleCI自动部署所有这些将使您的基础设施更加可靠，同时提供高效的软件开发生命周期。</p>


        
          
          
            <hr/>
            <p>Jonathan Cardoso热衷于DevOps、开源和游戏。他有六年的经验，帮助世界各地的公司通过技术解决方案推进他们的目标。他目前在巴西担任HelloMD的全栈开发人员和DevOps专家。</p>

            <p><a href="/blog/author/jonathan-cardoso/" class="arrow-link">阅读乔纳森·卡多佐的更多帖子</a></p>
          
        
      </div>
    </div>    
</body>
</html>