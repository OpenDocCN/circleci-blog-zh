<html>
<head>
<title>Incident postmortem for July 19: what happened and what’s next - CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>7月19日事件事后分析:发生了什么，下一步是什么</h1>
<blockquote>原文：<a href="https://circleci.com/blog/incident-postmortem-for-july-19-what-happened-and-what-s-next/#2018-07-31T07:31:00-07:00">https://circleci.com/blog/incident-postmortem-for-july-19-what-happened-and-what-s-next/#2018-07-31T07:31:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>7月19日，CircleCI面临站点范围的中断，这使得数千个团队在一天的大部分时间里无法测试和部署构建。这次中断影响了许多开发团队的生产力，并且肯定导致了一些错过的最后期限。我们重视客户对我们的信任，并对由此给他们的工作带来的影响深感抱歉。对于那些感兴趣的人，我们想给出更多关于发生了什么，为什么会发生，以及我们正在做什么的细节。</p>
<h3>发生了什么事？</h3>

<p>世界协调时2018-07-19 16:46:14，CircleCI的一个内部证书颁发机构(CA)的根证书意外过期，导致该CA颁发的所有证书同时失效。正在讨论的CA用于CircleCI环境中运行的所有Mongo实例(总共17台主机)。使用内部CA要求将根证书分发给每个客户端，以便建立信任关系。由于影响范围，数百台主机和容器受到影响。为了避免重写每个客户端主机的证书库，我们为所有Mongo服务器生成了第三方证书，并重新配置了服务器以使用这些证书。</p>

<h3>我们是怎么到这里的？</h3>

<p>在2015年夏天，在CircleCI雇佣第一个SRE团队成员之前，当我们的第三方Mongo托管提供商一直让我们失望时，我们开始构建一套内部管理的Mongo服务器，我们可以扩展这些服务器以满足我们的需求，并使用我们认为更适合我们提供的服务的工具进行管理。虽然我们已经把目光放在了离开Mongo上，但我们也知道我们可能会在未来很长一段时间内使用它。2015年8月初，在构建最终成为5个独立副本集的第一个副本集时，我们创建了一个内部证书颁发机构，开始为我们的副本集颁发证书。该证书的有效期为10年，以避免在处理关键基础设施的内部轮换证书时遇到一些挑战。做出这个决定的时候，还没有像今天这样方便地轮换证书的工具。</p>

<p>在2015年9月下旬，当我们准备开始将流量迁移到我们的新Mongo集群时，一名审查人员发现用于签署我们的服务器证书的根证书正在使用SHA1作为签名算法。该证书立即被替换为一个新的证书，它使用SHA512作为签名算法。其意图是该证书也将有10年的有效期。然而，我们最近发现，情况并非如此。虽然我们无法访问机器，因此无法访问创建该证书的原始命令，但很明显，操作员的错误导致生成的根证书的有效期较短。</p>

<p>我们用这个根CA生成和签名的所有特定于服务器的证书都有10年的有效期，我们检查了这些证书以确保我们不急于替换它们。</p>

<h3>为了避免这种情况再次发生，我们要改变什么？</h3>

<p>避免此类事件发生的大部分工作是我们已经完成的工作。在我们部署Mongo基础设施以来的这段时间里，我们的SRE团队成员从0人增加到了9人，我们在运营基础设施方面投入了大量资金。我们现在使用自动化工具来管理我们的内部证书，并使用多个第三方来处理我们的整体TLS证书加载。我们还监控随后构建的所有系统的证书到期时间。</p>

<p>不幸的是，基于我们有一个相当大的窗口来处理工具的迁移，我们允许我们的Mongo基础设施上的证书管理的迁移被去优先级化。我们目前正在审核我们在整个基础设施中对TLS的所有使用，以识别任何没有使用我们工具的最新标准的配置。我们还在寻找旧系统基础设施上的任何其他非标准配置，以使我们的所有系统达到我们当前的监控和维护工具水平。具体到此次事件中的Mongo服务器，我们将来自内部CA的证书替换为外部提供的有效期为1年的证书，现在我们已经清除了该事件，将积极地将它们迁移到我们的公共基础架构。</p>

<h3>我们还学到了什么？</h3>

<p>我们有一个工程团队，非常重视同行代码审查和自动化，以便在错误进入生产之前将其捕获。这是我们如此依赖基础设施而不是代码的原因之一。但是，即使在这些工具还没有很好开发的时候，我们还没有把它们中的一些放在适当的位置上，仍然有可能以手工的方式进行同行评审。当采取有风险的行动时，我们经常这样做。一句简单的“我要用这个命令做这件事”来获得第二双眼睛的“LGTM”总是值得的。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>