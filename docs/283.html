<html>
<head>
<title>Dynamically rendering config templates for secrets management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>动态呈现用于秘密管理的配置模板</h1>
<blockquote>原文：<a href="https://circleci.com/blog/dynamically-rendering-config-templates/#2021-10-15T09:00:00-07:00">https://circleci.com/blog/dynamically-rendering-config-templates/#2021-10-15T09:00:00-07:00</a></blockquote><div><div class="post-content col-xs-12 col-md-10 col-lg-8">
        

        <p>通常有必要在构建或部署过程中注入秘密，以便部署的服务可以与其他服务交互。如果您只部署到单一环境，这可能很简单。但是，当部署到多个环境时，您可能需要根据您要部署到的环境动态地注入不同的秘密。</p>

<p>假设您的应用程序中有一个虚拟机(VM)。该虚拟机需要一个嵌入在配置文件中的秘密API令牌来与第三方服务通信。为了保持生产和非生产环境的隔离，您为生产服务器创建了一个“prod”API令牌，为非生产服务器创建了一个“dev”API令牌。现在，您不希望将这些令牌硬编码到配置文件中，并将其签入您的版本控制系统(VCS)，原因有两个。首先，因为将秘密签入源代码控制是不安全的做法，其次，因为您不想维护这个配置文件的单独的“prod”和“dev”版本。更好的解决方案是动态生成带有正确令牌的配置文件，并将其注入到CI/CD管道作业中。但是这带来了几个新的挑战:</p>

<ol>
  <li>如何安全地存储和访问机密</li>
  <li>如何动态呈现配置模板</li>
  <li>如何在渲染后注入模板</li>
</ol>

<p>在这篇文章的下一部分，我们将讨论这些挑战的一些解决方案。</p>

<h2>安全地存储和访问机密</h2>

<p>这里的挑战是双重的:首先，如何安全地存储您的秘密？第二，如何使它们能够被CI/CD管道中呈现模板的流程访问？</p>

<h3>用CircleCI上下文管理秘密</h3>

<p>CircleCI有一个内置的秘密存储，可通过我们的上下文功能访问。记录在上下文中的机密具有以下属性:</p>

<ul>
  <li>它们存储在Hashicorp的保险库中，使用AES256-GCM96加密，CircleCI员工无法访问(链接)。</li>
  <li>可以使用CircleCI CLI自动旋转它们。</li>
  <li>它们的键和值在创建后不能修改。</li>
  <li>它们的值不能在CircleCI管道作业之外公开。</li>
</ul>

<div class="pull-quote">
  <blockquote><b>提示:</b>如果您的秘密只在CircleCI内部使用，请使用CircleCI的上下文。</blockquote>
</div>

<p>在CircleCI管道作业的配置中，可以指定一个或多个要加载的上下文。这些上下文中的秘密将在该作业的持续时间内作为环境变量变得可用。然后，您可以让模板呈现引擎将这些环境变量中的数据插入到配置文件模板中，以呈现适合目标部署环境的配置文件。</p>

<h3>使用第三方秘密存储</h3>

<p>另一种选择是使用第三方秘密存储，如<a href="https://secrethub.io/"> SecretHub </a>、AWS Secrets Manager或Hashicorp Vault。这些更灵活，因为它们的秘密可以用于CircleCI以外的服务。然而，要在CircleCI中使用它们的秘密，您需要编写自己的方法来提取这些秘密，并使它们对您的模板渲染引擎可用。你也许可以利用CircleCI的<a href="https://circleci.com/developer/orbs">合作伙伴和社区orbs </a>来帮助整合这些工具。</p>

<h2>动态呈现配置模板</h2>

<p>您对模板渲染引擎的选择取决于几个因素，包括:</p>

<ul>
  <li>您用于构建和/或部署的工具</li>
  <li>应用程序中使用的语言</li>
  <li>您的团队最习惯使用的模板语言</li>
</ul>

<div class="pull-quote">
  <blockquote><b>提示:</b>对于需要多个工具访问的秘密，可以考虑第三方秘密存储。预算时间来编写逻辑，使秘密可用于您的模板渲染引擎。</blockquote>
</div>

<p>如果你使用Terraform，你可以使用它的<a href="https://www.terraform.io/docs/language/expressions/strings.html">字符串模板语法</a>。如果你使用Python或Ansible，你可能会使用<a href="https://docs.makotemplates.org/en/latest/">樱井真子</a>或<a href="https://jinja.palletsprojects.com/en/3.0.x/">金贾</a>模板。在这两个例子中，您可以使用CircleCI <a href="https://circleci.com/developer/images">预构建的图像</a>，为包含模板渲染的作业预安装Terraform、Ansible或Python，从而节省一些时间。你也可以查看任何相关的宝珠，比如<a href="https://circleci.com/developer/orbs/orb/jtreutel/jinja">金贾宝珠</a>。</p>

<p>一旦您将配置文件模板签入到VCS中，并向管道的部署作业添加了使用您选择的模板呈现引擎来呈现模板的步骤，您只需确保您将注入到模板中的秘密对您的模板呈现引擎可用。如前一节所述，CircleCI <a href="https://circleci.com/docs/contexts/"> contexts </a>使这变得容易。如果您使用的是第三方秘密存储，您需要编写一些脚本来安全地检索秘密，并将它们传递给模板呈现引擎。</p>

<div class="pull-quote">
  <blockquote>提示:使用方便的图像和球体来减少设置模板渲染环境的工作量。</blockquote>
</div>

<h2>将渲染模板注入管道</h2>

<p>因此，您已经在管道中呈现了模板，现在您需要将它们注入到管道作业中。这一部分听起来可能很简单:只需呈现模板并将它们插入到您的构建工件中，或者将它们推送到在您的部署过程中创建的基础设施中</p>

<p>但是，在使用渲染模板的同一作业中渲染模板并不总是可行的。假设您正在呈现想要注入到Docker映像构建中的Jinja模板化的配置文件。用于渲染Jinja模板的最方便的CircleCI <a href="https://circleci.com/docs/executor-types/">执行器</a>是一个Docker容器，它运行CircleCI的<a href="https://circleci.com/developer/images/image/cimg/python"> Python便利图像</a>。构建Docker映像最有效的执行器可能是一个<a href="https://circleci.com/docs/executor-types/#using-machine">机器执行器</a>(换句话说，一个VM)。每个作业都在一个干净的容器或VM中运行，所以Docker容器中呈现的模板对于运行Docker构建的机器执行器是不可用的。您可以将这两个任务合并成一个管道作业，在两个执行器中的一个上运行，但是这会使您的管道更慢、更复杂。</p>

<div class="pull-quote">
  <blockquote><b>提示:</b>缓存渲染后的模板，供管道中的其他作业使用。</blockquote>
</div>

<p>幸运的是，CircleCI允许您<a href="https://circleci.com/docs/caching/">缓存工作空间中作业之间的依赖关系</a>。您可以渲染模板，将其缓存在工作空间中，然后将该工作空间附加到需要使用这些模板的任何后续作业。这使您能够为每个作业使用最有效的执行器(就配置工作和计算时间而言)。</p>

<p>动态呈现配置模板解决了安全存储机密的问题，同时保持CI/CD管道中的进程可以访问它们。在本文中，我介绍了如何使用CircleCI上下文或第三方秘密存储安全地存储和访问秘密。我还介绍了如何选择模板呈现引擎，以及如何使用该引擎将秘密注入配置模板。使用动态呈现模板应用机密管理的最佳实践将有助于保持CI/CD管道成功安全地运行。</p>


        
          
          
        
      </div>
    </div>    
</body>
</html>